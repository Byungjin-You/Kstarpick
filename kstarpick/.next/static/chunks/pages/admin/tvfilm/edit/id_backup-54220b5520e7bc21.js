(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6138],{95753:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/tvfilm/edit/id_backup",function(){return a(42010)}])},42010:function(e,t,a){"use strict";a.r(t);var r=a(85893),i=a(67294),n=a(2575),s=a(11163),o=a(87066),l=a(5152),u=a.n(l);a(25675);var c=a(82606),d=a(33299),g=a(31955);a(74128),a(62076),a(65972);var m=a(79731),v=a(86501);u()(()=>Promise.all([a.e(9414),a.e(4966)]).then(a.bind(a,14966)),{loadableGenerated:{webpack:()=>[14966]},ssr:!1}),t.default=function(){let e=(0,s.useRouter)(),{id:t}=e.query,{data:a,status:l}=(0,d.useSession)(),[u,h]=(0,i.useState)(!1),[f,w]=(0,i.useState)(!1),[p,y]=(0,i.useState)(!1),[S,b]=(0,i.useState)(""),[x,I]=(0,i.useState)(""),[k,N]=(0,i.useState)("basic"),[C,j]=(0,i.useState)({title:"",originalTitle:"",category:"",coverImage:null,bannerImage:null,summary:"",network:"",status:"Ongoing",releaseDate:"",rating:"",runtime:"",ageRating:"",director:"",country:"",tags:[],trailerUrl:"",cast:[],watchProviders:[],videos:[],genres:[],productionCountry:"",content:"",reviews:[],reviewRating:0,reviewCount:0,ratingDistribution:[0,0,0,0,0,0,0,0,0,0]}),[A,R]=(0,i.useState)(""),[_,O]=(0,i.useState)(""),[D,E]=(0,i.useState)({}),[P,T]=(0,i.useState)(!1),[J,U]=(0,i.useState)(!1),[F,M]=(0,i.useState)(""),[z,B]=(0,i.useState)(null),[W,X]=(0,i.useState)(null),[q,G]=(0,i.useState)(""),[V,H]=(0,i.useState)(""),[K,L]=(0,i.useState)(""),[Q,Y]=(0,i.useState)(""),[Z,$]=(0,i.useState)(!1),[ee,et]=(0,i.useState)(""),[ea,er]=(0,i.useState)(!1),[ei,en]=(0,i.useState)([]),[es,eo]=(0,i.useState)(!1);(0,i.useRef)(null),(0,i.useRef)(null),(0,i.useRef)(null),(0,i.useEffect)(()=>{(async()=>{try{var t;if("loading"===l)return;if((null==a?void 0:null===(t=a.user)||void 0===t?void 0:t.role)==="admin"){$(!0);return}let r=g.default.get("token")||localStorage.getItem("token");if(!r){e.push("/admin/login");return}try{(await o.default.get("/api/auth/check-admin",{headers:{Authorization:"Bearer ".concat(r)},withCredentials:!0})).data.isAdmin?(g.default.get("token")||g.default.set("token",r,{expires:7}),$(!0)):(g.default.remove("token"),localStorage.removeItem("token"),e.push("/admin/login"))}catch(t){g.default.remove("token"),localStorage.removeItem("token"),e.push("/admin/login")}}catch(t){e.push("/admin/login")}})()},[e,a,l]),(0,i.useEffect)(()=>{t&&Z&&(async()=>{U(!0);try{let e=(await o.default.get("/api/tvfilm/".concat(t))).data.data,a=Array.isArray(e.cast)?e.cast:[],r=Array.isArray(e.watchProviders)?e.watchProviders:[],i=Array.isArray(e.videos)?e.videos:[],n=Array.isArray(e.tags)?e.tags:[],s=Array.isArray(e.genres)?e.genres:[],l=Array.isArray(e.reviews)?e.reviews:[],u={title:e.title||"",originalTitle:e.originalTitle||"",category:e.category||"",coverImage:e.coverImage||null,bannerImage:e.bannerImage||null,summary:e.summary||"",content:e.content||"",network:e.network||"",status:e.status||"Ongoing",releaseDate:e.releaseDate?new Date(e.releaseDate).toISOString().split("T")[0]:"",rating:e.rating||"",runtime:e.runtime||"",ageRating:e.ageRating||"",director:e.director||"",country:e.country||"",tags:n,trailerUrl:e.trailerUrl||"",cast:a,watchProviders:r,videos:i,genres:s,productionCountry:e.productionCountry||"",reviews:l,reviewRating:e.reviewRating||0,reviewCount:e.reviewCount||0,ratingDistribution:e.ratingDistribution||[0,0,0,0,0,0,0,0,0,0]};j(u),en(JSON.parse(JSON.stringify(l))),eo(!1),e.coverImage&&(R(e.coverImage),e.coverImage.startsWith("http")?B("/api/proxy?url=".concat(encodeURIComponent(e.coverImage))):B(e.coverImage)),e.bannerImage&&(O(e.bannerImage),e.bannerImage.startsWith("http")?X("/api/proxy?url=".concat(encodeURIComponent(e.bannerImage))):X(e.bannerImage))}catch(e){E({general:"TV/Film 데이터를 불러오는데 실패했습니다"})}finally{U(!1)}})()},[t,Z]);let el=async e=>{if(!ea)try{var r;er(!0),E(e=>({...e,reviews:null}));let i=g.default.get("token")||localStorage.getItem("token");if(!i&&(null==a?void 0:null===(r=a.user)||void 0===r?void 0:r.role)==="admin"){await o.default.post("/api/tvfilm/admin/reviews",{tvfilmId:t,reviews:e},{timeout:15e3}),v.toast.success("리뷰가 성공적으로 저장되었습니다."),en(JSON.parse(JSON.stringify(e))),eo(!1),er(!1);return}if(!i){E(e=>({...e,reviews:"인증 토큰이 없습니다. 다시 로그인해 주세요."})),er(!1);return}await o.default.post("/api/tvfilm/admin/reviews",{tvfilmId:t,reviews:e},{headers:{Authorization:"Bearer ".concat(i)},timeout:15e3}),v.toast.success("리뷰가 성공적으로 저장되었습니다."),en(JSON.parse(JSON.stringify(e))),eo(!1)}catch(e){v.toast.error("리뷰 저장 중 오류가 발생했습니다."),E(t=>{var a,r;return{...t,reviews:(null===(r=e.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.message)||e.message||"리뷰 저장 중 오류가 발생했습니다."}})}finally{er(!1)}};return(0,r.jsx)(n.default,{children:(0,r.jsxs)("div",{className:"p-5 bg-white rounded-lg shadow space-y-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-pink-600",children:"사용자 리뷰"}),(0,r.jsx)("button",{type:"button",onClick:()=>el(C.reviews),disabled:ea||J||P||!es,className:"px-4 py-2 rounded ".concat(ea||J||P||!es?"bg-gray-300 cursor-not-allowed":"bg-green-500 hover:bg-green-600"," text-white flex items-center"),children:ea?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(c.default,{className:"animate-spin w-4 h-4 mr-2"}),"저장 중..."]}):es?"리뷰 저장":"저장됨"})]}),(0,r.jsxs)("div",{className:"bg-gray-100 p-2 text-xs rounded",children:[(0,r.jsxs)("p",{children:["변경감지: ",es?"있음":"없음"]}),(0,r.jsxs)("p",{children:["리뷰 개수: ",C.reviews.length,"개"]}),(0,r.jsxs)("p",{children:["평론가 리뷰: ",C.reviews.filter(e=>e.isCritic).length,"개"]}),(0,r.jsxs)("p",{children:["마지막 저장: ",ei.length,"개"]}),(0,r.jsx)("button",{onClick:()=>{eo(!0)},className:"mt-1 px-2 py-1 bg-blue-500 text-white text-xs rounded",children:"변경상태 강제설정"})]}),(0,r.jsx)(m.default,{reviews:C.reviews,onChange:e=>{let t=0,a=[0,0,0,0,0,0,0,0,0,0];e.filter(e=>!!e.isCritic).length,e.forEach(e=>{t+=e.rating;let r=Math.min(Math.max(Math.floor(e.rating)-1,0),9);a[r]++});let r=e.length>0?t/e.length:0;eo(!0),j(t=>({...t,reviews:e,reviewRating:parseFloat(r.toFixed(1)),reviewCount:e.length,ratingDistribution:a}))},tvfilmId:t})]})})}}},function(e){e.O(0,[1664,5089,1876,7066,8766,5942,9222,2888,9774,179],function(){return e(e.s=95753)}),_N_E=e.O()}]);