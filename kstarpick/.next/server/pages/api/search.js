"use strict";(()=>{var e={};e.id=5198,e.ids=[5198],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},71854:(e,t,i)=>{i.r(t),i.d(t,{config:()=>p,default:()=>c,routeModule:()=>$});var r={};i.r(r),i.d(r,{default:()=>l});var o=i(71802),a=i(47153),n=i(56249),s=i(35968);async function l(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let{q:i,type:r,page:o=1,limit:a=12,sortBy:n="newest",dateRange:l}=e.query;if(!i)return t.status(400).json({message:"Search query is required"});let{db:c}=await (0,s.connectToDatabase)(),p=(parseInt(o)-1)*parseInt(a),$={};if(l&&"all"!==l){let e=new Date;switch(l){case"today":$={createdAt:{$gte:new Date(e.setHours(0,0,0,0))}};break;case"week":$={createdAt:{$gte:new Date(e.setDate(e.getDate()-7))}};break;case"month":$={createdAt:{$gte:new Date(e.setMonth(e.getMonth()-1))}};break;case"year":$={createdAt:{$gte:new Date(e.setFullYear(e.getFullYear()-1))}}}}let g={};switch(n){case"newest":g={createdAt:-1};break;case"oldest":g={createdAt:1};break;case"popular":g={viewCount:-1};break;default:g={score:{$meta:"textScore"}}}let m=i.trim().split(/\s+/).filter(e=>e.length>1),u=(e,t={})=>{let i=[{title:{$regex:e,$options:"i"}},{name:{$regex:e,$options:"i"}},{content:{$regex:e,$options:"i"}},{contentHtml:{$regex:e,$options:"i"}},{summary:{$regex:e,$options:"i"}},{description:{$regex:e,$options:"i"}},{cast:{$regex:e,$options:"i"}},{actors:{$regex:e,$options:"i"}},{director:{$regex:e,$options:"i"}},{starring:{$regex:e,$options:"i"}},{"cast.name":{$regex:e,$options:"i"}},{"actors.name":{$regex:e,$options:"i"}},{biography:{$regex:e,$options:"i"}},{knownAs:{$regex:e,$options:"i"}},{alternateNames:{$regex:e,$options:"i"}},{body:{$regex:e,$options:"i"}},{"tags.name":{$regex:e,$options:"i"}}];e.includes(" ")&&(i.push({cast:{$elemMatch:{name:{$regex:e,$options:"i"}}}}),i.push({"credits.mainCast":{$elemMatch:{name:{$regex:e,$options:"i"}}}}),i.push({"credits.supportCast":{$elemMatch:{name:{$regex:e,$options:"i"}}}}));let r={$or:i};return Object.keys(t).length>0?{$and:[r,t]}:r},d=m.length>=1&&m.length<=3;if(("all"===r||"news"===r)&&1===m.length&&m[0].length>=4)try{let e=c.collection("news"),r={$or:[{title:{$regex:i,$options:"i"}},{content:{$regex:i,$options:"i"}},{contentHtml:{$regex:i,$options:"i"}}],...$},n=await e.find(r).sort(g).skip(p).limit(parseInt(a)).toArray();if(n.length>0){let i=await e.countDocuments(r);return t.status(200).json({results:{news:n,dramas:[],movies:[],actors:[]},total:i,page:parseInt(o),totalPages:Math.ceil(i/parseInt(a))})}}catch(e){}if("all"===r&&d)try{if(i.toLowerCase().includes("park bo gum")||i.toLowerCase().includes("parkbogum")){let e=c.collection("news"),i=await e.find({title:{$regex:"Park Bo Gum",$options:"i"}}).sort({publishedAt:-1,createdAt:-1}).limit(parseInt(a)).toArray(),r=c.collection("tvfilms"),n=await r.find({"cast.name":{$regex:"Park Bo Gum",$options:"i"}}).limit(parseInt(a)).toArray();return t.status(200).json({results:{news:i,dramas:n.filter(e=>"drama"===e.category),movies:n.filter(e=>"movie"===e.category),actors:[]},total:i.length+n.length,page:parseInt(o),totalPages:Math.ceil((i.length+n.length)/parseInt(a))})}let e=c.collection("tvfilms"),r=await e.find({cast:{$elemMatch:{name:{$regex:i,$options:"i"}}}}).limit(parseInt(a)).toArray(),n=c.collection("news"),s=await n.find({title:{$regex:i,$options:"i"}}).sort({publishedAt:-1,createdAt:-1}).limit(parseInt(a)).toArray();if(r.length>0||s.length>0)return t.status(200).json({results:{dramas:r.filter(e=>"drama"===e.category),movies:r.filter(e=>"movie"===e.category),news:s,actors:[]},total:r.length+s.length,page:parseInt(o),totalPages:Math.ceil((r.length+s.length)/parseInt(a))})}catch(e){}let h={news:{name:"news",filter:{}},dramas:{name:"tvfilms",filter:{category:"drama"}},movies:{name:"tvfilms",filter:{category:"movie"}},actors:{name:"celebrities",filter:{}}},f=["news","dramas","movies","actors"].map(async e=>{let{name:t,filter:r}=h[e],o=c.collection(t),n=u(i,r);if((i.toLowerCase().includes("park bo gum")||i.toLowerCase().includes("parkbogum"))&&"news"===t){let t={...r,title:{$regex:"Park Bo Gum",$options:"i"}},i=await o.find(t).sort(g).limit(parseInt(a)).toArray();if(i.length>0)return{type:e,results:i,total:i.length}}"tvfilms"===t&&n.$or.push({"cast.name":{$regex:i,$options:"i"}});let s=await o.find(n).sort(g).limit(parseInt(a)).toArray();if("tvfilms"===t&&i.includes(" "))try{let e=await o.find({...r,"cast.name":{$regex:i,$options:"i"}}).limit(parseInt(a)).toArray();if(e.length>0){e.forEach(e=>{if(e.cast&&Array.isArray(e.cast)){let t=e.cast.filter(e=>RegExp(i,"i").test(e.name||""));t.length>0&&(e.matchInfo={type:"cast",matches:t.map(e=>({name:e.name,role:e.role||"Actor"}))})}});let t=new Set(s.map(e=>e._id.toString())),r=e.filter(e=>!t.has(e._id.toString()));if(r.length>0){s=[...r,...s];let e=r[0];e.matchInfo&&e.matchInfo.matches.length}}}catch(e){}if("news"===t&&i.includes(" ")&&d)try{let e=await o.find({title:{$regex:i,$options:"i"}}).limit(parseInt(a)).toArray();if(e.length>0){let t=new Set(s.map(e=>e._id.toString())),i=e.filter(e=>!t.has(e._id.toString()));i.length>0&&(s=[...i,...s])}}catch(e){}if(0===s.length&&m.length>1){let e={$and:[...m.map(e=>{let i=[{title:{$regex:e,$options:"i"}},{name:{$regex:e,$options:"i"}},{content:{$regex:e,$options:"i"}},{contentHtml:{$regex:e,$options:"i"}},{summary:{$regex:e,$options:"i"}},{description:{$regex:e,$options:"i"}},{cast:{$regex:e,$options:"i"}},{actors:{$regex:e,$options:"i"}},{director:{$regex:e,$options:"i"}},{starring:{$regex:e,$options:"i"}},{"cast.name":{$regex:e,$options:"i"}},{"actors.name":{$regex:e,$options:"i"}},{biography:{$regex:e,$options:"i"}},{knownAs:{$regex:e,$options:"i"}},{alternateNames:{$regex:e,$options:"i"}},{body:{$regex:e,$options:"i"}},{"tags.name":{$regex:e,$options:"i"}}];return"tvfilms"===t&&(i.push({cast:{$elemMatch:{name:{$regex:e,$options:"i"}}}}),i.push({"credits.mainCast":{$elemMatch:{name:{$regex:e,$options:"i"}}}}),i.push({"credits.supportCast":{$elemMatch:{name:{$regex:e,$options:"i"}}}})),{$or:i}}),r]};s=await o.find(e).sort(g).skip(p).limit(parseInt(a)).toArray()}if(0===s.length&&m.length>1){let e=m.flatMap(e=>[{title:{$regex:e,$options:"i"}},{name:{$regex:e,$options:"i"}},{content:{$regex:e,$options:"i"}},{contentHtml:{$regex:e,$options:"i"}},{summary:{$regex:e,$options:"i"}},{description:{$regex:e,$options:"i"}},{cast:{$regex:e,$options:"i"}},{actors:{$regex:e,$options:"i"}},{director:{$regex:e,$options:"i"}},{starring:{$regex:e,$options:"i"}},{"cast.name":{$regex:e,$options:"i"}},{"actors.name":{$regex:e,$options:"i"}},{biography:{$regex:e,$options:"i"}},{knownAs:{$regex:e,$options:"i"}},{alternateNames:{$regex:e,$options:"i"}},{body:{$regex:e,$options:"i"}},{"tags.name":{$regex:e,$options:"i"}}]);s=await o.find({$and:[{$or:e},r]}).sort(g).skip(p).limit(parseInt(a)).toArray()}s.length;let l=s.length;return{type:e,results:s,total:l}}),x=await Promise.all(f),y=x.reduce((e,t)=>e+t.total,0);return x.map(e=>`${e.type}: ${e.total}`).join(", "),0===y&&(await c.collection("news").find({}).sort({createdAt:-1}).limit(3).toArray(),await c.collection("celebrities").find({}).sort({createdAt:-1}).limit(3).toArray()),t.status(200).json({results:x.reduce((e,t)=>({...e,[t.type]:t.results}),{}),total:y,page:parseInt(o),totalPages:Math.ceil(y/parseInt(a))})}catch(e){return t.status(500).json({message:"Internal server error",error:e.message})}}i(38013);let c=(0,n.hoist)(r,"default"),p=(0,n.hoist)(r,"config"),$=new o.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/search",pathname:"/api/search",bundlePath:"",filename:""},userland:r})},35968:(e,t,i)=>{let r;i.r(t),i.d(t,{connectToDatabase:()=>c,dbConnect:()=>p,default:()=>$});var o=i(38013),a=i(92048),n=i.n(a),s=i(55315),l=i.n(s);{let e=i(25142),t=l().resolve(process.cwd(),".env.production");n().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await r,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}r=new o.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let p=c,$=r},47153:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},71802:(e,t,i)=>{e.exports=i(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var i=t(t.s=71854);module.exports=i})();