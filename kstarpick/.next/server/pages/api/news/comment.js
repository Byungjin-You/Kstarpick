"use strict";(()=>{var e={};e.id=7279,e.ids=[7279],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},88638:(e,t,n)=>{n.r(t),n.d(t,{config:()=>h,default:()=>g,routeModule:()=>p});var s={};n.r(s),n.d(s,{default:()=>l});var a=n(71802),r=n(47153),o=n(56249),i=n(41649),c=n(35968),u=n(38013);async function l(e,t){if("GET"===e.method)return d(e,t);if("POST"===e.method)return m(e,t);let n=await (0,i.getSession)({req:e});return n?"DELETE"===e.method?f(e,t,n):t.status(405).json({success:!1,message:"Method not allowed"}):t.status(401).json({success:!1,message:"Not authenticated"})}async function d(e,t){try{let n,s;let{id:a,page:r=1,limit:o=10}=e.query;if(!a)return t.status(400).json({success:!1,message:"News ID is required"});let{db:i}=await (0,c.connectToDatabase)();try{u.ObjectId.isValid(a)&&(n=await i.collection("news").findOne({_id:new u.ObjectId(a)}),s=n?._id),n||(n=await i.collection("news").findOne({slug:a}),s=n?._id)}catch(e){}if(!n)return t.status(404).json({success:!1,message:"News article not found"});let l=(parseInt(r)-1)*parseInt(o),d=await i.collection("comments").find({contentId:s instanceof u.ObjectId?s:new u.ObjectId(s),contentType:"news"}).sort({createdAt:-1}).skip(l).limit(parseInt(o)).toArray(),m=d.filter(e=>e.author).map(e=>{try{return new u.ObjectId(e.author)}catch(e){return null}}).filter(e=>null!==e),f=[];m.length>0&&(f=await i.collection("users").find({_id:{$in:m}}).toArray());let g=d.map(e=>{if(!e.author)return{...e,author:{name:e.guestName||"Guest",image:null,isGuest:!0}};{let t=f.find(t=>t._id.toString()===e.author.toString());return{...e,author:t?{_id:t._id,name:t.name,image:t.image||null,isGuest:!1}:{name:"Unknown User",image:null,isGuest:!1}}}});g.forEach((e,t)=>{e.author._id});let h=await i.collection("comments").countDocuments({contentId:s instanceof u.ObjectId?s:new u.ObjectId(s),contentType:"news"});return t.status(200).json({success:!0,comments:g,pagination:{total:h,page:parseInt(r),limit:parseInt(o),pages:Math.ceil(h/parseInt(o))}})}catch(e){return t.status(500).json({success:!1,message:`Server error: ${e.message}`})}}async function m(e,t){try{let n;let{id:s,content:a,guestName:r}=e.body;if(!s||!a)return t.status(400).json({success:!1,message:"News ID and comment content are required"});if(a.trim().length<1)return t.status(400).json({success:!1,message:"Comment cannot be empty"});let{db:o}=await (0,c.connectToDatabase)();try{u.ObjectId.isValid(s)&&(n=await o.collection("news").findOne({_id:new u.ObjectId(s)})),n||(n=await o.collection("news").findOne({slug:s}))}catch(e){}if(!n)return t.status(404).json({success:!1,message:"News article not found"});let l=await (0,i.getSession)({req:e}),d=null,m=null,f=null;if(l&&l.user){let e=await o.collection("users").findOne({email:l.user.email});e&&(d=e._id,m=e.name)}else f=r&&r.trim()?r.trim():function(){let e=["Amazing","Bright","Cool","Dreamy","Elegant","Fancy","Glowing","Happy"],t=["Fan","Star","Angel","Melody","Voice","Heart","Artist","ARMY"],n=e[Math.floor(Math.random()*e.length)],s=t[Math.floor(Math.random()*t.length)];return`${n}${s}${Math.floor(100*Math.random())}`}();let g=n._id instanceof u.ObjectId?n._id:new u.ObjectId(n._id),h={content:a.trim(),contentId:g,contentType:"news",createdAt:new Date};d?h.author=d:(h.guestName=f,h.isGuest=!0);let p=await o.collection("comments").insertOne(h),w={...await o.collection("comments").findOne({_id:p.insertedId}),author:d?{_id:d,name:m||"User",image:l?.user?.image||null}:{name:f,image:null,isGuest:!0}};return t.status(201).json({success:!0,message:"Comment added successfully",comment:w})}catch(e){return t.status(500).json({success:!1,message:`Server error: ${e.message}`})}}async function f(e,t,n){try{let{commentId:s}=e.body;if(!s)return t.status(400).json({success:!1,message:"Comment ID is required"});let{db:a}=await (0,c.connectToDatabase)(),r=await a.collection("comments").findOne({_id:new u.ObjectId(s)});if(!r)return t.status(404).json({success:!1,message:"Comment not found"});let o=r.author&&r.author.toString()===n.user.id,i="admin"===n.user.role;if(!o&&!i)return t.status(403).json({success:!1,message:"Not authorized to delete this comment"});return await a.collection("comments").deleteOne({_id:new u.ObjectId(s)}),t.status(200).json({success:!0,message:"Comment deleted successfully"})}catch(e){return t.status(500).json({success:!1,message:`Server error: ${e.message}`})}}let g=(0,o.hoist)(s,"default"),h=(0,o.hoist)(s,"config"),p=new a.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/news/comment",pathname:"/api/news/comment",bundlePath:"",filename:""},userland:s})},35968:(e,t,n)=>{let s;n.r(t),n.d(t,{connectToDatabase:()=>u,dbConnect:()=>l,default:()=>d});var a=n(38013),r=n(92048),o=n.n(r),i=n(55315),c=n.n(i);{let e=n(25142),t=c().resolve(process.cwd(),".env.production");o().existsSync(t)&&e.config({path:t}).error}async function u(){try{let e=await s,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}s=new a.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=u,d=s},47153:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},71802:(e,t,n)=>{e.exports=n(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=88638);module.exports=n})();