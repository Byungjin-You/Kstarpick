"use strict";(()=>{var e={};e.id=2990,e.ids=[2990],e.modules={98432:e=>{e.exports=require("bcryptjs")},84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},62113:e=>{e.exports=require("next-auth/next")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},73673:e=>{e.exports=require("slugify")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},93464:(e,t,n)=>{n.r(t),n.d(t,{config:()=>S,default:()=>g,routeModule:()=>b});var r={};n.r(r),n.d(r,{default:()=>h});var a=n(71802),s=n(47153),i=n(56249),o=n(35968),c=n(38013);n(41649);var u=n(62113),l=n(57309),d=n(86044),m=n(73673),p=n.n(m);async function h(e,t){let{id:n}=e.query;try{let{db:r}=await (0,o.connectToDatabase)();if("GET"===e.method)return f(e,t,n,r);if("PUT"===e.method)return y(e,t,n,r);if("DELETE"===e.method)return w(e,t,n,r);return t.status(405).json({success:!1,message:"Method not allowed"})}catch(e){return t.status(500).json({success:!1,message:e.message||"Internal server error"})}}async function f(e,t,n,r){try{let e;try{c.ObjectId.isValid(n)&&(e=await r.collection("news").findOne({_id:new c.ObjectId(n)}))}catch(e){}if(e||(e=await r.collection("news").findOne({slug:n})),!e)return t.status(404).json({success:!1,message:"News not found"});return await r.collection("news").updateOne({_id:e._id},{$inc:{viewCount:1}}),e._id=e._id.toString(),e.createdAt&&(e.createdAt=e.createdAt.toISOString()),e.updatedAt&&(e.updatedAt=e.updatedAt.toISOString()),t.status(200).json({success:!0,data:e})}catch(e){return t.status(500).json({success:!1,message:e.message})}}async function y(e,t,n,r){try{{let n=!1;try{let r=await (0,u.getServerSession)(e,t,l.authOptions);r&&r.user&&"admin"===r.user.role&&(n=!0,r.user)}catch(e){}if(!n)try{let t=await (0,d.verifyToken)(e);t&&("admin"===t.role||t.isAdmin)&&(n=!0)}catch(e){}if(!n){e.headers.authorization;let t=e.headers["x-user-email"];if(t)try{let e=await r.collection("users").findOne({email:t});e&&"admin"===e.role&&(n=!0)}catch(e){}}if(!n)return t.status(401).json({success:!1,message:"Unauthorized - Admin access required"})}let a=e.body;if(!a.title||!a.content||!a.summary)return t.status(400).json({success:!1,message:"Missing required fields"});a.title&&(a.slug=p()(a.title,{lower:!0,strict:!0})),a.updatedAt=new Date;let s=await r.collection("news").updateOne({_id:new c.ObjectId(n)},{$set:a});if(0===s.matchedCount)return t.status(404).json({success:!1,message:"News article not found"});let i=await r.collection("news").findOne({_id:new c.ObjectId(n)});return t.status(200).json({success:!0,data:i,message:"News article updated successfully"})}catch(e){return t.status(500).json({success:!1,message:e.message||"Something went wrong"})}}async function w(e,t,n,r){try{{let n=!1;try{let r=await (0,u.getServerSession)(e,t,l.authOptions);r&&r.user&&"admin"===r.user.role&&(n=!0,r.user)}catch(e){}if(!n)try{let t=await (0,d.verifyToken)(e);t&&("admin"===t.role||t.isAdmin)&&(n=!0)}catch(e){}if(!n){let t=e.headers["x-user-email"];if(t)try{let e=await r.collection("users").findOne({email:t});e&&"admin"===e.role&&(n=!0)}catch(e){}}if(!n)return t.status(401).json({success:!1,message:"Unauthorized - Admin access required"})}if(!c.ObjectId.isValid(n))return t.status(400).json({success:!1,message:"Invalid news ID"});let a=await r.collection("news").deleteOne({_id:new c.ObjectId(n)});if(0===a.deletedCount)return t.status(404).json({success:!1,message:"News article not found"});return t.status(200).json({success:!0,message:"News article deleted successfully"})}catch(e){return t.status(500).json({success:!1,message:e.message||"Something went wrong"})}}let g=(0,i.hoist)(r,"default"),S=(0,i.hoist)(r,"config"),b=new a.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/news/[id]",pathname:"/api/news/[id]",bundlePath:"",filename:""},userland:r})},86044:(e,t,n)=>{let r=n(99344),{connectToDatabase:a}=n(35968),{ObjectId:s}=n(38013),{parse:i}=n(84802),o=n(44756),c=n(81075),u="kstarpick_jwt_secret_key_2024_production";async function l(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=i(e.headers.cookie).token),!t)return null;try{let e=r.verify(t,u);try{await o();let t=await c.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await a(),n=await t.collection("users").findOne({_id:new s(e.id)});if(n)return{_id:n._id,id:n._id,name:n.name,email:n.email,isAdmin:"admin"===n.role,role:n.role}}catch(e){}return null}catch(e){return null}}async function d(e){try{let t=await l(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return r.sign(e,u,{expiresIn:"7d"})},verifyToken:l,isAdmin:d}},44756:(e,t,n)=>{n.r(t),n.d(t,{default:()=>u});var r=n(11185),a=n.n(r);n(25142).config({path:".env.production"});let s="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";s||(s="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),s.includes("localhost")||(s.includes("mongodb://")&&!s.includes("authSource=")&&(s.includes("?")?s+="&authSource=admin":s+="?authSource=admin"),!s.includes("docdb.amazonaws.com")||s.includes("authMechanism=")||(s.includes("?")?s+="&authMechanism=SCRAM-SHA-1":s+="?authMechanism=SCRAM-SHA-1"));let i=s.includes("localhost")||s.includes("127.0.0.1"),o=global.mongoose;async function c(){if(o.conn&&1===a().connection.readyState)return o.conn;if(0===a().connection.readyState||3===a().connection.readyState){o.conn=null,o.promise=null;try{await a().connection.close()}catch(e){}}if(!o.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};i||(s.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),o.promise=a().connect(s,e).then(e=>(e.connection.on("error",e=>{o.conn=null,o.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{o.conn=null,o.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw o.promise=null,e})}try{return o.conn=await o.promise,o.conn}catch(e){throw o.promise=null,e}}o||(o=global.mongoose={conn:null,promise:null});let u=c},81075:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var r=n(11185),a=n.n(r);let s=new(a()).Schema({name:{type:String,required:[!0,"Please provide a name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},image:{type:String,default:"/images/default-avatar.png"},role:{type:String,enum:["user","admin","editor"],default:"user"},likes:{type:[{contentId:{type:a().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},dislikes:{type:[{contentId:{type:a().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},bookmarks:{type:[{contentId:{type:a().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),i=a().models.User||a().model("User",s)},57309:(e,t,n)=>{n.r(t),n.d(t,{authOptions:()=>l,default:()=>d});let r=require("next-auth");var a=n.n(r);let s=require("next-auth/providers/credentials");var i=n.n(s),o=n(35968),c=n(98432),u=n.n(c);let l={providers:[i()({name:"Credentials",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){try{let{db:t}=await (0,o.connectToDatabase)(),n=await t.collection("users").findOne({email:e.email});if(!n||!await u().compare(e.password,n.password))return null;return{id:n._id.toString(),name:n.name,email:n.email,role:n.role}}catch(e){return null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.id,e.user.role=t.role),e)},pages:{signIn:"/auth/signin",error:"/auth/error"},debug:!1,secret:"kstarpick_nextauth_secret_key_2024_production"},d=a()(l)},35968:(e,t,n)=>{let r;n.r(t),n.d(t,{connectToDatabase:()=>u,dbConnect:()=>l,default:()=>d});var a=n(38013),s=n(92048),i=n.n(s),o=n(55315),c=n.n(o);{let e=n(25142),t=c().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function u(){try{let e=await r,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}r=new a.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=u,d=r},47153:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},71802:(e,t,n)=>{e.exports=n(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=93464);module.exports=n})();