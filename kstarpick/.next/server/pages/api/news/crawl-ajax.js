"use strict";(()=>{var e={};e.id=283,e.ids=[283],e.modules={38013:e=>{e.exports=require("mongodb")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},99648:e=>{e.exports=import("axios")},20295:e=>{e.exports=import("cheerio")},65462:e=>{e.exports=import("puppeteer")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},35437:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>c,routeModule:()=>d});var i=a(71802),r=a(47153),l=a(56249),n=a(70394),o=e([n]);n=(o.then?(await o)():o)[0];let c=(0,l.hoist)(n,"default"),u=(0,l.hoist)(n,"config"),d=new i.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/news/crawl-ajax",pathname:"/api/news/crawl-ajax",bundlePath:"",filename:""},userland:n});s()}catch(e){s(e)}})},70394:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.r(t),a.d(t,{default:()=>p});var i=a(99648),r=a(20295),l=a(38013),n=a(92048),o=a.n(n),c=a(65462),u=e([i,r,c]);function d(e){!function(e){let t=new Date().toISOString(),a=`[${t}] ${e}
`;try{o().appendFileSync("/tmp/news-crawl-ajax-debug.log",a)}catch(e){}}(`[FORCE] ${e}`)}function h(e,t,a,s,i,r){let l="";if(t&&t.includes("/article/")){let e=t.match(/\/article\/([^\/]+)/);e&&e[1]&&(l=e[1])}return l||(l=e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").substring(0,50)),{title:e.trim(),slug:l,content:"",summary:"",thumbnailUrl:a||"",category:s||"K-Pop",tags:[],articleUrl:t,timeText:i||"Recently",createdAt:new Date,updatedAt:new Date,source:"Soompi",status:"published",views:0,likes:0,index:r}}async function m(e=300){let t;try{d("=== AJAX 기반 Soompi 크롤링 시작 ==="),d(`목표 뉴스 개수: ${e}개`),t=await c.default.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--disable-gpu"]});let a=await t.newPage();await a.setUserAgent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36");let s=[];d("https://www.soompi.com/latest 접속 중..."),await a.goto("https://www.soompi.com/latest",{waitUntil:"networkidle2",timeout:3e4}),d("페이지 로드 완료");let i=await a.evaluate(()=>{let e=[];for(let t of[".col-sm-12.col-md-4 h4.media-heading a","h4.media-heading a",".media-heading a",'a[href*="/article/"]'])if(document.querySelectorAll(t).forEach(t=>{let a=t.href,s=t.textContent?.trim();a&&s&&a.includes("/article/")&&!e.some(e=>e.url===a)&&e.push({url:a,title:s})}),e.length>10)break;return e});for(let t of(d(`첫 페이지에서 ${i.length}개 뉴스 발견`),i)){if(s.length>=e)break;if(!s.some(e=>e.articleUrl===t.url)){let e=h(t.title,t.url,"","","Recently",s.length);s.push(e),d(`뉴스 추가 [${s.length}]: "${t.title}"`)}}let l=2,n=Math.ceil(e/15);for(d(`Load More를 통해 최대 ${n}페이지까지 로드 시도`);s.length<e&&l<=n;)try{d(`=== 페이지 ${l} AJAX 로드 시작 ===`);let t=await a.evaluate(async e=>{try{let t=new FormData;t.append("action","get_ltp_search_articles"),t.append("ltp","1"),t.append("page",e.toString());let a=await fetch("https://www.soompi.com/wp-admin/admin-ajax.php",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:t});if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);return await a.text()}catch(e){return null}},l);if(!t){d(`페이지 ${l} AJAX 요청 실패`);break}if(t.trim().length<100){d(`페이지 ${l} 응답이 너무 짧음 (${t.length} bytes) - 더 이상 데이터 없음`);break}d(`페이지 ${l} AJAX 응답 수신 (${t.length} bytes)`);let i=r.load(t),n=[];for(let e of["h4.media-heading a",".media-heading a",'a[href*="/article/"]'])if(i(e).each((e,t)=>{let a=i(t).attr("href"),s=i(t).text()?.trim();a&&s&&(a.startsWith("http")||(a=a.startsWith("/")?`https://www.soompi.com${a}`:`https://www.soompi.com/${a}`),a.includes("/article/")&&!n.some(e=>e.url===a)&&n.push({url:a,title:s}))}),n.length>0)break;if(d(`페이지 ${l}에서 ${n.length}개 새 뉴스 발견`),0===n.length){d("더 이상 새 뉴스가 없습니다.");break}let o=0;for(let t of n){if(s.length>=e)break;if(!s.some(e=>e.articleUrl===t.url)){let e=h(t.title,t.url,"","","Recently",s.length);s.push(e),o++,d(`새 뉴스 추가 [${s.length}]: "${t.title}"`)}}if(d(`페이지 ${l}에서 ${o}개 뉴스 추가됨 (총 ${s.length}개)`),0===o){d("새로 추가된 뉴스가 없습니다. 크롤링 종료.");break}l++,await new Promise(e=>setTimeout(e,1500))}catch(e){d(`페이지 ${l} 로드 중 오류: ${e.message}`);break}return d(`=== AJAX 크롤링 완료: 총 ${s.length}개 뉴스 수집 ===`),s}catch(e){throw d(`AJAX 크롤링 중 오류: ${e.message}`),e}finally{t&&await t.close()}}async function p(e,t){if("POST"!==e.method)return t.status(405).json({success:!1,message:"Method not allowed"});try{let a;d("=== AJAX 크롤링 시작 ===");let s=Math.min(parseInt(e.body.maxItems)||50,300);d(`최대 크롤링 아이템 수: ${s}`);try{a=await m(s)}catch(e){return d("크롤링 중 오류 발생: "+e.message),t.status(500).json({success:!1,message:"크롤링 중 오류가 발생했습니다: "+e.message})}if(0===a.length)return d("크롤링할 뉴스를 찾을 수 없음"),t.status(404).json({success:!1,message:"크롤링할 뉴스를 찾을 수 없습니다."});d("=== 데이터베이스 연결 시작 ===");let i=new l.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!0,tlsAllowInvalidHostnames:!0,tlsAllowInvalidCertificates:!0});await i.connect();let r=i.db("kstarpick").collection("news");d("MongoDB 연결 성공");let n=0,o=[];for(let e of a)try{if(await r.findOne({$or:[{articleUrl:e.articleUrl},{slug:e.slug}]}))d(`중복 뉴스 스킵: "${e.title}"`);else{let t=await r.insertOne(e);t.insertedId&&(n++,o.push({title:e.title,slug:e.slug,id:t.insertedId}),d(`새 뉴스 저장: "${e.title}"`))}}catch(e){d(`뉴스 저장 오류: ${e.message}`)}await i.close();let c=n>0?`${n}개의 새 뉴스 항목을 추가했습니다.`:"새로운 뉴스가 없습니다.";return d(`=== 크롤링 완료: ${c} ===`),t.status(200).json({success:!0,message:c,total:a.length,new:n,savedNews:o.slice(0,5)})}catch(e){return d("API 핸들러 오류: "+e.message),t.status(500).json({success:!1,message:"서버 오류가 발생했습니다: "+e.message})}}[i,r,c]=u.then?(await u)():u,s()}catch(e){s(e)}})},47153:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},71802:(e,t,a)=>{e.exports=a(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=35437);module.exports=a})();