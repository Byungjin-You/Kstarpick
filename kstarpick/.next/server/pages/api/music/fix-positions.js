"use strict";(()=>{var e={};e.id=7025,e.ids=[7025],e.modules={98432:e=>{e.exports=require("bcryptjs")},84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},73227:e=>{e.exports=require("next-auth")},62113:e=>{e.exports=require("next-auth/next")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},73673:e=>{e.exports=require("slugify")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},4815:(e,t,i)=>{i.r(t),i.d(t,{config:()=>h,default:()=>y,routeModule:()=>f});var o={};i.r(o),i.d(o,{default:()=>m});var n=i(71802),r=i(47153),a=i(56249),s=i(44756),u=i(33151),l=i(86044),d=i(62113),c=i(69097),p=i(35968);async function m(e,t){if("POST"!==e.method)return t.status(405).json({success:!1,message:"Method Not Allowed"});try{let i=!1;try{let o=await (0,d.getServerSession)(e,t,c.authOptions);o&&o.user&&"admin"===o.user.role&&(i=!0,o.user)}catch(e){}if(!i)try{let t=await (0,l.verifyToken)(e);t&&("admin"===t.role||t.isAdmin)&&(i=!0)}catch(e){}if(!i){let t=e.headers["x-user-email"];if(t)try{let{db:e}=await (0,p.connectToDatabase)(),o=await e.collection("users").findOne({email:t});o&&"admin"===o.role&&(i=!0)}catch(e){}}if(!i)return t.status(401).json({success:!1,message:"관리자 권한이 필요합니다."});await (0,s.default)();let o=[...(await u.default.find().exec()).map(e=>{let t=0;return t="number"==typeof e.dailyViews?e.dailyViews:"number"==typeof e.dailyview?e.dailyview:"number"==typeof e.dailyView?e.dailyView:Math.round(.02*(e.views||0)),{_id:e._id,title:e.title,dailyViews:t,originalPosition:"number"==typeof e.position?e.position:99}})].sort((e,t)=>t.dailyViews-e.dailyViews);o.slice(0,3).forEach((e,t)=>{});let n=[];for(let e=0;e<o.length;e++){let t=o[e],i=e+1,r=t.originalPosition;try{let e=await u.default.findById(t._id);e&&(e.position=i,e.previousPosition=r,await e.save(),n.push({id:t._id.toString(),title:t.title,oldPosition:r,newPosition:i}))}catch(e){}}return t.status(200).json({success:!0,message:`${n.length}개 음악의 순위가 일일 조회수 기준으로 업데이트되었습니다.`,updates:n})}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다.",error:e.message})}}let y=(0,a.hoist)(o,"default"),h=(0,a.hoist)(o,"config"),f=new n.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/music/fix-positions",pathname:"/api/music/fix-positions",bundlePath:"",filename:""},userland:o})},86044:(e,t,i)=>{let o=i(99344),{connectToDatabase:n}=i(35968),{ObjectId:r}=i(38013),{parse:a}=i(84802),s=i(44756),u=i(81075),l="kstarpick_jwt_secret_key_2024_production";async function d(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=a(e.headers.cookie).token),!t)return null;try{let e=o.verify(t,l);try{await s();let t=await u.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await n(),i=await t.collection("users").findOne({_id:new r(e.id)});if(i)return{_id:i._id,id:i._id,name:i.name,email:i.email,isAdmin:"admin"===i.role,role:i.role}}catch(e){}return null}catch(e){return null}}async function c(e){try{let t=await d(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return o.sign(e,l,{expiresIn:"7d"})},verifyToken:d,isAdmin:c}},44756:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var o=i(11185),n=i.n(o);i(25142).config({path:".env.production"});let r="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";r||(r="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),r.includes("localhost")||(r.includes("mongodb://")&&!r.includes("authSource=")&&(r.includes("?")?r+="&authSource=admin":r+="?authSource=admin"),!r.includes("docdb.amazonaws.com")||r.includes("authMechanism=")||(r.includes("?")?r+="&authMechanism=SCRAM-SHA-1":r+="?authMechanism=SCRAM-SHA-1"));let a=r.includes("localhost")||r.includes("127.0.0.1"),s=global.mongoose;async function u(){if(s.conn&&1===n().connection.readyState)return s.conn;if(0===n().connection.readyState||3===n().connection.readyState){s.conn=null,s.promise=null;try{await n().connection.close()}catch(e){}}if(!s.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};a||(r.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),s.promise=n().connect(r,e).then(e=>(e.connection.on("error",e=>{s.conn=null,s.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{s.conn=null,s.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw s.promise=null,e})}try{return s.conn=await s.promise,s.conn}catch(e){throw s.promise=null,e}}s||(s=global.mongoose={conn:null,promise:null});let l=u},33151:(e,t,i)=>{i.r(t),i.d(t,{default:()=>u});var o=i(11185),n=i.n(o),r=i(73673),a=i.n(r);let s=new(n()).Schema({title:{type:String,required:[!0,"음악 제목을 입력해주세요."],trim:!0},slug:{type:String,unique:!0,index:!0},artist:{type:String,required:[!0,"아티스트 이름을 입력해주세요."],trim:!0},album:{type:String,trim:!0},releaseDate:{type:Date,required:[!0,"발매일을 입력해주세요."]},genre:{type:[String],required:[!0,"적어도 하나의 장르를 선택해주세요."],enum:["kpop","ballad","dance","hiphop","rnb","rock","indie","trot","ost"]},description:{type:String,trim:!0},lyrics:{type:String,trim:!0},coverImage:{type:String,required:[!0,"앨범 커버 이미지를 입력해주세요."]},audioUrl:{type:String},musicVideo:{type:String},position:{type:Number,default:99},previousPosition:{type:Number,default:99},featured:{type:Boolean,default:!1},likes:{type:Number,default:0},views:{type:Number,default:0},dailyViews:{type:Number,default:0},dailyview:{type:Number,default:0},dailyView:{type:Number,default:0},status:{type:String,enum:["active","inactive"],default:"active"}},{timestamps:!0});s.pre("save",function(e){(this.isModified("title")||!this.slug)&&(this.slug=a()(`${this.title}-${this.artist}`,{lower:!0,strict:!0,remove:/[*+~.()'"!:@]/g})),e()}),s.pre("save",function(e){void 0===this.position||null===this.position||isNaN(this.position)?this.position=99:"number"!=typeof this.position&&(this.position=parseInt(this.position)||99),void 0===this.previousPosition||null===this.previousPosition||isNaN(this.previousPosition)?this.previousPosition=this.position:"number"!=typeof this.previousPosition&&(this.previousPosition=parseInt(this.previousPosition)||this.position),e()}),s.set("toJSON",{transform:function(e,t){return void 0===t.position||null===t.position||isNaN(t.position)?t.position=99:"number"!=typeof t.position&&(t.position=parseInt(t.position)||99),void 0===t.previousPosition||null===t.previousPosition||isNaN(t.previousPosition)?t.previousPosition=t.position:"number"!=typeof t.previousPosition&&(t.previousPosition=parseInt(t.previousPosition)||t.position),t}});let u=n().models.Music||n().model("Music",s)},81075:(e,t,i)=>{i.r(t),i.d(t,{default:()=>a});var o=i(11185),n=i.n(o);let r=new(n()).Schema({name:{type:String,required:[!0,"Please provide a name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},image:{type:String,default:"/images/default-avatar.png"},role:{type:String,enum:["user","admin","editor"],default:"user"},likes:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},dislikes:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},bookmarks:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),a=n().models.User||n().model("User",r)},69097:(e,t,i)=>{i.r(t),i.d(t,{authOptions:()=>d,default:()=>c});var o=i(73227),n=i.n(o);let r=require("next-auth/providers/credentials");var a=i.n(r),s=i(35968),u=i(98432),l=i.n(u);let d={providers:[a()({name:"Credentials",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){try{let{db:t}=await (0,s.connectToDatabase)(),i=await t.collection("users").findOne({email:e.email});if(!i||!await l().compare(e.password,i.password))return null;return{id:i._id.toString(),name:i.name,email:i.email,role:i.role}}catch(e){return null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.id,e.user.role=t.role),e)},pages:{signIn:"/auth/signin",error:"/auth/error"},debug:!1,secret:"kstarpick_nextauth_secret_key_2024_production"},c=n()(d)},35968:(e,t,i)=>{let o;i.r(t),i.d(t,{connectToDatabase:()=>l,dbConnect:()=>d,default:()=>c});var n=i(38013),r=i(92048),a=i.n(r),s=i(55315),u=i.n(s);{let e=i(25142),t=u().resolve(process.cwd(),".env.production");a().existsSync(t)&&e.config({path:t}).error}async function l(){try{let e=await o,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}o=new n.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=l,c=o},47153:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},71802:(e,t,i)=>{e.exports=i(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=4815);module.exports=i})();