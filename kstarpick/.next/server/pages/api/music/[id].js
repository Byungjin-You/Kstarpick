"use strict";(()=>{var e={};e.id=7864,e.ids=[7864],e.modules={98432:e=>{e.exports=require("bcryptjs")},84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},73227:e=>{e.exports=require("next-auth")},62113:e=>{e.exports=require("next-auth/next")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},73673:e=>{e.exports=require("slugify")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},33823:(e,t,i)=>{i.r(t),i.d(t,{config:()=>c,default:()=>d,routeModule:()=>p});var s={};i.r(s),i.d(s,{default:()=>l});var n=i(71802),o=i(47153),r=i(56249);i(62113),i(69097);var a=i(33151);i(38013);var u=i(44756);async function l(e,t){let{query:{id:i},method:s}=e;switch(await (0,u.default)(),s){case"GET":try{let e=await a.default.findById(i);if(!e)return t.status(404).json({success:!1,message:"해당 음악을 찾을 수 없습니다."});return await a.default.findByIdAndUpdate(i,{$inc:{views:1}}),e.dailyViews,e.dailyview,e.dailyView,void 0===e.dailyViews&&void 0===e.dailyview&&void 0===e.dailyView?e.dailyViews=Math.round(.02*(e.views||0)):void 0===e.dailyViews&&(void 0!==e.dailyview?e.dailyViews=e.dailyview:void 0!==e.dailyView&&(e.dailyViews=e.dailyView)),t.status(200).json({success:!0,music:e})}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다."})}break;case"PUT":try{let s={...e.body};if(void 0!==s.dailyViews){let e=parseInt(s.dailyViews)||0;s.dailyViews=e,s.dailyview=e,s.dailyView=e}void 0!==s.views&&(s.views=parseInt(s.views)||0),void 0!==s.likes&&(s.likes=parseInt(s.likes)||0);let n=await a.default.findByIdAndUpdate(i,s,{new:!0,runValidators:!0});if(!n)return t.status(404).json({success:!1,message:"해당 음악을 찾을 수 없습니다."});return t.status(200).json({success:!0,message:"음악 정보가 업데이트되었습니다.",music:n})}catch(e){if("ValidationError"===e.name){let i=Object.values(e.errors).map(e=>e.message);return t.status(400).json({success:!1,message:i[0]})}return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다."})}break;case"DELETE":try{if(!await a.default.findByIdAndDelete(i))return t.status(404).json({success:!1,message:"해당 음악을 찾을 수 없습니다."});return t.status(200).json({success:!0,message:"음악이 삭제되었습니다."})}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다."})}break;case"PATCH":try{if("like"!==e.body.action)return t.status(400).json({success:!1,message:"지원되지 않는 작업입니다."});{let e=await a.default.findByIdAndUpdate(i,{$inc:{likes:1}},{new:!0});if(!e)return t.status(404).json({success:!1,message:"해당 음악을 찾을 수 없습니다."});return t.status(200).json({success:!0,message:"좋아요가 추가되었습니다.",likes:e.likes})}}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다."})}break;default:t.setHeader("Allow",["GET","PUT","DELETE","PATCH"]),t.status(405).json({success:!1,message:`Method ${s} Not Allowed`})}}i(86044);let d=(0,r.hoist)(s,"default"),c=(0,r.hoist)(s,"config"),p=new n.PagesAPIRouteModule({definition:{kind:o.RouteKind.PAGES_API,page:"/api/music/[id]",pathname:"/api/music/[id]",bundlePath:"",filename:""},userland:s})},86044:(e,t,i)=>{let s=i(99344),{connectToDatabase:n}=i(35968),{ObjectId:o}=i(38013),{parse:r}=i(84802),a=i(44756),u=i(81075),l="kstarpick_jwt_secret_key_2024_production";async function d(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=r(e.headers.cookie).token),!t)return null;try{let e=s.verify(t,l);try{await a();let t=await u.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await n(),i=await t.collection("users").findOne({_id:new o(e.id)});if(i)return{_id:i._id,id:i._id,name:i.name,email:i.email,isAdmin:"admin"===i.role,role:i.role}}catch(e){}return null}catch(e){return null}}async function c(e){try{let t=await d(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return s.sign(e,l,{expiresIn:"7d"})},verifyToken:d,isAdmin:c}},44756:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var s=i(11185),n=i.n(s);i(25142).config({path:".env.production"});let o="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";o||(o="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),o.includes("localhost")||(o.includes("mongodb://")&&!o.includes("authSource=")&&(o.includes("?")?o+="&authSource=admin":o+="?authSource=admin"),!o.includes("docdb.amazonaws.com")||o.includes("authMechanism=")||(o.includes("?")?o+="&authMechanism=SCRAM-SHA-1":o+="?authMechanism=SCRAM-SHA-1"));let r=o.includes("localhost")||o.includes("127.0.0.1"),a=global.mongoose;async function u(){if(a.conn&&1===n().connection.readyState)return a.conn;if(0===n().connection.readyState||3===n().connection.readyState){a.conn=null,a.promise=null;try{await n().connection.close()}catch(e){}}if(!a.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};r||(o.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),a.promise=n().connect(o,e).then(e=>(e.connection.on("error",e=>{a.conn=null,a.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{a.conn=null,a.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw a.promise=null,e})}try{return a.conn=await a.promise,a.conn}catch(e){throw a.promise=null,e}}a||(a=global.mongoose={conn:null,promise:null});let l=u},33151:(e,t,i)=>{i.r(t),i.d(t,{default:()=>u});var s=i(11185),n=i.n(s),o=i(73673),r=i.n(o);let a=new(n()).Schema({title:{type:String,required:[!0,"음악 제목을 입력해주세요."],trim:!0},slug:{type:String,unique:!0,index:!0},artist:{type:String,required:[!0,"아티스트 이름을 입력해주세요."],trim:!0},album:{type:String,trim:!0},releaseDate:{type:Date,required:[!0,"발매일을 입력해주세요."]},genre:{type:[String],required:[!0,"적어도 하나의 장르를 선택해주세요."],enum:["kpop","ballad","dance","hiphop","rnb","rock","indie","trot","ost"]},description:{type:String,trim:!0},lyrics:{type:String,trim:!0},coverImage:{type:String,required:[!0,"앨범 커버 이미지를 입력해주세요."]},audioUrl:{type:String},musicVideo:{type:String},position:{type:Number,default:99},previousPosition:{type:Number,default:99},featured:{type:Boolean,default:!1},likes:{type:Number,default:0},views:{type:Number,default:0},dailyViews:{type:Number,default:0},dailyview:{type:Number,default:0},dailyView:{type:Number,default:0},status:{type:String,enum:["active","inactive"],default:"active"}},{timestamps:!0});a.pre("save",function(e){(this.isModified("title")||!this.slug)&&(this.slug=r()(`${this.title}-${this.artist}`,{lower:!0,strict:!0,remove:/[*+~.()'"!:@]/g})),e()}),a.pre("save",function(e){void 0===this.position||null===this.position||isNaN(this.position)?this.position=99:"number"!=typeof this.position&&(this.position=parseInt(this.position)||99),void 0===this.previousPosition||null===this.previousPosition||isNaN(this.previousPosition)?this.previousPosition=this.position:"number"!=typeof this.previousPosition&&(this.previousPosition=parseInt(this.previousPosition)||this.position),e()}),a.set("toJSON",{transform:function(e,t){return void 0===t.position||null===t.position||isNaN(t.position)?t.position=99:"number"!=typeof t.position&&(t.position=parseInt(t.position)||99),void 0===t.previousPosition||null===t.previousPosition||isNaN(t.previousPosition)?t.previousPosition=t.position:"number"!=typeof t.previousPosition&&(t.previousPosition=parseInt(t.previousPosition)||t.position),t}});let u=n().models.Music||n().model("Music",a)},81075:(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});var s=i(11185),n=i.n(s);let o=new(n()).Schema({name:{type:String,required:[!0,"Please provide a name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},image:{type:String,default:"/images/default-avatar.png"},role:{type:String,enum:["user","admin","editor"],default:"user"},likes:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},dislikes:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},bookmarks:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),r=n().models.User||n().model("User",o)},69097:(e,t,i)=>{i.r(t),i.d(t,{authOptions:()=>d,default:()=>c});var s=i(73227),n=i.n(s);let o=require("next-auth/providers/credentials");var r=i.n(o),a=i(35968),u=i(98432),l=i.n(u);let d={providers:[r()({name:"Credentials",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){try{let{db:t}=await (0,a.connectToDatabase)(),i=await t.collection("users").findOne({email:e.email});if(!i||!await l().compare(e.password,i.password))return null;return{id:i._id.toString(),name:i.name,email:i.email,role:i.role}}catch(e){return null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.id,e.user.role=t.role),e)},pages:{signIn:"/auth/signin",error:"/auth/error"},debug:!1,secret:"kstarpick_nextauth_secret_key_2024_production"},c=n()(d)},35968:(e,t,i)=>{let s;i.r(t),i.d(t,{connectToDatabase:()=>l,dbConnect:()=>d,default:()=>c});var n=i(38013),o=i(92048),r=i.n(o),a=i(55315),u=i.n(a);{let e=i(25142),t=u().resolve(process.cwd(),".env.production");r().existsSync(t)&&e.config({path:t}).error}async function l(){try{let e=await s,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}s=new n.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=l,c=s},47153:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},71802:(e,t,i)=>{e.exports=i(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=33823);module.exports=i})();