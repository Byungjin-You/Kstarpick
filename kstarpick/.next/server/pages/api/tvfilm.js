"use strict";(()=>{var e={};e.id=104,e.ids=[104],e.modules={84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},60614:e=>{e.exports=require("next-auth/jwt")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},73673:e=>{e.exports=require("slugify")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},17360:e=>{e.exports=require("url")},36705:e=>{e.exports=import("formidable")},46555:e=>{e.exports=import("uuid")},14263:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>u,routeModule:()=>d});var s=r(71802),i=r(47153),n=r(56249),o=r(59617),c=e([o]);o=(c.then?(await c)():c)[0];let u=(0,n.hoist)(o,"default"),l=(0,n.hoist)(o,"config"),d=new s.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/tvfilm",pathname:"/api/tvfilm",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},86044:(e,t,r)=>{let a=r(99344),{connectToDatabase:s}=r(35968),{ObjectId:i}=r(38013),{parse:n}=r(84802),o=r(44756),c=r(81075),u="kstarpick_jwt_secret_key_2024_production";async function l(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=n(e.headers.cookie).token),!t)return null;try{let e=a.verify(t,u);try{await o();let t=await c.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await s(),r=await t.collection("users").findOne({_id:new i(e.id)});if(r)return{_id:r._id,id:r._id,name:r.name,email:r.email,isAdmin:"admin"===r.role,role:r.role}}catch(e){}return null}catch(e){return null}}async function d(e){try{let t=await l(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return a.sign(e,u,{expiresIn:"7d"})},verifyToken:l,isAdmin:d}},69176:(e,t,r)=>{r.r(t),r.d(t,{default:()=>n});var a=r(11185),s=r.n(a);let i=new(s()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),n=s().models.Review||s().model("Review",i)},59617:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>x,default:()=>k}),r(35968),r(86044);var s=r(12277);r(38013);var i=r(36705),n=r(55315),o=r.n(n),c=r(92048),u=r.n(c),l=r(46555),d=r(17360);r(84802);var m=r(99344),g=r.n(m),p=r(74053),f=r(44756),y=r(73673),v=r.n(y);r(41649),r(11185);var w=r(69176),h=e([i,l]);[i,l]=h.then?(await h)():h;let x={api:{bodyParser:{sizeLimit:"10mb"}}},A=(0,d.fileURLToPath)("file:///Users/byungjinyou/Desktop/kstarpick-server-backup/kstarpick/pages/api/tvfilm/index.js");(0,n.dirname)(A);let I=o().join(process.cwd(),"public","uploads");async function k(e,t){if("true"!==e.headers["x-internal-ssr"])try{let r=e.headers.authorization?.replace("Bearer ","");if(!r)return t.status(401).json({success:!1,message:"인증 토큰이 필요합니다."});if(!g().verify(r,"kstarpick_jwt_secret_key_2024_production").isAdmin)return t.status(403).json({success:!1,message:"관리자 권한이 필요합니다."})}catch(e){return t.status(401).json({success:!1,message:"유효하지 않은 토큰입니다."})}let{method:r}=e;await (0,f.default)();try{switch(r){case"GET":await S(e,t);break;case"POST":await b(e,t);break;case"DELETE":await j(e,t);break;default:t.setHeader("Allow",["GET","POST","DELETE"]),t.status(405).end(`Method ${r} Not Allowed`)}}catch(e){t.status(500).json({success:!1,message:e.message||"Server Error"})}}async function S(e,t){try{let{page:r=1,limit:a=10,search:s="",category:i="",sort:n="createdAt",order:o="desc"}=e.query,c=parseInt(r,10),u=parseInt(a,10),l=(c-1)*u,d={};s&&(d.$or=[{title:{$regex:s,$options:"i"}},{summary:{$regex:s,$options:"i"}},{network:{$regex:s,$options:"i"}}]),"k-drama"===i&&e.headers.referer&&e.headers.referer.includes("/admin/")?d.category="k-drama":i&&"k-drama"!==i?d.category=i:d.category={$ne:"k-drama"},await p.default.aggregate([{$group:{_id:"$category",count:{$sum:1}}}]),"k-drama"===i&&e.headers.referer&&e.headers.referer.includes("/admin/")&&await p.default.find({category:"k-drama"}).limit(3).lean();let m=["createdAt","title","rating","reviewRating","reviewCount","views"].includes(n)?n:"createdAt",g={};g[m]="asc"===o?1:-1;let f=await p.default.find(d).sort(g).skip(l).limit(u).populate("author","name email"),y=await p.default.countDocuments(d),v=await Promise.all(f.map(async e=>{let t=e.toObject();t.coverImage||(t.coverImage="/images/placeholder-tvfilm.svg"),t.bannerImage||(t.bannerImage="/images/placeholder-tvfilm.svg"),t.coverImage&&(t.coverImage.startsWith("http://")||t.coverImage.startsWith("https://"));try{let r=await w.default.findOne({tvfilm:e._id,featured:!0}).populate("author","name image");if(r)t.reviews=[r];else{let r=await w.default.find({tvfilm:e._id}).populate("author","name image").sort({createdAt:-1}).limit(1);t.reviews=r}}catch(e){t.reviews=[]}return t}));t.status(200).json({success:!0,data:v,pagination:{total:y,page:c,limit:u,pages:Math.ceil(y/u)}})}catch(e){t.status(500).json({success:!1,message:e.message})}}async function b(e,t){try{let r=await (0,s.validateToken)(e);if(!r)return t.status(401).json({success:!1,message:"Unauthorized"});if("admin"!==r.role)return t.status(403).json({success:!1,message:"Forbidden: Admin access required"});let a=e.headers["content-type"]||"",n={};if(a.includes("application/json"))n=e.body;else{if(!a.includes("multipart/form-data"))return t.status(400).json({success:!1,message:"Unsupported content type"});let r=(0,i.formidable)({uploadDir:I,keepExtensions:!0,maxFileSize:10485760});try{let[t,a]=await r.parse(e),s={};Object.keys(t).forEach(e=>{s[e]=t[e][0]}),n={...s};try{n.tags&&(n.tags=JSON.parse(n.tags)),n.genres&&(n.genres=JSON.parse(n.genres)),n.cast&&(n.cast=JSON.parse(n.cast)),n.watchProviders&&(n.watchProviders=JSON.parse(n.watchProviders)),n.videos&&(n.videos=JSON.parse(n.videos)),n.reviews&&(n.reviews=JSON.parse(n.reviews))}catch(e){}if(a.coverImage){let e=a.coverImage[0],t=o().join(I,e.newFilename);u().copyFileSync(e.filepath,t),n.coverImage=`/uploads/${e.newFilename}`}if(a.bannerImage){let e=a.bannerImage[0],t=o().join(I,e.newFilename);u().copyFileSync(e.filepath,t),n.bannerImage=`/uploads/${e.newFilename}`}}catch(e){return t.status(400).json({success:!1,message:"Failed to parse form data"})}}if(!n.title)return t.status(400).json({success:!1,message:"Title is required"});if(!n.summary)return t.status(400).json({success:!1,message:"Summary is required"});if(!n.category)return t.status(400).json({success:!1,message:"Category is required"});n.coverImage||n.coverImage?.startsWith("/")||(n.coverImage="/images/placeholder-tvfilm.svg");let c=n.slug;if(!c)try{c=v()(n.title,{lower:!0,strict:!0})}catch(e){}if(!c||""===c.trim()){let e=(0,l.v4)().substring(0,8);c=`tvfilm-${e}`}let d=c,m=1,g=await p.default.findOne({slug:d});for(;g;)d=`${c}-${m}`,m++,g=await p.default.findOne({slug:d});let f={...n,slug:d,author:r._id?.toString(),content:n.content||n.summary||"",lang:n.lang||"ko",status:n.status||"ongoing",createdAt:new Date,updatedAt:new Date,reviewRating:parseFloat(n.reviewRating)||0,reviewCount:parseInt(n.reviewCount)||0,ratingDistribution:n.ratingDistribution||[0,0,0,0,0,0,0,0,0,0],views:0,likes:0};f.tags=Array.isArray(f.tags)?f.tags:[],f.genres=Array.isArray(f.genres)?f.genres:[],f.cast=Array.isArray(f.cast)?f.cast:[],f.watchProviders=Array.isArray(f.watchProviders)?f.watchProviders:[],f.videos=Array.isArray(f.videos)?f.videos:[],f.reviews=Array.isArray(f.reviews)?f.reviews:[];let y=new p.default(f),w=y.validateSync();if(w)return t.status(400).json({success:!1,message:`Validation failed: ${w.message}`,errors:w.errors});return await y.save(),t.status(201).json({success:!0,data:y,message:"TV/Film created successfully"})}catch(e){return t.status(500).json({success:!1,message:e.message||"Server error occurred"})}}async function j(e,t){try{let{id:r}=e.query;if(!r)return t.status(400).json({success:!1,message:"ID parameter is required"});let a=await p.default.findById(r);if(!a)return t.status(404).json({success:!1,message:"TV/Film not found"});if(await p.default.findByIdAndDelete(r),a.coverImage&&a.coverImage.startsWith("/uploads/")){let e=o().join(process.cwd(),"public",a.coverImage);try{u().existsSync(e)&&u().unlinkSync(e)}catch(e){}}t.status(200).json({success:!0,message:"TV/Film deleted successfully"})}catch(e){t.status(500).json({success:!1,message:e.message})}}u().existsSync(I)||u().mkdirSync(I,{recursive:!0}),a()}catch(e){a(e)}})},35968:(e,t,r)=>{let a;r.r(t),r.d(t,{connectToDatabase:()=>u,dbConnect:()=>l,default:()=>d});var s=r(38013),i=r(92048),n=r.n(i),o=r(55315),c=r.n(o);{let e=r(25142),t=c().resolve(process.cwd(),".env.production");n().existsSync(t)&&e.config({path:t}).error}async function u(){try{let e=await a,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}a=new s.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=u,d=a}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9778],()=>r(14263));module.exports=a})();