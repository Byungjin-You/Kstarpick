"use strict";(()=>{var e={};e.id=6370,e.ids=[6370],e.modules={25142:e=>{e.exports=require("dotenv")},11185:e=>{e.exports=require("mongoose")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},63864:(e,t,r)=>{r.r(t),r.d(t,{config:()=>g,default:()=>p,routeModule:()=>f});var a={};r.r(a),r.d(a,{default:()=>m});var n=r(71802),i=r(47153),s=r(56249),o=r(44756),u=r(74053),d=r(69176),l=r(11185),c=r.n(l);async function m(e,t){if("POST"!==e.method)return t.setHeader("Allow",["POST"]),t.status(405).json({success:!1,message:`Method ${e.method} Not Allowed`});try{let{tvfilmId:r,dramaId:a,reviews:n}=e.body;if(!r&&!a)return t.status(400).json({success:!1,message:"TVFilm ID or Drama ID is required"});let i=r||a;if(!n||!Array.isArray(n))return t.status(400).json({success:!1,message:"Reviews must be an array",receivedType:typeof n});await (0,o.default)();try{if(!await u.default.findById(i))return t.status(404).json({success:!1,message:"TVFilm not found"})}catch(e){return t.status(500).json({success:!1,message:`Error finding TVFilm: ${e.message}`})}let s={added:0,updated:0,deleted:0,errors:0,errorMessages:[]};try{let e=await d.default.find({tvfilm:i}),t=new Map;e.forEach(e=>{t.set(e._id.toString(),e)});let r=new Set,a=(e,t)=>{let r=[];e.title&&"string"==typeof e.title&&""!==e.title.trim()||r.push(`리뷰 #${t+1}: 제목이 없거나 유효하지 않습니다`),e.content&&"string"==typeof e.content&&""!==e.content.trim()||r.push(`리뷰 #${t+1}: 내용이 없거나 유효하지 않습니다`),e.authorName&&"string"==typeof e.authorName&&""!==e.authorName.trim()||r.push(`리뷰 #${t+1}: 작성자 이름이 없거나 유효하지 않습니다`);let a=parseInt(e.rating,10);return(isNaN(a)||a<1||a>10)&&r.push(`리뷰 #${t+1}: 별점이 유효하지 않습니다 (1-10 사이 숫자여야 함)`),e.tags&&!Array.isArray(e.tags)&&r.push(`리뷰 #${t+1}: 태그가 배열 형식이 아닙니다`),r};for(let e=0;e<n.length;e+=20){let o=n.slice(e,e+20).map(async(n,o)=>{try{let u=e+o,l=a(n,u);if(l.length>0)return l.forEach(e=>{s.errorMessages.push(e)}),s.errors++,null;let m=!n._id||n._id.startsWith("temp_"),p=parseInt(n.rating,10);if(m){let e=new d.default({tvfilm:i,author:new(c()).Types.ObjectId("000000000000000000000000"),authorName:n.authorName,rating:p,title:n.title,content:n.content,tags:Array.isArray(n.tags)?n.tags:[],isCritic:!1,spoiler:!1,featured:!0===n.featured||"true"===n.featured,approved:!0,createdAt:new Date(n.date||n.createdAt||Date.now()),updatedAt:new Date});!0===n.featured||n.featured;try{let t=await e.save();return r.add(t._id.toString()),s.added++,t}catch(e){return s.errors++,s.errorMessages.push(`리뷰 #${u+1} 저장 실패: ${e.message}`),null}}else{let e=n._id;if(t.has(e))try{let t=await d.default.findByIdAndUpdate(e,{authorName:n.authorName,rating:p,title:n.title,content:n.content,tags:Array.isArray(n.tags)?n.tags:[],featured:!0===n.featured||"true"===n.featured,updatedAt:new Date},{new:!0});return!0===n.featured||n.featured,r.add(e),s.updated++,t}catch(t){return s.errors++,s.errorMessages.push(`리뷰 #${u+1} (ID: ${e}) 업데이트 실패: ${t.message}`),null}else try{let e=new d.default({tvfilm:i,author:new(c()).Types.ObjectId("000000000000000000000000"),authorName:n.authorName,rating:p,title:n.title,content:n.content,tags:Array.isArray(n.tags)?n.tags:[],isCritic:!1,spoiler:!1,featured:!0===n.featured||"true"===n.featured,approved:!0,createdAt:new Date(n.date||n.createdAt||Date.now()),updatedAt:new Date});!0===n.featured||n.featured;let t=await e.save();return r.add(t._id.toString()),s.added++,t}catch(t){return s.errors++,s.errorMessages.push(`리뷰 #${u+1} (ID: ${e}) 존재하지 않아 새로 저장 시도 중 실패: ${t.message}`),null}}}catch(t){return s.errors++,s.errorMessages.push(`리뷰 #${e+o+1} 처리 중 예상치 못한 오류: ${t.message}`),null}});await Promise.all(o)}let o=[...t.keys()].filter(e=>!r.has(e));if(o.length>0){let e=await d.default.deleteMany({_id:{$in:o.map(e=>new(c()).Types.ObjectId(e))}});s.deleted=e.deletedCount}let l=await d.default.find({tvfilm:i}),m=l.length,p=0,g=[0,0,0,0,0,0,0,0,0,0];if(m>0){let e=l.reduce((e,t)=>{let r=parseInt(t.rating,10);return e+(isNaN(r)?0:r)},0);p=parseFloat((e/m).toFixed(1)),l.forEach(e=>{let t=parseInt(e.rating,10);!isNaN(t)&&t>=1&&t<=10&&g[Math.min(Math.max(Math.floor(t)-1,0),9)]++})}await u.default.findByIdAndUpdate(i,{reviewCount:m,reviewRating:p,ratingDistribution:g})}catch(e){throw e}return t.status(200).json({success:!0,message:"리뷰 처리 완료",data:{processed:n.length,added:s.added,updated:s.updated,deleted:s.deleted,errors:s.errors,errorDetails:s.errorMessages.length>0?s.errorMessages:void 0}})}catch(e){return t.status(500).json({success:!1,message:e.message||"Error synchronizing reviews"})}}r(41649);let p=(0,s.hoist)(a,"default"),g=(0,s.hoist)(a,"config"),f=new n.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/tvfilm/admin/reviews",pathname:"/api/tvfilm/admin/reviews",bundlePath:"",filename:""},userland:a})},44756:(e,t,r)=>{r.r(t),r.d(t,{default:()=>d});var a=r(11185),n=r.n(a);r(25142).config({path:".env.production"});let i="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";i||(i="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),i.includes("localhost")||(i.includes("mongodb://")&&!i.includes("authSource=")&&(i.includes("?")?i+="&authSource=admin":i+="?authSource=admin"),!i.includes("docdb.amazonaws.com")||i.includes("authMechanism=")||(i.includes("?")?i+="&authMechanism=SCRAM-SHA-1":i+="?authMechanism=SCRAM-SHA-1"));let s=i.includes("localhost")||i.includes("127.0.0.1"),o=global.mongoose;async function u(){if(o.conn&&1===n().connection.readyState)return o.conn;if(0===n().connection.readyState||3===n().connection.readyState){o.conn=null,o.promise=null;try{await n().connection.close()}catch(e){}}if(!o.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};s||(i.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),o.promise=n().connect(i,e).then(e=>(e.connection.on("error",e=>{o.conn=null,o.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{o.conn=null,o.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw o.promise=null,e})}try{return o.conn=await o.promise,o.conn}catch(e){throw o.promise=null,e}}o||(o=global.mongoose={conn:null,promise:null});let d=u},69176:(e,t,r)=>{r.r(t),r.d(t,{default:()=>s});var a=r(11185),n=r.n(a);let i=new(n()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),s=n().models.Review||n().model("Review",i)},74053:(e,t,r)=>{r.r(t),r.d(t,{default:()=>s});var a=r(11185),n=r.n(a);let i=new(n()).Schema({title:{type:String,required:[!0,"Please provide a title for this TV/Film"],maxlength:[200,"Title cannot be more than 200 characters"]},originalTitle:{type:String,required:!1},slug:{type:String,required:!0,unique:!0},content:{type:String,required:[!0,"Please provide content for this TV/Film"]},summary:{type:String,required:[!0,"Please provide a summary for this TV/Film"],maxlength:[1e3,"Summary cannot be more than 1000 characters"]},coverImage:{type:String,required:[!0,"Please provide a cover image for this TV/Film"]},bannerImage:{type:String,required:!1,default:""},trailerUrl:{type:String,required:!1,default:""},category:{type:String,required:[!0,"Please select a category for this TV/Film"],enum:["drama","movie","variety","documentary","other"]},status:{type:String,required:[!0,"Please select a status for this TV/Film"],enum:["ongoing","completed","upcoming","canceled"],default:"ongoing"},network:{type:String,required:!1},releaseDate:{type:Date,required:[!0,"Please provide a release date for this TV/Film"]},rating:{type:Number,required:!1,min:[0,"Rating cannot be less than 0"],max:[10,"Rating cannot be more than 10"],default:0},reviewRating:{type:Number,min:[0,"Review rating cannot be less than 0"],max:[10,"Review rating cannot be more than 10"],default:0},reviewCount:{type:Number,default:0},ratingDistribution:{type:[Number],default:[0,0,0,0,0,0,0,0,0,0],validate:{validator:function(e){return 10===e.length},message:"Rating distribution must have exactly 10 values"}},runtime:{type:String,required:!1},ageRating:{type:String,required:!1,enum:["ALL","12","15","18","R"]},director:{type:String,required:!1},country:{type:String,required:!1},tags:{type:[String],default:[]},genres:{type:[String],default:[]},cast:{type:[{name:{type:String,required:!0},role:{type:String},image:{type:String},order:{type:Number,default:0}}],default:[]},watchProviders:{type:[{name:{type:String,required:!0},logo:{type:String},type:{type:String,enum:["subscription","rental","purchase","free"],required:!0},price:{type:String},quality:[String],url:{type:String},order:{type:Number,default:0}}],default:[]},videos:{type:[{title:{type:String},type:{type:String,enum:["trailer","teaser","ad","making-of","clip","interview","other"],required:!0},url:{type:String,required:!0},order:{type:Number,default:0}}],default:[]},author:{type:n().Schema.Types.ObjectId,ref:"User",required:!0},featured:{type:Boolean,default:!1},orderNumber:{type:Number,default:0,index:!0},lang:{type:String,required:!0,enum:["en","ko","ja","zh","es"],default:"en"},translationOf:{type:n().Schema.Types.ObjectId,ref:"TVFilm",default:null},views:{type:Number,default:0},likes:{type:Number,default:0},dislikes:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),s=n().models.TVFilm||n().model("TVFilm",i)},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=63864);module.exports=r})();