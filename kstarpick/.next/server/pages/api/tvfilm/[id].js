"use strict";(()=>{var e={};e.id=4183,e.ids=[4183],e.modules={84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},60614:e=>{e.exports=require("next-auth/jwt")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},73673:e=>{e.exports=require("slugify")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},17360:e=>{e.exports=require("url")},36705:e=>{e.exports=import("formidable")},46817:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>c,routeModule:()=>u});var i=a(71802),s=a(47153),o=a(56249),n=a(75331),l=e([n]);n=(l.then?(await l)():l)[0];let c=(0,o.hoist)(n,"default"),d=(0,o.hoist)(n,"config"),u=new i.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/tvfilm/[id]",pathname:"/api/tvfilm/[id]",bundlePath:"",filename:""},userland:n});r()}catch(e){r(e)}})},86044:(e,t,a)=>{let r=a(99344),{connectToDatabase:i}=a(35968),{ObjectId:s}=a(38013),{parse:o}=a(84802),n=a(44756),l=a(81075),c="kstarpick_jwt_secret_key_2024_production";async function d(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=o(e.headers.cookie).token),!t)return null;try{let e=r.verify(t,c);try{await n();let t=await l.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await i(),a=await t.collection("users").findOne({_id:new s(e.id)});if(a)return{_id:a._id,id:a._id,name:a.name,email:a.email,isAdmin:"admin"===a.role,role:a.role}}catch(e){}return null}catch(e){return null}}async function u(e){try{let t=await d(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return r.sign(e,c,{expiresIn:"7d"})},verifyToken:d,isAdmin:u}},69176:(e,t,a)=>{a.r(t),a.d(t,{default:()=>o});var r=a(11185),i=a.n(r);let s=new(i()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),o=i().models.Review||i().model("Review",s)},75331:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>j,default:()=>I});var i=a(36705),s=a(92048),o=a.n(s),n=a(55315),l=a.n(n);a(99344),a(35968),a(84802);var c=a(44756),d=a(74053);a(86044);var u=a(12277),m=a(17360);a(81075);var g=a(73673),p=a.n(g);a(41649),a(38013);var w=a(11185),h=a.n(w),v=a(69176),y=e([i]);i=(y.then?(await y)():y)[0];let x=l().join(process.cwd(),"public","uploads");function f(e,t){let a={updatedAt:new Date};return e.title&&(a.title=e.title),e.originalTitle&&(a.originalTitle=e.originalTitle),e.category&&(a.category=e.category.toLowerCase()),e.summary&&(a.summary=e.summary),e.content&&(a.content=e.content),e.network&&(a.network=e.network),e.status&&(a.status=e.status.toLowerCase()),e.releaseDate&&(a.releaseDate=new Date(e.releaseDate)),e.rating&&(a.rating=parseFloat(e.rating)),e.runtime&&(a.runtime=e.runtime),e.ageRating&&(a.ageRating=e.ageRating),e.director&&(a.director=e.director),e.country&&(a.country=e.country),e.trailerUrl&&(a.trailerUrl=e.trailerUrl),e.coverImage&&(a.coverImage=e.coverImage),e.bannerImage&&(a.bannerImage=e.bannerImage),void 0!==e.orderNumber&&(a.orderNumber=parseInt(e.orderNumber)),void 0!==e.previousOrderNumber&&(a.previousOrderNumber=parseInt(e.previousOrderNumber)),a.title&&a.title!==t.title&&(a.slug=p()(a.title,{lower:!0}),a.slug&&""!==a.slug.trim()||(a.slug=a.title.toLowerCase().replace(/\s+/g,"-"))),e.tags&&(a.tags=Array.isArray(e.tags)?e.tags:[]),e.genres&&(a.genres=Array.isArray(e.genres)?e.genres:[]),e.cast&&(a.cast=Array.isArray(e.cast)?e.cast:[]),e.watchProviders&&(a.watchProviders=Array.isArray(e.watchProviders)?e.watchProviders:[]),e.videos&&(a.videos=Array.isArray(e.videos)?e.videos:[]),e.reviewRating&&(a.reviewRating=parseFloat(e.reviewRating)),e.reviewCount&&(a.reviewCount=parseInt(e.reviewCount,10)),e.ratingDistribution&&(a.ratingDistribution=Array.isArray(e.ratingDistribution)?e.ratingDistribution:[0,0,0,0,0,0,0,0,0,0]),a}let j={api:{bodyParser:{sizeLimit:"20mb"}}},T=(0,m.fileURLToPath)("file:///Users/byungjinyou/Desktop/kstarpick-server-backup/kstarpick/pages/api/tvfilm/%5Bid%5D.js");async function I(e,t){let{method:a}=e,{id:r}=e.query;await (0,c.default)();try{switch(a){case"GET":await b(e,t);break;case"PUT":await k(e,t);break;case"DELETE":await A(e,t);break;default:t.setHeader("Allow",["GET","PUT","DELETE"]),t.status(405).end(`Method ${a} Not Allowed`)}}catch(e){t.status(500).json({success:!1,message:e.message||"Server Error"})}}async function b(e,t){try{let a;let{id:r}=e.query,{view:i=!1}=e.query;if(!r)return t.status(400).json({success:!1,message:"ID is required"});if(h().Types.ObjectId.isValid(r)&&(a=await d.default.findById(r).populate("author","name email")),a||(a=await d.default.findOne({slug:r}).populate("author","name email")),a||(a=await d.default.findOne({slug:{$regex:RegExp(r,"i")}}).populate("author","name email")),a||(a=await d.default.findOne({title:r}).populate("author","name email")),!a&&((a=await d.default.findOne({title:{$regex:RegExp(r,"i")}}).populate("author","name email"))||(a=await d.default.findOne({originalTitle:{$regex:RegExp(r,"i")}}).populate("author","name email"))||(await d.default.find({},"_id title originalTitle slug").limit(10)).forEach(e=>{})),!a)return t.status(404).json({success:!1,message:"TV/Film not found",detail:`No TV/Film found with identifier: ${r}`,searchAttempts:["ObjectId lookup","Exact slug match","Partial slug match","Exact title match","Partial title match","Partial originalTitle match"]});let s=await v.default.find({tvfilm:a._id}).populate("author","name image").sort({createdAt:-1}),o=a.toObject();for(let e of(o.reviews=s,o.coverImage&&o.coverImage.includes("justwatch.com")?o.coverImage.startsWith("http://")&&(o.coverImage=o.coverImage.replace("http://","https://")):o.coverImage||(o.coverImage="/images/placeholder-tvfilm.jpg"),o.bannerImage&&o.bannerImage.includes("justwatch.com")?o.bannerImage.startsWith("http://")&&(o.bannerImage=o.bannerImage.replace("http://","https://")):o.bannerImage||(o.bannerImage=o.coverImage||"/images/placeholder-tvfilm.jpg"),["title","category","summary","content","coverImage","bannerImage","cast","watchProviders","videos","reviews","tags","genres"]))void 0===o[e]?"cast"===e||"watchProviders"===e||"videos"===e||"reviews"===e||"tags"===e||"genres"===e?o[e]=[]:o[e]="":Array.isArray(o[e]);Array.isArray(o.watchProviders)&&0!==o.watchProviders.length?o.watchProviders=o.watchProviders.map(e=>{if(!e.logo){let t="/images/placeholder-image.jpg";if(e.name.toLowerCase().includes("netflix"))t="https://upload.wikimedia.org/wikipedia/commons/7/7a/Logonetflix.png";else if(e.name.toLowerCase().includes("disney"))t="https://upload.wikimedia.org/wikipedia/commons/3/3e/Disney%2B_logo.svg";else if(e.name.toLowerCase().includes("tving"))t="https://upload.wikimedia.org/wikipedia/commons/9/95/TVING_logo.png";else if(e.name.toLowerCase().includes("wavve"))t="https://upload.wikimedia.org/wikipedia/commons/8/8c/Wavve_logo.png";else if(e.name.toLowerCase().includes("watcha"))t="https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/Watcha_logo.png/800px-Watcha_logo.png";else if(e.name.toLowerCase().includes("apple"))t="https://upload.wikimedia.org/wikipedia/commons/3/39/Apple_TV.svg";else{let a=e.url||"";t=`https://www.google.com/s2/favicons?domain=${encodeURIComponent(a)}&sz=128`}return{...e,logo:t}}return e}):o.watchProviders=[{name:"Netflix",logo:"https://upload.wikimedia.org/wikipedia/commons/7/7a/Logonetflix.png",type:"subscription",price:"13,500원/월",quality:["HD","4K","HDR"],url:"https://www.netflix.com",order:1},{name:"Disney+",logo:"https://upload.wikimedia.org/wikipedia/commons/3/3e/Disney%2B_logo.svg",type:"subscription",price:"9,900원/월",quality:["HD","4K"],url:"https://www.disneyplus.com",order:2},{name:"TVING",logo:"https://upload.wikimedia.org/wikipedia/commons/9/95/TVING_logo.png",type:"subscription",price:"7,900원/월",quality:["HD"],url:"https://www.tving.com",order:3}],Array.isArray(o.videos)&&0!==o.videos.length||(o.videos=[{title:"공식 예고편",type:"trailer",url:o.trailerUrl||"https://www.youtube.com/watch?v=dQw4w9WgXcQ",order:1}]),("true"===i||!0===i)&&(await d.default.findByIdAndUpdate(r,{$inc:{views:1}}),o.views+=1);let n={title:o.title||"",originalTitle:o.originalTitle||"",category:o.category||"",summary:o.summary||"",content:o.content||o.summary||"",coverImage:o.coverImage||"/images/placeholder-tvfilm.jpg",bannerImage:o.bannerImage||o.coverImage||"/images/placeholder-tvfilm.jpg",releaseDate:o.releaseDate||null,rating:o.rating||0,runtime:o.runtime||"",ageRating:o.ageRating||"",director:o.director||"",country:o.country||"",network:o.network||"",status:o.status||"Ongoing",trailerUrl:o.trailerUrl||"",cast:Array.isArray(o.cast)?o.cast:[],watchProviders:Array.isArray(o.watchProviders)?o.watchProviders:[],videos:Array.isArray(o.videos)?o.videos:[],tags:Array.isArray(o.tags)?o.tags:[],genres:Array.isArray(o.genres)?o.genres:[],reviews:Array.isArray(o.reviews)?o.reviews:[],reviewRating:o.reviewRating||0,reviewCount:o.reviewCount||0,ratingDistribution:Array.isArray(o.ratingDistribution)?o.ratingDistribution:[0,0,0,0,0,0,0,0,0,0],_id:o._id,id:o._id};t.status(200).json({success:!0,data:n})}catch(e){t.status(500).json({success:!1,message:e.message})}}async function k(e,t){try{let a=await (0,u.validateToken)(e);if(!a)return t.status(401).json({success:!1,message:"Unauthorized"});if("admin"!==a.role)return t.status(403).json({success:!1,message:"Forbidden: Admin access required"});let r=e.headers["content-type"],s={},n=e.query.id,c=null;try{h().Types.ObjectId.isValid(n)&&(c=await d.default.findById(n)),!c&&((c=await d.default.findOne({slug:n}))||(await d.default.find({},"slug title").limit(10)).forEach(e=>{}))}catch(e){}if(!c)return t.status(404).json({success:!1,message:"TV/Film not found"});if(r&&r.includes("multipart/form-data"))try{let t=(0,i.formidable)({uploadDir:x,keepExtensions:!0,maxFileSize:10485760}),[a,r]=await t.parse(e),n={};Object.keys(a).forEach(e=>{n[e]=a[e][0]});let d={};if(Object.keys(r).forEach(e=>{d[e]=r[e][0]}),s=f(n,c),r.coverImage){let e=r.coverImage[0],t=l().join(x,e.newFilename);try{o().existsSync(x)||o().mkdirSync(x,{recursive:!0}),o().copyFileSync(e.filepath,t),s.coverImage=`/uploads/${e.newFilename}`}catch(e){}}else n.coverImage&&n.coverImage.startsWith("http")&&(s.coverImage=n.coverImage,n.coverImage.includes("justwatch.com")&&n.coverImage.startsWith("http://")&&(s.coverImage=n.coverImage.replace("http://","https://")));if(r.bannerImage){let e=r.bannerImage[0],t=l().join(x,e.newFilename);try{o().existsSync(x)||o().mkdirSync(x,{recursive:!0}),o().copyFileSync(e.filepath,t),s.bannerImage=`/uploads/${e.newFilename}`}catch(e){}}else n.bannerImage&&n.bannerImage.startsWith("http")&&(s.bannerImage=n.bannerImage,n.bannerImage.includes("justwatch.com")&&n.bannerImage.startsWith("http://")&&(s.bannerImage=n.bannerImage.replace("http://","https://")))}catch(e){return t.status(400).json({success:!1,message:"폼 데이터 처리 중 오류가 발생했습니다."})}else(s=f(e.body,c)).coverImage&&s.coverImage.startsWith("http://")&&(s.coverImage=s.coverImage.replace("http://","https://")),s.bannerImage&&s.bannerImage.startsWith("http://")&&(s.bannerImage=s.bannerImage.replace("http://","https://"));s.watchProviders&&Array.isArray(s.watchProviders)&&(s.watchProviders=s.watchProviders.map(e=>{if(e.logo)e.logo.includes("justwatch.com")&&e.logo.startsWith("http://")&&(e.logo=e.logo.replace("http://","https://"));else{let t="/images/placeholder-image.jpg";if(e.name.toLowerCase().includes("netflix"))t="https://upload.wikimedia.org/wikipedia/commons/7/7a/Logonetflix.png";else if(e.name.toLowerCase().includes("disney"))t="https://upload.wikimedia.org/wikipedia/commons/3/3e/Disney%2B_logo.svg";else if(e.name.toLowerCase().includes("tving"))t="https://upload.wikimedia.org/wikipedia/commons/9/95/TVING_logo.png";else if(e.name.toLowerCase().includes("wavve"))t="https://upload.wikimedia.org/wikipedia/commons/8/8c/Wavve_logo.png";else if(e.name.toLowerCase().includes("watcha"))t="https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/Watcha_logo.png/800px-Watcha_logo.png";else if(e.name.toLowerCase().includes("apple"))t="https://upload.wikimedia.org/wikipedia/commons/3/39/Apple_TV.svg";else{let a=e.url||"";t=`https://www.google.com/s2/favicons?domain=${encodeURIComponent(a)}&sz=128`}return{...e,logo:t}}return e})),s.videos&&Array.isArray(s.videos)&&(s.videos=s.videos.map(e=>{if(e._id)return e;let{id:t,...a}=e;return{...a,videoId:t||`video_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}));let m=await d.default.findByIdAndUpdate(e.query.id,{$set:s},{new:!0,runValidators:!0});return t.status(200).json({success:!0,message:"TV/Film updated successfully",data:m})}catch(e){return t.status(500).json({success:!1,message:e.message||"Error updating TV/Film",error:e.stack})}}async function A(e,t){try{let a=e.query.id,r=null;try{h().Types.ObjectId.isValid(a)&&(r=await d.default.findById(a)),r||(r=await d.default.findOne({slug:a}))}catch(e){}if(!r)return t.status(404).json({success:!1,message:"TV/Film not found"});let i=await d.default.deleteOne({_id:r._id});if(!i||0===i.deletedCount)return t.status(404).json({success:!1,message:"TV/Film not found or could not be deleted"});return t.status(200).json({success:!0,message:"TV/Film deleted successfully"})}catch(e){return t.status(500).json({success:!1,message:e.message||"Error deleting TV/Film"})}}(0,n.dirname)(T),o().existsSync(x)||o().mkdirSync(x,{recursive:!0}),r()}catch(e){r(e)}})},35968:(e,t,a)=>{let r;a.r(t),a.d(t,{connectToDatabase:()=>c,dbConnect:()=>d,default:()=>u});var i=a(38013),s=a(92048),o=a.n(s),n=a(55315),l=a.n(n);{let e=a(25142),t=l().resolve(process.cwd(),".env.production");o().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await r,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}r=new i.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=c,u=r}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[9778],()=>a(46817));module.exports=r})();