"use strict";(()=>{var e={};e.id=6007,e.ids=[6007],e.modules={25142:e=>{e.exports=require("dotenv")},11185:e=>{e.exports=require("mongoose")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},28072:(e,t,a)=>{a.r(t),a.d(t,{config:()=>f,default:()=>p,routeModule:()=>g});var r={};a.r(r),a.d(r,{default:()=>m});var i=a(71802),n=a(47153),s=a(56249),u=a(41649),o=a(44756),d=a(74053),l=a(69176),c=a(81075);async function m(e,t){let a=await (0,u.getSession)({req:e});if(await (0,o.default)(),"GET"===e.method)try{let{id:a,page:r=1,limit:i=10,sort:n="createdAt",order:s="desc",featured:u=!1}=e.query;if(!a)return t.status(400).json({success:!1,message:"TVFilm ID is required"});if(!await d.default.findById(a))return t.status(404).json({success:!1,message:"TVFilm not found"});let o={tvfilm:a,approved:!0};"true"===u&&(o.featured=!0);let c=parseInt(r,10),m=parseInt(i,10),p=(c-1)*m,f="asc"===s.toLowerCase()?1:-1,g={};g[n]=f;let y=await l.default.find(o).sort(g).skip(p).limit(m).populate("author","name image"),h=await l.default.countDocuments(o);return t.status(200).json({success:!0,data:y,pagination:{total:h,page:c,limit:m,pages:Math.ceil(h/m)}})}catch(e){return t.status(500).json({success:!1,message:e.message})}else if("POST"===e.method){if(!a)return t.status(401).json({success:!1,message:"Authentication required"});try{let{id:r,rating:i,title:n,content:s,spoiler:u=!1,isCritic:o=!1}=e.body;if(!r)return t.status(400).json({success:!1,message:"TVFilm ID is required"});if(!i||i<1||i>10)return t.status(400).json({success:!1,message:"Rating must be between 1 and 10"});if(!n)return t.status(400).json({success:!1,message:"Review title is required"});if(!s)return t.status(400).json({success:!1,message:"Review content is required"});if(o&&(!a.user.role||"admin"!==a.user.role))return t.status(403).json({success:!1,message:"평론가 리뷰는 관리자만 작성할 수 있습니다."});if(!await d.default.findById(r))return t.status(404).json({success:!1,message:"TVFilm not found"});let m=await l.default.findOne({tvfilm:r,author:a.user.id});if(m)return t.status(400).json({success:!1,message:"You have already reviewed this TV/Film",reviewId:m._id});let p=await c.default.findById(a.user.id),f=new l.default({tvfilm:r,author:a.user.id,authorName:p.name,rating:parseInt(i,10),title:n,content:s,isCritic:!!o,spoiler:!0===u||"true"===u,featured:!1,approved:!0,createdAt:new Date,updatedAt:new Date});await f.save();let g=await l.default.find({tvfilm:r,approved:!0}),y=g.length,h=0,v=[0,0,0,0,0,0,0,0,0,0];if(y>0){let e=g.reduce((e,t)=>e+t.rating,0);h=parseFloat((e/y).toFixed(1)),g.forEach(e=>{let t=Math.min(Math.max(Math.floor(e.rating)-1,0),9);v[t]++})}await d.default.findByIdAndUpdate(r,{reviewCount:y,reviewRating:h,ratingDistribution:v});let S=f.toObject();return S.tvfilmStats={reviewCount:y,reviewRating:h,ratingDistribution:v},t.status(201).json({success:!0,data:S})}catch(e){return t.status(500).json({success:!1,message:e.message})}}else if("PUT"===e.method){if(!a)return t.status(401).json({success:!1,message:"Authentication required"});try{let{reviewId:r,rating:i,title:n,content:s,spoiler:u,isCritic:o}=e.body;if(!r)return t.status(400).json({success:!1,message:"Review ID is required"});let c=await l.default.findById(r);if(!c)return t.status(404).json({success:!1,message:"Review not found"});if(c.author.toString()!==a.user.id&&"admin"!==a.user.role)return t.status(403).json({success:!1,message:"Not authorized to update this review"});if(void 0!==o&&o&&(!a.user.role||"admin"!==a.user.role))return t.status(403).json({success:!1,message:"평론가 리뷰는 관리자만 수정할 수 있습니다."});if(void 0!==i&&(i<1||i>10))return t.status(400).json({success:!1,message:"Rating must be between 1 and 10"});let m={updatedAt:new Date};void 0!==i&&(m.rating=parseInt(i,10)),void 0!==n&&(m.title=n),void 0!==s&&(m.content=s),void 0!==u&&(m.spoiler=!0===u||"true"===u),void 0!==o&&(m.isCritic=!!o);let p=await l.default.findByIdAndUpdate(r,m,{new:!0});if(void 0!==i){let e=c.tvfilm,a=await l.default.find({tvfilm:e,approved:!0}),r=a.length,i=0,n=[0,0,0,0,0,0,0,0,0,0];if(r>0){let e=a.reduce((e,t)=>e+t.rating,0);i=parseFloat((e/r).toFixed(1)),a.forEach(e=>{let t=Math.min(Math.max(Math.floor(e.rating)-1,0),9);n[t]++})}await d.default.findByIdAndUpdate(e,{reviewRating:i,ratingDistribution:n});let s=p.toObject();return s.tvfilmStats={reviewCount:r,reviewRating:i,ratingDistribution:n},t.status(200).json({success:!0,data:s})}return t.status(200).json({success:!0,data:p})}catch(e){return t.status(500).json({success:!1,message:e.message})}}else{if("DELETE"!==e.method)return t.setHeader("Allow",["GET","POST","PUT","DELETE"]),t.status(405).json({success:!1,message:`Method ${e.method} not allowed`});if(!a)return t.status(401).json({success:!1,message:"Authentication required"});try{let{reviewId:r}=e.body;if(!r)return t.status(400).json({success:!1,message:"Review ID is required"});let i=await l.default.findById(r);if(!i)return t.status(404).json({success:!1,message:"Review not found"});if(i.author.toString()!==a.user.id&&"admin"!==a.user.role)return t.status(403).json({success:!1,message:"Not authorized to delete this review"});let n=i.tvfilm;await l.default.findByIdAndDelete(r);let s=await l.default.find({tvfilm:n,approved:!0}),u=s.length,o=0,c=[0,0,0,0,0,0,0,0,0,0];if(u>0){let e=s.reduce((e,t)=>e+t.rating,0);o=parseFloat((e/u).toFixed(1)),s.forEach(e=>{let t=Math.min(Math.max(Math.floor(e.rating)-1,0),9);c[t]++})}return await d.default.findByIdAndUpdate(n,{reviewCount:u,reviewRating:o,ratingDistribution:c}),t.status(200).json({success:!0,message:"Review deleted successfully",tvfilmStats:{reviewCount:u,reviewRating:o,ratingDistribution:c}})}catch(e){return t.status(500).json({success:!1,message:e.message})}}}a(11185);let p=(0,s.hoist)(r,"default"),f=(0,s.hoist)(r,"config"),g=new i.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/tvfilm/review",pathname:"/api/tvfilm/review",bundlePath:"",filename:""},userland:r})},44756:(e,t,a)=>{a.r(t),a.d(t,{default:()=>d});var r=a(11185),i=a.n(r);a(25142).config({path:".env.production"});let n="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";n||(n="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),n.includes("localhost")||(n.includes("mongodb://")&&!n.includes("authSource=")&&(n.includes("?")?n+="&authSource=admin":n+="?authSource=admin"),!n.includes("docdb.amazonaws.com")||n.includes("authMechanism=")||(n.includes("?")?n+="&authMechanism=SCRAM-SHA-1":n+="?authMechanism=SCRAM-SHA-1"));let s=n.includes("localhost")||n.includes("127.0.0.1"),u=global.mongoose;async function o(){if(u.conn&&1===i().connection.readyState)return u.conn;if(0===i().connection.readyState||3===i().connection.readyState){u.conn=null,u.promise=null;try{await i().connection.close()}catch(e){}}if(!u.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};s||(n.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),u.promise=i().connect(n,e).then(e=>(e.connection.on("error",e=>{u.conn=null,u.promise=null,setTimeout(()=>{o().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{u.conn=null,u.promise=null,setTimeout(()=>{o().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw u.promise=null,e})}try{return u.conn=await u.promise,u.conn}catch(e){throw u.promise=null,e}}u||(u=global.mongoose={conn:null,promise:null});let d=o},69176:(e,t,a)=>{a.r(t),a.d(t,{default:()=>s});var r=a(11185),i=a.n(r);let n=new(i()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),s=i().models.Review||i().model("Review",n)},74053:(e,t,a)=>{a.r(t),a.d(t,{default:()=>s});var r=a(11185),i=a.n(r);let n=new(i()).Schema({title:{type:String,required:[!0,"Please provide a title for this TV/Film"],maxlength:[200,"Title cannot be more than 200 characters"]},originalTitle:{type:String,required:!1},slug:{type:String,required:!0,unique:!0},content:{type:String,required:[!0,"Please provide content for this TV/Film"]},summary:{type:String,required:[!0,"Please provide a summary for this TV/Film"],maxlength:[1e3,"Summary cannot be more than 1000 characters"]},coverImage:{type:String,required:[!0,"Please provide a cover image for this TV/Film"]},bannerImage:{type:String,required:!1,default:""},trailerUrl:{type:String,required:!1,default:""},category:{type:String,required:[!0,"Please select a category for this TV/Film"],enum:["drama","movie","variety","documentary","other"]},status:{type:String,required:[!0,"Please select a status for this TV/Film"],enum:["ongoing","completed","upcoming","canceled"],default:"ongoing"},network:{type:String,required:!1},releaseDate:{type:Date,required:[!0,"Please provide a release date for this TV/Film"]},rating:{type:Number,required:!1,min:[0,"Rating cannot be less than 0"],max:[10,"Rating cannot be more than 10"],default:0},reviewRating:{type:Number,min:[0,"Review rating cannot be less than 0"],max:[10,"Review rating cannot be more than 10"],default:0},reviewCount:{type:Number,default:0},ratingDistribution:{type:[Number],default:[0,0,0,0,0,0,0,0,0,0],validate:{validator:function(e){return 10===e.length},message:"Rating distribution must have exactly 10 values"}},runtime:{type:String,required:!1},ageRating:{type:String,required:!1,enum:["ALL","12","15","18","R"]},director:{type:String,required:!1},country:{type:String,required:!1},tags:{type:[String],default:[]},genres:{type:[String],default:[]},cast:{type:[{name:{type:String,required:!0},role:{type:String},image:{type:String},order:{type:Number,default:0}}],default:[]},watchProviders:{type:[{name:{type:String,required:!0},logo:{type:String},type:{type:String,enum:["subscription","rental","purchase","free"],required:!0},price:{type:String},quality:[String],url:{type:String},order:{type:Number,default:0}}],default:[]},videos:{type:[{title:{type:String},type:{type:String,enum:["trailer","teaser","ad","making-of","clip","interview","other"],required:!0},url:{type:String,required:!0},order:{type:Number,default:0}}],default:[]},author:{type:i().Schema.Types.ObjectId,ref:"User",required:!0},featured:{type:Boolean,default:!1},orderNumber:{type:Number,default:0,index:!0},lang:{type:String,required:!0,enum:["en","ko","ja","zh","es"],default:"en"},translationOf:{type:i().Schema.Types.ObjectId,ref:"TVFilm",default:null},views:{type:Number,default:0},likes:{type:Number,default:0},dislikes:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),s=i().models.TVFilm||i().model("TVFilm",n)},81075:(e,t,a)=>{a.r(t),a.d(t,{default:()=>s});var r=a(11185),i=a.n(r);let n=new(i()).Schema({name:{type:String,required:[!0,"Please provide a name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},image:{type:String,default:"/images/default-avatar.png"},role:{type:String,enum:["user","admin","editor"],default:"user"},likes:{type:[{contentId:{type:i().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},dislikes:{type:[{contentId:{type:i().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},bookmarks:{type:[{contentId:{type:i().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),s=i().models.User||i().model("User",n)},47153:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},71802:(e,t,a)=>{e.exports=a(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=28072);module.exports=a})();