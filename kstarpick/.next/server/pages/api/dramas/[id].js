"use strict";(()=>{var e={};e.id=3093,e.ids=[3093],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},16599:(e,t,r)=>{r.r(t),r.d(t,{config:()=>v,default:()=>c,routeModule:()=>m});var i={};r.r(i),r.d(i,{default:()=>l});var o=r(71802),s=r(47153),a=r(56249),n=r(35968);r(41649);var d=r(38013);function u(e){let t=0,r=0,i=[0,0,0,0,0,0,0,0,0,0];if(!Array.isArray(e)||0===e.length)return{reviewCount:t,reviewRating:r,ratingDistribution:i};t=e.length;let o=0;return e.forEach(e=>{let t=parseInt(e.rating,10);!isNaN(t)&&t>=1&&t<=10&&(o+=t,i[Math.min(Math.max(Math.floor(t)-1,0),9)]++)}),t>0&&(r=parseFloat((o/t).toFixed(1))),{reviewCount:t,reviewRating:r,ratingDistribution:i}}async function l(e,t){let{id:r,view:i}=e.query;try{let{db:o}=await (0,n.connectToDatabase)(),s=o.collection("dramas");switch(e.method){case"GET":let a;if(d.ObjectId.isValid(r)&&(a=await s.findOne({_id:new d.ObjectId(r)})),a||(a=await s.findOne({slug:r})),!a)return t.status(404).json({success:!1,message:"드라마를 찾을 수 없습니다."});"true"===i&&(await s.updateOne({_id:a._id},{$inc:{viewCount:1}}),a=await s.findOne({_id:a._id}));let l=[];try{let e=await o.collection("reviews").find({dramaId:r}).toArray(),t=[];d.ObjectId.isValid(r)&&(t=await o.collection("reviews").find({dramaId:new d.ObjectId(r)}).toArray());let i=[...e,...t],s=new Map;i.forEach(e=>{s.set(e.reviewId||e._id.toString(),e)}),l=Array.from(s.values())}catch(e){}let{reviewCount:c,reviewRating:v,ratingDistribution:m}=u(l);return a.reviewCount=c,a.reviewRating=v,a.ratingDistribution=m,a.reviews&&Array.isArray(a.reviews)||(a.reviews=[]),l&&l.length>0&&(a.reviews=[...a.reviews,...l]),t.status(200).json({success:!0,data:a});case"PUT":case"DELETE":if("PUT"===e.method){let{title:i,originalTitle:o,description:a,summary:n,status:l,country:c,releaseDate:v,runtime:m,ageRating:p,director:f,genres:w,category:g,coverImage:h,bannerImage:A,trailerUrl:y,cast:b,watchProviders:P,streamingLinks:I,tags:j,videos:E,reviews:O,reviewRating:_,reviewCount:k,ratingDistribution:x,featured:M,metaDescription:R,metaKeywords:S,episodeList:T,whereToWatch:C,orderNumber:D,previousOrderNumber:q}=e.body;if(!i)return t.status(400).json({success:!1,message:"제목은 필수 필드입니다."});let G={title:i,updatedAt:new Date};if(void 0!==o&&(G.originalTitle=o),void 0!==a&&(G.description=a),void 0!==n&&(G.summary=n),void 0!==l&&(G.status=l),void 0!==c&&(G.country=c),void 0!==v&&(G.releaseDate=v),void 0!==m&&(G.runtime=m),void 0!==p&&(G.ageRating=p),void 0!==f&&(G.director=f),void 0!==w&&(G.genres=w),void 0!==g&&(G.category=g),void 0!==h&&(G.coverImage=h),void 0!==A&&(G.bannerImage=A),void 0!==y&&(G.trailerUrl=y),void 0!==P&&(G.watchProviders=P),void 0!==I&&(G.streamingLinks=I),void 0!==j&&(G.tags=j),void 0!==E&&(G.videos=E),void 0!==O&&(G.reviews=O),void 0!==_&&(G.reviewRating=_),void 0!==k&&(G.reviewCount=k),void 0!==x&&(G.ratingDistribution=x),void 0!==M&&(G.featured=M),void 0!==R&&(G.metaDescription=R),void 0!==S&&(G.metaKeywords=S),void 0!==T&&(G.episodeList=T),void 0!==C&&(G.whereToWatch=C),void 0!==D&&(G.orderNumber=parseInt(D)||0),void 0!==q&&(G.previousOrderNumber=parseInt(q)||0),void 0!==O&&(void 0===_||void 0===k||void 0===x)){let e=u(O);G.reviewRating=e.reviewRating,G.reviewCount=e.reviewCount,G.ratingDistribution=e.ratingDistribution}if(void 0!==b){if("object"==typeof b&&null!==b&&!Array.isArray(b)&&(b.mainRoles||b.supportRoles)){let e=Array.isArray(b.mainRoles)?b.mainRoles:[],t=Array.isArray(b.supportRoles)?b.supportRoles:[],r=e=>{if(!e)return!0;let t=e.toLowerCase();return!t.includes("director")&&!t.includes("producer")&&!t.includes("screenwriter")&&!t.includes("writer")&&!t.includes("creator")&&!t.includes("pd")&&!t.includes("production")&&!t.includes("script")&&!t.includes("original author")&&!t.includes("original work")},i=e=>{if(!e)return!0;let t=e.toLowerCase();return""===t||"unknown"===t||"unknown role"===t||"main role"===t||"support role"===t||"supporting role"===t||"guest role"===t||t.includes("known for roles")},o=[...e.filter(e=>r(e.role)&&!i(e.role)).map((e,t)=>({name:e.name||"N/A",role:e.role||"",profileImage:e.profileImage||e.image||"",order:t})),...t.filter(e=>r(e.role)&&!i(e.role)).map((t,r)=>({name:t.name||"N/A",role:t.role||"",profileImage:t.profileImage||t.image||"",order:e.length+r}))];G.cast=o}else G.cast=b}let N=await s.updateOne({_id:new d.ObjectId(r)},{$set:G});if(0===N.matchedCount)return t.status(404).json({success:!1,message:"드라마를 찾을 수 없습니다."});return t.status(200).json({success:!0,message:"드라마가 성공적으로 수정되었습니다."})}{let e=await s.deleteOne({_id:new d.ObjectId(r)});if(0===e.deletedCount)return t.status(404).json({success:!1,message:"드라마를 찾을 수 없습니다."});return t.status(200).json({success:!0,message:"드라마가 성공적으로 삭제되었습니다."})}default:return t.setHeader("Allow",["GET","PUT","DELETE"]),t.status(405).json({success:!1,message:`Method ${e.method} Not Allowed`})}}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다."})}}let c=(0,a.hoist)(i,"default"),v=(0,a.hoist)(i,"config"),m=new o.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/dramas/[id]",pathname:"/api/dramas/[id]",bundlePath:"",filename:""},userland:i})},35968:(e,t,r)=>{let i;r.r(t),r.d(t,{connectToDatabase:()=>u,dbConnect:()=>l,default:()=>c});var o=r(38013),s=r(92048),a=r.n(s),n=r(55315),d=r.n(n);{let e=r(25142),t=d().resolve(process.cwd(),".env.production");a().existsSync(t)&&e.config({path:t}).error}async function u(){try{let e=await i,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}i=new o.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=u,c=i},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=16599);module.exports=r})();