"use strict";(()=>{var e={};e.id=6517,e.ids=[6517],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},19828:e=>{e.exports=require("puppeteer-extra")},43199:e=>{e.exports=require("puppeteer-extra-plugin-stealth")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},20295:e=>{e.exports=import("cheerio")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},29425:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>c,routeModule:()=>u});var a=r(71802),n=r(47153),i=r(56249),l=r(12450),s=e([l]);l=(s.then?(await s)():s)[0];let c=(0,i.hoist)(l,"default"),d=(0,i.hoist)(l,"config"),u=new a.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/crawler/stealth-reviews-crawler",pathname:"/api/crawler/stealth-reviews-crawler",bundlePath:"",filename:""},userland:l});o()}catch(e){o(e)}})},12450:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{default:()=>u}),r(41649);var a=r(20295),n=r(35968),i=r(19828),l=r.n(i),s=r(43199),c=r.n(s),d=e([a]);a=(d.then?(await d)():d)[0],l().use(c()());let m=e=>new Promise(t=>setTimeout(t,e));async function u(e,t){let r;if("POST"!==e.method)return t.status(405).json({success:!1,message:"허용되지 않는 메소드입니다."});try{let{url:o,dramaId:a}=e.body;if(!o)return t.status(400).json({success:!1,message:"URL이 필요합니다."});if(!a)return t.status(400).json({success:!1,message:"드라마 ID가 필요합니다."});let n=o;n.endsWith("/reviews")||(n.endsWith("/")&&(n=n.slice(0,-1)),n=`${n}/reviews`),r=await l().launch({headless:"new",args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu","--window-size=1920,1080"],ignoreHTTPSErrors:!0,defaultViewport:{width:1920,height:1080}});let i=await r.newPage();await i.setUserAgent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"),await i.setExtraHTTPHeaders({"Accept-Language":"en-US,en;q=0.9",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br"}),await i.setRequestInterception(!0),i.on("request",e=>{let t=e.resourceType();["image","font","media","stylesheet"].includes(t)?e.abort():e.continue()}),i.on("console",e=>console.log("[브라우저 콘솔]",e.text()));try{await i.goto(n,{waitUntil:"domcontentloaded",timeout:6e4}),await i.waitForFunction(()=>"complete"===document.readyState||document.querySelectorAll(".box, .post, .comment, #content").length>0,{timeout:3e4})}catch(e){}await m(Math.floor(2e3*Math.random())+1e3),await i.evaluate(async()=>{let e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight);window.innerHeight;let t=0;for(;t<e;){let e=Math.floor(300*Math.random())+100;t+=e,window.scrollTo(0,t),await new Promise(e=>setTimeout(e,Math.floor(300*Math.random())+100)),Math.random()>.7&&await new Promise(e=>setTimeout(e,Math.floor(1e3*Math.random())+500))}let r=Array.from(document.querySelectorAll("h1, h2, h3, h4, .box-header")).filter(e=>e.textContent.includes("Reviews"));r.length>0&&(r[0].scrollIntoView({behavior:"smooth"}),await new Promise(e=>setTimeout(e,1e3))),window.scrollTo(0,0),await new Promise(e=>setTimeout(e,500)),window.scrollTo(0,e/2)});try{for(let e of[".load-more",".more-reviews",".show-more",'button:contains("Show More")','a:contains("Show More")','button:contains("Load More")','a:contains("Load More")',".reviews-pagination .next",".pagination .next"])if(await i.evaluate(e=>Array.from(document.querySelectorAll(e)).filter(e=>{let t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&null!==e.offsetParent}).length>0,e)){for(let t=0;t<3;t++)try{if(await i.evaluate(e=>{let t=document.querySelector(e);t&&t.scrollIntoView({behavior:"smooth",block:"center"})},e),await m(1e3),await i.click(e),await m(3e3),!await i.evaluate(e=>{let t=document.querySelector(e);return t&&null!==t.offsetParent},e))break}catch(e){break}break}await i.waitForFunction(()=>!document.querySelector(".loading, .spinner, .loading-indicator"),{timeout:5e3}).catch(()=>console.log("[향상된 스텔스 크롤러] 로딩 인디케이터가 없거나 계속 표시됨")),await m(3e3)}catch(e){}await i.evaluate(()=>({posts:document.querySelectorAll(".post").length,comments:document.querySelectorAll(".comment:not(.reply)").length,reviews:document.querySelectorAll(".review").length,reviewContainers:document.querySelectorAll(".review-container, .review-item").length})),await i.evaluate(()=>{let e=Array.from(document.querySelectorAll("h1, h2, h3, h4, .box-header")).filter(e=>e.textContent.includes("Reviews"));return e.length>0&&(e[0].scrollIntoView({behavior:"smooth",block:"center"}),!0)}),await i.evaluate(()=>({title:document.title,url:window.location.href,headers:Array.from(document.querySelectorAll("h1, h2, h3, h4, .box-header")).map(e=>e.textContent.trim()),counts:{reviews:document.querySelectorAll(".review").length,posts:document.querySelectorAll(".post").length,comments:document.querySelectorAll(".comment:not(.reply)").length,boxes:document.querySelectorAll(".box").length}}));try{await i.screenshot({path:"/tmp/stealth-reviews.png",fullPage:!0})}catch(e){}await m(2e3);let s=await i.content(),c=await i.evaluate(()=>{let e=[],t=[];for(let e of[".post",".comment:not(.reply)",".review",".box .review-container",".review-item",".member-review"]){let r=document.querySelectorAll(e);r.length>t.length&&(t=Array.from(r))}let r=t.slice(0,10);for(let t=0;t<r.length;t++){let o=r[t];try{let r=o.querySelector('a[href^="/profile/"], .user-display, .text-primary'),a=r?r.textContent.trim():"Unknown User",n=r&&r.href?r.href:"",i=o.querySelector("img.avatar, .avatar img"),l=i?i.src:"",s=0;for(let e of[".rating-overall .score",".score",".rated",'[itemprop="ratingValue"]',"span.score","div.score",".overall"]){let t=o.querySelector(e);if(t){let e=t.textContent.trim().match(/(\d+(\.\d+)?)/);if(e){s=parseFloat(e[1]);break}}}let c="",d="";for(let e of[".review-body",".review-bodyfull",".review-bodyfull-read",".text",".post-body",".comment-body",'[itemprop="reviewBody"]',".text-content",".review-content",".post-content",".review-text","p.text",".box-body p",".user-content",".content"]){let t=o.querySelector(e);if(t){let e=t.cloneNode(!0);if(["box","user-stats","review-helpful","review-tag","rating-overall","spoiler-warning","hidden-spoiler"].forEach(t=>{e.querySelectorAll(`.${t}`).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),d=e.innerHTML?.trim()||"",c=e.textContent.trim())break}}if(!c){let e=o.querySelectorAll("p");if(e.length>1){let t=[];e.forEach(e=>{let r=e.textContent.trim();r.length>10&&t.push(r)}),t.length>0&&(c=t.join("\n\n"),d="<p>"+t.join("</p><p>")+"</p>")}}if(!c){let e=o.cloneNode(!0);["avatar","user-display","rating-overall","review-rating","review-helpful","review-tag","datetime","post-header","user-stats","spoiler-warning","hidden-spoiler"].forEach(t=>{e.querySelectorAll(`.${t}`).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),["rating","score","header","title"].forEach(t=>{e.querySelectorAll(`[class*="${t}"]`).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),c=e.textContent.trim(),d=e.innerHTML?.trim()||"",c=c.replace(/\(\d+(\.\d+)?\)/g,"").trim()}if(!c||c.length<10){let e=o.cloneNode(!0);["h3","h4",".review-title",".post-header"].forEach(t=>{e.querySelectorAll(t).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),c=e.textContent.trim().replace(RegExp(a,"g"),"").replace(/Main Role|Support Role|Completed|Watching|\d+\/\d+/g,"").replace(/Overall:|Story:|Acting:|Music:|Rewatch:/gi,"").replace(/\d+(\.\d+)?\/10/g,"").replace(/\s{2,}/g," ").trim()}if(c&&c.length>0&&(c=c.replace(/(?:Overall|Story|Acting|Cast|Music|Rewatch)(?:\s*(?::|Value|Rating))?\s*\d+(?:\.\d+)?(?:\/\d+)?/gi,"").replace(/(?:Rating|Score):\s*\d+(?:\.\d+)?(?:\/\d+)?/gi,"").replace(/\(\d+(?:\.\d+)?\/\d+\)/g,"").replace(/\s{2,}/g," ").trim()).length>0){let e=c.split(/\n{2,}/);d=e.length>1?"<p>"+e.join("</p><p>")+"</p>":`<p>${c}</p>`}let u="";for(let e of[".review-title","h3","h4",".post-header h2"]){let t=o.querySelector(e);if(t&&(u=t.textContent.trim()))break}if(!u&&c){let e=c.split("\n")[0].trim();u=e.length>50?`${e.substring(0,50)}...`:e}else u||(u=`${a}의 리뷰`);e.push({reviewId:`browser-${t}-${Date.now()}`,username:a,userProfileUrl:n,userImage:l,rating:s,title:u,reviewText:c,reviewHtml:d,extractMethod:"browser"})}catch(e){}}return e}),d=await h(s,n),u=function(e,t){let r=[],o=new Map;for(let t of e)t.username&&"Unknown User"!==t.username&&t.reviewText&&t.reviewText.length>=10&&o.set(t.username,t);for(let e of t)if(o.has(e.username)){let t=o.get(e.username);e.reviewText.length>t.reviewText.length&&o.set(e.username,e)}else e.username&&"Unknown User"!==e.username&&e.reviewText&&e.reviewText.length>=10&&o.set(e.username,e);for(let[e,t]of o.entries())r.push(t);return r}(c,d);return u.length>0&&await p(u,a),await r.close(),t.status(200).json({success:!0,message:`${u.length}개의 리뷰를 크롤링했습니다.`,data:{reviews:u.map(e=>({reviewId:e.reviewId,username:e.username,rating:e.rating,title:e.title}))}})}catch(e){return t.status(500).json({success:!1,message:"크롤링 중 오류가 발생했습니다.",error:e.message,stack:e.stack})}finally{if(r)try{await r.close()}catch(e){}}}async function h(e,t){try{let r=a.load(e),o=r(".box-header").filter(function(){return r(this).text().includes("Reviews")}).closest(".box"),n=[{name:"posts",selector:".post",elements:r(".post")},{name:"comments",selector:".comment:not(.reply)",elements:r(".comment:not(.reply)")},{name:"reviews",selector:".review",elements:r(".review")}];o.length>0&&n.push({name:"reviewBoxPosts",selector:"reviewsBox .post",elements:o.find(".post")},{name:"reviewBoxComments",selector:"reviewsBox .comment:not(.reply)",elements:o.find(".comment:not(.reply)")}),n.forEach(e=>{});let i=r();for(let e of n)e.elements.length>i.length&&(i=r(e.selector),e.selector);if(0===i.length)return[];let l=i.slice(0,10),s=[];return l.each((e,o)=>{try{let a=r(o);a.attr("class");let n=a.attr("id")||`stealth-${e}-${Date.now()}`,i=a.find('a[href^="/profile/"], .user-display, .post-header a, .text-primary').first(),l=i.text().trim()||"Unknown User",c=i.attr("href")?i.attr("href").startsWith("http")?i.attr("href"):`https://mydramalist.com${i.attr("href")}`:"",d=a.find("img.avatar, .avatar img").attr("src")||"",u=0;for(let e of[".rating-overall .score",".score",".rated",'[itemprop="ratingValue"]',"span.score","div.score",".overall"]){let t=a.find(e).first();if(t.length>0){let e=t.text().trim().match(/(\d+(\.\d+)?)/);if(e){u=parseFloat(e[1]);break}}}let h="",p="";for(let e of[".review-body",".review-bodyfull",".review-bodyfull-read",".text",".post-body",".comment-body",'[itemprop="reviewBody"]',".text-content",".review-content",".post-content",".review-text","p.text",".box-body p",".user-content",".content"]){let t=a.find(e).first();if(t.length>0){let e=t.cloneNode(!0);if(["box","user-stats","review-helpful","review-tag","rating-overall","spoiler-warning","hidden-spoiler"].forEach(t=>{e.querySelectorAll(`.${t}`).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),p=e.innerHTML?.trim()||"",h=e.textContent.trim())break}}if(!h){let e=a.find("p");if(e.length>1){let t=[];e.each((e,o)=>{let a=r(o).text().trim();a.length>10&&t.push(a)}),t.length>0&&(h=t.join("\n\n"),p="<p>"+t.join("</p><p>")+"</p>")}}if(!h){let e=a.cloneNode(!0);["avatar","user-display","rating-overall","review-rating","review-helpful","review-tag","datetime","post-header","user-stats","spoiler-warning","hidden-spoiler"].forEach(t=>{e.querySelectorAll(`.${t}`).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),["rating","score","header","title"].forEach(t=>{e.querySelectorAll(`[class*="${t}"]`).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),h=e.textContent.trim(),p=e.innerHTML?.trim()||"",h=h.replace(/\(\d+(\.\d+)?\)/g,"").trim()}if(!h||h.length<10){let e=a.cloneNode(!0);["h3","h4",".review-title",".post-header"].forEach(t=>{e.querySelectorAll(t).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),h=e.textContent.trim().replace(RegExp(l,"g"),"").replace(/Main Role|Support Role|Completed|Watching|\d+\/\d+/g,"").replace(/Overall:|Story:|Acting:|Music:|Rewatch:/gi,"").replace(/\d+(\.\d+)?\/10/g,"").replace(/\s{2,}/g," ").trim()}if(h&&h.length>0&&(h=h.replace(/(?:Overall|Story|Acting|Cast|Music|Rewatch)(?:\s*(?::|Value|Rating))?\s*\d+(?:\.\d+)?(?:\/\d+)?/gi,"").replace(/(?:Rating|Score):\s*\d+(?:\.\d+)?(?:\/\d+)?/gi,"").replace(/\(\d+(?:\.\d+)?\/\d+\)/g,"").replace(/\s{2,}/g," ").trim()).length>0){let e=h.split(/\n{2,}/);p=e.length>1?"<p>"+e.join("</p><p>")+"</p>":`<p>${h}</p>`}h||(h="내용 없음");let m=a.find(".review-title, h3, h4, .post-header h2").first().text().trim();if(!m&&h){let e=h.split("\n")[0].trim();m=e.length>50?`${e.substring(0,50)}...`:e}else m||(m=`${l}의 리뷰`);s.push({reviewId:n,username:l,userProfileUrl:c,userImage:d,status:"Completed",watchedEpisodes:0,totalEpisodes:0,createdAt:new Date,rating:u,storyRating:0,actingRating:0,musicRating:0,rewatchRating:0,title:m,reviewText:h,reviewHtml:p,helpfulCount:0,commentCount:0,reviewUrl:"",sourceUrl:t,crawledAt:new Date})}catch(e){}}),s}catch(e){return[]}}async function p(e,t){try{let{db:r}=await (0,n.connectToDatabase)();for(let o of e)o.dramaId=t,await r.collection("reviews").findOne({reviewId:o.reviewId})?await r.collection("reviews").updateOne({reviewId:o.reviewId},{$set:o}):await r.collection("reviews").insertOne(o);let o=await r.collection("reviews").find({dramaId:t}).toArray(),a=o.length,i=0,l=0;for(let e of o)e.rating&&e.rating>0&&(i+=e.rating,l++);let s=l>0?i/l:0,c=Array(10).fill(0);for(let e of o)if(e.rating&&e.rating>0&&e.rating<=10){let t=Math.floor(e.rating)-1;t>=0&&t<10&&c[t]++}await r.collection("dramas").updateOne({_id:t},{$set:{reviewCount:a,reviewRating:s,ratingDistribution:c}})}catch(e){throw e}}o()}catch(e){o(e)}})},35968:(e,t,r)=>{let o;r.r(t),r.d(t,{connectToDatabase:()=>c,dbConnect:()=>d,default:()=>u});var a=r(38013),n=r(92048),i=r.n(n),l=r(55315),s=r.n(l);{let e=r(25142),t=s().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await o,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}o=new a.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=c,u=o},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=29425);module.exports=r})();