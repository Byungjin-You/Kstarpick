"use strict";(()=>{var e={};e.id=4244,e.ids=[4244],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},74809:e=>{e.exports=require("node-fetch")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},74071:(e,t,r)=>{r.r(t),r.d(t,{config:()=>f,default:()=>p,routeModule:()=>h});var a={};r.r(a),r.d(a,{default:()=>u});var s=r(71802),i=r(47153),o=r(56249);r(41649);var n=r(35968),c=r(74809),l=r.n(c);async function u(e,t){if("POST"!==e.method)return t.status(405).json({success:!1,message:"허용되지 않는 메소드입니다."});try{let{url:r,dramaId:a}=e.body;if(!r)return t.status(400).json({success:!1,message:"URL이 필요합니다."});if(!a)return t.status(400).json({success:!1,message:"드라마 ID가 필요합니다."});let s=r.match(/\/(\d+)[-\w]*\/reviews?/),i=s?s[1]:null;if(!i)return t.status(400).json({success:!1,message:"MyDramalist URL에서 ID를 추출할 수 없습니다."});let o=await d(i);return o.length>0&&await m(o,a),t.status(200).json({success:!0,message:`${o.length}개의 리뷰를 가져왔습니다.`,data:{reviews:o}})}catch(e){return t.status(500).json({success:!1,message:"리뷰 가져오기 중 오류가 발생했습니다.",error:e.message,stack:e.stack})}finally{}}async function d(e){try{let t=`https://mydramalist.com/v1/titles/${e}/reviews?page=1&limit=10&sort=newest`,r={"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"application/json","Accept-Language":"en-US,en;q=0.9",Origin:"https://mydramalist.com",Referer:`https://mydramalist.com/${e}-title/reviews`,"sec-ch-ua":'"Google Chrome";v="120", "Chromium";v="120", "Not-A.Brand";v="24"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin","X-Requested-With":"XMLHttpRequest"},a=await l()(t,{method:"GET",headers:r});if(!a.ok)throw await a.text(),Error(`API 요청 실패: ${a.status} ${a.statusText}`);let s=await a.json();if(!s||!s.data||!Array.isArray(s.data))return[];return s.data.map(t=>(function(e,t){try{let r;let a=`mdl-${e.id}`,s=e.user?.name||"Unknown User",i=e.user?.url||"",o=e.user?.avatar_url||"",n=e.watch_status||"Completed",c=e.watched_episodes||0,l=e.total_episodes||0;try{r=e.created_at?new Date(e.created_at):new Date}catch(e){r=new Date}let u=parseFloat(e.score)||0,d=parseFloat(e.story_score)||0,m=parseFloat(e.acting_score)||0,p=parseFloat(e.music_score)||0,f=parseFloat(e.rewatch_value_score)||0,h=e.subject||`${s}의 리뷰`,w=e.body||"",v=e.body_html||w,g=e.like_count||0,y=e.total_comments||0,A=e.url||`https://mydramalist.com/${t}/reviews/${e.id}`;return{reviewId:a,username:s,userProfileUrl:i,userImage:o,status:n,watchedEpisodes:c,totalEpisodes:l,createdAt:r,rating:u,storyRating:d,actingRating:m,musicRating:p,rewatchRating:f,title:h,reviewText:w,reviewHtml:v,helpfulCount:g,commentCount:y,reviewUrl:A,sourceUrl:`https://mydramalist.com/${t}/reviews`,crawledAt:new Date}}catch(e){return null}})(t,e))}catch(e){throw e}}async function m(e,t){try{let{db:r}=await (0,n.connectToDatabase)();for(let a of e.filter(e=>null!==e))a.dramaId=t,await r.collection("reviews").findOne({reviewId:a.reviewId})?await r.collection("reviews").updateOne({reviewId:a.reviewId},{$set:a}):await r.collection("reviews").insertOne(a);let a=await r.collection("reviews").find({dramaId:t}).toArray(),s=a.length,i=0,o=0;for(let e of a)e.rating&&e.rating>0&&(i+=e.rating,o++);let c=o>0?i/o:0,l=Array(10).fill(0);for(let e of a)if(e.rating&&e.rating>0&&e.rating<=10){let t=Math.floor(e.rating)-1;t>=0&&t<10&&l[t]++}await r.collection("dramas").updateOne({_id:t},{$set:{reviewCount:s,reviewRating:c,ratingDistribution:l}})}catch(e){throw e}}let p=(0,o.hoist)(a,"default"),f=(0,o.hoist)(a,"config"),h=new s.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/crawler/mdl-review-api",pathname:"/api/crawler/mdl-review-api",bundlePath:"",filename:""},userland:a})},35968:(e,t,r)=>{let a;r.r(t),r.d(t,{connectToDatabase:()=>l,dbConnect:()=>u,default:()=>d});var s=r(38013),i=r(92048),o=r.n(i),n=r(55315),c=r.n(n);{let e=r(25142),t=c().resolve(process.cwd(),".env.production");o().existsSync(t)&&e.config({path:t}).error}async function l(){try{let e=await a,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}a=new s.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let u=l,d=a},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=74071);module.exports=r})();