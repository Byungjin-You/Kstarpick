"use strict";(()=>{var e={};e.id=408,e.ids=[408],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},19828:e=>{e.exports=require("puppeteer-extra")},43199:e=>{e.exports=require("puppeteer-extra-plugin-stealth")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},20295:e=>{e.exports=import("cheerio")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,o){return o in t?t[o]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,o)):"function"==typeof t&&"default"===o?t:void 0}}})},68036:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{config:()=>d,default:()=>c,routeModule:()=>u});var n=o(71802),a=o(47153),i=o(56249),l=o(71720),s=e([l]);l=(s.then?(await s)():s)[0];let c=(0,i.hoist)(l,"default"),d=(0,i.hoist)(l,"config"),u=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/crawler/reviews-crawler",pathname:"/api/crawler/reviews-crawler",bundlePath:"",filename:""},userland:l});r()}catch(e){r(e)}})},71720:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{default:()=>u}),o(41649);var n=o(19828),a=o.n(n),i=o(43199),l=o.n(i),s=o(20295),c=o(35968),d=e([s]);s=(d.then?(await d)():d)[0],a().use(l()());let p=()=>{let e=Math.floor(1500*Math.random())+500;return new Promise(t=>setTimeout(t,e))},f=async(e,t)=>{await e.evaluate(e=>new Promise(t=>setTimeout(t,e)),t)};async function u(e,t){let r;if("POST"!==e.method)return t.status(405).json({success:!1,message:"허용되지 않는 메소드입니다."});try{let{url:n,dramaId:a}=e.body;if(!n)return t.status(400).json({success:!1,message:"URL이 필요합니다."});if(!a)return t.status(400).json({success:!1,message:"드라마 ID가 필요합니다."});let i=n;i.endsWith("/reviews")||(i.endsWith("/")&&(i=i.slice(0,-1)),i=`${i}/reviews`);let{browser:l,page:s}=await w();r=l,s.on("console",e=>console.log("[브라우저 콘솔]",e.text()));let d=!1,u=0;for(;!d&&u<3;)try{u++;let e=new Promise((e,t)=>{setTimeout(()=>{t(Error("페이지 로딩 타임아웃"))},6e4)});await Promise.race([s.goto(i,{waitUntil:"domcontentloaded",timeout:3e4}),e]);try{await s.waitForFunction(()=>"complete"===document.readyState||document.querySelectorAll(".review, .box, #content, .post, .comment").length>0,{timeout:15e3}),d=!0}catch(t){let e=await s.content();e&&e.length>1e3&&(d=!0)}}catch(e){u>=3||await f(s,5e3)}await p();try{await h(s)}catch(e){await f(s,5e3)}try{await m(s)}catch(e){}try{await s.waitForFunction(()=>{for(let e of[".review",'.box-body[data-section="reviews"] > div',".post",".comment:not(.reply)",".user-reviews > div"])if(document.querySelectorAll(e).length>0)return!0;return!1},{timeout:1e4})}catch(e){}await s.evaluate(()=>{let e={title:document.title,url:window.location.href,bodyClasses:document.body.className,reviewCount:document.querySelectorAll(".review").length,postCount:document.querySelectorAll(".post").length,commentCount:document.querySelectorAll(".comment:not(.reply)").length,boxCount:document.querySelectorAll(".box").length,contentCount:document.querySelectorAll("#content").length,textareaCount:document.querySelectorAll("textarea").length,reviewElements:[]},t=document.querySelectorAll(".box");for(let o=0;o<t.length;o++){let r=t[o].querySelector(".box-header")?.textContent||"";if(r.includes("Reviews")){e.reviewsBox={headerText:r,boxIndex:o,postsCount:t[o].querySelectorAll(".post").length,commentsCount:t[o].querySelectorAll(".comment:not(.reply)").length};break}}let o=[];for(let t of[".review",".post",".comment:not(.reply)",'.box-body[data-section="reviews"] > div']){let r=document.querySelectorAll(t);if(r.length>0){o=Array.from(r),e.foundSelector=t,e.foundCount=r.length;break}}for(let t=0;t<Math.min(o.length,3);t++){let r=o[t];e.reviewElements.push({classes:r.className,id:r.id,childrenCount:r.children.length,hasRatingOverall:null!==r.querySelector(".rating-overall, .score, .rated"),hasReviewBody:null!==r.querySelector(".review-body, .review-bodyfull, .post-body, .text-content, .comment-body")})}return e});try{await s.screenshot({path:"/tmp/review-page-debug.png",fullPage:!0})}catch(e){}await f(s,5e3);let v=await s.content();if(!v||v.length<1e3)throw Error("HTML이 비어있거나 너무 짧습니다. 크롤링에 실패했습니다.");v.length>2e3&&(v.substring(0,1e3),v.substring(v.length-1e3));try{let e=o(92048),t=o(55315),r=t.join(process.cwd(),"debug");e.existsSync(r)||e.mkdirSync(r,{recursive:!0});let n=new Date().toISOString().replace(/[:.]/g,"-"),a=t.join(r,`review-page-${n}.html`);e.writeFileSync(a,v)}catch(e){}let b=await g(v,i);if(b.length>0)try{let{db:e}=await (0,c.connectToDatabase)();for(let t of b)t.dramaId=a,await e.collection("reviews").findOne({reviewId:t.reviewId})?await e.collection("reviews").updateOne({reviewId:t.reviewId},{$set:t}):await e.collection("reviews").insertOne(t);let t=await e.collection("reviews").find({dramaId:a}).toArray(),o=t.length,r=0,n=0;for(let e of t)e.rating&&e.rating>0&&(r+=e.rating,n++);let i=n>0?r/n:0,l=Array(10).fill(0);for(let e of t)if(e.rating&&e.rating>0&&e.rating<=10){let t=Math.floor(e.rating)-1;t>=0&&t<10&&l[t]++}await e.collection("dramas").updateOne({_id:a},{$set:{reviewCount:o,reviewRating:i,ratingDistribution:l}})}catch(e){throw e}return t.status(200).json({success:!0,message:`${b.length}개의 리뷰를 크롤링했습니다.`,data:{reviews:b}})}catch(e){return t.status(500).json({success:!1,message:"크롤링 중 오류가 발생했습니다.",error:e.message,stack:e.stack})}finally{if(r)try{await r.close()}catch(e){}}}async function m(e){try{await e.waitForSelector("#content, .box, .review",{timeout:1e4})}catch(e){}await e.evaluate(async()=>{let e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),t=window.innerHeight,o=0,r=document.querySelector("#content .box, .review");for(r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),await new Promise(e=>setTimeout(e,1e3)));o<e;){let r=Math.floor(300*Math.random())+100;if(o+=r,.15>Math.random()&&o>t){let e=Math.floor(100*Math.random())+10;window.scrollTo({top:o-e,behavior:"smooth"}),await new Promise(e=>setTimeout(e,400*Math.random()+100))}if(window.scrollTo({top:o,behavior:"smooth"}),await new Promise(e=>setTimeout(e,800*Math.random()+300)),.25>Math.random()&&(await new Promise(e=>setTimeout(e,2e3*Math.random()+500)),.3>Math.random())){let e=document.querySelectorAll(".review, .review-body, .box-body");if(e.length>0){let t=e[Math.floor(Math.random()*e.length)];try{let e=window.getSelection(),o=document.createRange();o.selectNodeContents(t),e.removeAllRanges(),e.addRange(o),await new Promise(e=>setTimeout(e,500*Math.random()+200)),e.removeAllRanges()}catch(e){}}}let n=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight);if(n>e&&(e=n),o>=e-t)break}let n=document.querySelectorAll(".review, .box-body");n.length>0?n[0].scrollIntoView({behavior:"smooth",block:"center"}):window.scrollTo({top:Math.floor(e/3),behavior:"smooth"}),await new Promise(e=>setTimeout(e,1e3))})}async function h(e){let t=await e.title();if(t.includes("Just a moment")||t.includes("Cloudflare")||t.includes("Attention Required"))try{await e.waitForFunction(()=>!document.title.includes("Just a moment")&&!document.title.includes("Cloudflare")&&!document.title.includes("Attention Required"),{timeout:3e4});try{let t=await e.$$('input[type="checkbox"], button, a.button');t.length>0&&(await t[0].click(),await f(e,5e3))}catch(e){}await f(e,5e3);let t=await e.title();if(t.includes("Just a moment")||t.includes("Cloudflare")||t.includes("Attention Required"))throw Error("Cloudflare 보호를 우회하지 못했습니다.");return t}catch(o){let t=await e.content();throw t.includes("challenge-running")||t.includes("challenge-error"),Error("Cloudflare 보호를 우회하지 못했습니다: "+o.message)}return t}async function w(){let e=await a().launch({headless:"new",args:["--no-sandbox","--disable-setuid-sandbox","--disable-web-security","--disable-features=IsolateOrigins,site-per-process","--disable-blink-features=AutomationControlled","--window-size=1920,1080","--disable-extensions","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--single-process","--disable-gpu","--disable-features=site-per-process","--ignore-certificate-errors","--enable-features=NetworkService,NetworkServiceInProcess"],ignoreHTTPSErrors:!0,slowMo:20,timeout:12e4}),t=await e.newPage();return await t.setViewport({width:1920+Math.floor(100*Math.random()),height:1080+Math.floor(100*Math.random()),deviceScaleFactor:.5>Math.random()?1:2,isMobile:!1,hasTouch:!1,isLandscape:!0}),await t.setDefaultNavigationTimeout(12e4),await t.setDefaultTimeout(12e4),await t.setRequestInterception(!0),t.on("request",e=>{let t=e.resourceType(),o=e.url();o.includes("mydramalist.com")||o.includes("review")||o.includes("rating")||o.includes("user")||"document"===t||"script"===t||"xhr"===t||"fetch"===t?e.continue():["image","font","media"].includes(t)?e.abort():e.continue()}),await t.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"webdriver",{get:()=>!1}),window.navigator.chrome={runtime:{}},window.chrome={app:{InstallState:{DISABLED:"disabled",INSTALLED:"installed",NOT_INSTALLED:"not_installed"},RunningState:{CANNOT_RUN:"cannot_run",READY_TO_RUN:"ready_to_run",RUNNING:"running"},getDetails:function(){},getIsInstalled:function(){},installState:function(){return"installed"},isInstalled:!0,runningState:function(){return"running"}},csi:function(){},loadTimes:function(){},runtime:{OnInstalledReason:{CHROME_UPDATE:"chrome_update",INSTALL:"install",SHARED_MODULE_UPDATE:"shared_module_update",UPDATE:"update"},OnRestartRequiredReason:{APP_UPDATE:"app_update",OS_UPDATE:"os_update",PERIODIC:"periodic"},PlatformArch:{ARM:"arm",ARM64:"arm64",MIPS:"mips",MIPS64:"mips64",X86_32:"x86-32",X86_64:"x86-64"},PlatformNaclArch:{ARM:"arm",MIPS:"mips",MIPS64:"mips64",X86_32:"x86-32",X86_64:"x86-64"},PlatformOs:{ANDROID:"android",CROS:"cros",LINUX:"linux",MAC:"mac",OPENBSD:"openbsd",WIN:"win"},RequestUpdateCheckStatus:{NO_UPDATE:"no_update",THROTTLED:"throttled",UPDATE_AVAILABLE:"update_available"}}},Object.defineProperty(navigator,"plugins",{get:()=>{let e=[{name:"Chrome PDF Plugin",filename:"internal-pdf-viewer"},{name:"Chrome PDF Viewer",filename:"mhjfbmdgcfjbbpaeojofohoefgiehjai"},{name:"Native Client",filename:"internal-nacl-plugin"}].map(e=>{let t={name:e.name,filename:e.filename};return t.__proto__=Plugin.prototype,t});return e.__proto__=PluginArray.prototype,e}}),navigator.geolocation.getCurrentPosition,navigator.geolocation.getCurrentPosition=function(e,t,o){e({coords:{accuracy:20,altitude:null,altitudeAccuracy:null,heading:null,latitude:37.5665,longitude:126.978,speed:null},timestamp:Date.now()})}}),await t.evaluateOnNewDocument(()=>{localStorage.setItem("random_item",Math.random().toString(36)),localStorage.setItem("last_visit",Date.now().toString()),localStorage.setItem("visit_count",Math.floor(10*Math.random()+1).toString()),document.setCookie=function(e,t,o){var r="";if(o){var n=new Date;n.setTime(n.getTime()+864e5*o),r="; expires="+n.toUTCString()}document.cookie=e+"="+(t||"")+r+"; path=/"}}),await t.setUserAgent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"),await t.setExtraHTTPHeaders({"Accept-Language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br","Cache-Control":"max-age=0",Connection:"keep-alive",Referer:"https://mydramalist.com/","sec-ch-ua":'"Google Chrome";v="120", "Chromium";v="120", "Not-A.Brand";v="24"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"same-origin","Sec-Fetch-User":"?1","Upgrade-Insecure-Requests":"1"}),{browser:e,page:t}}async function g(e,t){try{let o=s.load(e);(e.match(/review/g)||[]).length;let r=o('#content .box-header:contains("Reviews")').closest(".box");r.length>0&&(r.find(".post").length,r.find(".comment:not(.reply)").length),o(".box .box-header").each((e,t)=>{});let n=o(".review");for(let e of[{selector:".review",count:o(".review").length},{selector:'.box-body[data-section="reviews"] > div',count:o('.box-body[data-section="reviews"] > div').length},{selector:".user-reviews .review-item",count:o(".user-reviews .review-item").length},{selector:".user-reviews > div",count:o(".user-reviews > div").length},{selector:"#content .box .review",count:o("#content .box .review").length},{selector:"#reviewsSection .comment, #reviewsSection .review",count:o("#reviewsSection .comment, #reviewsSection .review").length},{selector:'[itemprop="review"]',count:o('[itemprop="review"]').length},{selector:".post",count:o(".post").length},{selector:".comment:not(.reply)",count:o(".comment:not(.reply)").length},{selector:'.box-body[data-section="reviews"] .post',count:o('.box-body[data-section="reviews"] .post').length},{selector:".post-body",count:o(".post-body").length},{selector:'.box:contains("Reviews") .post',count:o('.box:contains("Reviews") .post').length},{selector:'.box:contains("Reviews") .comment',count:o('.box:contains("Reviews") .comment:not(.reply)').length},{selector:'.box-header:contains("Reviews") + .box-body .post',count:o('.box-header:contains("Reviews") + .box-body .post').length},{selector:'.box-header:contains("Reviews") ~ .box-body .post',count:o('.box-header:contains("Reviews") ~ .box-body .post').length},{selector:'.box-header:contains("Reviews") + .box-body .comment:not(.reply)',count:o('.box-header:contains("Reviews") + .box-body .comment:not(.reply)').length}])e.count>n.length&&(n=o(e.selector),e.selector);let a=o(':contains("Reviews")').filter(function(){return o(this).children().length<5&&o(this).text().includes("Reviews")});if(a.length>0){let e=a.first().closest(".box"),t=e.find(".post").length,r=e.find(".comment:not(.reply)").length;t>0?n=o('.box:contains("Reviews") .post'):r>0&&(n=o('.box:contains("Reviews") .comment:not(.reply)'))}let i=[];return n.slice(0,10).each((e,r)=>{try{o(r).attr("class"),o(r).find('.rating-overall, [itemprop="ratingValue"], .score, .rated').length,o(r).find('.review-body, .review-bodyfull, .review-bodyfull-read, [itemprop="reviewBody"], .text, .post-body, .text-content').length;let n=o(r).html();n.length>200&&n.substring(0,200);let a=o(r).attr("id")?.replace("review-","")||o(r).attr("data-id")||`unknown-${e}-${Date.now()}`,l=o(r).find('a.text-primary[href^="/profile/"], a[href^="/profile/"], [itemprop="author"] a, a.user-display, .user-display, .post-header a[href^="/profile/"]').first(),s=l.text().trim()||o(r).find('[itemprop="author"], .user-display').text().trim()||"Unknown User",c=l.attr("href")?l.attr("href").startsWith("http")?l.attr("href"):"https://mydramalist.com"+l.attr("href"):"",d=o(r).find('.avatar img, img.avatar, img.user-avatar, [itemprop="image"]').attr("src")||"",u=o(r).find(".review-tag, .status").first().text().trim()||"Completed",m=o(r).find('.datetime, [itemprop="datePublished"], .date, time, .post-header small, .text-muted small').first().text().trim(),h=new Date;if(m)try{if(m.includes("hour")){let e=parseInt(m)||0;h=new Date(Date.now()-36e5*e)}else if(m.includes("day")){let e=parseInt(m)||0;h=new Date(Date.now()-864e5*e)}else if(m.includes("month")){let e=parseInt(m)||0;h=new Date(Date.now()-2592e6*e)}else if(m.includes("year")){let e=parseInt(m)||0;h=new Date(Date.now()-31536e6*e)}else h=new Date(m),isNaN(h.getTime())&&(h=new Date)}catch(e){h=new Date}let w=0;if(o(r).attr("data-rating"))w=parseFloat(o(r).attr("data-rating"))||0;else{for(let e of[".rating-overall .score",'.score[itemprop="ratingValue"]','[class*="rating"] .score',".rated",".score",".rating span","span.rated"]){let t=o(r).find(e).first();if(t.length>0){let e=t.text().trim().match(/(\d+(\.\d+)?)/);if(e){w=parseFloat(e[1]);break}}}if(0===w){let e=o(r).find("span, div, strong").filter(function(){let e=o(this).text().trim();return/^\d+(\.\d+)?$/.test(e)&&10>=parseFloat(e)});e.length>0&&(w=parseFloat(e.first().text())||0)}}let g="",p="";for(let e of[".review-bodyfull-read",".review-body",".text",'[itemprop="reviewBody"]',".comment-body",".post-body",".text-content"]){let t=o(r).find(e).first();if(t.length>0&&(t.find(".box, .user-stats, .review-helpful, .read-more, .button").remove(),p=t.html()?.trim()||"",g=t.text()?.trim()||""))break}if(!g){let e=o(r).clone();e.find(".avatar, .user-stats, .rating-overall, .review-rating, .review-helpful, .review-tag, .datetime, .post-header, a").remove(),g=e.text().trim(),p=e.html()?.trim()||""}let f="",v=o(r).find('.review-title, h3, h4, [itemprop="headline"], .post-header h1, .post-header h2').first();if(v.length>0)f=v.text().trim();else if(g.length>0){let e=g.split("\n")[0].trim();f=e.length>50?e.substring(0,50)+"...":e}else f=`${s}의 리뷰`;let b={reviewId:a,username:s,userProfileUrl:c,userImage:d,status:u,watchedEpisodes:0,totalEpisodes:0,createdAt:h,rating:w,storyRating:0,actingRating:0,musicRating:0,rewatchRating:0,title:f,reviewText:g,reviewHtml:p,helpfulCount:0,commentCount:0,reviewUrl:"",sourceUrl:t,crawledAt:new Date};i.push(b)}catch(e){}}),e.includes("review")&&0===i.length&&([{name:"review 클래스",regex:/class=["']review["']/g},{name:"review-body 클래스",regex:/class=["']review-body["']/g},{name:"rating-overall 클래스",regex:/class=["']rating-overall["']/g},{name:"ratingValue 항목",regex:/itemprop=["']ratingValue["']/g},{name:"reviewBody 항목",regex:/itemprop=["']reviewBody["']/g},{name:"author 항목",regex:/itemprop=["']author["']/g},{name:"datePublished 항목",regex:/itemprop=["']datePublished["']/g},{name:"data-rating 속성",regex:/data-rating=["']\d+(\.\d+)?["']/g},{name:'data-section="reviews"',regex:/data-section=["']reviews["']/g}].forEach(t=>{(e.match(t.regex)||[]).length}),e.indexOf("review")>-1&&e.substring(Math.max(0,e.indexOf("review")-100),Math.min(e.length,e.indexOf("review")+500))),i}catch(e){return[]}}r()}catch(e){r(e)}})},35968:(e,t,o)=>{let r;o.r(t),o.d(t,{connectToDatabase:()=>c,dbConnect:()=>d,default:()=>u});var n=o(38013),a=o(92048),i=o.n(a),l=o(55315),s=o.n(l);{let e=o(25142),t=s().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await r,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}r=new n.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=c,u=r},47153:(e,t)=>{var o;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},71802:(e,t,o)=>{e.exports=o(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var o=t(t.s=68036);module.exports=o})();