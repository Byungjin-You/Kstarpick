"use strict";(()=>{var e={};e.id=9165,e.ids=[9165],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},74809:e=>{e.exports=require("node-fetch")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},20295:e=>{e.exports=import("cheerio")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},27569:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>c,routeModule:()=>p});var i=r(71802),n=r(47153),o=r(56249),s=r(67026),l=e([s]);s=(l.then?(await l)():l)[0];let c=(0,o.hoist)(s,"default"),d=(0,o.hoist)(s,"config"),p=new i.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/crawler/direct-review-crawler",pathname:"/api/crawler/direct-review-crawler",bundlePath:"",filename:""},userland:s});a()}catch(e){a(e)}})},67026:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>c}),r(41649);var i=r(20295),n=r(35968),o=r(74809),s=r.n(o),l=e([i]);async function c(e,t){if("POST"!==e.method)return t.status(405).json({success:!1,message:"허용되지 않는 메소드입니다."});try{let{url:a,dramaId:i}=e.body;if(!a)return t.status(400).json({success:!1,message:"URL이 필요합니다."});if(!i)return t.status(400).json({success:!1,message:"드라마 ID가 필요합니다."});let o=a;o.endsWith("/reviews")||(o.endsWith("/")&&(o=o.slice(0,-1)),o=`${o}/reviews`);let l=await s()(o,{method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","Accept-Encoding":"gzip, deflate, br","Cache-Control":"max-age=0",Connection:"keep-alive",Referer:"https://mydramalist.com/","sec-ch-ua":'"Google Chrome";v="120", "Chromium";v="120", "Not-A.Brand";v="24"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"same-origin","Sec-Fetch-User":"?1","Upgrade-Insecure-Requests":"1"},redirect:"follow",timeout:3e4});if(!l.ok)throw Error(`HTTP 요청 실패: ${l.status} ${l.statusText}`);let c=await l.text();if(!c||c.length<1e3)throw Error("HTML이 비어있거나 너무 짧습니다. 크롤링에 실패했습니다.");c.length>2e3&&(c.substring(0,1e3),c.substring(c.length-1e3));try{let e=r(92048),t=r(55315),a=t.join(process.cwd(),"debug");e.existsSync(a)||e.mkdirSync(a,{recursive:!0});let i=new Date().toISOString().replace(/[:.]/g,"-"),n=t.join(a,`direct-review-page-${i}.html`);e.writeFileSync(n,c)}catch(e){}let p=await d(c,o);if(p.length>0)try{let{db:e}=await (0,n.connectToDatabase)();for(let t of p)t.dramaId=i,await e.collection("reviews").findOne({reviewId:t.reviewId})?await e.collection("reviews").updateOne({reviewId:t.reviewId},{$set:t}):await e.collection("reviews").insertOne(t);let t=await e.collection("reviews").find({dramaId:i}).toArray(),r=t.length,a=0,o=0;for(let e of t)e.rating&&e.rating>0&&(a+=e.rating,o++);let s=o>0?a/o:0,l=Array(10).fill(0);for(let e of t)if(e.rating&&e.rating>0&&e.rating<=10){let t=Math.floor(e.rating)-1;t>=0&&t<10&&l[t]++}await e.collection("dramas").updateOne({_id:i},{$set:{reviewCount:r,reviewRating:s,ratingDistribution:l}})}catch(e){throw e}return t.status(200).json({success:!0,message:`${p.length}개의 리뷰를 크롤링했습니다.`,data:{reviews:p}})}catch(e){return t.status(500).json({success:!1,message:"크롤링 중 오류가 발생했습니다.",error:e.message,stack:e.stack})}finally{}}async function d(e,t){try{let r=i.load(e);(e.match(/review/g)||[]).length,r(".box .box-header").each((e,t)=>{});let a=[{selector:".post",count:r(".post").length},{selector:".comment:not(.reply)",count:r(".comment:not(.reply)").length},{selector:".review",count:r(".review").length},{selector:'.box-header:contains("Reviews") + .box-body .post',count:r('.box-header:contains("Reviews") + .box-body .post').length},{selector:'.box-header:contains("Reviews") ~ .box-body .post',count:r('.box-header:contains("Reviews") ~ .box-body .post').length},{selector:'.box:contains("Reviews") .post',count:r('.box:contains("Reviews") .post').length},{selector:'.box:contains("Reviews") .comment:not(.reply)',count:r('.box:contains("Reviews") .comment:not(.reply)').length}];for(let e of a);let n=r();for(let e of a)e.count>n.length&&(n=r(e.selector),e.selector);let o=[];return n.slice(0,10).each((e,a)=>{try{r(a).attr("class"),r(a).find('.rating-overall, [itemprop="ratingValue"], .score, .rated').length,r(a).find('.review-body, .review-bodyfull, .review-bodyfull-read, [itemprop="reviewBody"], .text, .post-body, .text-content').length;let i=r(a).html();i.length>200&&i.substring(0,200);let n=r(a).attr("id")?.replace("review-","")||r(a).attr("data-id")||`direct-${e}-${Date.now()}`,s=r(a).find('a.user-display, a.text-primary[href^="/profile/"], a[href^="/profile/"], [itemprop="author"] a, .user-display').first(),l=s.text().trim()||r(a).find('[itemprop="author"], .user-display').text().trim()||"Unknown User",c=s.attr("href")?s.attr("href").startsWith("http")?s.attr("href"):"https://mydramalist.com"+s.attr("href"):"",d=r(a).find('.avatar img, img.avatar, img.user-avatar, [itemprop="image"]').attr("src")||"",p=r(a).find(".review-tag, .status, .review-status").first().text().trim()||"Completed",u=r(a).find('.datetime, [itemprop="datePublished"], .date, time, .post-header small, .text-muted small').first().text().trim(),h=new Date;if(u)try{if(u.includes("hour")){let e=parseInt(u)||0;h=new Date(Date.now()-36e5*e)}else if(u.includes("day")){let e=parseInt(u)||0;h=new Date(Date.now()-864e5*e)}else if(u.includes("month")){let e=parseInt(u)||0;h=new Date(Date.now()-2592e6*e)}else if(u.includes("year")){let e=parseInt(u)||0;h=new Date(Date.now()-31536e6*e)}else h=new Date(u),isNaN(h.getTime())&&(h=new Date)}catch(e){h=new Date}let m=0;if(r(a).attr("data-rating"))m=parseFloat(r(a).attr("data-rating"))||0;else{for(let e of[".rating-overall .score",'.score[itemprop="ratingValue"]','[class*="rating"] .score',".rated",".score",".rating span","span.rated"]){let t=r(a).find(e).first();if(t.length>0){let e=t.text().trim().match(/(\d+(\.\d+)?)/);if(e){m=parseFloat(e[1]);break}}}if(0===m){let e=r(a).find("span, div, strong").filter(function(){let e=r(this).text().trim();return/^\d+(\.\d+)?$/.test(e)&&10>=parseFloat(e)});e.length>0&&(m=parseFloat(e.first().text())||0)}}let g="",f="";for(let e of[".review-bodyfull-read",".review-body",".text",'[itemprop="reviewBody"]',".comment-body",".post-body",".text-content"]){let t=r(a).find(e).first();if(t.length>0){let e=t.clone();if(e.find(".box, .user-stats, .review-helpful, .review-tag, .rating-overall, .read-more, .button").remove(),f=e.html()?.trim()||"",g=e.text()?.trim()||"")break}}if(!g){let e=r(a).find("p");if(e.length>1){let t=[];e.each((e,a)=>{let i=r(a).text().trim();i.length>10&&t.push(i)}),t.length>0&&(g=t.join("\n\n"),f="<p>"+t.join("</p><p>")+"</p>")}}if(!g){let e=r(a).clone();e.find(".avatar, .user-stats, .rating-overall, .review-rating, .review-helpful, .review-tag, .datetime, .post-header, a, img, .spoiler-warning, .hidden-spoiler").remove(),e.find('[class*="rating"], [class*="score"], [class*="header"], [class*="title"], .user-display').remove(),g=e.text().trim(),f=e.html()?.trim()||"",g=g.replace(/\(\d+(\.\d+)?\)/g,"").trim()}if(!g||g.length<20){let e=r(a).clone();e.find("h3, h4, .review-title, .post-header, .avatar, .rating-overall").remove(),(g=e.text().trim().replace(RegExp(l,"g"),"").replace(/Completed|Watching|Dropped|Plan to Watch|On Hold|\d+\/\d+|\d+ of \d+/g,"").replace(/Main Role|Support Role|Guest Role/g,"").replace(/Overall:|Story:|Acting:|Music:|Rewatch:/gi,"").replace(/\d+(\.\d+)?\/10/g,"").replace(/\s{2,}/g," ").trim())&&(f=`<p>${g}</p>`)}if(g&&g.length>0&&(g=g.replace(/(?:Overall|Story|Acting|Cast|Music|Rewatch)(?:\s*(?::|Value|Rating))?\s*\d+(?:\.\d+)?(?:\/\d+)?/gi,"").replace(/(?:Rating|Score):\s*\d+(?:\.\d+)?(?:\/\d+)?/gi,"").replace(/\(\d+(?:\.\d+)?\/\d+\)/g,"").replace(/\s{2,}/g," ").trim()).length>0){let e=g.split(/\n{2,}/);f=e.length>1?"<p>"+e.join("</p><p>")+"</p>":`<p>${g}</p>`}g||(g="내용 없음",f="<p>내용 없음</p>");let w="";for(let e of[".review-title","h3","h4",'[itemprop="headline"]',".post-header h1",".post-header h2"]){let t=r(a).find(e).first();if(t.length>0&&(w=t.text().trim()))break}if(!w&&g&&"내용 없음"!==g){let e=g.split("\n")[0].trim();w=e.length>50?e.substring(0,50)+"...":e}else w||(w=`${l}의 리뷰`);let v={reviewId:n,username:l,userProfileUrl:c,userImage:d,status:p,watchedEpisodes:0,totalEpisodes:0,createdAt:h,rating:m,storyRating:0,actingRating:0,musicRating:0,rewatchRating:0,title:w,reviewText:g,reviewHtml:f,helpfulCount:0,commentCount:0,reviewUrl:"",sourceUrl:t,crawledAt:new Date};o.push(v)}catch(e){}}),o}catch(e){return[]}}i=(l.then?(await l)():l)[0],a()}catch(e){a(e)}})},35968:(e,t,r)=>{let a;r.r(t),r.d(t,{connectToDatabase:()=>c,dbConnect:()=>d,default:()=>p});var i=r(38013),n=r(92048),o=r.n(n),s=r(55315),l=r.n(s);{let e=r(25142),t=l().resolve(process.cwd(),".env.production");o().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await a,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}a=new i.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=c,p=a},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=27569);module.exports=r})();