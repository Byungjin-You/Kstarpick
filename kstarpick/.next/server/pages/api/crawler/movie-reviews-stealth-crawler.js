"use strict";(()=>{var e={};e.id=6247,e.ids=[6247],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},60614:e=>{e.exports=require("next-auth/jwt")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},19828:e=>{e.exports=require("puppeteer-extra")},43199:e=>{e.exports=require("puppeteer-extra-plugin-stealth")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},20295:e=>{e.exports=import("cheerio")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},60843:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>d,routeModule:()=>c});var i=r(71802),n=r(47153),o=r(56249),l=r(59387),s=e([l]);l=(s.then?(await s)():s)[0];let d=(0,o.hoist)(l,"default"),u=(0,o.hoist)(l,"config"),c=new i.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/crawler/movie-reviews-stealth-crawler",pathname:"/api/crawler/movie-reviews-stealth-crawler",bundlePath:"",filename:""},userland:l});a()}catch(e){a(e)}})},69176:(e,t,r)=>{r.r(t),r.d(t,{default:()=>o});var a=r(11185),i=r.n(a);let n=new(i()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),o=i().models.Review||i().model("Review",n)},59387:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>m}),r(41649);var i=r(19828),n=r.n(i),o=r(43199),l=r.n(o),s=r(20295),d=r(35968),u=r(38013);r(69176),r(60614);var c=e([s]);s=(c.then?(await c)():c)[0],n().use(l()());let p=()=>{let e=Math.floor(1500*Math.random())+500;return new Promise(t=>setTimeout(t,e))};async function m(e,t){let r;if("POST"!==e.method)return t.status(405).json({message:"허용되지 않는 요청 방식입니다."});try{let{url:a,dramaId:i}=e.body;if(!a||!i)return t.status(400).json({message:"URL과 드라마 ID가 필요합니다."});r=await n().launch({headless:"new",args:["--no-sandbox","--disable-setuid-sandbox","--disable-infobars","--window-position=0,0","--ignore-certificate-errors","--ignore-certificate-errors-spki-list","--disable-dev-shm-usage"],ignoreHTTPSErrors:!0,defaultViewport:{width:1920,height:1080}});let o=await r.newPage();await o.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"webdriver",{get:()=>!1}),window.navigator.chrome={runtime:{}},Object.defineProperty(navigator,"plugins",{get:()=>[{0:{type:"application/x-google-chrome-pdf",suffixes:"pdf",description:"Portable Document Format",enabledPlugin:Plugin},description:"Portable Document Format",filename:"internal-pdf-viewer",length:1,name:"Chrome PDF Plugin"},{0:{type:"application/pdf",suffixes:"pdf",description:"",enabledPlugin:Plugin},description:"",filename:"mhjfbmdgcfjbbpaeojofohoefgiehjai",length:1,name:"Chrome PDF Viewer"}]})});let l=`${a}/reviews`;await o.goto(l,{waitUntil:"domcontentloaded",timeout:6e4}),await p();let c=0,m=!0;for(;m&&c<5;)try{let e=await o.$(".more-button");e?(await e.click(),c++,await p()):m=!1}catch(e){m=!1}let f=await o.content(),w=s.load(f),g=w("title").text().trim().replace(" Reviews - MyDramaList","").trim(),h=[];for(let e of[{selector:"#main-box-reviews .box-review",name:"main-box-reviews"},{selector:".global-items .review",name:"global-items"},{selector:".body-posts .review",name:"body-posts"}]){let t=w(e.selector);t.length>h.length&&(h=t,e.name)}let v=[];h.each((e,t)=>{try{w(t).attr("class"),w(t).attr("id");let e=w(t).attr("id")?w(t).attr("id").replace("review-",""):null,r=w(t).find(".review-title").text().trim(),a=w(t).find(".rating-overall .score"),n=0;if(a.length>0)n=parseFloat(a.text().trim());else{let e=w(t).find(".score");e.length>0&&(n=parseFloat(e.text().trim()))}let o="";for(let e of[".review-body",".review-bodyfull-read",".review-bodypartial-read"]){let r=w(t).find(e);if(r.length>0){let e=r.clone();e.find(".read-more, .button, .box, .user-stats, .review-helpful").remove();let t=e.text().trim();t&&t.length>o.length&&(o=t)}}let l=w(t).find(".review-meta").text().trim(),s=w(t).find(".username a").text().trim();e&&o&&v.push({mdlId:e,title:r||`${g.substring(0,30)}... Review`,content:o,rating:n,date:l,username:s,dramaId:i,source:"mydramalist"})}catch(e){}});let{db:b}=await (0,d.connectToDatabase)(),y=[];for(let e of v)try{await b.collection("reviews").findOne({mdlId:e.mdlId,dramaId:e.dramaId})?await b.collection("reviews").updateOne({mdlId:e.mdlId,dramaId:e.dramaId},{$set:e}):await b.collection("reviews").insertOne(e),y.push(e)}catch(e){}let P=await b.collection("reviews").find({dramaId:i}).toArray(),x=P.map(e=>e.rating).filter(e=>e>0),S=x.length>0?Math.round(x.reduce((e,t)=>e+t,0)/x.length*10)/10:0,A=Array(10).fill(0);return x.forEach(e=>{e>0&&e<=10&&A[Math.ceil(e)-1]++}),await b.collection("dramas").updateOne({_id:new u.ObjectId(i)},{$set:{reviewCount:P.length,reviewRating:S,ratingDistribution:A}}),t.status(200).json({message:`${y.length}개 리뷰 크롤링 및 저장 완료`,reviewCount:y.length,averageRating:S})}catch(e){return t.status(500).json({message:"리뷰 크롤링 중 오류가 발생했습니다.",error:e.message})}finally{r&&await r.close()}}a()}catch(e){a(e)}})},35968:(e,t,r)=>{let a;r.r(t),r.d(t,{connectToDatabase:()=>d,dbConnect:()=>u,default:()=>c});var i=r(38013),n=r(92048),o=r.n(n),l=r(55315),s=r.n(l);{let e=r(25142),t=s().resolve(process.cwd(),".env.production");o().existsSync(t)&&e.config({path:t}).error}async function d(){try{let e=await a,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}a=new i.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let u=d,c=a},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=60843);module.exports=r})();