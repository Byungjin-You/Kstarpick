"use strict";(()=>{var e={};e.id=8909,e.ids=[8909],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},19828:e=>{e.exports=require("puppeteer-extra")},43199:e=>{e.exports=require("puppeteer-extra-plugin-stealth")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},20295:e=>{e.exports=import("cheerio")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},81167:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>c,routeModule:()=>u});var i=a(71802),n=a(47153),o=a(56249),l=a(8433),s=e([l]);l=(s.then?(await s)():s)[0];let c=(0,o.hoist)(l,"default"),d=(0,o.hoist)(l,"config"),u=new i.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/crawler/reviews-stealth-crawler",pathname:"/api/crawler/reviews-stealth-crawler",bundlePath:"",filename:""},userland:l});r()}catch(e){r(e)}})},69176:(e,t,a)=>{a.r(t),a.d(t,{default:()=>o});var r=a(11185),i=a.n(r);let n=new(i()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),o=i().models.Review||i().model("Review",n)},8433:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>p}),a(41649);var i=a(19828),n=a.n(i),o=a(43199),l=a.n(o),s=a(20295),c=a(11185),d=a.n(c);a(35968);var u=a(69176),m=e([s]);s=(m.then?(await m)():m)[0],n().use(l()());let w="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",v=e=>new Promise(t=>setTimeout(t,e)),b=async(e=500,t=3e3)=>{let a=Math.floor(Math.random()*(t-e))+e;return await v(a),a};async function p(e,t){let a;if("POST"!==e.method)return t.status(405).json({success:!1,message:"허용되지 않는 메소드입니다."});try{d().connections[0].readyState||await d().connect(w,{useUnifiedTopology:!0,useNewUrlParser:!0});let{url:r,dramaId:i}=e.body;if(!r)return t.status(400).json({success:!1,message:"URL이 필요합니다."});if(!i)return t.status(400).json({success:!1,message:"드라마 ID가 필요합니다."});let o=r;o.endsWith("/reviews")||(o.endsWith("/")&&(o=o.slice(0,-1)),o=`${o}/reviews`),l()().enabledEvasions.delete("webgl.vendor"),l()().enabledEvasions.delete("navigator.plugins"),a=await n().launch({headless:"new",args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu","--disable-extensions","--window-size=1920,1080","--disable-features=site-per-process","--js-flags=--max-old-space-size=4096","--no-zygote","--single-process","--disable-blink-features=AutomationControlled","--disable-web-security","--ignore-certificate-errors","--allow-running-insecure-content"],ignoreHTTPSErrors:!0,timeout:12e4,defaultViewport:{width:1920,height:1080}});let s=await a.newPage();await s.setUserAgent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15"),await s.setExtraHTTPHeaders({"Accept-Language":"en-US,en;q=0.9,ko;q=0.8",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br","Cache-Control":"max-age=0",Connection:"keep-alive","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Sec-Fetch-User":"?1","Upgrade-Insecure-Requests":"1",Referer:"https://www.google.com/"}),await s.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"webdriver",{get:()=>!1}),delete navigator.__proto__.webdriver,Object.defineProperty(navigator,"plugins",{get:()=>{let e=[{0:{type:"application/x-google-chrome-pdf",description:"Portable Document Format"},name:"Chrome PDF Plugin",filename:"internal-pdf-viewer",description:"Portable Document Format",length:1},{0:{type:"application/pdf",description:""},name:"Chrome PDF Viewer",filename:"mhjfbmdgcfjbbpaeojofohoefgiehjai",description:"",length:1},{0:{type:"application/x-nacl",description:"Native Client Executable"},name:"Native Client",filename:"internal-nacl-plugin",description:"",length:1}];return{...e,length:e.length,item:t=>e[t],namedItem:t=>e.find(e=>e.name===t),refresh:()=>{}}}}),Object.defineProperty(navigator,"language",{get:()=>"en-US"}),Object.defineProperty(navigator,"languages",{get:()=>["en-US","en","ko"]}),Object.defineProperty(navigator,"hardwareConcurrency",{get:()=>8}),Object.defineProperty(screen,"colorDepth",{get:()=>24}),navigator.userAgentData&&(Object.defineProperty(navigator.userAgentData,"brands",{get:()=>[{brand:"Safari",version:"17.0"},{brand:"AppleWebKit",version:"605.1.15"}]}),Object.defineProperty(navigator.userAgentData,"mobile",{get:()=>!1}),Object.defineProperty(navigator.userAgentData,"platform",{get:()=>"macOS"})),window.chrome={app:{isInstalled:!1},webstore:{onInstallStageChanged:{},onDownloadProgress:{}},runtime:{PlatformOs:{MAC:"mac",WIN:"win",ANDROID:"android",CROS:"cros",LINUX:"linux",OPENBSD:"openbsd"},PlatformArch:{ARM:"arm",X86_32:"x86-32",X86_64:"x86-64"},PlatformNaclArch:{ARM:"arm",X86_32:"x86-32",X86_64:"x86-64"},RequestUpdateCheckStatus:{THROTTLED:"throttled",NO_UPDATE:"no_update",UPDATE_AVAILABLE:"update_available"},OnInstalledReason:{INSTALL:"install",UPDATE:"update",CHROME_UPDATE:"chrome_update",SHARED_MODULE_UPDATE:"shared_module_update"},OnRestartRequiredReason:{APP_UPDATE:"app_update",OS_UPDATE:"os_update",PERIODIC:"periodic"}}}}),await s.setRequestInterception(!0),s.on("request",e=>{let t=e.resourceType(),a=e.url();["image","font","media"].includes(t)||a.includes("google-analytics")||a.includes("googletagmanager")||a.includes("facebook")||a.includes("twitter")||a.includes("analytics")?e.abort():e.continue()}),await s.setCookie({name:"cf_clearance",value:"cleared",domain:".mydramalist.com",path:"/"},{name:"cf_chl_2",value:"cleared",domain:".mydramalist.com",path:"/"},{name:"cf_chl_prog",value:"cleared",domain:".mydramalist.com",path:"/"});try{await s.goto(o,{waitUntil:["domcontentloaded","networkidle2"],timeout:9e4})}catch(e){}if(await s.evaluate(()=>document.title.includes("Just a moment")||document.title.includes("Cloudflare")||document.body.innerText.includes("Checking your browser")||document.body.innerText.includes("DDoS protection by Cloudflare"))){let e=0;for(;e<10&&(await v(3e3),e++,await s.evaluate(()=>document.title.includes("Just a moment")||document.title.includes("Cloudflare")||document.body.innerText.includes("Checking your browser")));)await s.mouse.move(100+Math.floor(500*Math.random()),100+Math.floor(300*Math.random()))}await s.waitForFunction(()=>"complete"===document.readyState||document.querySelectorAll(".box, .post, .comment, #content").length>0,{timeout:3e4}).catch(e=>console.log("초기 로딩 대기 타임아웃:",e.message));let c=await s.title();if(c.includes("not found")||c.includes("404"))throw Error("페이지를 찾을 수 없습니다. URL을 확인해주세요.");await b(1e3,3e3),await s.evaluate(async()=>{let e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),t=0;for(;t<e;){let e=Math.floor(300*Math.random())+100;if(t+=e,window.scrollTo(0,t),await new Promise(e=>setTimeout(e,Math.floor(300*Math.random())+100)),.2>Math.random()&&t>300){let e=Math.floor(200*Math.random())+50;t-=e,window.scrollTo(0,t),await new Promise(e=>setTimeout(e,Math.floor(200*Math.random())+100))}}let a=Array.from(document.querySelectorAll("h1, h2, h3, h4, .box-header")).filter(e=>e.textContent.includes("Reviews"));a.length>0&&(a[0].scrollIntoView({behavior:"smooth"}),await new Promise(e=>setTimeout(e,1e3)))});try{for(let e of[".load-more",".more-reviews",".show-more",'button:contains("Show More")','a:contains("Show More")','button:contains("Load More")','a:contains("Load More")',".reviews-pagination .next",".pagination .next",".more",".show-full-review",".read-more",".expand-review"])if(await s.evaluate(e=>{if(e.includes(":contains(")){let t=e.match(/:contains\("(.+?)"\)/)[1],a=e.split(":")[0];return Array.from(document.querySelectorAll(a)).some(e=>e.textContent.includes(t)&&null!==e.offsetParent)}return Array.from(document.querySelectorAll(e)).filter(e=>{let t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&null!==e.offsetParent}).length>0},e)){for(let t=0;t<5;t++)try{if(await s.evaluate(e=>{let t=document.querySelector(e);t&&t.scrollIntoView({behavior:"smooth",block:"center"})},e),await b(500,2e3),!await s.evaluate(e=>{let t=document.querySelector(e);if(!t)return!1;let a=window.getComputedStyle(t);return"none"!==a.display&&"hidden"!==a.visibility&&"0"!==a.opacity&&null!==t.offsetParent&&!t.disabled},e)||(await s.click(e),await b(2e3,5e3),await s.evaluate(e=>document.body.scrollHeight>e,await s.evaluate(()=>document.body.scrollHeight)),!await s.evaluate(e=>{let t=document.querySelector(e);return t&&null!==t.offsetParent&&!t.disabled},e)))break}catch(e){break}break}}catch(e){}await b(2e3,4e3);let u=await s.content(),m=await f(u,o);return m.length>0&&await h(m,i),t.status(200).json({success:!0,message:`${m.length}개의 리뷰를 성공적으로 크롤링했습니다.`,data:{url:o,reviews:m}})}catch(e){return t.status(500).json({success:!1,message:"리뷰 크롤링 중 오류가 발생했습니다.",error:e.message})}finally{a&&await a.close()}}async function f(e,t){try{let a=s.load(e),r=a("title").text().trim();if(r.includes("not found")||r.includes("404")||e.includes("Just a moment")&&e.includes("Cloudflare"))return[];a("h1.film-title").first().text().trim()||a(".film-title, .box-header h1").first().text().trim()||a("h1").first().text().trim();let i=a();for(let e of[{container:'#content .box:has(.box-header:contains("Reviews"))',items:".post",name:"main-box-reviews"},{container:".review-list",items:".review-item, .post",name:"review-list-items"},{container:".user-reviews-box",items:".review, .post",name:"user-reviews"},{container:"#reviews-section",items:".review, .post",name:"reviews-section"},{container:"#app",items:".post, .review, .review-item, .comment:not(.reply)",name:"global-items"},{container:"body",items:".post",name:"body-posts"}]){let t=a(e.container);if(t.length>0){let a=t.find(e.items);a.length>i.length&&(i=a,e.name)}}if(0===i.length)for(let e of[".post, .review-item, .review, .comment:not(.reply)",".box .post, .box .comment:not(.reply)",".list-item:has(.review-body), .list-item:has(.text)",'[class*="review"], [id*="review"]']){let t=a(e);t.length>i.length&&(i=t)}a("#app > .app-content > div").each((e,t)=>{a(t).attr("class"),a(t).attr("id")});let n=[];return i.each((e,r)=>{try{a(r).attr("class"),a(r).attr("id");let i="";if(a(r).attr("id")){let e=a(r).attr("id").match(/review-(\d+)|post-(\d+)|comment-(\d+)/i);i=e?e[1]||e[2]||e[3]:a(r).attr("id")}!i&&a(r).attr("data-id")&&(i=a(r).attr("data-id")),!i&&a(r).attr("data-review-id")&&(i=a(r).attr("data-review-id")),i||(i=`unknown-${t.split("/").pop()}-${e}-${Date.now()}`);let o="Unknown User",l="",s="";for(let e of['a[href^="/profile/"]',".user-name a",".user a",".profile-link",'.meta a[href^="/profile/"]',".user-display a",'.text-primary[href^="/profile/"]',".avatar-name",".reviewer-name"]){let t=a(r).find(e).first();if(t.length>0&&(o=t.text().trim(),l=t.attr("href")||"",o))break}for(let e of[".avatar img",".user-picture img",".profile-pic img",'[class*="avatar"] img',".user img"]){let t=a(r).find(e).first();if(t.length>0&&(s=t.attr("src")||""))break}let c=0;for(let e of[".overall-rating .score",".rating-overall .score",".score",".rated",'[itemprop="ratingValue"]',"span.score","div.score",".overall",".user-rating",".rating-value",".rating"]){let t=a(r).find(e).first();if(t.length>0){let e=t.text().trim().match(/(\d+(\.\d+)?)/);if(e){c=parseFloat(e[1]);break}}}let d="";for(let e of[".review-title","h3","h4",".post-title",".post-header h2",".title",".subject",".heading"]){let t=a(r).find(e).first();if(t.length>0&&(d=t.text().trim()))break}let u="";for(let e of[".review-body",".review-bodyfull",".review-bodyfull-read",".text",".post-body",".comment-body",'[itemprop="reviewBody"]',".text-content",".content",".description",".review-content",".review-description",".detail-content"]){let t=a(r).find(e).first();if(t.length>0){let e=t.clone();if(e.find(".box, .user-stats, .review-helpful, .review-tag, .rating-overall, script, style, .read-more, .button").remove(),(u=e.text().trim())&&u.length>=20)break}}if(!u||u.length<20){let e=a(r).find("p");if(e.length>0){let t=[];e.each(function(){let e=a(this);e.closest(".user-info, .rating, .score, .meta, .header, .title, .review-header, .avatar, .user").length||t.push(e.text().trim())}),t.length>0&&(u=t.join("\n\n"))}}if(!u||u.length<20){let e=a(r).clone();e.find(".avatar, .user-display, .rating-overall, .review-rating, .review-helpful, .review-tag, .datetime, .post-header, .user-stats, h1, h2, h3, h4, .title, .meta, .rating, .score, .header, script, style, .hidden, .visually-hidden").remove(),u=e.text().trim().replace(/\s{2,}/g," ").replace(/\n{2,}/g,"\n"),o&&"Unknown User"!==o&&(u=u.replace(RegExp(o,"g"),"")),u=u.replace(/\b(rated it|Rating|Score|Overall|Story|Acting|Music|Rewatch)\b\s*:?\s*\d+(\.\d+)?/gi,"").replace(/\b(Main Role|Support Role|Lead Role|Guest Role)\b/g,"").replace(/\b(Completed|Watching|Plan to Watch|On Hold|Dropped)\b/g,"").replace(/\d+\/\d+/g,"").replace(/\b(days?|weeks?|months?|years?) ago\b/g,"").trim()}if(!d&&u){let e=u.split("\n")[0].trim();d=e.length>50?`${e.substring(0,50)}...`:e}else d||(d=`${o}'s Review`);let m="";for(let e of[".date",".datetime",".review-date",".meta time","[datetime]",".post-date",".timestamp",".post-info time",".post-time"]){let t=a(r).find(e).first();if(t.length>0&&(m=t.text().trim()||t.attr("datetime")||"")){m=m.replace(/^\s*on\s+/i,"");break}}let p=0;for(let e of[".review-helpful",".helpful",".likes",".like-count",".reactions"]){let t=a(r).find(e).first();if(t.length>0){let e=t.text().trim().match(/(\d+)/);if(e){p=parseInt(e[1]);break}}}let f=a(r).html();u&&u.length>=20&&n.push({reviewId:i,username:o,userProfileUrl:l,userImage:s,rating:c,title:d,reviewText:u,reviewHtml:f,reviewDate:m,helpfulCount:p,createdAt:new Date,dramaId:null,sourceUrl:t})}catch(e){}}),0===n.length&&a("h1, h2").each((e,t)=>console.log(`  ${e+1}. ${a(t).text().trim()}`)),n}catch(e){return[]}}async function h(e,t){if(e&&0!==e.length)try{await d().connect(w,{useNewUrlParser:!0,useUnifiedTopology:!0,serverSelectionTimeoutMS:3e4,socketTimeoutMS:45e3,connectTimeoutMS:3e4}),e.forEach(e=>{e.dramaId=t});let a=0,r=0;for(let t=0;t<e.length;t+=5){let i=e.slice(t,t+5).map(async e=>{try{if(!e.reviewId||!e.title||!e.reviewText||!e.dramaId)return!1;let t=await u.default.updateOne({reviewId:e.reviewId},{$set:{...e,updatedAt:new Date}},{upsert:!0});return t.upsertedCount>0||t.modifiedCount>0}catch(e){return!1}});(await Promise.allSettled(i)).forEach(e=>{"fulfilled"===e.status&&!0===e.value?a++:r++}),t+5<e.length&&await v(500)}a>0&&await g(t)}catch(e){throw e}finally{try{0!==d().connection.readyState&&await d().connection.close()}catch(e){}}}async function g(e){try{let t=e;if("string"==typeof e)try{t=new(d()).Types.ObjectId(e)}catch(a){t=e}let a=await u.default.find({dramaId:t}).lean(),r=a.length,i=0,n=0;for(let e of a)e.rating&&e.rating>0&&(i+=e.rating,n++);let o=n>0?parseFloat((i/n).toFixed(1)):0,l=Array(10).fill(0);for(let e of a)if(e.rating&&e.rating>0&&e.rating<=10){let t=Math.floor(e.rating)-1;t>=0&&t<10&&l[t]++}let s=d().models.Drama||d().model("Drama",new(d()).Schema({},{strict:!1}));return await s.updateOne({_id:t},{$set:{reviewCount:r,reviewRating:o,ratingDistribution:l}}),!0}catch(e){return!1}}r()}catch(e){r(e)}})},35968:(e,t,a)=>{let r;a.r(t),a.d(t,{connectToDatabase:()=>c,dbConnect:()=>d,default:()=>u});var i=a(38013),n=a(92048),o=a.n(n),l=a(55315),s=a.n(l);{let e=a(25142),t=s().resolve(process.cwd(),".env.production");o().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await r,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}r=new i.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=c,u=r},47153:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},71802:(e,t,a)=>{e.exports=a(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=81167);module.exports=a})();