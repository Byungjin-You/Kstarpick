"use strict";(()=>{var e={};e.id=2123,e.ids=[2123],e.modules={98432:e=>{e.exports=require("bcryptjs")},25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},73227:e=>{e.exports=require("next-auth")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},66778:(e,t,a)=>{a.r(t),a.d(t,{config:()=>m,default:()=>d,routeModule:()=>p});var r={};a.r(r),a.d(r,{default:()=>c});var s=a(71802),o=a(47153),i=a(56249),n=a(35968),l=a(73227),u=a(69097);async function c(e,t){if("GET"!==e.method)return t.status(405).json({success:!1,message:"Method Not Allowed"});try{let a=await (0,l.getServerSession)(e,t,u.authOptions);if(!a||a.user?.role!=="admin")return t.status(401).json({success:!1,message:"관리자 권한이 필요합니다."});let{db:r}=await (0,n.connectToDatabase)(),{days:s=30}=e.query,o=new Date,i=new Date;i.setDate(o.getDate()-parseInt(s));let c=await r.collection("dramas").aggregate([{$match:{createdAt:{$gte:i,$lte:o}}},{$group:{_id:null,totalViews:{$sum:"$viewCount"},totalDramas:{$sum:1}}}]).toArray(),d=await r.collection("news").aggregate([{$match:{createdAt:{$gte:i,$lte:o}}},{$group:{_id:null,totalViews:{$sum:"$viewCount"},totalNews:{$sum:1}}}]).toArray(),m=await r.collection("tvfilms").aggregate([{$match:{createdAt:{$gte:i,$lte:o}}},{$group:{_id:null,totalViews:{$sum:"$viewCount"},totalMovies:{$sum:1}}}]).toArray(),p=await r.collection("musics").aggregate([{$match:{createdAt:{$gte:i,$lte:o}}},{$group:{_id:null,totalViews:{$sum:"$views"},totalMusic:{$sum:1}}}]).toArray(),w=await r.collection("news").aggregate([{$match:{createdAt:{$gte:i,$lte:o}}},{$group:{_id:{year:{$year:"$createdAt"},month:{$month:"$createdAt"},day:{$dayOfMonth:"$createdAt"}},views:{$sum:"$viewCount"},articles:{$sum:1}}},{$sort:{"_id.year":1,"_id.month":1,"_id.day":1}}]).toArray(),g=await r.collection("dramas").find({}).sort({viewCount:-1}).limit(10).project({title:1,viewCount:1,_id:0}).toArray(),v=await r.collection("news").find({}).sort({viewCount:-1}).limit(10).project({title:1,viewCount:1,_id:0}).toArray(),y=w.reduce((e,t)=>e+(t.views||0),0),$=(c[0]?.totalDramas||0)+(d[0]?.totalNews||0)+(m[0]?.totalMovies||0)+(p[0]?.totalMusic||0),h=w.length>0?Math.round(y/w.length):0,f={success:!0,period:{startDate:i.toISOString().split("T")[0],endDate:o.toISOString().split("T")[0],days:parseInt(s)},summary:{totalViews:y,totalContent:$,dailyAverage:h,estimatedDailyVisitors:Math.round(.7*h)},breakdown:{dramas:{views:c[0]?.totalViews||0,count:c[0]?.totalDramas||0},news:{views:d[0]?.totalViews||0,count:d[0]?.totalNews||0},movies:{views:m[0]?.totalViews||0,count:m[0]?.totalMovies||0},music:{views:p[0]?.totalViews||0,count:p[0]?.totalMusic||0}},dailyTrends:w.map(e=>({date:`${e._id.year}-${String(e._id.month).padStart(2,"0")}-${String(e._id.day).padStart(2,"0")}`,views:e.views,articles:e.articles})),topContent:{dramas:g,news:v}};return t.status(200).json(f)}catch(e){return t.status(500).json({success:!1,message:"통계 조회 중 오류가 발생했습니다.",error:e.message})}}let d=(0,i.hoist)(r,"default"),m=(0,i.hoist)(r,"config"),p=new s.PagesAPIRouteModule({definition:{kind:o.RouteKind.PAGES_API,page:"/api/analytics/visitors",pathname:"/api/analytics/visitors",bundlePath:"",filename:""},userland:r})},69097:(e,t,a)=>{a.r(t),a.d(t,{authOptions:()=>c,default:()=>d});var r=a(73227),s=a.n(r);let o=require("next-auth/providers/credentials");var i=a.n(o),n=a(35968),l=a(98432),u=a.n(l);let c={providers:[i()({name:"Credentials",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){try{let{db:t}=await (0,n.connectToDatabase)(),a=await t.collection("users").findOne({email:e.email});if(!a||!await u().compare(e.password,a.password))return null;return{id:a._id.toString(),name:a.name,email:a.email,role:a.role}}catch(e){return null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.id,e.user.role=t.role),e)},pages:{signIn:"/auth/signin",error:"/auth/error"},debug:!1,secret:"kstarpick_nextauth_secret_key_2024_production"},d=s()(c)},35968:(e,t,a)=>{let r;a.r(t),a.d(t,{connectToDatabase:()=>u,dbConnect:()=>c,default:()=>d});var s=a(38013),o=a(92048),i=a.n(o),n=a(55315),l=a.n(n);{let e=a(25142),t=l().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function u(){try{let e=await r,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}r=new s.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let c=u,d=r},47153:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},71802:(e,t,a)=>{e.exports=a(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=66778);module.exports=a})();