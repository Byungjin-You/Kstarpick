"use strict";(()=>{var e={};e.id=2123,e.ids=[2123],e.modules={84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},66778:(e,t,a)=>{a.r(t),a.d(t,{config:()=>d,default:()=>u,routeModule:()=>m});var o={};a.r(o),a.d(o,{default:()=>l});var n=a(71802),i=a(47153),r=a(56249),s=a(35968),c=a(86044);async function l(e,t){if("GET"!==e.method)return t.status(405).json({success:!1,message:"Method Not Allowed"});try{if(!await (0,c.isAdmin)(e))return t.status(401).json({success:!1,message:"관리자 권한이 필요합니다."});let{db:a}=await (0,s.connectToDatabase)(),{days:o=30}=e.query,n=new Date,i=new Date;i.setDate(n.getDate()-parseInt(o));let r=await a.collection("dramas").aggregate([{$match:{updatedAt:{$gte:i,$lte:n}}},{$group:{_id:null,totalViews:{$sum:"$viewCount"},totalDramas:{$sum:1}}}]).toArray(),l=await a.collection("news").aggregate([{$match:{createdAt:{$gte:i,$lte:n}}},{$group:{_id:null,totalViews:{$sum:"$viewCount"},totalNews:{$sum:1}}}]).toArray(),u=await a.collection("tvfilms").aggregate([{$match:{updatedAt:{$gte:i,$lte:n}}},{$group:{_id:null,totalViews:{$sum:"$viewCount"},totalMovies:{$sum:1}}}]).toArray(),d=await a.collection("musics").aggregate([{$match:{updatedAt:{$gte:i,$lte:n}}},{$group:{_id:null,totalViews:{$sum:"$views"},totalMusic:{$sum:1}}}]).toArray(),m=await a.collection("news").aggregate([{$match:{createdAt:{$gte:i,$lte:n}}},{$group:{_id:{year:{$year:"$createdAt"},month:{$month:"$createdAt"},day:{$dayOfMonth:"$createdAt"}},views:{$sum:"$viewCount"},articles:{$sum:1}}},{$sort:{"_id.year":1,"_id.month":1,"_id.day":1}}]).toArray(),p=await a.collection("dramas").find({}).sort({viewCount:-1}).limit(10).project({title:1,viewCount:1,_id:0}).toArray(),w=await a.collection("news").find({}).sort({viewCount:-1}).limit(10).project({title:1,viewCount:1,_id:0}).toArray(),y=(r[0]?.totalViews||0)+(l[0]?.totalViews||0)+(u[0]?.totalViews||0)+(d[0]?.totalViews||0),h=(r[0]?.totalDramas||0)+(l[0]?.totalNews||0)+(u[0]?.totalMovies||0)+(d[0]?.totalMusic||0),g=Math.round(y/parseInt(o)),f={success:!0,period:{startDate:i.toISOString().split("T")[0],endDate:n.toISOString().split("T")[0],days:parseInt(o)},summary:{totalViews:y,totalContent:h,dailyAverage:g,estimatedDailyVisitors:Math.round(.7*g)},breakdown:{dramas:{views:r[0]?.totalViews||0,count:r[0]?.totalDramas||0},news:{views:l[0]?.totalViews||0,count:l[0]?.totalNews||0},movies:{views:u[0]?.totalViews||0,count:u[0]?.totalMovies||0},music:{views:d[0]?.totalViews||0,count:d[0]?.totalMusic||0}},dailyTrends:m.map(e=>({date:`${e._id.year}-${String(e._id.month).padStart(2,"0")}-${String(e._id.day).padStart(2,"0")}`,views:e.views,articles:e.articles})),topContent:{dramas:p,news:w}};return t.status(200).json(f)}catch(e){return t.status(500).json({success:!1,message:"통계 조회 중 오류가 발생했습니다.",error:e.message})}}let u=(0,r.hoist)(o,"default"),d=(0,r.hoist)(o,"config"),m=new n.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/analytics/visitors",pathname:"/api/analytics/visitors",bundlePath:"",filename:""},userland:o})},86044:(e,t,a)=>{let o=a(99344),{connectToDatabase:n}=a(35968),{ObjectId:i}=a(38013),{parse:r}=a(84802),s=a(44756),c=a(81075),l="kstarpick_jwt_secret_key_2024_production";async function u(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=r(e.headers.cookie).token),!t)return null;try{let e=o.verify(t,l);try{await s();let t=await c.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await n(),a=await t.collection("users").findOne({_id:new i(e.id)});if(a)return{_id:a._id,id:a._id,name:a.name,email:a.email,isAdmin:"admin"===a.role,role:a.role}}catch(e){}return null}catch(e){return null}}async function d(e){try{let t=await u(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return o.sign(e,l,{expiresIn:"7d"})},verifyToken:u,isAdmin:d}},44756:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var o=a(11185),n=a.n(o);a(25142).config({path:".env.production"});let i="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";i||(i="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),i.includes("localhost")||(i.includes("mongodb://")&&!i.includes("authSource=")&&(i.includes("?")?i+="&authSource=admin":i+="?authSource=admin"),!i.includes("docdb.amazonaws.com")||i.includes("authMechanism=")||(i.includes("?")?i+="&authMechanism=SCRAM-SHA-1":i+="?authMechanism=SCRAM-SHA-1"));let r=i.includes("localhost")||i.includes("127.0.0.1"),s=global.mongoose;async function c(){if(s.conn&&1===n().connection.readyState)return s.conn;if(0===n().connection.readyState||3===n().connection.readyState){s.conn=null,s.promise=null;try{await n().connection.close()}catch(e){}}if(!s.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};r||(i.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),s.promise=n().connect(i,e).then(e=>(e.connection.on("error",e=>{s.conn=null,s.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{s.conn=null,s.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw s.promise=null,e})}try{return s.conn=await s.promise,s.conn}catch(e){throw s.promise=null,e}}s||(s=global.mongoose={conn:null,promise:null});let l=c},81075:(e,t,a)=>{a.r(t),a.d(t,{default:()=>r});var o=a(11185),n=a.n(o);let i=new(n()).Schema({name:{type:String,required:[!0,"Please provide a name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},image:{type:String,default:"/images/default-avatar.png"},role:{type:String,enum:["user","admin","editor"],default:"user"},likes:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},dislikes:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},bookmarks:{type:[{contentId:{type:n().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),r=n().models.User||n().model("User",i)},35968:(e,t,a)=>{let o;a.r(t),a.d(t,{connectToDatabase:()=>l,dbConnect:()=>u,default:()=>d});var n=a(38013),i=a(92048),r=a.n(i),s=a(55315),c=a.n(s);{let e=a(25142),t=c().resolve(process.cwd(),".env.production");r().existsSync(t)&&e.config({path:t}).error}async function l(){try{let e=await o,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}o=new n.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let u=l,d=o},47153:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},71802:(e,t,a)=>{e.exports=a(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=66778);module.exports=a})();