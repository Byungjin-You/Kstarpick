"use strict";(()=>{var e={};e.id=992,e.ids=[992],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},65567:(e,t,r)=>{r.r(t),r.d(t,{config:()=>d,default:()=>l,routeModule:()=>u});var a={};r.r(a),r.d(a,{default:()=>c});var s=r(71802),i=r(47153),n=r(56249),o=r(35968);async function c(e,t){let{db:r}=await (0,o.connectToDatabase)();if("GET"===e.method)try{let{page:a=1,limit:s=10,sortBy:i="updatedAt",sortOrder:n="desc",title:o="",category:c="",status:l="",featured:d="",includeAllFields:u="false"}=e.query,m=parseInt(a),g=parseInt(s),p=(m-1)*g,h={};o&&(h.title={$regex:o,$options:"i"}),c&&"all"!==c&&(h.category=c),l&&"all"!==l&&(h.status=l),"true"===d?h.featured=!0:"false"===d&&(h.featured=!1);let f={};"true"!==u&&(f={title:1,slug:1,category:1,status:1,mdlId:1,coverImage:1,network:1,featured:1,updatedAt:1,createdAt:1,genres:1,genre:1,rating:1,reviewRating:1,orderNumber:1,previousOrderNumber:1,description:1,summary:1});let w={};if("orderNumber"===i){let e=[{$match:h},{$addFields:{sortOrder:{$cond:{if:{$gt:["$orderNumber",null]},then:"$orderNumber",else:999999}}}},{$sort:{sortOrder:"asc"===n?1:-1,updatedAt:-1}},{$skip:p},{$limit:g}];Object.keys(f).length>0&&e.push({$project:f});let a=await r.collection("dramas").aggregate(e).toArray(),s=await r.collection("dramas").countDocuments(h);return t.status(200).json({success:!0,data:a,pagination:{total:s,page:m,limit:g,pages:Math.ceil(s/g)}})}w[i]="asc"===n?1:-1;let v=await r.collection("dramas").find(h,{projection:f}).sort(w).skip(p).limit(g).toArray(),P=await r.collection("dramas").countDocuments(h);return t.status(200).json({success:!0,data:v,pagination:{total:P,page:m,limit:g,pages:Math.ceil(P/g)}})}catch(e){return t.status(500).json({success:!1,message:"드라마 조회 중 오류가 발생했습니다.",error:e.message})}else if("POST"!==e.method)return t.status(405).json({success:!1,message:"허용되지 않는 메소드입니다."});else try{let a;let s=e.body;if(!s||!s.title)return t.status(400).json({success:!1,message:"유효한 드라마 데이터가 필요합니다."});if(s.synopsis&&!s.summary&&(s.summary=s.synopsis),s.posterImage&&!s.coverImage&&(s.coverImage=s.posterImage),s.nativeTitle&&!s.originalTitle&&(s.originalTitle=s.nativeTitle),s.airsInfo&&!s.releaseDate&&(s.releaseDate=s.airsInfo),s.contentRating&&!s.ageRating&&(s.ageRating=s.contentRating),s.backgroundImage&&!s.bannerImage&&(s.bannerImage=s.backgroundImage),(!s.watchProviders||0===s.watchProviders.length)&&(s.whereToWatch&&s.whereToWatch.length>0?s.watchProviders=s.whereToWatch:s.streamingServices&&s.streamingServices.length>0?s.watchProviders=s.streamingServices.map(e=>({name:e.name,link:e.url,imageUrl:e.logo,type:e.type})):s.credits?.watchProviders&&s.credits.watchProviders.length>0&&(s.watchProviders=s.credits.watchProviders)),s.credits?.directors&&s.credits.directors.length>0&&(s.directors&&0!==s.directors.length||(s.directors=s.credits.directors),s.director||(s.director=s.credits.directors[0]?.name||"")),s.credits?.writers&&s.credits.writers.length>0&&(!s.screenwriters||0===s.screenwriters.length)&&(s.screenwriters=s.credits.writers.map(e=>({name:e.name,image:e.image||""}))),!s.cast||!s.cast.mainRoles&&!s.cast.supportRoles){let e=s.credits?.mainCast?.map(e=>({name:e.name,role:e.role,image:e.image}))||[],t=s.credits?.supportCast?.map(e=>({name:e.name,role:e.role,image:e.image}))||[];(e.length>0||t.length>0)&&(s.cast={mainRoles:e,supportRoles:t})}if(!s.status&&s.airsInfo){let e=s.airsInfo.toLowerCase(),t=new Date;e.includes("upcoming")||s.startDate&&new Date(s.startDate)>t?s.status="Upcoming":e.includes("airing")||e.includes("ongoing")||s.startDate&&new Date(s.startDate)<=t&&(!s.endDate||new Date(s.endDate)>=t)?s.status="Airing":(s.endDate&&s.endDate,s.status="Completed")}let i=new Date;s.createdAt=i,s.updatedAt=i;let n={};s.url?n.url=s.url:s.mdlUrl?n.mdlUrl=s.mdlUrl:s.id?n.id=s.id:s.title&&(n.title=s.title);let o=await r.collection("dramas").findOne(n);if(o){let e={...s,_id:o._id,createdAt:o.createdAt||new Date,updatedAt:new Date};if(o.slug)e.slug=o.slug;else if(!e.slug){let t=s.title.toLowerCase().replace(/[^a-z0-9ㄱ-ㅎㅏ-ㅣ가-힣]+/g,"-").replace(/^-|-$/g,""),r=Date.now().toString().slice(-6);e.slug=`${t}-${r}`}return a=await r.collection("dramas").replaceOne({_id:o._id},e),t.status(200).json({success:!0,message:"기존 항목이 업데이트되었습니다.",data:{_id:o._id,title:e.title,slug:e.slug,isUpdate:!0}})}if(!s.slug){let e=s.title.toLowerCase().replace(/[^a-z0-9ㄱ-ㅎㅏ-ㅣ가-힣]+/g,"-").replace(/^-|-$/g,""),t=Date.now().toString().slice(-6);s.slug=`${e}-${t}`}return a=await r.collection("dramas").insertOne(s),t.status(201).json({success:!0,message:"드라마가 성공적으로 생성되었습니다.",data:{_id:a.insertedId,title:s.title,slug:s.slug}})}catch(e){return t.status(500).json({success:!1,message:"드라마 생성 중 오류가 발생했습니다.",error:e.message,details:e.stack})}}r(41649),r(38013);let l=(0,n.hoist)(a,"default"),d=(0,n.hoist)(a,"config"),u=new s.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/dramas",pathname:"/api/dramas",bundlePath:"",filename:""},userland:a})},35968:(e,t,r)=>{let a;r.r(t),r.d(t,{connectToDatabase:()=>l,dbConnect:()=>d,default:()=>u});var s=r(38013),i=r(92048),n=r.n(i),o=r(55315),c=r.n(o);{let e=r(25142),t=c().resolve(process.cwd(),".env.production");n().existsSync(t)&&e.config({path:t}).error}async function l(){try{let e=await a,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}a=new s.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let d=l,u=a},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=65567);module.exports=r})();