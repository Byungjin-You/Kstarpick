"use strict";(()=>{var e={};e.id=1704,e.ids=[1704],e.modules={84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},14668:(e,t,n)=>{n.r(t),n.d(t,{config:()=>h,default:()=>p,routeModule:()=>f});var r={};n.r(r),n.d(r,{default:()=>m});var o=n(71802),a=n(47153),i=n(56249),s=n(41649);n(35968),n(86044),n(38013);var c=n(84802),d=n(99344),l=n.n(d);n(44756),n(81075);let u="kstarpick_jwt_secret_key_2024_production";async function m(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let r=await (0,s.getSession)({req:e});if(r?.user?.role==="admin")return t.status(200).json({isAdmin:!0});let o=e.headers.authorization;if(o&&o.startsWith("Bearer ")){let e=o.substring(7);try{let r=l().verify(e,u),{connectToDatabase:o}=n(35968),{db:a}=await o(),{ObjectId:i}=n(38013),s=await a.collection("users").findOne({_id:new i(r.id)});if(s&&"admin"===s.role)return t.status(200).json({isAdmin:!0})}catch(e){}}if(e.headers.cookie){let r=(0,c.parse)(e.headers.cookie).token;if(r)try{let e=l().verify(r,u),{connectToDatabase:o}=n(35968),{db:a}=await o(),{ObjectId:i}=n(38013),s=await a.collection("users").findOne({_id:new i(e.id)});if(s&&"admin"===s.role)return t.status(200).json({isAdmin:!0})}catch(e){}}return t.status(200).json({isAdmin:!1})}catch(e){return t.status(500).json({error:"Internal server error"})}}let p=(0,i.hoist)(r,"default"),h=(0,i.hoist)(r,"config"),f=new o.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/auth/check-admin",pathname:"/api/auth/check-admin",bundlePath:"",filename:""},userland:r})},86044:(e,t,n)=>{let r=n(99344),{connectToDatabase:o}=n(35968),{ObjectId:a}=n(38013),{parse:i}=n(84802),s=n(44756),c=n(81075),d="kstarpick_jwt_secret_key_2024_production";async function l(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=i(e.headers.cookie).token),!t)return null;try{let e=r.verify(t,d);try{await s();let t=await c.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await o(),n=await t.collection("users").findOne({_id:new a(e.id)});if(n)return{_id:n._id,id:n._id,name:n.name,email:n.email,isAdmin:"admin"===n.role,role:n.role}}catch(e){}return null}catch(e){return null}}async function u(e){try{let t=await l(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return r.sign(e,d,{expiresIn:"7d"})},verifyToken:l,isAdmin:u}},44756:(e,t,n)=>{n.r(t),n.d(t,{default:()=>d});var r=n(11185),o=n.n(r);n(25142).config({path:".env.production"});let a="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";a||(a="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),a.includes("localhost")||(a.includes("mongodb://")&&!a.includes("authSource=")&&(a.includes("?")?a+="&authSource=admin":a+="?authSource=admin"),!a.includes("docdb.amazonaws.com")||a.includes("authMechanism=")||(a.includes("?")?a+="&authMechanism=SCRAM-SHA-1":a+="?authMechanism=SCRAM-SHA-1"));let i=a.includes("localhost")||a.includes("127.0.0.1"),s=global.mongoose;async function c(){if(s.conn&&1===o().connection.readyState)return s.conn;if(0===o().connection.readyState||3===o().connection.readyState){s.conn=null,s.promise=null;try{await o().connection.close()}catch(e){}}if(!s.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};i||(a.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),s.promise=o().connect(a,e).then(e=>(e.connection.on("error",e=>{s.conn=null,s.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{s.conn=null,s.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw s.promise=null,e})}try{return s.conn=await s.promise,s.conn}catch(e){throw s.promise=null,e}}s||(s=global.mongoose={conn:null,promise:null});let d=c},81075:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var r=n(11185),o=n.n(r);let a=new(o()).Schema({name:{type:String,required:[!0,"Please provide a name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},image:{type:String,default:"/images/default-avatar.png"},role:{type:String,enum:["user","admin","editor"],default:"user"},likes:{type:[{contentId:{type:o().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},dislikes:{type:[{contentId:{type:o().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},bookmarks:{type:[{contentId:{type:o().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),i=o().models.User||o().model("User",a)},35968:(e,t,n)=>{let r;n.r(t),n.d(t,{connectToDatabase:()=>d,dbConnect:()=>l,default:()=>u});var o=n(38013),a=n(92048),i=n.n(a),s=n(55315),c=n.n(s);{let e=n(25142),t=c().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function d(){try{let e=await r,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}r=new o.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=d,u=r},47153:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},71802:(e,t,n)=>{e.exports=n(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=14668);module.exports=n})();