"use strict";(()=>{var e={};e.id=2534,e.ids=[2534],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},68064:(e,t,r)=>{r.r(t),r.d(t,{config:()=>m,default:()=>d,routeModule:()=>p});var a={};r.r(a),r.d(a,{default:()=>c});var s=r(71802),n=r(47153),i=r(56249),o=r(35968),u=r(41649);async function c(e,t){try{let{db:r}=await (0,o.connectToDatabase)(),{method:a}=e;if("GET"===a){let{dramaId:a,username:s,rating:n,limit:i=10,page:o=1,sort:u="createdAt",order:c="desc"}=e.query,l=parseInt(i),d=(parseInt(o)-1)*l,m={};if(a&&(m.dramaId=a),s&&(m.username=s),n){let e=parseInt(n);if(!isNaN(e)){if(n.includes("-")){let[e,t]=n.split("-").map(e=>parseInt(e));isNaN(e)||isNaN(t)||(m.rating={$gte:e,$lte:t})}else m.rating=e}}let p=await r.collection("reviews").countDocuments(m),f=await r.collection("reviews").find(m).sort({[u]:"desc"===c?-1:1}).skip(d).limit(l).toArray();return t.status(200).json({success:!0,data:f,pagination:{page:parseInt(o),limit:l,total:p,pages:Math.ceil(p/l)}})}if("POST"!==a)return t.status(405).json({success:!1,message:`Method ${a} Not Allowed`});{let a=await (0,u.getSession)({req:e});if(!a||"admin"!==a.user.role)return t.status(401).json({success:!1,message:"관리자만 리뷰를 생성할 수 있습니다."});let{reviewData:s}=e.body;if(!s)return t.status(400).json({success:!1,message:"리뷰 데이터가 필요합니다."});if(!s.dramaId||!s.username||!s.reviewText)return t.status(400).json({success:!1,message:"드라마 ID, 작성자 이름, 리뷰 내용은 필수입니다."});if(!s.title){let e=(s.reviewText||"").split("\n")[0].trim();s.title=e.length>50?e.substring(0,50)+"...":e,s.title||(s.title=`${s.username}의 리뷰`)}s.reviewId||(s.reviewId=`manual-${Date.now()}-${Math.random().toString(36).substring(2,10)}`),s.createdAt=new Date,s.crawledAt=new Date;let n=await r.collection("reviews").insertOne(s);return await l(r,s.dramaId),t.status(201).json({success:!0,message:"리뷰가 성공적으로 생성되었습니다.",data:{...s,_id:n.insertedId}})}}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다.",error:e.message})}}async function l(e,t){try{let r=await e.collection("reviews").find({dramaId:t}).toArray(),a=r.length,s=0,n=0;for(let e of r)e.rating&&e.rating>0&&(s+=e.rating,n++);let i=n>0?s/n:0,o=Array(10).fill(0);for(let e of r)if(e.rating&&e.rating>0&&e.rating<=10){let t=Math.floor(e.rating)-1;t>=0&&t<10&&o[t]++}return await e.collection("dramas").updateOne({_id:t},{$set:{reviewCount:a,reviewRating:i,ratingDistribution:o}}),!0}catch(e){return!1}}let d=(0,i.hoist)(a,"default"),m=(0,i.hoist)(a,"config"),p=new s.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/reviews",pathname:"/api/reviews",bundlePath:"",filename:""},userland:a})},35968:(e,t,r)=>{let a;r.r(t),r.d(t,{connectToDatabase:()=>c,dbConnect:()=>l,default:()=>d});var s=r(38013),n=r(92048),i=r.n(n),o=r(55315),u=r.n(o);{let e=r(25142),t=u().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await a,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}a=new s.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=c,d=a},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=68064);module.exports=r})();