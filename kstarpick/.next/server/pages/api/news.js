"use strict";(()=>{var e={};e.id=4801,e.ids=[4801],e.modules={98432:e=>{e.exports=require("bcryptjs")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},73227:e=>{e.exports=require("next-auth")},62113:e=>{e.exports=require("next-auth/next")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},73673:e=>{e.exports=require("slugify")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},36705:e=>{e.exports=import("formidable")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},28442:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>c,routeModule:()=>m});var a=r(71802),n=r(47153),i=r(56249),o=r(85190),u=e([o]);o=(u.then?(await u)():u)[0];let c=(0,i.hoist)(o,"default"),l=(0,i.hoist)(o,"config"),m=new a.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/news",pathname:"/api/news",bundlePath:"",filename:""},userland:o});s()}catch(e){s(e)}})},69097:(e,t,r)=>{r.r(t),r.d(t,{authOptions:()=>l,default:()=>m});var s=r(73227),a=r.n(s);let n=require("next-auth/providers/credentials");var i=r.n(n),o=r(35968),u=r(98432),c=r.n(u);let l={providers:[i()({name:"Credentials",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){try{let{db:t}=await (0,o.connectToDatabase)(),r=await t.collection("users").findOne({email:e.email});if(!r||!await c().compare(e.password,r.password))return null;return{id:r._id.toString(),name:r.name,email:r.email,role:r.role}}catch(e){return null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.id,e.user.role=t.role),e)},pages:{signIn:"/auth/signin",error:"/auth/error"},debug:!1,secret:"kstarpick_nextauth_secret_key_2024_production"},m=a()(l)},85190:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>x,default:()=>y});var a=r(38013),n=r(62113),i=r(73673),o=r.n(i),u=r(36705),c=r(55315),l=r.n(c),m=r(92048),d=r.n(m),p=r(99344),g=r.n(p),f=r(69097),h=e([u]);u=(h.then?(await h)():h)[0];let j="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",b="kstarpick";if(!j)throw Error("MONGODB_URI environment variable is not defined");let x={api:{bodyParser:!1}};async function y(e,t){if("GET"===e.method)return w(e,t);if("true"!==e.headers["x-internal-ssr"])try{let r=e.headers.authorization?.replace("Bearer ","");if(!r)return t.status(401).json({success:!1,message:"인증 토큰이 필요합니다."});if(!g().verify(r,"kstarpick_jwt_secret_key_2024_production").isAdmin)return t.status(403).json({success:!1,message:"관리자 권한이 필요합니다."})}catch(e){return t.status(401).json({success:!1,message:"유효하지 않은 토큰입니다."})}try{let r=await (0,n.getServerSession)(e,t,f.authOptions);if(!r)return t.status(401).json({message:"로그인이 필요합니다."});if("POST"===e.method){if("admin"!==r.user.role&&"editor"!==r.user.role)return t.status(403).json({message:"권한이 없습니다."});return S(e,t,r)}return t.status(405).json({message:"지원하지 않는 메소드입니다."})}catch(e){return t.status(500).json({message:"서버 오류가 발생했습니다.",error:e.message})}}async function w(e,t){let r;try{let s;r=new a.MongoClient(j,{retryWrites:!1,connectTimeoutMS:3e4,socketTimeoutMS:45e3,serverSelectionTimeoutMS:3e4,authSource:"admin",authMechanism:"SCRAM-SHA-1"}),await r.connect();let n=r.db(b),{page:i=1,limit:o=10,category:u,featured:c,sort:l="publishedAt",order:m="desc",fields:d,title:p,createdAfter:g,createdBefore:f,adminMode:h="false"}=e.query,y={},w=[];if(u&&"all"!==u&&w.push({category:u}),"true"===c&&w.push({featured:!0}),"true"!==h&&(w.push({$or:[{title:{$exists:!0,$ne:"",$ne:null}},{title:{$exists:!1}}]}),w.push({$or:[{content:{$exists:!1}},{content:{$ne:"<p>상세 기사를 가져오는 중 오류가 발생했습니다. 원본 페이지를 방문해 주세요.</p>"}},{content:{$not:{$regex:"^<p>상세 기사를 가져오는 중 오류가 발생했습니다"}}}]})),p&&(w.push({title:{$regex:p,$options:"i"}}),p.toLowerCase().includes("watch:"))){let e=new Date;e.setDate(e.getDate()-3),w.push({$or:[{publishedAt:{$gte:e}},{createdAt:{$gte:e}}]})}if(g||f){let e={};g&&(e.$gte=new Date(g)),f&&(e.$lte=new Date(f)),w.push({createdAt:e})}w.length>0&&(y.$and=w);let S=(parseInt(i)-1)*parseInt(o),x={};x[l]="asc"===m?1:-1;let A=null;if(d&&(A={},d.split(",").map(e=>e.trim()).forEach(e=>{A[e]=1})),p&&p.toLowerCase().includes("watch:")){let e=n.collection("news").find(y);A&&e.project(A);let t=await e.sort(x).toArray();s=(e=>{let t=[...e];for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t})(t).slice(S,S+parseInt(o))}else{let e=n.collection("news").find(y);A&&e.project(A),s=await e.sort(x).skip(S).limit(parseInt(o)).toArray()}let k=await n.collection("news").countDocuments(y);return t.status(200).json({success:!0,data:{news:s,total:k,page:parseInt(i),limit:parseInt(o),totalPages:Math.ceil(k/parseInt(o))}})}catch(e){return t.status(500).json({success:!1,message:e.message})}finally{r&&await r.close()}}async function S(e,t,r){let s;try{s=new a.MongoClient(j,{retryWrites:!1,connectTimeoutMS:3e4,socketTimeoutMS:45e3,serverSelectionTimeoutMS:3e4,authSource:"admin",authMechanism:"SCRAM-SHA-1"}),await s.connect();let n=s.db(b),i=(0,u.default)({keepExtensions:!0,maxFileSize:5242880});return new Promise((a,u)=>{i.parse(e,async(e,i,u)=>{if(e)return a(t.status(500).json({message:"파일 처리 중 오류가 발생했습니다."}));try{let e={};for(let r of(Object.keys(i).forEach(t=>{e[t]=Array.isArray(i[t])?i[t][0]:i[t]}),["title","summary","content","category"]))if(!e[r])return a(t.status(400).json({message:`${r} 필드는 필수입니다.`}));let s=[];if(e.tags)try{s=JSON.parse(e.tags)}catch(e){s=[]}let c="";if(e.coverImageUrl)try{c=function(e){try{if(!e)return"";let t=String(e).trim();try{new URL(t)}catch(e){return t}return(t.includes("soompi.io")||t.includes("soompi.com"))&&new URL(t).search,t}catch(t){return"string"==typeof e?e:""}}(e.coverImageUrl)}catch(e){return a(t.status(400).json({message:"이미지 URL 처리 중 오류가 발생했습니다."}))}else{if(!u.file)return a(t.status(400).json({message:"커버 이미지를 업로드하거나 URL을 입력해주세요."}));let e=u.file;if(!["image/jpeg","image/png","image/gif","image/webp"].includes(e.mimetype))return a(t.status(400).json({message:"유효한 이미지 파일이 아닙니다. (JPEG, PNG, GIF, WebP만 허용됩니다)"}));let r=l().join(process.cwd(),"public","uploads");d().existsSync(r)||d().mkdirSync(r,{recursive:!0});let s=Date.now(),n=l().extname(e.originalFilename),i=`news-${s}${n}`,o=l().join(r,i);try{d().copyFileSync(e.filepath,o),c=`/uploads/${i}`}catch(e){return a(t.status(500).json({message:"파일 저장 중 오류가 발생했습니다."}))}}if(!r||!r.user)return a(t.status(401).json({message:"인증되지 않은 사용자입니다."}));let m=o()(e.title,{lower:!0,strict:!0}),p={title:e.title,summary:e.summary,content:e.content,slug:m,coverImage:c,category:e.category,tags:s,featured:"true"===e.featured,author:{id:r.user.id,name:r.user.name,email:r.user.email,image:r.user.image||""},createdAt:new Date,updatedAt:new Date},g=await n.collection("news").insertOne(p);return a(t.status(201).json({message:"뉴스가 성공적으로 등록되었습니다.",news:{...p,_id:g.insertedId}}))}catch(e){return a(t.status(500).json({message:"서버 오류가 발생했습니다.",error:e.message}))}finally{s&&await s.close()}})})}catch(e){return s&&await s.close(),t.status(500).json({message:"서버 오류가 발생했습니다.",error:e.message})}}s()}catch(e){s(e)}})},35968:(e,t,r)=>{let s;r.r(t),r.d(t,{connectToDatabase:()=>c,dbConnect:()=>l,default:()=>m});var a=r(38013),n=r(92048),i=r.n(n),o=r(55315),u=r.n(o);{let e=r(25142),t=u().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function c(){try{let e=await s,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}s=new a.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=c,m=s},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=28442);module.exports=r})();