"use strict";(()=>{var e={};e.id=5724,e.ids=[5724],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},43620:(e,t,r)=>{r.r(t),r.d(t,{config:()=>S,default:()=>p,routeModule:()=>y});var i={};r.r(i),r.d(i,{default:()=>m});var n=r(71802),a=r(47153),s=r(56249),u=r(35968),o=r(41649);r(38013);var d=r(69176),g=r(65571),l=r.n(g);async function m(e,t){let{id:r}=e.query;if(!r)return t.status(400).json({success:!1,message:"리뷰 ID가 필요합니다."});await (0,u.default)();try{let{method:i}=e;if("GET"===i){let e=await d.default.findById(r);if(!e)return t.status(404).json({success:!1,message:"리뷰를 찾을 수 없습니다."});return t.status(200).json({success:!0,data:e})}if("PUT"===i){let i=await (0,o.getSession)({req:e});if(!i||"admin"!==i.user.role)return t.status(401).json({success:!1,message:"관리자만 리뷰를 수정할 수 있습니다."});let{reviewData:n}=e.body;if(!n)return t.status(400).json({success:!1,message:"수정할 리뷰 데이터가 필요합니다."});if(delete n.reviewId,n.reviewText&&!n.title){let e=n.reviewText.split("\n")[0].trim();n.title=e.length>50?e.substring(0,50)+"...":e}n.updatedAt=new Date;let a=await d.default.findByIdAndUpdate(r,n,{new:!0,runValidators:!0});if(!a)return t.status(404).json({success:!1,message:"리뷰를 찾을 수 없습니다."});return a.dramaId&&await c(a.dramaId),t.status(200).json({success:!0,message:"리뷰가 성공적으로 수정되었습니다.",data:a})}{if("DELETE"!==i)return t.status(405).json({success:!1,message:`Method ${i} Not Allowed`});let n=await (0,o.getSession)({req:e});if(!n||"admin"!==n.user.role)return t.status(401).json({success:!1,message:"관리자만 리뷰를 삭제할 수 있습니다."});let a=await d.default.findById(r);if(!a)return t.status(404).json({success:!1,message:"리뷰를 찾을 수 없습니다."});let s=a.dramaId,u=await d.default.findByIdAndDelete(r);return await c(s),t.status(200).json({success:!0,message:"리뷰가 성공적으로 삭제되었습니다.",data:u})}}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다.",error:e.message})}}async function c(e){try{let t=await d.default.find({dramaId:e}),r=t.length;if(0===r){await l().findByIdAndUpdate(e,{reviewCount:0,reviewRating:0,ratingDistribution:Array(10).fill(0)});return}let i=t.reduce((e,t)=>e+(t.rating||0),0),n=Array(10).fill(0);t.forEach(e=>{e.rating>0&&e.rating<=10&&n[e.rating-1]++}),await l().findByIdAndUpdate(e,{reviewCount:r,reviewRating:r>0?i/r:0,ratingDistribution:n})}catch(e){}}r(11185);let p=(0,s.hoist)(i,"default"),S=(0,s.hoist)(i,"config"),y=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/reviews/[id]",pathname:"/api/reviews/[id]",bundlePath:"",filename:""},userland:i})},65571:(e,t,r)=>{let i=r(11185),{Schema:n}=i,a=new n({title:{type:String,required:[!0,"제목이 필요합니다."],trim:!0},slug:{type:String,required:[!0,"슬러그(URL)가 필요합니다."],unique:!0,trim:!0},originalTitle:{type:String,trim:!0},description:{type:String,trim:!0},summary:{type:String,trim:!0},coverImage:{type:String,trim:!0},bannerImage:{type:String,trim:!0},releaseDate:{type:Date},endDate:{type:Date},episodes:{type:Number},episodeList:[{number:{type:Number,required:!0},title:{type:String,trim:!0},airDate:{type:Date},summary:{type:String,trim:!0},runtime:{type:Number},rating:{type:Number,min:0,max:10},viewerRating:{type:Number,min:0,max:100},image:{type:String,trim:!0},mdlUrl:{type:String,trim:!0}}],country:{type:String,default:"South Korea"},status:{type:String,enum:["ongoing","completed","upcoming","cancelled"],default:"upcoming"},type:{type:String,trim:!0},airsOn:{type:String,trim:!0},network:{type:String,trim:!0},runtime:{type:String,trim:!0},contentRating:{type:String,trim:!0},reviewRating:{type:Number,min:0,max:10},category:{type:String,enum:["drama","movie"],default:"drama"},cast:[{name:String,role:String,image:String}],credits:{directors:[{name:String,role:String,image:String,link:String}],writers:[{name:String,role:String,image:String,link:String}],mainCast:[{name:String,role:String,character:String,image:String,link:String}],supportCast:[{name:String,role:String,character:String,image:String,link:String}],guestCast:[{name:String,role:String,character:String,image:String,link:String,episodes:String}],others:[{name:String,role:String,character:String,image:String,link:String,category:String}]},genres:[String],tags:[String],mdlId:{type:String,trim:!0},mdlUrl:{type:String,trim:!0},mdlSlug:{type:String,trim:!0},whereToWatch:[{name:String,link:String,imageUrl:String,type:String}],createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});e.exports=i.models.Drama||i.model("Drama",a)},69176:(e,t,r)=>{r.r(t),r.d(t,{default:()=>s});var i=r(11185),n=r.n(i);let a=new(n()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),s=n().models.Review||n().model("Review",a)},35968:(e,t,r)=>{let i;r.r(t),r.d(t,{connectToDatabase:()=>d,dbConnect:()=>g,default:()=>l});var n=r(38013),a=r(92048),s=r.n(a),u=r(55315),o=r.n(u);{let e=r(25142),t=o().resolve(process.cwd(),".env.production");s().existsSync(t)&&e.config({path:t}).error}async function d(){try{let e=await i,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}i=new n.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let g=d,l=i},47153:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=43620);module.exports=r})();