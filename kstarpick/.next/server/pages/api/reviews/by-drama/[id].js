"use strict";(()=>{var e={};e.id=2370,e.ids=[2370],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},39776:(e,t,n)=>{n.r(t),n.d(t,{config:()=>p,default:()=>f,routeModule:()=>h});var o={};n.r(o),n.d(o,{default:()=>m});var r=n(71802),a=n(47153),i=n(56249),s=n(44756),c=n(69176),u=n(38013),d=n(11185),l=n.n(d);async function m(e,t){let{id:n}=e.query,{method:o}=e;if(!n)return t.status(400).json({success:!1,message:"드라마 ID가 필요합니다."});try{let e=0,r=null;for(;e<3&&!r;)try{e++,r=await (0,s.default)()}catch(t){if(e<3)await new Promise(e=>setTimeout(e,3e3));else throw Error(`MongoDB 연결 실패 (최대 시도 횟수 초과): ${t.message}`)}if(1!==l().connection.readyState)throw Error(`MongoDB 연결 실패: 현재 상태 = ${l().connection.readyState} (1=연결됨, 0=끊김, 2=연결중, 3=연결해제중)`);if("GET"===o)try{let e=[];try{let t=await c.default.find({dramaId:n}).sort({createdAt:-1}).limit(100);t&&t.length>0&&(e=[...t])}catch(t){if("MongoNotConnectedError"===t.name||t.message.includes("disconnected"))try{if(await (0,s.default)(),1!==l().connection.readyState)throw Error(`MongoDB 재연결 실패: 현재 상태 = ${l().connection.readyState}`);let t=await c.default.find({dramaId:n}).sort({createdAt:-1}).limit(100);t&&t.length>0&&(e=[...t])}catch(e){}}if(u.ObjectId.isValid(n))try{1!==l().connection.readyState&&await (0,s.default)();let t=await c.default.find({dramaId:new u.ObjectId(n)}).sort({createdAt:-1}).limit(100);if(t&&t.length>0){let n=new Map;e.forEach(e=>{let t=e.reviewId||e._id.toString();n.set(t,e)}),t.forEach(e=>{let t=e.reviewId||e._id.toString();n.has(t)||n.set(t,e)}),e=Array.from(n.values())}}catch(e){}if(!e||0===e.length)return t.status(200).json({success:!0,message:"이 드라마에 등록된 리뷰가 없습니다.",data:[]});return t.status(200).json({success:!0,message:"리뷰 목록을 성공적으로 가져왔습니다.",data:e})}catch(e){return t.status(500).json({success:!1,message:"리뷰 조회 중 오류가 발생했습니다.",error:e.message})}return t.status(405).json({success:!1,message:`Method ${o} Not Allowed`})}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다.",error:e.message})}}let f=(0,i.hoist)(o,"default"),p=(0,i.hoist)(o,"config"),h=new r.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/reviews/by-drama/[id]",pathname:"/api/reviews/by-drama/[id]",bundlePath:"",filename:""},userland:o})},44756:(e,t,n)=>{n.r(t),n.d(t,{default:()=>u});var o=n(11185),r=n.n(o);n(25142).config({path:".env.production"});let a="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";a||(a="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),a.includes("localhost")||(a.includes("mongodb://")&&!a.includes("authSource=")&&(a.includes("?")?a+="&authSource=admin":a+="?authSource=admin"),!a.includes("docdb.amazonaws.com")||a.includes("authMechanism=")||(a.includes("?")?a+="&authMechanism=SCRAM-SHA-1":a+="?authMechanism=SCRAM-SHA-1"));let i=a.includes("localhost")||a.includes("127.0.0.1"),s=global.mongoose;async function c(){if(s.conn&&1===r().connection.readyState)return s.conn;if(0===r().connection.readyState||3===r().connection.readyState){s.conn=null,s.promise=null;try{await r().connection.close()}catch(e){}}if(!s.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};i||(a.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),s.promise=r().connect(a,e).then(e=>(e.connection.on("error",e=>{s.conn=null,s.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{s.conn=null,s.promise=null,setTimeout(()=>{c().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw s.promise=null,e})}try{return s.conn=await s.promise,s.conn}catch(e){throw s.promise=null,e}}s||(s=global.mongoose={conn:null,promise:null});let u=c},69176:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(11185),r=n.n(o);let a=new(r()).Schema({reviewId:{type:String,required:!0,unique:!0},username:{type:String,required:!0},userProfileUrl:String,userImage:String,rating:{type:Number,default:0},title:{type:String,required:!0},reviewText:{type:String,required:!0},reviewHtml:String,reviewDate:String,helpfulCount:{type:Number,default:0},dramaId:{type:String,required:!0},sourceUrl:String,createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),i=r().models.Review||r().model("Review",a)},47153:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},71802:(e,t,n)=>{e.exports=n(20145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=39776);module.exports=n})();