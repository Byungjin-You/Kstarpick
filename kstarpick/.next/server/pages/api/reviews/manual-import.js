"use strict";(()=>{var e={};e.id=2066,e.ids=[2066],e.modules={25142:e=>{e.exports=require("dotenv")},38013:e=>{e.exports=require("mongodb")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},19821:(e,t,s)=>{s.r(t),s.d(t,{config:()=>g,default:()=>p,routeModule:()=>h});var a={};s.r(a),s.d(a,{default:()=>l});var r=s(71802),n=s(47153),i=s(56249),o=s(41649),c=s(35968),u=s(38013);async function l(e,t){try{{let s=await (0,o.getSession)({req:e});if(!s||"admin"!==s.user.role)return t.status(401).json({success:!1,message:"관리자 권한이 필요합니다."})}if("POST"===e.method)return await d(e,t);if("GET"===e.method)return await m(e,t);if("DELETE"===e.method)return await f(e,t);return t.status(405).json({success:!1,message:"허용되지 않는 메소드입니다."})}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다.",error:e.message})}}async function d(e,t){try{let{db:s}=await (0,c.connectToDatabase)(),{dramaId:a,username:r,userProfileUrl:n,userImage:i,status:o="Completed",rating:l,storyRating:d=0,actingRating:m=0,musicRating:f=0,rewatchRating:p=0,title:g,reviewText:h,reviewId:v}=e.body;if(!a||!r||!g||!h)return t.status(400).json({success:!1,message:"드라마 ID, 사용자 이름, 제목, 리뷰 내용은 필수 항목입니다."});if(!l||isNaN(l)||l<0||l>10)return t.status(400).json({success:!1,message:"평점은 0에서 10 사이의 숫자여야 합니다."});let y=null;if(!(y=await s.collection("dramas").findOne({_id:a}))&&u.ObjectId.isValid(a)&&(y=await s.collection("dramas").findOne({_id:new u.ObjectId(a)})),y||(y=await s.collection("dramas").findOne({$or:[{id:a},{mdlId:a}]})),!y){for(let e of(await s.collection("dramas").find({}).limit(3).toArray()));return t.status(404).json({success:!1,message:"드라마를 찾을 수 없습니다."})}let P={reviewId:v||`manual-${Date.now()}`,dramaId:a,username:r,userProfileUrl:n||"",userImage:i||"",status:o,watchedEpisodes:0,totalEpisodes:0,createdAt:new Date,rating:parseFloat(l),storyRating:parseFloat(d)||0,actingRating:parseFloat(m)||0,musicRating:parseFloat(f)||0,rewatchRating:parseFloat(p)||0,title:g,reviewText:h,reviewHtml:"",helpfulCount:0,commentCount:0,reviewUrl:"",isManualImport:!0,updatedAt:new Date};if(await s.collection("reviews").findOne({reviewId:P.reviewId}))return await s.collection("reviews").updateOne({reviewId:P.reviewId},{$set:P}),await w(s,a),t.status(200).json({success:!0,message:"리뷰가 업데이트되었습니다.",review:P});return await s.collection("reviews").insertOne(P),await w(s,a),t.status(201).json({success:!0,message:"새 리뷰가 추가되었습니다.",review:P})}catch(e){return t.status(500).json({success:!1,message:"리뷰 추가 중 오류가 발생했습니다.",error:e.message})}}async function m(e,t){try{let{db:s}=await (0,c.connectToDatabase)(),{dramaId:a}=e.query;if(!a)return t.status(400).json({success:!1,message:"드라마 ID가 필요합니다."});if(!await s.collection("dramas").findOne({_id:a}))return t.status(404).json({success:!1,message:"드라마를 찾을 수 없습니다."});let r=await s.collection("reviews").find({dramaId:a}).sort({createdAt:-1}).toArray();return t.status(200).json({success:!0,message:`${r.length}개 리뷰를 가져왔습니다.`,data:r})}catch(e){return t.status(500).json({success:!1,message:"리뷰 조회 중 오류가 발생했습니다.",error:e.message})}}async function f(e,t){try{let{db:s}=await (0,c.connectToDatabase)(),{reviewId:a,dramaId:r}=e.query;if(!a)return t.status(400).json({success:!1,message:"리뷰 ID가 필요합니다."});let n=await s.collection("reviews").deleteOne({reviewId:a});if(0===n.deletedCount)return t.status(404).json({success:!1,message:"삭제할 리뷰를 찾을 수 없습니다."});return r&&await w(s,r),t.status(200).json({success:!0,message:"리뷰가 삭제되었습니다."})}catch(e){return t.status(500).json({success:!1,message:"리뷰 삭제 중 오류가 발생했습니다.",error:e.message})}}async function w(e,t){try{let s=await e.collection("reviews").find({dramaId:t}).toArray(),a=s.length,r=0,n=0;for(let e of s)e.rating&&e.rating>0&&(r+=e.rating,n++);let i=n>0?r/n:0,o=Array(10).fill(0);for(let e of s)if(e.rating&&e.rating>0&&e.rating<=10){let t=Math.floor(e.rating)-1;t>=0&&t<10&&o[t]++}await e.collection("dramas").updateOne({_id:t},{$set:{reviewCount:a,reviewRating:i,ratingDistribution:o,lastUpdated:new Date}})}catch(e){throw e}}let p=(0,i.hoist)(a,"default"),g=(0,i.hoist)(a,"config"),h=new r.PagesAPIRouteModule({definition:{kind:n.RouteKind.PAGES_API,page:"/api/reviews/manual-import",pathname:"/api/reviews/manual-import",bundlePath:"",filename:""},userland:a})},35968:(e,t,s)=>{let a;s.r(t),s.d(t,{connectToDatabase:()=>u,dbConnect:()=>l,default:()=>d});var r=s(38013),n=s(92048),i=s.n(n),o=s(55315),c=s.n(o);{let e=s(25142),t=c().resolve(process.cwd(),".env.production");i().existsSync(t)&&e.config({path:t}).error}async function u(){try{let e=await a,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}a=new r.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let l=u,d=a},47153:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},71802:(e,t,s)=>{e.exports=s(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=t(t.s=19821);module.exports=s})();