"use strict";(()=>{var e={};e.id=6456,e.ids=[6456],e.modules={84802:e=>{e.exports=require("cookie")},25142:e=>{e.exports=require("dotenv")},99344:e=>{e.exports=require("jsonwebtoken")},38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},99648:e=>{e.exports=import("axios")},56249:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"hoist",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},67320:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{config:()=>c,default:()=>l,routeModule:()=>d});var o=i(71802),r=i(47153),a=i(56249),s=i(46723),u=e([s]);s=(u.then?(await u)():u)[0];let l=(0,a.hoist)(s,"default"),c=(0,a.hoist)(s,"config"),d=new o.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/youtube/trending-music",pathname:"/api/youtube/trending-music",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},86044:(e,t,i)=>{let n=i(99344),{connectToDatabase:o}=i(35968),{ObjectId:r}=i(38013),{parse:a}=i(84802),s=i(44756),u=i(81075),l="kstarpick_jwt_secret_key_2024_production";async function c(e){let t=null;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")&&(t=e.headers.authorization.split(" ")[1]),!t&&e.headers.cookie&&(t=a(e.headers.cookie).token),!t)return null;try{let e=n.verify(t,l);try{await s();let t=await u.findById(e.id);if(t)return{_id:t._id,id:t._id,name:t.name,email:t.email,isAdmin:"admin"===t.role,role:t.role}}catch(e){}try{let{db:t}=await o(),i=await t.collection("users").findOne({_id:new r(e.id)});if(i)return{_id:i._id,id:i._id,name:i.name,email:i.email,isAdmin:"admin"===i.role,role:i.role}}catch(e){}return null}catch(e){return null}}async function d(e){try{let t=await c(e);return t&&(!0===t.isAdmin||"admin"===t.role)}catch(e){return!1}}e.exports={createToken:function(e){return n.sign(e,l,{expiresIn:"7d"})},verifyToken:c,isAdmin:d}},44756:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var n=i(11185),o=i.n(n);i(25142).config({path:".env.production"});let r="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1";r||(r="mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?authSource=admin"),r.includes("localhost")||(r.includes("mongodb://")&&!r.includes("authSource=")&&(r.includes("?")?r+="&authSource=admin":r+="?authSource=admin"),!r.includes("docdb.amazonaws.com")||r.includes("authMechanism=")||(r.includes("?")?r+="&authMechanism=SCRAM-SHA-1":r+="?authMechanism=SCRAM-SHA-1"));let a=r.includes("localhost")||r.includes("127.0.0.1"),s=global.mongoose;async function u(){if(s.conn&&1===o().connection.readyState)return s.conn;if(0===o().connection.readyState||3===o().connection.readyState){s.conn=null,s.promise=null;try{await o().connection.close()}catch(e){}}if(!s.promise){let e={maxPoolSize:10,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,connectTimeoutMS:1e4,family:4,heartbeatFrequencyMS:1e4};a||(r.includes("docdb.amazonaws.com")&&(e.tls=!1,e.tlsAllowInvalidCertificates=!0,e.tlsAllowInvalidHostnames=!0),e.authSource="admin"),s.promise=o().connect(r,e).then(e=>(e.connection.on("error",e=>{s.conn=null,s.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},5e3)}),e.connection.on("disconnected",()=>{s.conn=null,s.promise=null,setTimeout(()=>{u().catch(e=>console.error("[Mongoose] Reconnection failed:",e))},3e3)}),e)).catch(e=>{throw s.promise=null,e})}try{return s.conn=await s.promise,s.conn}catch(e){throw s.promise=null,e}}s||(s=global.mongoose={conn:null,promise:null});let l=u},81075:(e,t,i)=>{i.r(t),i.d(t,{default:()=>a});var n=i(11185),o=i.n(n);let r=new(o()).Schema({name:{type:String,required:[!0,"Please provide a name"],maxlength:[60,"Name cannot be more than 60 characters"]},email:{type:String,required:[!0,"Please provide an email"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},image:{type:String,default:"/images/default-avatar.png"},role:{type:String,enum:["user","admin","editor"],default:"user"},likes:{type:[{contentId:{type:o().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},dislikes:{type:[{contentId:{type:o().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},bookmarks:{type:[{contentId:{type:o().Schema.Types.ObjectId,required:!0},contentType:{type:String,required:!0},timestamp:{type:Date,default:Date.now}}],default:[]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),a=o().models.User||o().model("User",r)},46723:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{default:()=>a});var o=i(41736);i(86044);var r=e([o]);async function a(e,t){if("GET"!==e.method)return t.status(405).json({success:!1,message:"Method Not Allowed"});try{if(!process.env.YOUTUBE_API_KEY)return t.status(500).json({success:!1,message:"YouTube API 키가 설정되지 않았습니다."});let e=await (0,o.getTrendingMusicVideos)();if(!e||0===e.length)return t.status(404).json({success:!1,message:"인기 급상승 음악 비디오를 찾을 수 없습니다."});return t.status(200).json({success:!0,count:e.length,data:e})}catch(e){return t.status(500).json({success:!1,message:"서버 오류가 발생했습니다.",error:e.message,errorType:e.constructor.name})}}o=(r.then?(await r)():r)[0],n()}catch(e){n(e)}})},35968:(e,t,i)=>{let n;i.r(t),i.d(t,{connectToDatabase:()=>l,dbConnect:()=>c,default:()=>d});var o=i(38013),r=i(92048),a=i.n(r),s=i(55315),u=i.n(s);{let e=i(25142),t=u().resolve(process.cwd(),".env.production");a().existsSync(t)&&e.config({path:t}).error}async function l(){try{let e=await n,t=e.db("kstarpick");return{client:e,db:t}}catch(e){throw e}}n=new o.MongoClient("mongodb://kstarpick:zpdltmxkvlr0%212@kstarpick-mongodb-production.cluster-cjquemysifmm.ap-northeast-2.docdb.amazonaws.com:27017/kstarpick?retryWrites=false&authSource=admin&authMechanism=SCRAM-SHA-1",{tls:!1,tlsAllowInvalidCertificates:!0,tlsAllowInvalidHostnames:!0,retryWrites:!1,maxPoolSize:50,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,connectTimeoutMS:1e4,heartbeatFrequencyMS:1e4,maxIdleTimeMS:3e4}).connect();let c=l,d=n},41736:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{extractPlaylistId:()=>d,extractYoutubeVideoId:()=>u,getPlaylistVideos:()=>a,getTrendingMusicVideos:()=>s,getYoutubeVideoDetails:()=>c,getYoutubeVideoStats:()=>l});var o=i(99648),r=e([o]);o=(r.then?(await r)():r)[0];let u=e=>{if(!e)return null;let t=e.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);return t&&11===t[7].length?t[7]:null},l=async e=>{try{let t=u(e);if(!t)throw Error("유효한 YouTube URL이 아닙니다.");let i=process.env.YOUTUBE_API_KEY;if(!i)throw Error("YouTube API 키가 설정되지 않았습니다.");let n=await o.default.get(`https://www.googleapis.com/youtube/v3/videos?id=${t}&part=statistics&key=${i}`);if(!n.data.items||0===n.data.items.length)throw Error("동영상을 찾을 수 없습니다.");let r=n.data.items[0].statistics;return{viewCount:r.viewCount||"0",likeCount:r.likeCount||"0",commentCount:r.commentCount||"0"}}catch(e){return{viewCount:"0",likeCount:"0",commentCount:"0"}}},c=async e=>{try{let t=u(e);if(!t)throw Error("유효한 YouTube URL이 아닙니다.");let i=process.env.YOUTUBE_API_KEY;if(!i)throw Error("YouTube API 키가 설정되지 않았습니다.");let n=await o.default.get(`https://www.googleapis.com/youtube/v3/videos?id=${t}&part=snippet&key=${i}`);if(!n.data.items||0===n.data.items.length)throw Error("동영상을 찾을 수 없습니다.");let r=n.data.items[0].snippet,a=r.title,s="",l=a,c=a.split("-");return c.length>1&&(s=c[0].trim(),l=c.slice(1).join("-").trim()),{title:l,artist:s,description:r.description,thumbnailUrl:r.thumbnails?.high?.url||r.thumbnails?.default?.url,publishedAt:r.publishedAt}}catch(e){return null}},d=e=>e?new URLSearchParams(e.split("?")[1]||"").get("list"):null;async function a(e){try{let t=process.env.YOUTUBE_API_KEY;if(!t)return[];let i=d(e);if(!i)return[];let n=`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${i}&maxResults=50&key=${t}`,o=await fetch(n);if(!o.ok)throw await o.text(),Error(`YouTube Playlist API 오류: ${o.statusText}`);let r=await o.json();if(!r.items||0===r.items.length)return[];r.items[0];let a=r.items.map(e=>e.snippet?.resourceId?.videoId).filter(Boolean).join(",");if(a){let e=`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${a}&key=${t}`,i=await fetch(e);if(i.ok){let e=await i.json(),t={};return e.items&&e.items.forEach(e=>{t[e.id]={viewCount:e.statistics?.viewCount||"0",likeCount:e.statistics?.likeCount||"0"}}),r.items.map(e=>{let i=e.snippet?.resourceId?.videoId,n=t[i]||{viewCount:"0",likeCount:"0"};return{videoId:i,title:e.snippet?.title||"",channelTitle:e.snippet?.channelTitle||"",publishedAt:e.snippet?.publishedAt||"",thumbnailUrl:e.snippet?.thumbnails?.high?.url||e.snippet?.thumbnails?.default?.url,viewCount:parseInt(n.viewCount,10),likeCount:parseInt(n.likeCount,10),youtubeUrl:`https://www.youtube.com/watch?v=${i}`}})}}return r.items.map(e=>({videoId:e.snippet?.resourceId?.videoId,title:e.snippet?.title||"",channelTitle:e.snippet?.channelTitle||"",publishedAt:e.snippet?.publishedAt||"",thumbnailUrl:e.snippet?.thumbnails?.high?.url||e.snippet?.thumbnails?.default?.url,viewCount:0,likeCount:0,youtubeUrl:`https://www.youtube.com/watch?v=${e.snippet?.resourceId?.videoId}`}))}catch(e){return[]}}async function s(){try{let e=process.env.YOUTUBE_API_KEY;if(!e)return[];let t=new Date,i=new Date(t);i.setDate(t.getDate()-7),i.setHours(0,0,0,0);let n=i.toISOString(),o=`https://www.googleapis.com/youtube/v3/search?part=snippet&q=kpop+music&type=video&videoCategoryId=10&regionCode=KR&order=viewCount&publishedAfter=${n}&maxResults=20&key=${e}`,r=await fetch(o);if(!r.ok)throw await r.text(),Error(`YouTube API 오류: ${r.statusText}`);let a=await r.json();if(!a.items||0===a.items.length)return[];a.items[0];let s=a.items.map(e=>e.id?.videoId).filter(Boolean).join(",");if(s){let t=`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${s}&key=${e}`,i=await fetch(t);if(i.ok){let e=await i.json(),t={};return e.items&&e.items.forEach(e=>{t[e.id]={viewCount:e.statistics?.viewCount||"0",likeCount:e.statistics?.likeCount||"0"}}),a.items.map(e=>{let i=e.id?.videoId,n=t[i]||{viewCount:"0",likeCount:"0"};return{videoId:i,title:e.snippet?.title||"",channelTitle:e.snippet?.channelTitle||"",publishedAt:e.snippet?.publishedAt||"",thumbnailUrl:e.snippet?.thumbnails?.high?.url||e.snippet?.thumbnails?.default?.url,viewCount:parseInt(n.viewCount,10),likeCount:parseInt(n.likeCount,10),youtubeUrl:`https://www.youtube.com/watch?v=${i}`}})}}return a.items.map(e=>({videoId:e.id?.videoId,title:e.snippet?.title||"",channelTitle:e.snippet?.channelTitle||"",publishedAt:e.snippet?.publishedAt||"",thumbnailUrl:e.snippet?.thumbnails?.high?.url||e.snippet?.thumbnails?.default?.url,viewCount:0,likeCount:0,youtubeUrl:`https://www.youtube.com/watch?v=${e.id?.videoId}`}))}catch(e){return[]}}n()}catch(e){n(e)}})},47153:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouteKind",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},71802:(e,t,i)=>{e.exports=i(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=67320);module.exports=i})();