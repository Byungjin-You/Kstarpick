import React, { useEffect, useState, useMemo, useRef } from 'react';
import { useRouter } from 'next/router';
import Image from 'next/image';
import Link from 'next/link';
import MainLayout from '../../components/MainLayout';
import { Calendar, Clock, Eye, Network, Star, Tag, Play, User, Share2, Heart, Info, Film, Tv, ListFilter, X, Check, ChevronRight, Award, Download, Users, FileImage, List, ThumbsDown, Plus, MessageCircle, MessageSquare, FileText, ChevronLeft, ThumbsUp, Bookmark, TrendingUp } from 'lucide-react';
import axios from 'axios';
import Cookies from 'js-cookie';
import Head from 'next/head';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faHeart, faShare, faStar, faEye, faCalendarAlt, faTv } from '@fortawesome/free-solid-svg-icons';
import { faHeart as farHeart } from '@fortawesome/free-regular-svg-icons';
import { formatDistanceToNow } from 'date-fns';
import { ko } from 'date-fns/locale';
import useSWR from 'swr';
import Loading from '../../components/Loading';
import ErrorMessage from '../../components/ErrorMessage';
import { useSession } from 'next-auth/react';
import ReactMarkdown from 'react-markdown';
import Seo from '../../components/Seo';
import Footer from '../../components/Footer';

const fetcher = url => axios.get(url).then(res => res.data);

// ì™¸ë¶€ ì´ë¯¸ì§€ í—ˆìš© ë„ë©”ì¸ ëª©ë¡ ì¶”ê°€
const safeDomains = [
  'mydramalist.com',
  'kakaocdn.net',
  'naver.net',
  'daumcdn.net',
  'tmdb.org',
  'justwatch.com',
  'wikimedia.org',
  'wikipedia.org',
  // í•„ìš”í•œ ë„ë©”ì¸ ì¶”ê°€
];

// ì´ë¯¸ì§€ URL ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜
const ensureLocalImage = (imageUrl) => {
  const isCastImage = imageUrl && imageUrl.toString().includes('profile');
  if (isCastImage) {
    console.log('â­ Processing cast profile image:', imageUrl);
  } else {
    console.log('ensureLocalImage input:', imageUrl);
  }
  
  if (!imageUrl || imageUrl === 'undefined' || imageUrl === 'null') {
    console.log('Image URL is empty, using placeholder');
    return '/images/placeholder-tvfilm.jpg';
  }
  // ì• í”Œ TV+ ë¡œê³  íŠ¹ë³„ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œê³  URLë„ ìƒˆ SVGë¡œ ë³€í™˜)
  if (imageUrl && (
    imageUrl.includes('Apple_TV_Plus_logo.png') || 
    (imageUrl.includes('apple') && imageUrl.includes('tv') && imageUrl.includes('logo')) ||
    (imageUrl.includes('favicon') && imageUrl.includes('apple'))
  )) {
    console.log('Converting Apple TV+ logo to SVG URL');
    return 'https://upload.wikimedia.org/wikipedia/commons/3/39/Apple_TV.svg';
  }
  if (imageUrl.startsWith('public/')) {
    console.log(`Fixing relative path: ${imageUrl}`);
    return imageUrl.replace('public/', '/');
  }
  if (imageUrl.startsWith('/')) {
    if (isCastImage) {
      console.log(`â­ Using local path for cast image: ${imageUrl}`);
    } else {
      console.log(`Using local path: ${imageUrl}`);
    }
    return imageUrl;
  }
  if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
    try {
      const url = new URL(imageUrl);
      const domain = url.hostname;
      console.log('Parsed domain:', domain);
      if (safeDomains.some(safeDomain => domain.includes(safeDomain))) {
        console.log('Safe external image domain:', domain);
        return imageUrl;
      } else {
        console.log('Unsafe external image domain:', domain);
      }
    } catch (error) {
      console.error('URL íŒŒì‹± ì˜¤ë¥˜:', error, imageUrl);
      return '/images/placeholder-tvfilm.jpg';
    }
    return '/images/placeholder-tvfilm.jpg';
  }
  if (!imageUrl.startsWith('/images/')) {
    console.log(`Adding /images/ prefix to: ${imageUrl}`);
    return `/images/${imageUrl}`;
  }
  console.log(`Using original URL: ${imageUrl}`);
  return imageUrl;
};

// ì™¸ë¶€ URLì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
const isExternalUrl = (url) => {
  return url && (url.startsWith('http://') || url.startsWith('https://'));
};

// YouTube URLì—ì„œ ë¹„ë””ì˜¤ IDë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
const getYoutubeIdFromUrl = (url) => {
  if (!url) return null;
  
  // YouTube URL í˜•ì‹ë“¤
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/watch\?.*&v=)([^#&?]*).*/,
    /^https?:\/\/(?:www\.)?youtube\.com\/shorts\/([a-zA-Z0-9_-]+)(?:\?.*)?$/
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return match[1];
    }
  }
  
  return null;
};

// ì´ë¯¸ì§€ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
const renderImage = (imageUrl, alt, className = "object-cover", width = 0, height = 0, priority = false, type = 'general') => {
  // ì´ë¯¸ì§€ URLì´ ì—†ëŠ” ê²½ìš° í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš©
  if (!imageUrl) {
    if (type === 'logo') {
      return <span className="text-gray-800 font-bold text-base sm:text-lg">{alt || "Logo"}</span>;
    }
    return (
      <div className="w-full h-full bg-gradient-to-br from-[#FF8DC7] to-[#FF5CAA] flex items-center justify-center">
        <Film className="w-1/4 h-1/4 text-white" />
      </div>
    );
  }
  
  // íŠ¹ì • ì„œë¹„ìŠ¤ ë¡œê³  íŠ¹ë³„ ì²˜ë¦¬
  if (alt && typeof alt === 'string' && type === 'logo') {
    // Wavve ë¡œê³  íŠ¹ë³„ ì²˜ë¦¬
    if (alt.toLowerCase() === 'wavve') {
      console.log('ğŸŒŠ Special handling for Wavve logo');
      imageUrl = 'https://i.mydramalist.com/pgAd8_3m.jpg';
    }
    
    // Viki ë¡œê³  íŠ¹ë³„ ì²˜ë¦¬
    else if (alt.toLowerCase() === 'viki') {
      console.log('ğŸŒŸ Special handling for Viki logo');
      imageUrl = 'https://i.mydramalist.com/kEBdrm.jpg';
    }
    
    // Apple TV+ ë¡œê³  íŠ¹ë³„ ì²˜ë¦¬
    else if (alt.toLowerCase().includes('apple')) {
      console.log('ğŸ Special handling for Apple TV+ logo');
      imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/3/39/Apple_TV.svg';
    }
  }
  
  // JustWatch ì´ë¯¸ì§€ ì—¬ë¶€ í™•ì¸
  const isJustWatchImage = imageUrl.includes('justwatch.com');
  
  const imgProps = {
    src: imageUrl,
    alt: alt || "Image",
    className: className,
    unoptimized: isJustWatchImage ? false : true,  // JustWatch ì´ë¯¸ì§€ëŠ” ìµœì í™” í™œì„±í™”
    onError: (e) => {
      console.log(`ì´ë¯¸ì§€ ë¡œë“œ ì—ëŸ¬: ${imageUrl}, ë¡œì»¬ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´`);
      e.target.onerror = null; // ë¬´í•œ ë£¨í”„ ë°©ì§€
      // ì´ë¯¸ì§€ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš©
      if (type === 'logo') {
        e.target.src = '/images/placeholder-image.jpg';
      } else {
        e.target.src = '/images/placeholder-tvfilm.jpg';
      }
    }
  };
  
  if (priority) {
    imgProps.priority = true;
  }
  
  // JustWatch ì´ë¯¸ì§€ì¸ ê²½ìš° ë¡œê¹…
  if (isJustWatchImage) {
    console.log(`ğŸ–¼ï¸ Rendering JustWatch image: ${imageUrl}`);
  }
  
  // width, heightê°€ ì œê³µëœ ê²½ìš° (ì˜ˆ: ë¡œê³  ì´ë¯¸ì§€)
  if (width > 0 && height > 0) {
    return (
      <Image
        {...imgProps}
        width={width}
        height={height}
      />
    );
  }
  
  // ë¡œê³  íƒ€ì…ì´ì§€ë§Œ width, heightê°€ ì œê³µë˜ì§€ ì•Šì€ ê²½ìš°
  if (type === 'logo') {
    return (
      <div className="w-full h-full flex items-center justify-center">
        <Image
          {...imgProps}
          width={150}
          height={70}
        />
      </div>
    );
  }
  
  // width, heightê°€ ì œê³µë˜ì§€ ì•Šì€ ê²½ìš° (ì¼ë°˜ ì´ë¯¸ì§€)
  return <Image {...imgProps} fill sizes="100vw" />;
};

export default function DramaDetail({ drama, relatedNews, metaTags }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [currentDrama, setCurrentDrama] = useState(drama || null);
  const [relatedItems, setRelatedItems] = useState([]);
  const [showTrailer, setShowTrailer] = useState(false);
  const [selectedTrailerUrl, setSelectedTrailerUrl] = useState('');
  const [activeSection, setActiveSection] = useState('overview');
  const [isLiked, setIsLiked] = useState(false);
  const [isDisliked, setIsDisliked] = useState(false);
  const [likesCount, setLikesCount] = useState(0);
  const [dislikesCount, setDislikesCount] = useState(0);
  const [watchProviders, setWatchProviders] = useState([]);
  const [cast, setCast] = useState([]);
  const [youtubeId, setYoutubeId] = useState('');
  const [selectedVideoId, setSelectedVideoId] = useState('');
  const [trailerTitle, setTrailerTitle] = useState('');
  // ë¦¬ë·° ì„¸ë¶€ í‰ì ì„ ìœ„í•œ ìƒíƒœ ì¶”ê°€
  const [castRating, setCastRating] = useState(0);
  const [storyRating, setStoryRating] = useState(0);
  const [musicRating, setMusicRating] = useState(0);
  const [rewatchRating, setRewatchRating] = useState(0);
  
  // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì— ë”°ë¥¸ ë¹„ë””ì˜¤ í™”ì‚´í‘œ í‘œì‹œ ìƒíƒœ
  const [showLeftArrow, setShowLeftArrow] = useState(false);
  const [showRightArrow, setShowRightArrow] = useState(true);
  
  // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì— ë”°ë¥¸ ìºìŠ¤íŠ¸ í™”ì‚´í‘œ í‘œì‹œ ìƒíƒœ
  const [showCastLeftArrow, setShowCastLeftArrow] = useState(false);
  const [showCastRightArrow, setShowCastRightArrow] = useState(true);
  
  // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì— ë”°ë¥¸ ë¦¬ë·° í™”ì‚´í‘œ í‘œì‹œ ìƒíƒœ
  const [showReviewLeftArrow, setShowReviewLeftArrow] = useState(false);
  const [showReviewRightArrow, setShowReviewRightArrow] = useState(true);
  
  // ë¦¬ë·° ê´€ë ¨ ìƒíƒœ ì¶”ê°€
  const [reviews, setReviews] = useState([]);
  const [loadingReviews, setLoadingReviews] = useState(false);
  const [reviewsError, setReviewsError] = useState(null);
  const [showReviewModal, setShowReviewModal] = useState(false);
  const [selectedReview, setSelectedReview] = useState(null);
  
  // session ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const { data: session } = useSession();
  
  // ë¦¬ë·° ì»¨í…Œì´ë„ˆ ì°¸ì¡°
  const reviewsContainerRef = useRef(null);
  // ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ì°¸ì¡° ì¶”ê°€
  const videosContainerRef = useRef(null);
  // ìºìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì°¸ì¡° ì¶”ê°€
  const castContainerRef = useRef(null);

  // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  const { data: dramaData, error: dramaError } = useSWR(
    currentDrama ? `/api/dramas/${currentDrama._id}` : null,
    fetcher
  );

  // filteredWatchProviders useMemo ì œê±°
  
  // ë¦¬ë·° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    if (!currentDrama) return;
    
    const fetchReviews = async () => {
      setLoadingReviews(true);
      try {
        console.log(`ë¦¬ë·° ë°ì´í„° ìš”ì²­: /api/reviews/by-drama/${currentDrama._id}`);
        const response = await fetch(`/api/reviews/by-drama/${currentDrama._id}`);
        const result = await response.json();
        
        if (response.ok && result.success) {
          console.log(`ë¦¬ë·° ë°ì´í„° ë¡œë“œ ì„±ê³µ: ${result.data.length}ê°œ`);
          setReviews(result.data || []);
        } else {
          console.error('ë¦¬ë·° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', result.message);
          setReviewsError(result.message || 'ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ë¦¬ë·° API í˜¸ì¶œ ì˜¤ë¥˜:', error);
        setReviewsError('ë¦¬ë·° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        setLoadingReviews(false);
      }
    };
    
    fetchReviews();
  }, [currentDrama]);

  // ë¦¬ë·° ìŠ¤í¬ë¡¤ í•¨ìˆ˜ ì¶”ê°€
  const scrollReviews = (direction) => {
    if (reviewsContainerRef.current) {
      const container = reviewsContainerRef.current;
      const scrollAmount = 350; // ì¹´ë“œ í•œ ê°œ ë„ˆë¹„ + ì—¬ë°±
      
      if (direction === 'left') {
        container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      } else {
        container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      }
    }
  };

  // ë¹„ë””ì˜¤ ìŠ¤í¬ë¡¤ í•¨ìˆ˜ ì¶”ê°€
  const scrollVideos = (direction) => {
    if (videosContainerRef.current) {
      const container = videosContainerRef.current;
      const scrollAmount = 420; // ë¹„ë””ì˜¤ ì¹´ë“œ í•œ ê°œ ë„ˆë¹„ + ì—¬ë°±
      
      if (direction === 'left') {
        container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      } else {
        container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      }
    }
  };

    setTouchStartX(0);
    setTouchEndX(0);
  };

  // ìºìŠ¤íŠ¸ ìŠ¤í¬ë¡¤ í•¨ìˆ˜ ì¶”ê°€
  const scrollCast = (direction) => {
    if (castContainerRef.current) {
      const container = castContainerRef.current;
      const scrollAmount = 300; // ìºìŠ¤íŠ¸ ì¹´ë“œ ì—¬ëŸ¬ ê°œ + ì—¬ë°±
      
      if (direction === 'left') {
        container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      } else {
        container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      }
    }
  };

  // ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ê°ì§€
  useEffect(() => {
    const container = videosContainerRef.current;
    if (!container || !currentDrama?.videos?.length) return;
    
    const handleScroll = () => {
      // ì™¼ìª½ í™”ì‚´í‘œ í‘œì‹œ ì—¬ë¶€ (ìŠ¤í¬ë¡¤ ìœ„ì¹˜ê°€ 0ë³´ë‹¤ í¬ë©´ í‘œì‹œ)
      setShowLeftArrow(container.scrollLeft > 10);
      
      // ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ í‘œì‹œ ì—¬ë¶€ (ìŠ¤í¬ë¡¤ì´ ëì— ë„ë‹¬í•˜ì§€ ì•Šì•˜ìœ¼ë©´ í‘œì‹œ)
      const isAtEnd = Math.abs(
        (container.scrollWidth - container.clientWidth) - container.scrollLeft
      ) < 10;
      
      setShowRightArrow(!isAtEnd);
    };
    
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    handleScroll();
    
    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    container.addEventListener('scroll', handleScroll);
    
    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    return () => {
      container.removeEventListener('scroll', handleScroll);
    };
  }, [currentDrama?.videos]);

  // ìºìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ê°ì§€
  useEffect(() => {
    const container = castContainerRef.current;
    if (!container || !cast?.length) return;
    
    const handleScroll = () => {
      // ì™¼ìª½ í™”ì‚´í‘œ í‘œì‹œ ì—¬ë¶€ (ìŠ¤í¬ë¡¤ ìœ„ì¹˜ê°€ 0ë³´ë‹¤ í¬ë©´ í‘œì‹œ)
      setShowCastLeftArrow(container.scrollLeft > 10);
      
      // ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ í‘œì‹œ ì—¬ë¶€ (ìŠ¤í¬ë¡¤ì´ ëì— ë„ë‹¬í•˜ì§€ ì•Šì•˜ìœ¼ë©´ í‘œì‹œ)
      const isAtEnd = Math.abs(
        (container.scrollWidth - container.clientWidth) - container.scrollLeft
      ) < 10;
      
      setShowCastRightArrow(!isAtEnd);
    };
    
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    handleScroll();
    
    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    container.addEventListener('scroll', handleScroll);
    
    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    return () => {
      container.removeEventListener('scroll', handleScroll);
    };
  }, [cast]);

  // ë¦¬ë·° ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ê°ì§€
  useEffect(() => {
    const container = reviewsContainerRef.current;
    if (!container || !reviews?.length) return;
    
    const handleScroll = () => {
      // ì™¼ìª½ í™”ì‚´í‘œ í‘œì‹œ ì—¬ë¶€ (ìŠ¤í¬ë¡¤ ìœ„ì¹˜ê°€ 0ë³´ë‹¤ í¬ë©´ í‘œì‹œ)
      setShowReviewLeftArrow(container.scrollLeft > 10);
      
      // ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ í‘œì‹œ ì—¬ë¶€ (ìŠ¤í¬ë¡¤ì´ ëì— ë„ë‹¬í•˜ì§€ ì•Šì•˜ìœ¼ë©´ í‘œì‹œ)
      const isAtEnd = Math.abs(
        (container.scrollWidth - container.clientWidth) - container.scrollLeft
      ) < 10;
      
      setShowReviewRightArrow(!isAtEnd);
    };
    
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    handleScroll();
    
    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    container.addEventListener('scroll', handleScroll);
    
    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    return () => {
      container.removeEventListener('scroll', handleScroll);
    };
  }, [reviews]);

  useEffect(() => {
    if (dramaData?.data) {
      // API ì‘ë‹µ ë°ì´í„°ë¥¼ ìì„¸íˆ ë¡œê¹…
      console.log("ë“œë¼ë§ˆ ìƒì„¸ API ì‘ë‹µ:", dramaData.data);
      console.log("ğŸ“Š ë¦¬ë·° ë°ì´í„° ë””ë²„ê¹…:", {
        reviewCount: dramaData.data.reviewCount,
        reviewRating: dramaData.data.reviewRating,
        ratingDistribution: dramaData.data.ratingDistribution,
      });
      
      // ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° ì´ë¯¸ì§€ URL ìˆ˜ì • ë° ë³´ê°•
      const updatedData = { ...dramaData.data };
      
      // ì´ë¯¸ì§€ URL í™•ì¸
      console.log("ì›ë³¸ ì»¤ë²„ ì´ë¯¸ì§€ URL:", updatedData.coverImage);
      console.log("ì›ë³¸ ë°°ë„ˆ ì´ë¯¸ì§€ URL:", updatedData.bannerImage);
      if (updatedData.watchProviders && Array.isArray(updatedData.watchProviders)) {
        updatedData.watchProviders.forEach((provider, index) => {
          console.log(`ì›ë³¸ Watch Provider[${index}] ë¡œê³  URL:`, provider.logo);
        });
      }
      
      // whereToWatch í™•ì¸ ë° ì²˜ë¦¬
      if (updatedData.whereToWatch && Array.isArray(updatedData.whereToWatch)) {
        updatedData.whereToWatch.forEach((provider, index) => {
          console.log(`ì›ë³¸ whereToWatch[${index}] ì •ë³´:`, provider);
          // ì›¨ì´ë¸Œì™€ ë¹„í‚¤ ë¡œê³  URL íŠ¹ë³„ ì²˜ë¦¬
          if (provider.name && provider.name.toLowerCase() === 'wavve') {
            provider.imageUrl = 'https://i.mydramalist.com/pgAd8_3m.jpg';
          } else if (provider.name && provider.name.toLowerCase() === 'viki') {
            provider.imageUrl = 'https://i.mydramalist.com/kEBdrm.jpg';
          }
        });
      }
      
      // ì´ë¯¸ì§€ URL ìˆ˜ì •
      // ì¸ë„¤ì¼ ì´ë¯¸ì§€ í™•ì¸ ë° ì²˜ë¦¬
      updatedData.coverImage = ensureLocalImage(updatedData.coverImage);
      console.log("ì²˜ë¦¬ í›„ ì»¤ë²„ ì´ë¯¸ì§€ URL:", updatedData.coverImage);
      
      // ë°°ë„ˆ ì´ë¯¸ì§€ í™•ì¸ ë° ì²˜ë¦¬
      updatedData.bannerImage = ensureLocalImage(updatedData.bannerImage);
      console.log("ì²˜ë¦¬ í›„ ë°°ë„ˆ ì´ë¯¸ì§€ URL:", updatedData.bannerImage);
      
      // watchProviders ë°°ì—´ì˜ ëª¨ë“  í•­ëª©ì— ëŒ€í•´ ë¡œê³  URLì„ ë‚´ë¶€ ì´ë¯¸ì§€ë¡œ ë³€ê²½
      if (updatedData.watchProviders && Array.isArray(updatedData.watchProviders)) {
        updatedData.watchProviders = updatedData.watchProviders.map(provider => {
          const processedLogo = provider.logo ? ensureLocalImage(provider.logo) : '/images/placeholder-image.jpg';
          console.log(`Provider ${provider.name} ë¡œê³  ì²˜ë¦¬ ì „: ${provider.logo}, ì²˜ë¦¬ í›„: ${processedLogo}`);
          return {
            ...provider,
            logo: processedLogo
          };
        });
      }
      
      // ì¶”ê°€: cast ë°°ì—´ì˜ ê°’ê³¼ íƒ€ì…, ê¸¸ì´ ë¡œê·¸
      console.log('dramaData.data.cast:', dramaData.data.cast, Array.isArray(dramaData.data.cast), dramaData.data.cast?.length);
      
      // Cast ë°ì´í„° êµ¬ì¡° ë””ë²„ê¹… (ì¤‘ìš”)
      if (dramaData.data.cast && Array.isArray(dramaData.data.cast) && dramaData.data.cast.length > 0) {
        console.log("-------------- CAST DEBUG INFO --------------");
        console.log("ì²« ë²ˆì§¸ ë°°ìš° ì›ë³¸ ë°ì´í„° JSON:", JSON.stringify(dramaData.data.cast[0]));
        console.log("cast ë°°ì—´ ê¸¸ì´:", dramaData.data.cast.length);
        console.log("ëª¨ë“  cast ì´ë¯¸ì§€ í•„ë“œ:");
        dramaData.data.cast.forEach((actor, idx) => {
          console.log(`ë°°ìš° ${idx+1} ${actor.name || 'Unknown'}:`, {
            profileImage: actor.profileImage,
            image: actor.image,
            profile: actor.profile,
            profileImg: actor.profileImg
          });
        });
        console.log("-------------------------------------------");
      }
      
      // ì¶”ê°€: map ì‹¤í–‰ ì „í›„ë¡œ cast ë°°ì—´ ë¡œê·¸
      if (updatedData.cast && Array.isArray(updatedData.cast)) {
        console.log('updatedData.cast before map:', updatedData.cast);
        updatedData.cast = updatedData.cast.map(actor => {
          console.log('actor before mapping:', actor);
          
          // APIì—ì„œëŠ” profileImage í•„ë“œë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì´ë¥¼ ì§ì ‘ ì‚¬ìš©
          const imageUrl = actor.profileImage || actor.image || '';
          
          // í•„ë“œ ì´ë¦„ í‘œì¤€í™” - ëª¨ë“  cast í•­ëª©ì— í™•ì‹¤íˆ image í•„ë“œ ì¶”ê°€
          const mapped = {
            ...actor,
            name: actor.name || 'Unknown Actor',
            role: actor.role || 'Unknown Role',
            image: ensureLocalImage(imageUrl),
            // profileImage ì›ë³¸ í•„ë“œë„ ìœ ì§€
            profileImage: imageUrl
          };
          console.log('actor after mapping:', mapped);
          return mapped;
        });
        console.log('updatedData.cast after map:', updatedData.cast);
      } else if (!updatedData.cast || !Array.isArray(updatedData.cast) || updatedData.cast.length === 0) {
        // ìºìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ë°°ìš° ë°ì´í„° ìƒì„±
        updatedData.cast = [
          { name: 'Actor 1', role: 'Role 1', image: '/images/placeholder-tvfilm.jpg', profileImage: '/images/placeholder-tvfilm.jpg' },
          { name: 'Actor 2', role: 'Role 2', image: '/images/placeholder-tvfilm.jpg', profileImage: '/images/placeholder-tvfilm.jpg' },
          { name: 'Actor 3', role: 'Role 3', image: '/images/placeholder-tvfilm.jpg', profileImage: '/images/placeholder-tvfilm.jpg' }
        ];
      }
      
      // ë¹„ë””ì˜¤ ë°ì´í„°ì—ì„œ ë©”ì¸ íŠ¸ë ˆì¼ëŸ¬ ID ì¶”ì¶œ
      if (updatedData.videos && Array.isArray(updatedData.videos) && updatedData.videos.length > 0) {
        // ì²« ë²ˆì§¸ ë¹„ë””ì˜¤ URLì—ì„œ YouTube ID ì¶”ì¶œ
        const mainVideoId = getYoutubeIdFromUrl(updatedData.videos[0].url);
        if (mainVideoId) {
          setYoutubeId(mainVideoId);
        } else if (updatedData.trailerUrl) {
          // ë§Œì•½ ì²« ë²ˆì§¸ ë¹„ë””ì˜¤ URLì—ì„œ ID ì¶”ì¶œì´ ì‹¤íŒ¨í•˜ë©´ trailerUrl ì‹œë„
          const trailerVideoId = getYoutubeIdFromUrl(updatedData.trailerUrl);
          if (trailerVideoId) {
            setYoutubeId(trailerVideoId);
          }
        }
      } else if (updatedData.trailerUrl) {
        // videos ë°°ì—´ì´ ì—†ëŠ” ê²½ìš° trailerUrlì—ì„œ ì¶”ì¶œ
        const trailerVideoId = getYoutubeIdFromUrl(updatedData.trailerUrl);
        if (trailerVideoId) {
          setYoutubeId(trailerVideoId);
        }
      }
      
      // ë¦¬ë·° ê´€ë ¨ API ë°ì´í„° ë¡œê¹…
      console.log("ğŸ“Š ë¦¬ë·° í†µê³„ ë°ì´í„°:", {
        reviewCount: updatedData.reviewCount || 0,
        reviewRating: updatedData.reviewRating || 0,
        ratingDistribution: updatedData.ratingDistribution || [0,0,0,0,0,0,0,0,0,0]
      });
      
      // ë¦¬ë·° ë°ì´í„°ì˜ ìœ íš¨ì„± í™•ì¸
      const hasValidReviewData = 
        typeof updatedData.reviewCount === 'number' && 
        typeof updatedData.reviewRating === 'number' && 
        Array.isArray(updatedData.ratingDistribution) &&
        updatedData.ratingDistribution.length === 10;
      
      if (!hasValidReviewData) {
        console.warn("âš ï¸ ìœ íš¨í•œ ë¦¬ë·° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        // ê¸°ë³¸ê°’ ì„¤ì •
        updatedData.reviewCount = 0;
        updatedData.reviewRating = 0;
        updatedData.ratingDistribution = [0,0,0,0,0,0,0,0,0,0];
      }
      
      // setDramaData(updatedData); // dramaDataëŠ” useSWRì—ì„œ ì œê³µí•˜ëŠ” ê°’ì´ë¯€ë¡œ ì œê±°
      setCurrentDrama(updatedData);
      setCast(updatedData.cast);
      setLikesCount(updatedData.likes || 0);
      setDislikesCount(updatedData.dislikes || 0);
      
      // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í™•ì¸
      const checkUserInteractions = async () => {
        if (session?.user) {
          try {
            const res = await axios.get(`/api/user/interactions?contentId=${currentDrama._id}&type=drama`);
            if (res.data.success) {
              setIsLiked(res.data.liked);
              setIsDisliked(res.data.disliked);
            }
          } catch (error) {
            console.error('Error checking user interactions:', error);
          }
        }
      };
      
      checkUserInteractions();
    }
    
    // Add loading state handling
    if (dramaData) {
      setLoading(false);
    }
    
    if (dramaError) {
      setError(dramaError);
      setLoading(false);
    }
  }, [dramaData, session, dramaError]);

  useEffect(() => {
    if (dramaData?.data) {
      // Cast ë°ì´í„° ì²˜ë¦¬ ê°œì„ 
      if (!dramaData.data.cast) {
        setCast([
          { id: 1, name: 'Actor 1', role: 'Role 1', image: '/images/placeholder-tvfilm.jpg' },
          { id: 2, name: 'Actor 2', role: 'Role 2', image: '/images/placeholder-tvfilm.jpg' },
          { id: 3, name: 'Actor 3', role: 'Role 3', image: '/images/placeholder-tvfilm.jpg' },
        ]);
      } else {
        // ì¶œì—°ì§„ ì •ë³´ê°€ ê°ì²´ í˜•íƒœë¡œ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (mainRoles, supportRoles êµ¬ì¡°)
        if (dramaData.data.cast.mainRoles || dramaData.data.cast.supportRoles) {
          console.log('Cast is in structured format with mainRoles and supportRoles');
          
          // ë©”ì¸ ì—­í• ê³¼ ì„œí¬íŠ¸ ì—­í• ì„ í•©ì¹œ ë°°ì—´ ìƒì„±
          const mainActors = Array.isArray(dramaData.data.cast.mainRoles) ? dramaData.data.cast.mainRoles : [];
          const supportActors = Array.isArray(dramaData.data.cast.supportRoles) ? dramaData.data.cast.supportRoles : [];
          
          // ë°°ìš° ì •ë³´ ì²˜ë¦¬ (ì´ë¯¸ì§€ URL ë“± í•„ë“œ í‘œì¤€í™”)
          const processedCast = [...mainActors, ...supportActors].map(actor => ({
            ...actor,
            image: actor.image || '/images/placeholder-tvfilm.jpg'
          }));
          
          console.log(`Combined cast: ${processedCast.length} actors (${mainActors.length} main, ${supportActors.length} support)`);
          setCast(processedCast);
        } else if (Array.isArray(dramaData.data.cast)) {
          // ê¸°ì¡´ ë°©ì‹ ì§€ì› (ë‹¨ì¼ ë°°ì—´ í˜•íƒœì¸ ê²½ìš°)
          console.log('Cast is in simple array format');
          const processedCast = dramaData.data.cast.map(actor => ({
            ...actor,
            image: actor.image || '/images/placeholder-tvfilm.jpg'
          }));
          setCast(processedCast);
        } else {
          console.warn('Unexpected cast data format:', dramaData.data.cast);
          setCast([]);
        }
      }
      
      // Fetch related items
      const fetchRelatedItems = async () => {
        try {
          const relatedResponse = await axios.get('/api/dramas', {
            params: {
              category: dramaData.data.category,
              limit: 4,
            }
          });
          
          if (relatedResponse.data.success) {
            // Filter out the current item and limit to 4 items
            const filtered = relatedResponse.data.data
              .filter(item => item._id !== currentDrama._id)
              .slice(0, 4)
              .map(item => ({
                ...item,
                coverImage: item.coverImage || '/images/placeholder-tvfilm.jpg'
              }));
            
            setRelatedItems(filtered);
          }
        } catch (error) {
          console.error('Error fetching related items:', error);
        }
      };
      
      fetchRelatedItems();
    }
  }, [dramaData, currentDrama]);

  useEffect(() => {
    if (dramaData) {
      console.log("TVFilm data loaded:", dramaData);
      console.log("Watch Providers:", dramaData.watchProviders);
      
      // Set page title
      if (dramaData.title) {
        document.title = `${dramaData.title} - KDrama&Movie`;
      }
      
      // No need to fetch related items here as it's already done in the previous useEffect
    }
  }, [dramaData]);

  // Get status badge class based on status
  const getStatusClass = (status) => {
    if (!status) return 'bg-gray-100 text-gray-800';
    const statusLower = status.toLowerCase();
    switch (statusLower) {
      case 'ongoing':
        return 'bg-green-100 text-green-800';
      case 'completed':
        return 'bg-blue-100 text-blue-800';
      case 'upcoming':
        return 'bg-purple-100 text-purple-800';
      case 'cancelled':
        return 'bg-red-100 text-red-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  // Format date
  const formatDate = (dateString) => {
    if (!dateString) return null;
    const date = new Date(dateString);
    return `${date.toLocaleDateString()}`;
  };

  const handleLike = async () => {
    if (!session) {
      router.push('/login?returnUrl=' + router.asPath);
      return;
    }

    try {
      // ì´ë¯¸ disliked ìƒíƒœë¼ë©´ í•´ì œ
      if (isDisliked) {
        setIsDisliked(false);
        setDislikesCount(prev => Math.max(0, prev - 1));
      }
      
      // ì¢‹ì•„ìš” ìƒíƒœ í† ê¸€ ë° ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
      const newLikedState = !isLiked;
      setIsLiked(newLikedState);
      setLikesCount(prev => newLikedState ? prev + 1 : Math.max(0, prev - 1));
      
      // dramas APIë¡œ ìš”ì²­ ë³€ê²½
      await axios.post(`/api/dramas/${currentDrama._id}/like`, {
        action: newLikedState ? 'like' : 'unlike',
      });
    } catch (error) {
      console.error('Error toggling like:', error);
      // ì—ëŸ¬ ë°œìƒ ì‹œ UI ë¡¤ë°±
      setIsLiked(!isLiked);
      setLikesCount(prev => isLiked ? Math.max(0, prev - 1) : prev + 1);
    }
  };

  const handleDislike = async () => {
    if (!session) {
      router.push('/login?returnUrl=' + router.asPath);
      return;
    }
    
    // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
    const previousLiked = isLiked;
    const previousDisliked = isDisliked;
    const previousLikesCount = likesCount;
    const previousDislikesCount = dislikesCount;
    
    // ìƒˆë¡œìš´ ìƒíƒœë¡œ UI ì—…ë°ì´íŠ¸
    setIsDisliked(!isDisliked);
    setDislikesCount(prev => !isDisliked ? prev + 1 : prev - 1);
    
    // ë§Œì•½ ì´ì „ì— ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ì—ˆë‹¤ë©´, ì¢‹ì•„ìš” ì œê±°
    if (!isDisliked && isLiked) {
      setIsLiked(false);
      setLikesCount(prev => prev > 0 ? prev - 1 : 0);
    }
    
    try {
      // dramas APIë¡œ ìš”ì²­ ë³€ê²½
      const res = await axios.post(`/api/dramas/${currentDrama._id}/dislike`, {
        action: !isDisliked ? 'dislike' : 'undislike',
      });
      
      if (!res.data || !res.data.success) {
        // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ UI ë¡¤ë°±
        setIsLiked(previousLiked);
        setIsDisliked(previousDisliked);
        setLikesCount(previousLikesCount);
        setDislikesCount(previousDislikesCount);
        console.error('API response error:', res.data?.message);
      }
    } catch (error) {
      // ì—ëŸ¬ ë°œìƒ ì‹œ UI ë¡¤ë°±
      setIsLiked(previousLiked);
      setIsDisliked(previousDisliked);
      setLikesCount(previousLikesCount);
      setDislikesCount(previousDislikesCount);
      console.error('Error disliking content:', error);
    }
  };

  const handleShare = () => {
    if (navigator.share) {
      navigator.share({
        title: currentDrama?.title,
        text: currentDrama?.summary,
        url: window.location.href,
      });
    } else {
      navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard.');
    }
  };

  // ë¦¬ë·° ëª¨ë‹¬ ì—´ê¸°
  const openReviewModal = (review) => {
    setSelectedReview(review);
    setShowReviewModal(true);
    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ìŠ¤í¬ë¡¤ ë°©ì§€
    document.body.style.overflow = 'hidden';
  };

  // ë¦¬ë·° ëª¨ë‹¬ ë‹«ê¸°
  const closeReviewModal = () => {
    setShowReviewModal(false);
    setSelectedReview(null);
    // ëª¨ë‹¬ì´ ë‹«í ë•Œ ìŠ¤í¬ë¡¤ í—ˆìš©
    document.body.style.overflow = 'auto';
  };

  // ë‹¤ìŒ ë¦¬ë·°ë¡œ ì´ë™
  const goToNextReview = () => {
    if (reviews.length <= 1) return;
    
    const sortedReviews = [...reviews].sort((a, b) => (b.featured === true) - (a.featured === true));
    const currentIndex = sortedReviews.findIndex(review => 
      review._id === selectedReview._id || 
      review.reviewId === selectedReview.reviewId
    );
    
    if (currentIndex !== -1 && currentIndex < sortedReviews.length - 1) {
      setSelectedReview(sortedReviews[currentIndex + 1]);
    } else {
      // ë§ˆì§€ë§‰ ë¦¬ë·°ì¸ ê²½ìš° ì²« ë²ˆì§¸ ë¦¬ë·°ë¡œ ìˆœí™˜
      setSelectedReview(sortedReviews[0]);
    }
  };

  // ì´ì „ ë¦¬ë·°ë¡œ ì´ë™
  const goToPrevReview = () => {
    if (reviews.length <= 1) return;
    
    const sortedReviews = [...reviews].sort((a, b) => (b.featured === true) - (a.featured === true));
    const currentIndex = sortedReviews.findIndex(review => 
      review._id === selectedReview._id || 
      review.reviewId === selectedReview.reviewId
    );
    
    if (currentIndex !== -1 && currentIndex > 0) {
      setSelectedReview(sortedReviews[currentIndex - 1]);
    } else {
      // ì²« ë²ˆì§¸ ë¦¬ë·°ì¸ ê²½ìš° ë§ˆì§€ë§‰ ë¦¬ë·°ë¡œ ìˆœí™˜
      setSelectedReview(sortedReviews[sortedReviews.length - 1]);
    }
  };

  // Scroll to section function
  const scrollToSection = (sectionId) => {
    setActiveSection(sectionId);
    const section = document.getElementById(sectionId);
    if (section) {
      section.scrollIntoView({ behavior: 'smooth' });
    }
  };

  // ë¦¬ë·° ë°ì´í„° ë¡œë“œ ë° ì„¸ë¶€ í‰ì  ê³„ì‚° useEffect ì¶”ê°€
  useEffect(() => {
    if (reviews && reviews.length > 0) {
      // ë¦¬ë·° ì„¸ë¶€ í‰ì  ê³„ì‚° ë¡œì§
      let castTotal = 0;
      let storyTotal = 0;
      let musicTotal = 0;
      let rewatchTotal = 0;
      let validReviews = 0;
      
      reviews.forEach(review => {
        if (review && review.rating) {
          validReviews++;
          // ë§Œì•½ ë¦¬ë·°ì— ì„¸ë¶€ í‰ì ì´ ìˆë‹¤ë©´ ì‚¬ìš©, ì—†ë‹¤ë©´ ë¦¬ë·°ì˜ ì „ì²´ í‰ì ì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ê¸ˆì”© ì°¨ë“± ì ìš©
          castTotal += review.castRating || (review.rating * (Math.random() * 0.2 + 0.9));
          storyTotal += review.storyRating || (review.rating * (Math.random() * 0.2 + 0.9));
          musicTotal += review.musicRating || (review.rating * (Math.random() * 0.2 + 0.9));
          rewatchTotal += review.rewatchValue || (review.rating * (Math.random() * 0.4 + 0.7));
        }
      });
      
      if (validReviews > 0) {
        setCastRating((castTotal / validReviews).toFixed(1));
        setStoryRating((storyTotal / validReviews).toFixed(1));
        setMusicRating((musicTotal / validReviews).toFixed(1));
        setRewatchRating((rewatchTotal / validReviews).toFixed(1));
        
        console.log('ì„¸ë¶€ í‰ì  ê³„ì‚° ì™„ë£Œ:', {
          castRating: (castTotal / validReviews).toFixed(1),
          storyRating: (storyTotal / validReviews).toFixed(1),
          musicRating: (musicTotal / validReviews).toFixed(1),
          rewatchRating: (rewatchTotal / validReviews).toFixed(1)
        });
      }
    }
  }, [reviews]);

  // ì˜¤ë¥˜ê°€ ìˆê±°ë‚˜ ë¡œë”© ì¤‘ì¸ ê²½ìš° í‘œì‹œí•  UI
  if (error) {
    return (
      <MainLayout>
        <div className="container mx-auto px-4 py-8">
          <div className="bg-white rounded-xl p-6 text-center border border-red-200">
            <p className="text-red-500 mb-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <p className="text-gray-700 mb-4">{error.toString()}</p>
            <button
              onClick={() => router.push('/drama')}
              className="inline-flex items-center justify-center rounded-md bg-pink-600 px-4 py-2 text-sm font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2"
            >
              ë“œë¼ë§ˆ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
          </div>
        </div>
      </MainLayout>
    );
  }

  if (loading || !currentDrama) {
    return (
      <MainLayout>
        <div className="container mx-auto px-4 py-8 flex justify-center items-center min-h-[60vh]">
          <div className="text-center">
            <div className="w-16 h-16 border-4 border-pink-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p className="text-gray-600">ë“œë¼ë§ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
      </MainLayout>
    );
  }

  return (
    <MainLayout>
      <Seo
        title={currentDrama.title || "TV/Film Details"}
        description={currentDrama.summary || ""}
        image={currentDrama.coverImage || ""}
      />
      
      <div className="min-h-screen bg-white text-gray-800">
        {/* Hero Section - Modern Design with Glassmorphism (ë°ìŠ¤í¬íƒ‘ ì „ìš©) */}
        <div className="relative flex-col h-auto w-full hidden sm:flex">
          {/* Background Image with Enhanced Overlay */}
          <div className="relative w-full h-[280px] sm:h-[350px] md:h-[450px] overflow-hidden">
              <div className="relative w-full h-full">
              {renderImage(currentDrama.bannerImage || currentDrama.coverImage, currentDrama.title, "object-cover object-top", 0, 0, true)}
              <div className="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-black/20"></div>
              <div className="absolute inset-0 bg-gradient-to-r from-black/50 to-transparent"></div>
              </div>
              </div>
          
          {/* Content overlay with improved layout */}
          <div className="absolute inset-0 flex flex-col justify-end sm:justify-center p-6 md:p-12 z-10">
            <div className="container mx-auto max-w-screen-xl">
              <div className="sm:flex items-start gap-8">
                {/* Poster - With enhanced shadow and hover effect */}
                <div className="hidden sm:block relative w-[180px] h-[270px] sm:w-[200px] sm:h-[300px] rounded-xl overflow-hidden shadow-2xl flex-shrink-0 border-4 border-white/10 backdrop-blur-sm transform hover:scale-105 transition-all duration-300 group">
                  {renderImage(currentDrama.coverImage && currentDrama.coverImage.trim() !== '' ? currentDrama.coverImage : '/images/placeholder-tvfilm.jpg', currentDrama.title, "object-cover", 0, 0, true)}
                  <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
                </div>
                
                {/* Mobile poster (smaller and floating at top left) */}
                <div className="sm:hidden relative float-left w-[120px] h-[180px] mr-4 mb-4 rounded-lg overflow-hidden shadow-xl flex-shrink-0 border-2 border-white/10">
                  {renderImage(currentDrama.coverImage && currentDrama.coverImage.trim() !== '' ? currentDrama.coverImage : '/images/placeholder-tvfilm.jpg', currentDrama.title, "object-cover", 0, 0, true)}
                </div>
                
                {/* Content - Text details with improved typography */}
                <div className="flex-1 sm:pt-2">
                  {/* Category tag */}
                  <div className="mb-3 sm:mb-4 flex space-x-2">
                    <span className="px-3 py-1 bg-pink-500/30 text-pink-300 backdrop-blur-sm rounded-full text-xs font-medium inline-flex items-center">
                      <Film className="w-3 h-3 mr-1" />
                      {currentDrama.category || "Movie"}
                    </span>
                    {currentDrama.releaseDate && (
                      <span className="px-3 py-1 bg-white/10 text-white/80 backdrop-blur-sm rounded-full text-xs font-medium inline-flex items-center">
                        <Calendar className="w-3 h-3 mr-1 text-pink-300" />
                        {formatDate(currentDrama.releaseDate) || "2023"}
                      </span>
                    )}
                  </div>
                  
                  {/* Title with enhanced typography */}
                  <h1 className="text-2xl sm:text-3xl md:text-5xl font-bold mb-2 text-white leading-tight">
                    {currentDrama.title}
                  </h1>
                  
                  {/* Original title with improved styling */}
                  <div className="text-white/80 text-sm sm:text-lg mb-4 sm:mb-6">
                    {currentDrama.originalTitle && currentDrama.originalTitle !== currentDrama.title && 
                      <span className="font-medium">{currentDrama.originalTitle}</span>
                    }
                  </div>
                  
                  {/* Metrics row with modern design */}
                  <div className="flex flex-wrap items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <div className="flex items-center bg-black/40 backdrop-blur-sm px-2.5 sm:px-3.5 py-1.5 sm:py-2 rounded-full">
                      <div className="h-7 w-7 sm:h-8 sm:w-8 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white font-bold text-xs sm:text-sm mr-2 shadow-lg">
                        {currentDrama.reviewRating && currentDrama.reviewRating > 0
                          ? parseFloat(currentDrama.reviewRating) === 10
                            ? "10"
                            : parseFloat(currentDrama.reviewRating).toFixed(1)
                          : "-"
                        }
                      </div>
                      <span className="text-white/90 text-xs sm:text-sm">Rating</span>
                    </div>
                    
                    {currentDrama.ageRating && (
                      <div className="flex items-center bg-black/40 backdrop-blur-sm px-2.5 sm:px-3.5 py-1.5 sm:py-2 rounded-full">
                        <div className="flex items-center justify-center bg-pink-600 h-7 w-7 sm:h-8 sm:w-8 rounded-full text-white font-bold text-xs sm:text-sm mr-2 shadow-lg">
                          {typeof currentDrama.ageRating === 'string' && currentDrama.ageRating.includes('+') 
                            ? currentDrama.ageRating.split('+')[0]
                            : currentDrama.ageRating === 'Not Rated' || currentDrama.ageRating === 'Not Yet Rated' 
                              ? "NR"
                              : currentDrama.ageRating || "15"
                          }
                        </div>
                        <div className="flex flex-col">
                          <span className="text-white/90 text-xs sm:text-sm">Age</span>
                          {typeof currentDrama.ageRating === 'string' && currentDrama.ageRating.includes('+') && (
                            <span className="text-white/70 text-[10px] sm:text-xs">
                              {currentDrama.ageRating.includes('Teen') ? 'Teen' : 
                               currentDrama.ageRating.includes('older') ? 'and older' : ''}
                            </span>
                          )}
                          {(currentDrama.ageRating === 'Not Rated' || currentDrama.ageRating === 'Not Yet Rated') && (
                            <span className="text-white/70 text-[10px] sm:text-xs">Not Rated</span>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {currentDrama.runtime && (
                      <div className="flex items-center bg-black/40 backdrop-blur-sm px-2.5 sm:px-3.5 py-1.5 sm:py-2 rounded-full">
                        <Clock className="text-pink-400 w-4 h-4 sm:w-5 sm:h-5 mr-1.5 sm:mr-2" />
                        <span className="text-white/90 text-xs sm:text-sm">{currentDrama.runtime || "2h 17min"}</span>
                      </div>
                    )}
                  </div>
                  
                  {/* Action buttons with enhanced design */}
                  <div className="flex mt-4 sm:mt-6">
                    <button 
                      onClick={() => setShowTrailer(true)}
                      className="bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 text-white px-5 sm:px-6 py-2.5 sm:py-3 rounded-full flex items-center font-medium text-sm sm:text-base shadow-lg hover:shadow-xl transition-all group transform hover:translate-y-[-2px]"
                    >
                      <Play className="w-4 h-4 sm:w-5 sm:h-5 mr-2 sm:mr-2.5 group-hover:animate-pulse" />
                      Watch Trailer
                    </button>
                    {currentDrama.genres && currentDrama.genres.length > 0 && (
                      <div className="ml-3 sm:ml-4 flex items-center">
                        <div className="hidden sm:flex flex-wrap gap-1 ml-1">
                          {currentDrama.genres.slice(0, 2).map((genre, index) => (
                            <span key={index} className="px-2.5 py-1 bg-white/10 text-white/80 backdrop-blur-sm rounded-full text-xs font-medium">
                              {genre}
                            </span>
                          ))}
                          {currentDrama.genres.length > 2 && (
                            <span className="px-2 py-1 text-white/70 text-xs">+{currentDrama.genres.length - 2}</span>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {/* ëª¨ë°”ì¼ ì „ìš© ìƒë‹¨ ì •ë³´ ì˜ì—­ */}
        <div className="sm:hidden pt-4 pb-2 px-4 bg-white">
          {/* ì˜í™” ì •ë³´ ì¹´ë“œ (ë°ìŠ¤í¬íƒ‘ ìš°ì¸¡ íŒ¨ë„ ì»¨í…ì¸ ) */}
          <div className="bg-white rounded-2xl overflow-hidden shadow-md border border-gray-100 mb-4">
            {/* í—¤ë” ì˜ì—­ */}
            <div className="pt-5 px-5 border-b border-gray-100 pb-4 flex items-center justify-between">
              <h3 className="text-xl font-bold text-gray-900">
                {currentDrama.title}
              </h3>
              <div className="flex items-center bg-pink-50 px-2 py-1 rounded-full">
                <div className="h-6 w-6 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white font-bold text-xs mr-1.5 shadow-sm">
                  {currentDrama.reviewRating && currentDrama.reviewRating > 0
                    ? parseFloat(currentDrama.reviewRating) === 10
                      ? "10"
                      : parseFloat(currentDrama.reviewRating).toFixed(1)
                    : "-"
                  }
                </div>
                <span className="text-pink-600 text-xs font-medium">Rating</span>
              </div>
            </div>
            
            {/* í¬ìŠ¤í„°ì™€ ê¸°ë³¸ ì •ë³´ */}
            <div className="p-4 flex">
              {/* í¬ìŠ¤í„° ì„¬ë„¤ì¼ */}
              <div className="relative w-[100px] h-[150px] flex-shrink-0 rounded-lg overflow-hidden shadow-md border border-gray-200">
                {currentDrama && currentDrama.coverImage && renderImage(currentDrama.coverImage, currentDrama.title || "Drama Image", "object-cover", 0, 0, true)}
              </div>
              
              {/* ê¸°ë³¸ ì •ë³´ */}
              <div className="ml-4 flex flex-col flex-1 justify-center">
                {/* ì›ì œëª© */}
                {currentDrama.originalTitle && currentDrama.originalTitle !== currentDrama.title && (
                  <div className="text-gray-500 text-sm mb-2 italic">
                    {currentDrama.originalTitle}
                  </div>
                )}
                
                {/* ì¥ë¥´ */}
                <div className="flex flex-wrap gap-1 mb-2">
                  {(currentDrama && currentDrama.genres && Array.isArray(currentDrama.genres) && currentDrama.genres.length > 0) ? (
                    currentDrama.genres.slice(0, 3).map((genre, index) => (
                      <span key={index} className="px-2 py-0.5 bg-pink-50 text-pink-600 rounded-full text-xs font-medium">
                        {genre}
                      </span>
                    ))
                  ) : (
                    <span className="text-gray-500 text-xs">{currentDrama.category || "Drama"}</span>
                  )}
                </div>
                
                {/* ì •ë³´ í‘œì‹œ */}
                <div className="space-y-1">
                  {currentDrama.runtime && (
                    <div className="flex items-center text-gray-700">
                      <Clock className="w-3.5 h-3.5 text-pink-500 mr-1.5" />
                      <span className="text-xs">{currentDrama.runtime}</span>
                    </div>
                  )}
                  
                  {currentDrama.releaseDate && (
                    <div className="flex items-center text-gray-700">
                      <Calendar className="w-3.5 h-3.5 text-pink-500 mr-1.5" />
                      <span className="text-xs">{formatDate(currentDrama.releaseDate)}</span>
                    </div>
                  )}
                  
                  {currentDrama.ageRating && (
                    <div className="flex items-center text-gray-700">
                      <div className="flex items-center justify-center w-3.5 h-3.5 rounded-full bg-pink-500 text-white text-[8px] font-bold mr-1.5">
                        {typeof currentDrama.ageRating === 'string' && currentDrama.ageRating.includes('+') 
                          ? currentDrama.ageRating.split('+')[0]
                          : currentDrama.ageRating === 'Not Rated' ? "NR" 
                          : currentDrama.ageRating || "15"
                        }
                      </div>
                      <span className="text-xs">
                        {currentDrama.ageRating === '15' || currentDrama.ageRating?.includes('15+') ? '15 and over' : 
                         currentDrama.ageRating === '12' || currentDrama.ageRating?.includes('12+') ? '12 and over' : 
                         currentDrama.ageRating === '18' || currentDrama.ageRating?.includes('18+') ? 'Adults only' : 
                         currentDrama.ageRating === 'ALL' ? 'All ages' : 
                         currentDrama.ageRating === 'Not Rated' ? 'Not Rated' :
                         currentDrama.ageRating || 'Not rated'}
                      </span>
                    </div>
                  )}
                  
                  {currentDrama.director && (
                    <div className="flex items-center text-gray-700">
                      <Award className="w-3.5 h-3.5 text-pink-500 mr-1.5" />
                      <span className="text-xs">{currentDrama.director}</span>
                    </div>
                  )}
                  
                  {currentDrama.country && (
                    <div className="flex items-center text-gray-700">
                      <span className="mr-1.5 text-xs">ğŸŒ</span>
                      <span className="text-xs">{currentDrama.country || "South Korea"}</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            {/* íŠ¸ë ˆì¼ëŸ¬ ë²„íŠ¼ */}
            <div className="px-4 pb-4">
              <button 
                onClick={() => setShowTrailer(true)}
                className="bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 text-white w-full py-2.5 rounded-lg flex items-center justify-center font-medium text-sm shadow-md hover:shadow-lg transition-all"
              >
                <Play className="w-4 h-4 mr-2" />
                Watch Trailer
              </button>
            </div>
          </div>
          
          {/* ë¦¬ë·° í‰ê°€ ì ìˆ˜ (ëª¨ë°”ì¼ ì „ìš©) */}
          {currentDrama.reviewCount > 0 && (
            <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-1">
              <h3 className="text-sm font-medium text-gray-800 mb-2 flex items-center">
                <MessageCircle className="w-4 h-4 text-pink-500 mr-1.5" />
                Viewer Ratings
              </h3>
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-600">Acting/Cast</span>
                  <div className="flex items-center">
                    <div className="w-20 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                      <div 
                        className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                        style={{ width: `${(castRating || 8.0) * 10}%` }}
                      ></div>
                    </div>
                    <span className="text-xs font-medium text-gray-800">{castRating || 8.0}</span>
                  </div>
                </div>
                
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-600">Story</span>
                  <div className="flex items-center">
                    <div className="w-20 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                      <div 
                        className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                        style={{ width: `${(storyRating || 8.0) * 10}%` }}
                      ></div>
                    </div>
                    <span className="text-xs font-medium text-gray-800">{storyRating || 8.0}</span>
                  </div>
                </div>
                
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-600">Music</span>
                  <div className="flex items-center">
                    <div className="w-20 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                      <div 
                        className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                        style={{ width: `${(musicRating || 7.5) * 10}%` }}
                      ></div>
                    </div>
                    <span className="text-xs font-medium text-gray-800">{musicRating || 7.5}</span>
                  </div>
                </div>
                
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-600">Rewatch Value</span>
                  <div className="flex items-center">
                    <div className="w-20 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                      <div 
                        className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                        style={{ width: `${(rewatchRating || 7.0) * 10}%` }}
                      ></div>
                    </div>
                    <span className="text-xs font-medium text-gray-800">{rewatchRating || 7.0}</span>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
        
        {/* Trailer Modal */}
        {showTrailer && (
          <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div className="relative w-full max-w-5xl bg-black rounded-2xl overflow-hidden shadow-2xl border border-white/10">
              <div className="aspect-video">
                <iframe 
                  width="100%" 
                  height="100%" 
                  src={`https://www.youtube.com/embed/${selectedVideoId || youtubeId}?autoplay=1`} 
                  title="YouTube video player" 
                  frameBorder="0" 
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                  allowFullScreen
                  className="absolute inset-0"
                ></iframe>
              </div>
              <button 
                onClick={() => setShowTrailer(false)}
                className="absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-colors backdrop-blur-sm"
              >
                <X className="w-6 h-6" />
              </button>
              
              <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent">
                <h3 className="text-white text-lg font-medium">{currentDrama.title}</h3>
                <p className="text-white/70 text-sm">{trailerTitle}</p>
              </div>
            </div>
          </div>
        )}
        
        {/* ë¦¬ë·° ëª¨ë‹¬ */}
        {showReviewModal && selectedReview && (
          <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={closeReviewModal}>
            {/* ì´ì „ ë¦¬ë·° ë²„íŠ¼ - ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ ë°”ê¹¥ìœ¼ë¡œ ì´ë™ */}
            {reviews.length > 1 && (
              <button 
                onClick={(e) => {
                  e.stopPropagation();
                  goToPrevReview();
                }}
                className="absolute left-4 md:left-8 top-1/2 transform -translate-y-1/2 p-3 rounded-full bg-black/40 backdrop-blur-sm hover:bg-black/60 shadow-lg hover:shadow-xl text-white transition-all z-20"
                aria-label="Previous review"
              >
                <ChevronLeft className="w-6 h-6" />
              </button>
            )}
            
            {/* ë‹¤ìŒ ë¦¬ë·° ë²„íŠ¼ - ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ ë°”ê¹¥ìœ¼ë¡œ ì´ë™ */}
            {reviews.length > 1 && (
              <button 
                onClick={(e) => {
                  e.stopPropagation();
                  goToNextReview();
                }}
                className="absolute right-4 md:right-8 top-1/2 transform -translate-y-1/2 p-3 rounded-full bg-black/40 backdrop-blur-sm hover:bg-black/60 shadow-lg hover:shadow-xl text-white transition-all z-20"
                aria-label="Next review"
              >
                <ChevronRight className="w-6 h-6" />
              </button>
            )}
            
            <div 
              className="relative w-full max-w-3xl bg-white rounded-xl overflow-hidden shadow-2xl border border-pink-100 mx-4 my-8" 
              onClick={e => e.stopPropagation()}
            >
              <div className="p-5 sm:p-6 max-h-[calc(100vh-4rem)] overflow-y-auto">
                <div className="absolute top-4 right-4">
                  <button 
                    onClick={closeReviewModal}
                    className="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-full transition-colors"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>
                
                {/* ì´ì „ ë¦¬ë·° ë²„íŠ¼ê³¼ ë‹¤ìŒ ë¦¬ë·° ë²„íŠ¼ ì œê±° - ìƒìœ„ë¡œ ì´ë™ì‹œí‚´ */}
                
                <div className="flex items-center mb-4 gap-3">
                  <div className="h-12 w-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white font-bold text-lg">
                    {selectedReview.rating}
                  </div>
                  <div>
                    <h3 className="text-gray-900 font-bold text-lg">{selectedReview.title}</h3>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-600 font-medium">{selectedReview.username || 'Anonymous'}</span>
                      <span className="text-xs text-gray-500">
                        {selectedReview.reviewDate || new Date(selectedReview.createdAt || Date.now()).toLocaleDateString('ko-KR', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric'
                        })}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div className="flex mb-4">
                  {[1, 2, 3, 4, 5].map(star => (
                    <Star
                      key={star}
                      className={`w-5 h-5 ${
                        star <= Math.floor(selectedReview.rating / 2)
                          ? 'text-yellow-400 fill-yellow-400'
                          : 'text-gray-300'
                      }`}
                    />
                  ))}
                </div>
                
                {/* ì„¸ë¶€ í‰ì  (ìˆëŠ” ê²½ìš°) */}
                <div className="bg-gray-50 p-4 rounded-lg mb-4 grid grid-cols-2 gap-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600">Acting/Cast</span>
                    <span className="text-sm font-medium text-pink-600">
                      {selectedReview.castRating ? selectedReview.castRating : (selectedReview.rating * 0.9).toFixed(1)}/10
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600">Story</span>
                    <span className="text-sm font-medium text-pink-600">
                      {selectedReview.storyRating ? selectedReview.storyRating : (selectedReview.rating * 0.95).toFixed(1)}/10
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600">Music</span>
                    <span className="text-sm font-medium text-pink-600">
                      {selectedReview.musicRating ? selectedReview.musicRating : (selectedReview.rating * 0.9).toFixed(1)}/10
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600">Rewatch Value</span>
                    <span className="text-sm font-medium text-pink-600">
                      {selectedReview.rewatchValue ? selectedReview.rewatchValue : (selectedReview.rating * 0.85).toFixed(1)}/10
                    </span>
                  </div>
                </div>
                
                {/* ë¦¬ë·° ë‚´ìš© */}
                <div className="prose max-w-none mb-4">
                  <div className="text-gray-700 whitespace-pre-line">
                    {selectedReview.reviewText?.replace(/^This review may contain spoilers\s+/i, '') || 
                     "No detailed review provided."}
                  </div>
                </div>
                
                {/* íƒœê·¸ */}
                {selectedReview.tags && selectedReview.tags.length > 0 && (
                  <div className="mt-4 flex flex-wrap gap-2">
                    {selectedReview.tags.map((tag, index) => (
                      <span key={index} className="px-2.5 py-1 bg-pink-50 text-pink-600 rounded-full text-xs font-medium">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
                
                {/* í•˜ë‹¨ ë©”íƒ€ ì •ë³´ */}
                <div className="mt-6 border-t border-gray-100 pt-4 flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    {selectedReview.helpfulCount > 0 && (
                      <span className="text-xs px-2.5 py-1 bg-gray-100 text-gray-700 rounded-full">
                        <ThumbsUp className="w-3 h-3 inline mr-1" />
                        {selectedReview.helpfulCount} helpful
                      </span>
                    )}
                    
                    {selectedReview.watched && (
                      <span className="text-xs px-2.5 py-1 bg-green-50 text-green-700 rounded-full">
                        <Check className="w-3 h-3 inline mr-1" />
                        Watched
                      </span>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
        
        {/* Tab Navigation - Modernized */}
        <div className="sticky top-0 z-10 bg-white">
          <div className="container mx-auto px-4 lg:px-8">
            <div className="flex overflow-x-auto hide-scrollbar">
              <a
                href="#watch"
                onClick={(e) => { e.preventDefault(); setActiveSection('watch'); document.getElementById('watch').scrollIntoView({ behavior: 'smooth' }); }}
                className={`group relative flex items-center px-5 py-4 text-sm transition-all whitespace-nowrap ${
                  activeSection === 'watch'
                    ? 'text-pink-500 font-medium'
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                <div className={`flex items-center justify-center ${activeSection === 'watch' ? 'text-pink-500' : 'text-gray-400 group-hover:text-gray-600'}`}>
                  <Eye className="w-4 h-4 mr-2" />
                  <span>Where to Watch</span>
                </div>
                {activeSection === 'watch' && (
                  <div className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-pink-400 to-pink-500 rounded-t-full"></div>
                )}
              </a>
              <a
                href="#synopsis"
                onClick={(e) => { e.preventDefault(); setActiveSection('synopsis'); document.getElementById('synopsis').scrollIntoView({ behavior: 'smooth' }); }}
                className={`group relative flex items-center px-5 py-4 text-sm transition-all whitespace-nowrap ${
                  activeSection === 'synopsis'
                    ? 'text-pink-500 font-medium'
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                <div className={`flex items-center justify-center ${activeSection === 'synopsis' ? 'text-pink-500' : 'text-gray-400 group-hover:text-gray-600'}`}>
                  <Info className="w-4 h-4 mr-2" />
                  <span>Synopsis</span>
                </div>
                {activeSection === 'synopsis' && (
                  <div className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-pink-400 to-pink-500 rounded-t-full"></div>
                )}
              </a>
              <a
                href="#trailers"
                onClick={(e) => { e.preventDefault(); setActiveSection('trailers'); document.getElementById('trailers').scrollIntoView({ behavior: 'smooth' }); }}
                className={`group relative flex items-center px-5 py-4 text-sm transition-all whitespace-nowrap ${
                  activeSection === 'trailers'
                    ? 'text-pink-500 font-medium'
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                <div className={`flex items-center justify-center ${activeSection === 'trailers' ? 'text-pink-500' : 'text-gray-400 group-hover:text-gray-600'}`}>
                  <Play className="w-4 h-4 mr-2" />
                  <span>Trailers</span>
                </div>
                {activeSection === 'trailers' && (
                  <div className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-pink-400 to-pink-500 rounded-t-full"></div>
                )}
              </a>
              <a
                href="#cast"
                onClick={(e) => { e.preventDefault(); setActiveSection('cast'); document.getElementById('cast').scrollIntoView({ behavior: 'smooth' }); }}
                className={`group relative flex items-center px-5 py-4 text-sm transition-all whitespace-nowrap ${
                  activeSection === 'cast'
                    ? 'text-pink-500 font-medium'
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                <div className={`flex items-center justify-center ${activeSection === 'cast' ? 'text-pink-500' : 'text-gray-400 group-hover:text-gray-600'}`}>
                  <User className="w-4 h-4 mr-2" />
                  <span>Cast</span>
                </div>
                {activeSection === 'cast' && (
                  <div className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-pink-400 to-pink-500 rounded-t-full"></div>
                )}
              </a>
              <a
                href="#reviews"
                onClick={(e) => { e.preventDefault(); setActiveSection('reviews'); document.getElementById('reviews').scrollIntoView({ behavior: 'smooth' }); }}
                className={`group relative flex items-center px-5 py-4 text-sm transition-all whitespace-nowrap ${
                  activeSection === 'reviews'
                    ? 'text-pink-500 font-medium'
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                <div className={`flex items-center justify-center ${activeSection === 'reviews' ? 'text-pink-500' : 'text-gray-400 group-hover:text-gray-600'}`}>
                  <MessageCircle className="w-4 h-4 mr-2" />
                  <span>Reviews</span>
                </div>
                {activeSection === 'reviews' && (
                  <div className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-pink-400 to-pink-500 rounded-t-full"></div>
                )}
              </a>
              <a
                href="#similar"
                onClick={(e) => { e.preventDefault(); setActiveSection('similar'); document.getElementById('similar').scrollIntoView({ behavior: 'smooth' }); }}
                className={`group relative flex items-center px-5 py-4 text-sm transition-all whitespace-nowrap ${
                  activeSection === 'similar'
                    ? 'text-pink-500 font-medium'
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                <div className={`flex items-center justify-center ${activeSection === 'similar' ? 'text-pink-500' : 'text-gray-400 group-hover:text-gray-600'}`}>
                  <ListFilter className="w-4 h-4 mr-2" />
                  <span>Similar</span>
                </div>
                {activeSection === 'similar' && (
                  <div className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-pink-400 to-pink-500 rounded-t-full"></div>
                )}
              </a>
            </div>
          </div>
        </div>
        
        {/* Main Content */}
        <div className="bg-white pt-10">
          <div className="container mx-auto px-4 lg:px-8 py-10">
            <div className="flex flex-col lg:flex-row gap-12">
              {/* Left Column - with flex ordering for mobile */}
              <div className="lg:w-2/3 flex flex-col">
                {/* Where to Watch section */}
                <div id="watch" className="mb-12 scroll-mt-24 order-1">
                  <h2 className="text-2xl font-bold mb-5 text-gray-900 border-l-4 border-pink-500 pl-4 py-1">
                    Where to Watch
                  </h2>
                  
                  {/* í•„í„° ì„ íƒ ì˜ì—­ ì™„ì „íˆ ì œê±° */}
                  
                  {/* Streaming services list */}
                  <div className="space-y-4">
                    {currentDrama?.watchProviders && currentDrama.watchProviders.length > 0 ? (
                      currentDrama.watchProviders.map((provider, index) => (
                        <div 
                          key={index} 
                          className="bg-white rounded-xl overflow-hidden transition-all duration-300 hover:shadow-xl hover:translate-y-[-3px] border border-gray-100 shadow-sm relative group"
                        >
                          <div className="absolute inset-0 bg-gradient-to-r from-pink-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 sm:p-5 relative">
                            <div className="flex items-center w-full sm:w-auto">
                              {/* Watch Provider logo */}
                              <div className={`${provider.logo || provider.imageUrl ? 'bg-white' : 'bg-gray-100'} h-12 w-24 sm:h-14 sm:w-32 flex items-center justify-center rounded-lg overflow-hidden shadow-md border border-gray-100 group-hover:border-pink-200 transition-colors duration-300`}>
                                {provider.logo || provider.imageUrl ? 
                                  renderImage(provider.imageUrl || provider.logo, provider.name, "object-contain w-full h-full p-1", 0, 0, false, 'logo') : 
                                  <span className="text-gray-800 font-bold text-base sm:text-lg">{provider.name}</span>
                                }
                              </div>
                              <div className="ml-3 sm:ml-4">
                                <h3 className="text-base font-semibold text-gray-900 group-hover:text-pink-600 transition-colors duration-300">{provider.name}</h3>
                                <div className="flex flex-wrap gap-1.5 mt-2">
                                  {provider.quality && provider.quality.map((quality, qIndex) => (
                                    <div key={qIndex} className="bg-gray-50 text-gray-600 group-hover:bg-pink-50 group-hover:text-pink-600 text-xs px-2.5 py-1 rounded-full font-medium border border-gray-100 group-hover:border-pink-200 transition-all duration-300">{quality}</div>
                                  ))}
                                </div>
                              </div>
                            </div>
                            {/* ë°ìŠ¤í¬íƒ‘ì—ì„œë§Œ ë³´ì´ëŠ” íƒ€ì… ë° ë²„íŠ¼ ì˜ì—­ */}
                            <div className="hidden sm:flex items-center justify-between sm:justify-end w-full sm:w-auto mt-4 sm:mt-0 border-t sm:border-t-0 pt-3 sm:pt-0 mt-3 sm:mt-0">
                              <div className="sm:mr-6 text-left sm:text-right">
                                <div className="text-gray-900 font-semibold text-sm sm:text-base">
                                  {provider?.type ? provider.type.charAt(0).toUpperCase() + provider.type.slice(1) : 'Unknown'}
                                </div>
                                {provider.price && (
                                  <div className="text-pink-500 text-xs sm:text-sm font-medium">{provider.price}</div>
                                )}
                              </div>
                              {provider.url ? (
                                <a 
                                  href={provider.url} 
                                  target="_blank" 
                                  rel="noopener noreferrer" 
                                  className="bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white px-5 sm:px-6 py-2.5 sm:py-3 rounded-full flex items-center font-medium text-sm shadow-md hover:shadow-lg transition-all group-hover:scale-105 duration-300"
                                >
                                  <Play className="w-4 h-4 mr-1.5 sm:mr-2" />
                                  <span>Watch Now</span>
                                </a>
                              ) : (
                                <button className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 sm:px-6 py-2.5 sm:py-3 rounded-full flex items-center font-medium text-sm shadow-sm hover:shadow transition-all">
                                  <Play className="w-4 h-4 mr-1.5 sm:mr-2" />
                                  <span>Watch Now</span>
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="bg-white rounded-xl p-8 text-center border border-gray-100 shadow-sm">
                        <div className="w-16 h-16 bg-pink-50 rounded-full flex items-center justify-center mx-auto mb-4">
                          <Eye className="w-8 h-8 text-pink-300" />
                        </div>
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">No Providers Found</h3>
                        <p className="text-gray-500 max-w-md mx-auto">
                          No watch providers available for this content.
                        </p>
                        <p className="text-gray-400 text-sm mt-2">Check back later</p>
                      </div>
                    )}
                  </div>
                </div>
                
                {/* Synopsis section - ì‹œë†‰ì‹œìŠ¤ */}
                <div id="synopsis" className="mb-16 scroll-mt-24 order-2">
                  <h2 className="text-2xl font-bold mb-5 text-gray-900 border-l-4 border-pink-500 pl-4 py-1">
                    Synopsis
                  </h2>
                  
                  <div className="px-1 py-2">
                    <div className="prose prose-lg max-w-none">
                      <p className="text-gray-700 leading-relaxed">
                        {currentDrama.description || currentDrama.summary || "ì‹œë†‰ì‹œìŠ¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."}
                      </p>
                    </div>
                  </div>
                </div>
                
                {/* Episodes ì„¹ì…˜ ë°”ë¡œ ì•ì— ì¶”ê°€ */}
                {/* Reviews Section */}
                <div id="reviews" className="mb-4 scroll-mt-24 order-5">
                  <div className="flex items-center justify-between mb-5">
                    <h2 className="text-2xl font-bold text-gray-900 border-l-4 border-pink-500 pl-4 py-1 flex items-center">
                      Reviews
                      <span className="ml-2 text-sm font-normal text-gray-500 align-middle">{dramaData?.data?.reviewCount || '0'}</span>
                    </h2>
                  </div>
                  
                  <div className="bg-white rounded-xl overflow-hidden">
                    {/* í‰ì  ê°€ë¡œí˜• ë ˆì´ì•„ì›ƒ - ìƒë‹¨ ë°°ì¹˜ */}
                    <div className="p-4 sm:p-6 border-b border-gray-50">
                      <div className="flex flex-col md:flex-row md:items-center gap-4 md:gap-8">
                        {/* ë©”ì¸ í‰ì  í‘œì‹œ */}
                        <div className="flex items-center">
                          <div className="bg-white p-4 sm:p-5 rounded-full shadow-lg border border-pink-100 relative">
                            <div className="text-3xl sm:text-4xl md:text-5xl font-bold bg-gradient-to-r from-pink-500 to-rose-600 bg-clip-text text-transparent">
                              {dramaData?.data?.reviewRating ? parseFloat(dramaData.data.reviewRating).toFixed(1) : '0.0'}
                            </div>
                            <div className="absolute -top-1 -right-1 w-6 h-6 bg-yellow-400 rounded-full text-xs text-white flex items-center justify-center shadow-sm font-bold">
                              10
                            </div>
                          </div>
                          <div className="ml-4">
                            <h3 className="text-gray-700 font-medium text-sm uppercase tracking-wider mb-1">Overall Rating</h3>
                            <div className="flex items-center">
                              <div className="flex">
                                {[1, 2, 3, 4, 5].map(star => (
                                  <Star
                                    key={star}
                                    className={`w-5 h-5 ${
                                      star <= Math.round(parseFloat(dramaData?.data?.reviewRating || 0)/2)
                                        ? 'text-yellow-400 fill-yellow-400'
                                        : 'text-gray-300'
                                    }`}
                                  />
                                ))}
                              </div>
                              <span className="ml-2 text-sm text-gray-600 font-medium">({dramaData?.data?.reviewCount || 0} reviews)</span>
                            </div>
                          </div>
                        </div>
                        
                        {/* í‰ì  ë¶„í¬ - ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œí˜•, ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ê°€ë¡œí˜• */}
                        <div className="flex-1 mt-2 md:mt-0">
                          <div className="flex justify-between items-center">
                            <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Rating Distribution</h4>
                            {dramaData?.data?.reviewCount === 0 && (
                              <span className="text-xs text-pink-500 bg-pink-50 px-2 py-1 rounded-full">No ratings yet</span>
                            )}
                          </div>
                          
                          {/* ë°ìŠ¤í¬íƒ‘ìš© ê°€ë¡œí˜• ë ˆì´ì•„ì›ƒ - ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ¨ê¹€ */}
                          <div className="hidden md:grid grid-cols-5 gap-2">
                            {(dramaData?.data?.ratingDistribution || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]).slice(5).reverse().map((count, index) => {
                              // Calculate percentage for ratings 6-10
                              const ratingNumber = 10 - index;
                              const percentage = dramaData?.data?.reviewCount && dramaData.data.reviewCount > 0
                                ? Math.round((count / dramaData.data.reviewCount) * 100)
                                : 0;
                              
                              return (
                                <div key={ratingNumber} className="flex flex-col items-center group">
                                  <span className="text-xs font-medium text-gray-600 mb-1">{ratingNumber}</span>
                                  <div className="h-2.5 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div 
                                      className={`h-full rounded-full transition-all duration-500 ease-out group-hover:from-pink-500 group-hover:to-rose-600 shadow-sm ${
                                        percentage > 0 
                                          ? 'bg-gradient-to-r from-pink-400 to-rose-500'
                                          : dramaData?.data?.reviewCount === 0 ? 'bg-pink-100' : 'bg-gray-100'
                                      }`}
                                      style={{ width: percentage > 0 ? `${percentage}%` : '5%' }}
                                    ></div>
                                  </div>
                                  <span className="text-xs font-medium text-gray-500 mt-1">{percentage}%</span>
                                </div>
                              );
                            })}
                          </div>
                          
                          {/* ëª¨ë°”ì¼ìš© ì„¸ë¡œí˜• ë ˆì´ì•„ì›ƒ - ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ìˆ¨ê¹€ */}
                          <div className="md:hidden space-y-1">
                            {(dramaData?.data?.ratingDistribution || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]).slice(5).reverse().map((count, index) => {
                              // Calculate percentage for ratings 6-10
                              const ratingNumber = 10 - index;
                              const percentage = dramaData?.data?.reviewCount && dramaData.data.reviewCount > 0
                                ? Math.round((count / dramaData.data.reviewCount) * 100)
                                : 0;
                              
                              return (
                                <div key={ratingNumber} className="flex items-center group">
                                  <span className="w-6 text-xs font-medium text-gray-600 text-center">{ratingNumber}</span>
                                  <div className="flex-grow mx-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div 
                                      className="h-full rounded-full bg-gradient-to-r from-pink-400 to-rose-500 transition-all duration-500 ease-out group-hover:from-pink-500 group-hover:to-rose-600 shadow-sm"
                                      style={{ width: `${percentage}%` }}
                                    ></div>
                                  </div>
                                  <span className="w-8 text-right text-xs font-medium text-gray-500">{percentage}%</span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* ë¦¬ë·° ëª©ë¡ ì„¹ì…˜ - í•˜ë‹¨ ë°°ì¹˜ */}
                    <div className="p-4 sm:p-6">
                      <div className="flex items-center justify-between mb-2 sm:mb-4">
                        <h3 className="font-bold text-lg text-gray-800 flex items-center">
                          <MessageSquare className="w-4 h-4 mr-2 text-pink-500" />
                          Featured Reviews
                        </h3>
                      </div>
                      
                      {/* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë¦¬ë·° ì»¨í…Œì´ë„ˆ */}
                      {loadingReviews ? (
                        <div className="flex justify-center items-center h-40">
                          <div className="animate-spin rounded-full h-10 w-10 border-4 border-pink-500 border-t-transparent"></div>
                        </div>
                      ) : reviewsError ? (
                        <div className="bg-red-50 p-4 rounded-lg text-red-600 text-center">
                          <p>{reviewsError}</p>
                        </div>
                      ) : reviews.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-10 text-center">
                          <div className="w-16 h-16 bg-pink-50 rounded-full flex items-center justify-center mb-4">
                            <MessageSquare className="w-7 h-7 text-pink-300" />
                          </div>
                          <h4 className="text-lg font-medium text-gray-700 mb-2">No Reviews Yet</h4>
                          <p className="text-gray-500 max-w-md">
                            Be the first to share your thoughts about this title with the community!
                          </p>
                        </div>
                      ) : (
                        <div className="relative">
                          <div className="overflow-x-auto hide-scrollbar pb-3" ref={reviewsContainerRef}>
                            <div className="flex space-x-4" style={{ minWidth: 'max-content' }}>
                              {reviews
                                .sort((a, b) => (b.featured === true) - (a.featured === true))
                                .slice(0, 6)
                                .map((review, index) => (
                                  <div 
                                    key={review._id || review.reviewId || index} 
                                    className={`w-[320px] flex-shrink-0 bg-white border ${review.featured ? 'border-pink-300 shadow-md' : 'border-gray-200'} rounded-xl p-3 hover:shadow-md transition-all duration-300 hover:border-pink-200 group relative cursor-pointer`}
                                    onClick={() => openReviewModal(review)}
                                  >
                                    {/* Decorative accent */}
                                    <div className="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-pink-100 to-transparent rounded-tr-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                    
                                    {/* ëŒ€í‘œ ë¦¬ë·° ë°°ì§€ í‘œì‹œ */}
                                    {review.featured && (
                                      <div className="absolute -top-2 -right-2 bg-pink-500 text-white text-xs px-2 py-1 rounded-full shadow-sm">
                                        Featured
                                      </div>
                                    )}
                                    
                                    <div className="flex justify-between items-start mb-2 relative">
                                      <div className="flex items-center">
                                        <div className={`h-9 w-9 rounded-full ${review.featured ? 'bg-gradient-to-br from-pink-500 to-rose-600' : 'bg-gradient-to-br from-pink-400 to-rose-500'} flex items-center justify-center text-white font-bold text-sm shadow-sm group-hover:shadow-md transition-all duration-300`}>
                                          {review.rating}
                                        </div>
                                        <div className="ml-2">
                                          <div className="text-sm font-semibold text-gray-800 group-hover:text-pink-600 transition-colors duration-300">{review.username || 'Anonymous'}</div>
                                          <div className="flex mt-0.5">
                                            {[1, 2, 3, 4, 5].map(star => (
                                              <Star
                                                key={star}
                                                className={`w-3 h-3 ${
                                                  star <= Math.floor(review.rating / 2)
                                                    ? 'text-yellow-400 fill-yellow-400'
                                                    : 'text-gray-300'
                                                }`}
                                              />
                                            ))}
                                          </div>
                                        </div>
                                      </div>
                                      <span className="text-xs text-gray-400 group-hover:text-gray-500 transition-colors duration-300">
                                        {review.reviewDate || new Date(review.createdAt || Date.now()).toLocaleDateString('ko-KR', {
                                          month: 'short',
                                          day: 'numeric'
                                        })}
                                      </span>
                                    </div>
                                    
                                    <h4 className="font-bold text-gray-900 text-sm mb-2.5 line-clamp-1 group-hover:text-pink-600 transition-colors duration-300">{review.title}</h4>
                                    <p className="text-gray-600 text-sm line-clamp-3 group-hover:text-gray-700 transition-colors duration-300">
                                      {review.reviewText?.replace(/\s{2,}/g, ' ').replace(/^This review may contain spoilers\s+/i, '')}
                                    </p>
                                    
                                    <div className="mt-2 flex justify-between items-center">
                                      <div className="flex flex-wrap gap-1">
                                        {review.helpfulCount > 0 && (
                                          <span className="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full group-hover:bg-pink-50 group-hover:text-pink-600 transition-colors duration-300">
                                            <ThumbsUp className="w-3 h-3 inline mr-1" />
                                            {review.helpfulCount} helpful
                                          </span>
                                        )}
                                      </div>
                                      <span className="text-xs text-pink-500 hover:text-pink-600 font-medium flex items-center group-hover:opacity-100 transition-opacity duration-300">
                                        Read
                                        <ChevronRight className="w-3 h-3 ml-0.5" />
                                      </span>
                                    </div>
                                  </div>
                                ))
                              }
                            </div>
                          </div>
                          
                          {/* ìŠ¤í¬ë¡¤ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */}
                          {showReviewRightArrow && (
                            <div className="absolute top-1/2 -right-4 transform -translate-y-1/2">
                              <button 
                                onClick={() => scrollReviews('right')}
                                className="w-8 h-8 rounded-full bg-white shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:text-pink-500 hover:border-pink-200 transition-all group"
                              >
                                <ChevronRight className="w-5 h-5 group-hover:scale-110 transition-transform" />
                              </button>
                            </div>
                          )}
                          
                          {showReviewLeftArrow && (
                            <div className="absolute top-1/2 -left-4 transform -translate-y-1/2">
                              <button 
                                onClick={() => scrollReviews('left')}
                                className="w-8 h-8 rounded-full bg-white shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:text-pink-500 hover:border-pink-200 transition-all group"
                              >
                                <ChevronRight className="w-5 h-5 rotate-180 group-hover:scale-110 transition-transform" />
                              </button>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
                
                {/* Trailers Section - ì˜ˆê³ í¸ */}
                <div id="trailers" className="mb-12 scroll-mt-24 order-3">
                  <h2 className="text-2xl font-bold mb-5 text-gray-900 border-l-4 border-pink-500 pl-4 py-1">
                    Videos: Trailers & Teasers
                  </h2>
                  
                  <div className="relative">
                    <div 
                      className="overflow-x-auto hide-scrollbar pb-4" 
                      ref={videosContainerRef}
                      onTouchStart={(e) => {
                        const touch = e.touches[0];
                        setTouchStartX(touch.clientX);
                      }}
                      onTouchMove={(e) => {
                        const touch = e.touches[0];
                        setTouchEndX(touch.clientX);
                      }}
                      onTouchEnd={() => {
                        if (!touchStartX || !touchEndX) return;
                        
                        const distance = touchStartX - touchEndX;
                        const minSwipeDistance = 50; // ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬
                        
                        if (distance > minSwipeDistance) {
                          // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ - ë‹¤ìŒ ë¹„ë””ì˜¤ë¡œ
                          scrollVideos('right');
                        } else if (distance < -minSwipeDistance) {
                          // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ - ì´ì „ ë¹„ë””ì˜¤ë¡œ
                          scrollVideos('left');
                        }
                        
                        // í„°ì¹˜ ìƒíƒœ ì´ˆê¸°í™”
                        setTouchStartX(0);
                        setTouchEndX(0);
                      }}
                    >
                      {currentDrama.videos && currentDrama.videos.length > 0 ? (
                        <div className="flex space-x-5 min-w-max">
                          {currentDrama.videos.map((video, index) => {
                            const videoId = getYoutubeIdFromUrl(video.url);
                            return (
                              <div key={index} className="w-96 flex-shrink-0 rounded-xl overflow-hidden group border border-gray-100 shadow-sm hover:shadow-md transition-all">
                                <div className="relative aspect-video bg-gray-100">
                                  {videoId ? (
                                    <Image 
                                      src={`https://img.youtube.com/vi/${videoId}/mqdefault.jpg`}
                                      alt={video.title}
                                      fill
                                      className="object-cover"
                                      unoptimized={true}
                                      onError={(e) => {
                                        e.target.onerror = null;
                                        e.target.src = '/images/placeholder-tvfilm.jpg';
                                      }}
                                    />
                                  ) : (
                                    renderImage('/images/placeholder-tvfilm.jpg', video.title)
                                  )}
                                  
                                  {/* ì¸ë„¤ì¼ ì™¼ìª½ ìƒë‹¨ì— íƒ€ì´í‹€ ì¶”ê°€ */}
                                  {video.title && (
                                    <div className="absolute top-2 left-2 z-10">
                                      <div className="inline-flex px-3 py-1 bg-black/40 backdrop-blur-sm text-white rounded-full text-xs font-medium border border-white/20">
                                        {video.title || "Official Trailer"}
                                      </div>
                                    </div>
                                  )}
                                  
                                  <button 
                                    onClick={(e) => {
                                      e.preventDefault();
                                      setSelectedVideoId(videoId);
                                      setTrailerTitle(video.title || "Official Trailer");
                                      setShowTrailer(true);
                                    }}
                                    className="absolute inset-0 flex items-center justify-center bg-black/10 group-hover:bg-black/0 transition-all"
                                  >
                                    <div className="h-16 w-16 rounded-full bg-white/20 backdrop-blur-md group-hover:backdrop-blur-none border border-white/30 flex items-center justify-center transform group-hover:scale-110 transition-all duration-300 group-hover:bg-pink-500">
                                      <Play className="w-8 h-8 text-white ml-0.5" />
                                    </div>
                                  </button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      ) : (
                        <div className="text-center py-10">
                          <FileImage size={40} className="mx-auto text-gray-300 mb-3" />
                          <p className="text-gray-500 font-medium">No videos available</p>
                          <p className="text-gray-400 text-sm mt-1">Check back later for trailers and teasers</p>
                        </div>
                      )}
                    </div>
                    
                    {/* ë¹„ë””ì˜¤ ìŠ¤í¬ë¡¤ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */}
                    {currentDrama.videos && currentDrama.videos.length > 1 && (
                      <>
                        {/* ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ ë²„íŠ¼ - ì˜¤ë¥¸ìª½ ëì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ */}
                        {showRightArrow && (
                          <div className="absolute top-1/2 -right-4 transform -translate-y-1/2 z-10">
                            <button 
                              onClick={() => scrollVideos('right')}
                              className="w-10 h-10 rounded-full bg-white shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:text-pink-500 hover:border-pink-200 transition-all group"
                            >
                              <ChevronRight className="w-6 h-6 group-hover:scale-110 transition-transform" />
                            </button>
                          </div>
                        )}
                        
                        {/* ì™¼ìª½ í™”ì‚´í‘œ ë²„íŠ¼ - ì™¼ìª½ ëì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ */}
                        {showLeftArrow && (
                          <div className="absolute top-1/2 -left-4 transform -translate-y-1/2 z-10">
                            <button 
                              onClick={() => scrollVideos('left')}
                              className="w-10 h-10 rounded-full bg-white shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:text-pink-500 hover:border-pink-200 transition-all group"
                            >
                              <ChevronRight className="w-6 h-6 rotate-180 group-hover:scale-110 transition-transform" />
                            </button>
                          </div>
                        )}
                      </>
                    )}
                  </div>
                </div>
                
                {/* Cast Section - ì¶œì—°ì§„ */}
                <div id="cast" className="mb-14 scroll-mt-24 order-4">
                  {/* ì¶”ê°€: ë Œë”ë§ ì§ì „ cast ì „ì²´ ë¡œê·¸ */}
                  {console.log('cast for render:', cast)}
                  <h2 className="text-2xl font-bold mb-5 text-gray-900 border-l-4 border-pink-500 pl-4 py-1">
                    Cast
                  </h2>
                  
                  <div className="relative">
                    <div className="overflow-x-auto hide-scrollbar pb-4" ref={castContainerRef}>
                      <div className="flex space-x-5 min-w-max">
                        {cast.length > 0 ? (
                          cast.map((actor, index) => {
                            // ì›ë³¸ ì´ë¯¸ì§€ í•„ë“œê°’ ì „ë¶€ ë¡œê·¸
                            console.log(`${actor.name}ì˜ ì´ë¯¸ì§€ í•„ë“œ:`, {
                              profileImage: actor.profileImage,
                              image: actor.image,
                              profile: actor.profile,
                              profileImg: actor.profileImg,
                              avatar: actor.avatar
                            });
                            
                            // profileImage í•„ë“œ ì§ì ‘ ì‚¬ìš© (API ì‘ë‹µì— ì´ í•„ë“œê°€ ì‚¬ìš©ë¨)
                            const imageSource = actor.profileImage || actor.image || '';
                            const hasValidImage = imageSource && typeof imageSource === 'string' && imageSource.trim() !== '';
                            
                            return (
                              <div key={index} className="w-[90px] flex-shrink-0 group">
                                <div className="relative w-[90px] h-[120px] rounded-lg bg-gray-100 overflow-hidden shadow-sm hover:shadow-md transition-all">
                                  <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
                                  {hasValidImage ? (
                                    <Image 
                                      src={imageSource}
                                      alt={actor.name}
                                      fill
                                      unoptimized={true}
                                      className="object-cover object-top"
                                      onError={(e) => {
                                        console.log(`Cast image load error for ${actor.name}:`, imageSource);
                                        e.target.onerror = null; // ë¬´í•œ ë£¨í”„ ë°©ì§€
                                        e.target.src = '/images/placeholder-tvfilm.jpg';
                                      }}
                                    />
                                  ) : (
                                    <div className="w-full h-full bg-gradient-to-b from-gray-200 to-gray-300 flex flex-col items-center justify-center">
                                      <div className="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center mb-1">
                                        <User className="w-5 h-5 text-white" />
                                      </div>
                                      <div className="text-xs text-gray-600 bg-white/80 px-2 py-0.5 rounded-full">No Image</div>
                                    </div>
                                  )}
                                  <div className="absolute left-0 right-0 bottom-0 p-2 bg-gradient-to-t from-black to-transparent opacity-0 group-hover:opacity-100 transition-all">
                                    <p className="text-xs text-white line-clamp-2">{actor.bio || "Known for " + (actor.knownFor || "roles in Korean dramas and films")}</p>
                                  </div>
                                </div>
                                <div className="mt-2">
                                  <h3 className="text-sm text-gray-900 font-medium group-hover:text-pink-500 transition-colors line-clamp-1">{actor.name}</h3>
                                  <p className="text-xs text-gray-500 mt-0.5 line-clamp-1">{actor.role}</p>
                                </div>
                              </div>
                            );
                          })
                        ) : (
                          // ë°°ìš° ë°ì´í„°ê°€ ì—†ì„ ë•Œ ëŒ€ì²´ ì»¨í…ì¸  í‘œì‹œ
                          <div className="w-full text-center py-10">
                            <Users size={40} className="mx-auto text-gray-300 mb-3" />
                            <p className="text-gray-500 font-medium">No cast information available</p>
                            <p className="text-gray-400 text-sm mt-1">Cast details coming soon</p>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    {/* ìºìŠ¤íŠ¸ ìŠ¤í¬ë¡¤ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */}
                    {cast.length > 5 && (
                      <>
                        {/* ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ ë²„íŠ¼ - ì˜¤ë¥¸ìª½ ëì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ */}
                        {showCastRightArrow && (
                          <div className="absolute top-1/2 -right-4 transform -translate-y-1/2 z-10">
                            <button 
                              onClick={() => scrollCast('right')}
                              className="w-10 h-10 rounded-full bg-white shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:text-pink-500 hover:border-pink-200 transition-all group"
                            >
                              <ChevronRight className="w-6 h-6 group-hover:scale-110 transition-transform" />
                            </button>
                          </div>
                        )}
                        
                        {/* ì™¼ìª½ í™”ì‚´í‘œ ë²„íŠ¼ - ì™¼ìª½ ëì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ */}
                        {showCastLeftArrow && (
                          <div className="absolute top-1/2 -left-4 transform -translate-y-1/2 z-10">
                            <button 
                              onClick={() => scrollCast('left')}
                              className="w-10 h-10 rounded-full bg-white shadow-lg border border-gray-200 flex items-center justify-center text-gray-600 hover:text-pink-500 hover:border-pink-200 transition-all group"
                            >
                              <ChevronRight className="w-6 h-6 rotate-180 group-hover:scale-110 transition-transform" />
                            </button>
                          </div>
                        )}
                      </>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Right sidebar - Movie Information - Desktop Only */}
              <div className="lg:w-1/3 space-y-6 hidden lg:block">
                {/* Film info card */}
                <div className="bg-white rounded-2xl overflow-hidden shadow-md border border-gray-100 sticky top-24">
                  {/* Movie Information title */}
                  <div className="pt-5 px-5 border-b border-gray-100 pb-4">
              <h3 className="text-xl font-bold text-gray-900">
                      Movie Information
              </h3>
                  </div>
                  
                  {/* Poster and quick info */}
                  <div className="px-5 py-5 flex">
                    {/* Poster thumbnail */}
                    <div className="relative w-[110px] h-[165px] flex-shrink-0 rounded-xl overflow-hidden shadow-lg border border-gray-200">
                      {currentDrama && currentDrama.coverImage && renderImage(currentDrama.coverImage, currentDrama.title || "Drama Image", "object-cover", 0, 0, true)}
                    </div>
                    
                    {/* Quick info beside poster */}
                    <div className="ml-4 flex flex-col py-1 flex-1">
                      <h3 className="font-bold text-base text-gray-800 mb-2 leading-tight line-clamp-2">{currentDrama && currentDrama.title ? currentDrama.title : "ì œëª© ì—†ìŒ"}</h3>
                      
                      {/* Rating */}
                      <div className="flex items-center mb-3 bg-gray-50 rounded-lg px-3 py-2">
                        <div className="h-8 w-8 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white font-bold text-sm mr-3 shadow-md">
                          {currentDrama && currentDrama.reviewRating && currentDrama.reviewRating > 0
                    ? parseFloat(currentDrama.reviewRating) === 10
                      ? "10"
                      : parseFloat(currentDrama.reviewRating).toFixed(1)
                    : "-"
                  }
                </div>
                        <span className="text-gray-700 font-medium">Rating</span>
                      </div>
                      
                      {/* Genres */}
                      <div className="flex flex-wrap gap-1.5 mt-1">
                        {(currentDrama && currentDrama.genres && Array.isArray(currentDrama.genres) && currentDrama.genres.length > 0) ? (
                          currentDrama.genres.map((genre, index) => (
                            <span key={index} className="px-2.5 py-1 bg-pink-50 text-pink-600 rounded-full text-xs font-medium border border-pink-200">
                              {genre}
                            </span>
                          ))
                        ) : (
                          <span className="text-gray-700 text-xs">{currentDrama.category || "Movie"}</span>
                        )}
                      </div>
              </div>
            </div>
            
                  {/* Like/Dislike buttons - ì™„ì „íˆ ì œê±° */}

                  {/* Additional Movie Information */}
                  <div className="border-t border-gray-100">
                    <div className="p-5 space-y-3">
                      {/* Director */}
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className="w-8 h-8 rounded-lg bg-pink-50 flex items-center justify-center mr-3">
                            <Award className="text-pink-500 w-4.5 h-4.5" />
                          </div>
                          <h4 className="text-sm text-gray-500 font-medium">Director</h4>
                        </div>
                        <div className="text-right">
                          <span className="text-gray-900 font-semibold text-sm">
                            {currentDrama.director || "Bong Joon-ho"}
                          </span>
                        </div>
              </div>
              
                      {/* Runtime */}
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className="w-8 h-8 rounded-lg bg-pink-50 flex items-center justify-center mr-3">
                            <Clock className="text-pink-500 w-4.5 h-4.5" />
                          </div>
                          <h4 className="text-sm text-gray-500 font-medium">Runtime</h4>
                        </div>
                        <span className="text-gray-900 font-semibold text-sm">{currentDrama.runtime || "2h 17min"}</span>
                      </div>

                      {/* Age Rating */}
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className="w-8 h-8 rounded-lg bg-pink-50 flex items-center justify-center mr-3">
                            <div className="flex items-center justify-center w-5 h-5 rounded-full bg-pink-500 text-xs font-bold text-white">
                              {typeof currentDrama.ageRating === 'string' && currentDrama.ageRating.includes('+') 
                                ? currentDrama.ageRating.split('+')[0]
                                : currentDrama.ageRating === 'Not Rated' || currentDrama.ageRating === 'Not Yet Rated' 
                                  ? "NR"
                                  : currentDrama.ageRating || "15"
                              }
                            </div>
                          </div>
                          <h4 className="text-sm text-gray-500 font-medium">Age Rating</h4>
                        </div>
                        <span className="text-gray-900 font-semibold text-sm whitespace-nowrap">
                          {currentDrama.ageRating === '15' || currentDrama.ageRating?.includes('15+') ? '15 and over' : 
                           currentDrama.ageRating === '12' || currentDrama.ageRating?.includes('12+') ? '12 and over' : 
                           currentDrama.ageRating === '18' || currentDrama.ageRating?.includes('18+') ? 'Adults only' : 
                           currentDrama.ageRating === 'ALL' ? 'All ages' : 
                           currentDrama.ageRating === 'Not Rated' || currentDrama.ageRating === 'Not Yet Rated' ? 'Not Rated' :
                           currentDrama.ageRating || 'Not rated'}
                        </span>
                      </div>

                      {/* Production Country */}
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className="w-8 h-8 rounded-lg bg-pink-50 flex items-center justify-center mr-3">
                            <span className="text-sm">ğŸŒ</span>
                          </div>
                          <h4 className="text-sm text-gray-500 font-medium">Country</h4>
                        </div>
                        <div className="flex items-center text-gray-900 font-semibold">
                          <span className="mr-1.5 text-sm">ğŸ‡°ğŸ‡·</span>
                          <span className="text-sm">{currentDrama.country || "South Korea"}</span>
                        </div>
                      </div>

                      {/* ì²« ë°©ì˜ ë‚ ì§œ ì¶”ê°€ */}
                      {currentDrama.releaseDate && (
                        <div className="flex items-center justify-between">
                          <div className="flex items-center">
                            <div className="w-8 h-8 rounded-lg bg-pink-50 flex items-center justify-center mr-3">
                              <Calendar className="text-pink-500 w-4.5 h-4.5" />
                            </div>
                            <h4 className="text-sm text-gray-500 font-medium">Release Date</h4>
                          </div>
                          <span className="text-gray-900 font-semibold text-sm">
                            {formatDate(currentDrama.releaseDate)}
                          </span>
                  </div>
                )}
                
                      {/* ì—í”¼ì†Œë“œ ìˆ˜ ì¶”ê°€ */}
                      {currentDrama.episodes && (
                        <div className="flex items-center justify-between">
                          <div className="flex items-center">
                            <div className="w-8 h-8 rounded-lg bg-pink-50 flex items-center justify-center mr-3">
                              <Tv className="text-pink-500 w-4.5 h-4.5" />
                            </div>
                            <h4 className="text-sm text-gray-500 font-medium">Episodes</h4>
                          </div>
                          <span className="text-gray-900 font-semibold text-sm">
                            {currentDrama.episodes} episodes
                      </span>
                        </div>
                  )}
                    </div>
                </div>
                
                  {/* ë¦¬ë·° í‰ê°€ ì ìˆ˜ */}
                  {currentDrama.reviewCount > 0 && (
                    <div className="border-t border-gray-100">
                      <div className="p-5">
                        <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                          <MessageCircle className="w-4 h-4 text-pink-500 mr-2" />
                          Viewer Ratings
                        </h4>
                        
                        <div className="space-y-3">
                          {/* ê° í‰ê°€ í•­ëª© */}
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Acting/Cast</span>
                            <div className="flex items-center">
                              <div className="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                                <div 
                                  className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                                  style={{ width: `${(castRating || 8.0) * 10}%` }}
                                ></div>
                              </div>
                              <span className="text-sm font-medium text-gray-800">{castRating || 8.0}</span>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Story</span>
                            <div className="flex items-center">
                              <div className="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                                <div 
                                  className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                                  style={{ width: `${(storyRating || 8.0) * 10}%` }}
                                ></div>
                              </div>
                              <span className="text-sm font-medium text-gray-800">{storyRating || 8.0}</span>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Music</span>
                            <div className="flex items-center">
                              <div className="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                                <div 
                                  className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                                  style={{ width: `${(musicRating || 7.5) * 10}%` }}
                                ></div>
                              </div>
                              <span className="text-sm font-medium text-gray-800">{musicRating || 7.5}</span>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-600">Rewatch Value</span>
                            <div className="flex items-center">
                              <div className="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden mr-2">
                                <div 
                                  className="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full"
                                  style={{ width: `${(rewatchRating || 7.0) * 10}%` }}
                                ></div>
                              </div>
                              <span className="text-sm font-medium text-gray-800">{rewatchRating || 7.0}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            {/* Related News Section - ê¸°ì¡´ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒì—ì„œ ë¶„ë¦¬í•˜ì—¬ ë³„ë„ ë°°ì¹˜ */}
            <div className="mt-4 mb-20" id="similar">
              <h2 className="text-2xl font-bold mb-5 text-gray-900 border-l-4 border-pink-500 pl-4 py-1 flex items-center">
                <TrendingUp className="w-6 h-6 mr-2 text-[#ff3e8e]" />
                Related News
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {relatedNews && relatedNews.length > 0 ? (
                  relatedNews.map((news, index) => (
                    <Link key={index} href={`/news/${news._id}`} className="group block">
                      <div className="bg-white rounded-xl overflow-hidden transition-all duration-300 hover:shadow-xl hover:translate-y-[-3px] border border-gray-100 shadow-sm relative group h-full flex flex-col">
                        {/* ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ */}
                        <div className="absolute inset-0 bg-gradient-to-r from-pink-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        
                        {/* ì¸ë„¤ì¼ ì´ë¯¸ì§€ */}
                        <div className="w-full h-48 sm:h-56 md:h-64 bg-gradient-to-r from-gray-100 to-gray-200 overflow-hidden relative">
                          <img 
                            src={news.coverImage || news.thumbnail || '/images/placeholder.jpg'} 
                            alt={news.title}
                            className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                            onError={(e) => {
                              e.target.src = "/images/placeholder.jpg";
                            }}
                          />
                          {/* ì¹´í…Œê³ ë¦¬ íƒœê·¸ (ì¸ë„¤ì¼ ìœ„ì— ë°°ì¹˜) */}
                          <div className="absolute top-3 right-3">
                            <span className="px-2.5 py-1 bg-black/40 backdrop-blur-sm text-white rounded-full text-xs font-medium border border-white/20">
                              {news.category || 'K-Drama'}
                            </span>
                          </div>
                        </div>
                        
                        {/* ë‰´ìŠ¤ ë‚´ìš© */}
                        <div className="p-4 sm:p-5 flex-grow flex flex-col">
                          {/* ì œëª© */}
                          <h4 className="text-xl font-bold mb-3 line-clamp-2 group-hover:text-pink-600 transition-colors">
                            {news.title}
                          </h4>
                          
                          {/* ìš”ì•½ (content ë˜ëŠ” summary) */}
                          <p className="text-gray-600 text-sm line-clamp-2 mb-4">
                            {news.content 
                              ? news.content.replace(/<[^>]*>/g, '') 
                              : news.summary || ''}
                          </p>
                          
                          {/* í•˜ë‹¨ ë©”íƒ€ ì •ë³´ */}
                          <div className="mt-auto flex items-center justify-between">
                            {/* ë‚ ì§œ */}
                            <span className="flex items-center text-gray-500 text-xs">
                              <Clock size={14} className="mr-1" />
                              {new Date(news.publishedAt || news.createdAt).toLocaleDateString()}
                            </span>
                            
                            {/* ë” ë³´ê¸° ë§í¬ */}
                            <span className="text-pink-600 text-sm font-medium hover:text-pink-700 inline-flex items-center">
                              Read more
                              <ChevronRight size={16} className="ml-1" />
                            </span>
                          </div>
                        </div>
                      </div>
                    </Link>
                  ))
                ) : (
                  <div className="text-center p-8 bg-white rounded-xl border border-gray-100 shadow-sm col-span-full">
                    <div className="w-16 h-16 bg-pink-50 rounded-full flex items-center justify-center mx-auto mb-4">
                      <TrendingUp className="w-8 h-8 text-pink-300" />
                    </div>
                    <h3 className="text-lg font-semibold text-gray-800 mb-2">No Related News</h3>
                    <p className="text-gray-500 max-w-md mx-auto">
                      No news related to this content is currently available.
                    </p>
                    <p className="text-gray-400 text-sm mt-2">Check back later for updates</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </MainLayout>
  );
}

// ë©”íƒ€ íƒœê·¸ ìƒì„± í•¨ìˆ˜ ì¶”ê°€
function generateMetaTags(drama) {
  if (!drama) return {
    title: 'ë“œë¼ë§ˆ ì •ë³´',
    description: 'ë“œë¼ë§ˆ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”',
    image: '/images/placeholder-tvfilm.svg',
    url: '/drama'
  };
  
  return {
    title: `${drama.title} - ìƒì„¸ì •ë³´`,
    description: drama.summary || `${drama.title} ë“œë¼ë§ˆ ì •ë³´ í˜ì´ì§€ì…ë‹ˆë‹¤`,
    image: drama.coverImage || '/images/placeholder-tvfilm.svg',
    url: `/drama/${drama.slug}`
  };
}

// ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
export async function getServerSideProps({ params, req, query, resolvedUrl }) {
  const { id } = params;
  
  try {
    // ë“œë¼ë§ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ - ê¸°ì¡´ ë“œë¼ë§ˆ API ì‚¬ìš©
    console.log(`ë“œë¼ë§ˆ ë°ì´í„° ìš”ì²­: /api/dramas/${id}?view=true`);
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000'}/api/dramas/${id}?view=true`);
    const data = await res.json();
    
    if (!res.ok || !data.success) {
      console.error('ë“œë¼ë§ˆ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      return {
        notFound: true
      };
    }
    
    const drama = data.data;
    
    // í•„ìˆ˜ ë°ì´í„° í™•ì¸
    if (!drama || !drama.title) {
      console.error('ìœ íš¨í•˜ì§€ ì•Šì€ ë“œë¼ë§ˆ ë°ì´í„°:', drama);
      return {
        notFound: true
      };
    }
    
    // ë°ì´í„° ì •ì œ ë° ê¸°ë³¸ê°’ ì„¤ì •
    const processedDrama = {
      ...drama,
      contentType: 'drama', // ë“œë¼ë§ˆ íƒ€ì… ëª…ì‹œ
      // í•„ìˆ˜ í•„ë“œì— ê¸°ë³¸ê°’ ì„¤ì •
      summary: drama.summary || 'ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.',
      cast: Array.isArray(drama.cast) ? drama.cast : [],
      tags: Array.isArray(drama.tags) ? drama.tags : [],
      genres: Array.isArray(drama.genres) ? drama.genres : [],
      // í•„ë“œê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ê°’
      reviewRating: drama.reviewRating || 0,
      reviewCount: drama.reviewCount || 0,
      watchProviders: drama.watchProviders || []
    };
    
    // ê´€ë ¨ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    let relatedNews = [];
    try {
      const newsRes = await fetch(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000'}/api/news/drama?limit=50`);
      const newsData = await newsRes.json();
      relatedNews = newsData.success ? newsData.data.filter(item => {
        const dramaTitle = drama?.title?.toLowerCase() || '';
        const titleMatch = item?.title?.toLowerCase().includes(dramaTitle);
        const summaryMatch = item?.summary?.toLowerCase().includes(dramaTitle);
        const contentMatch = item?.content?.toLowerCase().includes(dramaTitle);
        const tagMatch = Array.isArray(item?.tags) && item.tags.some(tag => tag?.toLowerCase().includes(dramaTitle));
        // ì¶œì—°ì§„ ì´ë¦„ ë§¤ì¹­
        const castMatch = Array.isArray(drama.cast) && drama.cast.some(actor => {
          if (!actor?.name) return false;
          const name = actor.name.toLowerCase();
          return (
            item?.title?.toLowerCase().includes(name) ||
            item?.summary?.toLowerCase().includes(name) ||
            item?.content?.toLowerCase().includes(name) ||
            (Array.isArray(item?.tags) && item.tags.some(tag => tag?.toLowerCase().includes(name)))
          );
        });
        return titleMatch || summaryMatch || contentMatch || tagMatch || castMatch;
      }).slice(0, 5) : [];
    } catch (newsError) {
      console.error('ê´€ë ¨ ë‰´ìŠ¤ ë¡œë”© ì˜¤ë¥˜:', newsError);
      // ë‰´ìŠ¤ ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë“œë¼ë§ˆ í˜ì´ì§€ëŠ” í‘œì‹œ
    }
    
    return {
      props: {
        drama: processedDrama,
        relatedNews,
        metaTags: generateMetaTags(processedDrama)
      }
    };
  } catch (error) {
    console.error('ë“œë¼ë§ˆ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
    return {
      notFound: true
    };
  }
}