import axios from 'axios';
import * as cheerio from 'cheerio';
import { connectToDatabase } from '../../../utils/mongodb';
import { ObjectId } from 'mongodb';
import fs from 'fs';
import puppeteer from 'puppeteer';

const LOG_PATH = '/tmp/news-crawl-debug.log';

// ë””ë²„ê¹… í—¬í¼ í•¨ìˆ˜
function logDebug(message, data = null) {
  const logMsg = `[DEBUG] ${message} ${data ? JSON.stringify(data) : ''}`;
  console.log(logMsg);
  // íŒŒì¼ ì“°ê¸° ì œê±° - ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥ì„±
}

// ê°•ì œ ë¡œê·¸ í•¨ìˆ˜ ì¶”ê°€
function forceLog(message) {
  const timestamp = new Date().toISOString();
  const logMessage = `[FORCE LOG] ${timestamp}: ${message}`;
  console.log(logMessage);
  
  // ë¡œê·¸ë¥¼ íŒŒì¼ì—ë„ ì €ì¥
  const fs = require('fs');
  try {
    fs.appendFileSync('/tmp/news-crawl-debug.log', logMessage + '\n');
  } catch (e) {
    // íŒŒì¼ ì“°ê¸° ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ
  }
}

// ë‰´ìŠ¤ ì œëª© í•„í„°ë§ í•¨ìˆ˜ - ì œì™¸í•  ë‰´ìŠ¤ ìœ í˜• í™•ì¸
function shouldSkipNews(title) {
  if (!title) return true; // ì œëª©ì´ ì—†ìœ¼ë©´ ì œì™¸
  
  const lowerTitle = title.toLowerCase();
  
  // ì œì™¸í•  í‚¤ì›Œë“œë“¤
  const excludeKeywords = [
    'quiz:',
    'soompi'
  ];
  
  // ì œì™¸ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš° true ë°˜í™˜ (ì œì™¸)
  for (const keyword of excludeKeywords) {
    if (lowerTitle.includes(keyword)) {
      logDebug(`ë‰´ìŠ¤ ì œì™¸: "${title}" (í‚¤ì›Œë“œ: "${keyword}")`);
      return true;
    }
  }
  
  return false; // ì œì™¸í•˜ì§€ ì•ŠìŒ
}

// í•´ì‹œ ê¸°ë°˜ ì´ë¯¸ì§€ í”„ë¡ì‹œë¥¼ ìœ„í•œ í•¨ìˆ˜ë“¤
const crypto = require('crypto');

// URLì„ í•´ì‹œë¡œ ë³€í™˜
function createImageHash(url) {
  return crypto.createHash('sha256').update(url).digest('hex').substring(0, 16);
}

// ì´ë¯¸ì§€ í•´ì‹œë¥¼ DBì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
async function saveImageHash(url, hash) {
  try {
    const { db } = await connectToDatabase();
    const collection = db.collection('image_hashes');
    
    // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    const existing = await collection.findOne({ hash });
    if (!existing) {
      await collection.insertOne({
        hash,
        url,
        createdAt: new Date()
      });
    }
  } catch (error) {
    console.error('ì´ë¯¸ì§€ í•´ì‹œ ì €ì¥ ì˜¤ë¥˜:', error);
  }
}

// Soompi ì´ë¯¸ì§€ URLì„ í•´ì‹œ ê¸°ë°˜ í”„ë¡ì‹œ URLë¡œ ë³€í™˜
async function convertSoompiImageToProxy(soompiImageUrl) {
  if (!soompiImageUrl) return null;
  
  // ì´ë¯¸ ìš°ë¦¬ ì‚¬ì´íŠ¸ URLì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
  if (soompiImageUrl.startsWith('/api/proxy/') || soompiImageUrl.startsWith('/images/')) {
    return soompiImageUrl;
  }
  
  // ì™¸ë¶€ ì´ë¯¸ì§€ URLì¸ ê²½ìš° í•´ì‹œ ê¸°ë°˜ í”„ë¡ì‹œ URLë¡œ ë³€í™˜
  if (soompiImageUrl.startsWith('http://') || soompiImageUrl.startsWith('https://')) {
    const hash = createImageHash(soompiImageUrl);
    
    // í•´ì‹œë¥¼ DBì— ì €ì¥
    await saveImageHash(soompiImageUrl, hash);
    
    return `/api/proxy/hash-image?hash=${hash}`;
  }
  
  return soompiImageUrl;
}

// ê¸°ì‚¬ ë‚´ìš©ì— ë§ˆì¹¨í‘œ ë’¤ ì¤„ë°”ê¿ˆ ì¶”ê°€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function addLineBreakAfterPeriods(htmlContent) {
  try {
    const $ = cheerio.load(htmlContent);
    
    // ê° ë‹¨ë½(p íƒœê·¸)ì— ëŒ€í•´ ì²˜ë¦¬
    $('p').each(function(i, elem) {
      const paragraphText = $(this).html();
      if (!paragraphText) return;
      
      // ë¬¸ì¥ì„ ë§ˆì¹¨í‘œë¡œ ë¶„ë¦¬ (ë‹¨, HTML íƒœê·¸ ë‚´ë¶€ì˜ ë§ˆì¹¨í‘œëŠ” ì œì™¸)
      let sentences = [];
      let currentPos = 0;
      let inTag = false;
      let currentSentence = '';
      
      for (let i = 0; i < paragraphText.length; i++) {
        const char = paragraphText[i];
        currentSentence += char;
        
        // HTML íƒœê·¸ ì•ˆì¸ì§€ ë°–ì¸ì§€ ì¶”ì 
        if (char === '<') inTag = true;
        else if (char === '>') inTag = false;
        
        // ë§ˆì¹¨í‘œë¥¼ ë§Œë‚˜ê³ , íƒœê·¸ ë‚´ë¶€ê°€ ì•„ë‹ˆê³ , ë‹¤ìŒ ë¬¸ìê°€ ê³µë°±ì´ê±°ë‚˜ íƒœê·¸ì˜ ì‹œì‘ì¼ ë•Œ
        if (char === '.' && !inTag && 
            (i + 1 >= paragraphText.length || 
             paragraphText[i + 1] === ' ' || 
             paragraphText[i + 1] === '\t' || 
             paragraphText[i + 1] === '<')) {
          
          sentences.push(currentSentence);
          currentSentence = '';
        }
      }
      
      // ë§ˆì§€ë§‰ ë¬¸ì¥ì´ ë‚¨ì•„ìˆë‹¤ë©´ ì¶”ê°€
      if (currentSentence.trim()) {
        sentences.push(currentSentence);
      }
      
      // ë¬¸ì¥ì´ í•˜ë‚˜ ì´ìƒì´ë©´ ê° ë¬¸ì¥ì„ ë³„ë„ì˜ p íƒœê·¸ë¡œ ë¶„ë¦¬
      if (sentences.length > 1) {
        const newHtml = sentences.map(s => `<p>${s.trim()}</p>`).join('\n\n');
        $(this).replaceWith(newHtml);
      }
    });
    
    return $.html();
  } catch (error) {
    console.error('addLineBreakAfterPeriods í•¨ìˆ˜ ì˜¤ë¥˜:', error);
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì›ë³¸ HTML ë°˜í™˜
    return htmlContent;
  }
}

// Puppeteerë¥¼ ì‚¬ìš©í•œ ë™ì  í¬ë¡¤ë§ í•¨ìˆ˜
async function scrapeSoompiNewsWithPuppeteer(maxItemsLimit = 50) {
  forceLog(`!!!!! í•¨ìˆ˜ ì§„ì… í™•ì¸: maxItemsLimit=${maxItemsLimit} !!!!!`);
  forceLog(`!!!!! maxItemsLimit íƒ€ì…: ${typeof maxItemsLimit} !!!!!`);
  forceLog(`!!!!! maxItemsLimit ê°’: ${JSON.stringify(maxItemsLimit)} !!!!!`);
  let browser;
  try {
    logDebug('Puppeteer í¬ë¡¤ë§ ì‹œì‘...');
    forceLog('=== Puppeteer í¬ë¡¤ë§ ì‹œì‘ ===');
    forceLog(`=== DEBUG: Puppeteer í•¨ìˆ˜ ì§„ì…, maxItemsLimit=${maxItemsLimit} ===`);
    
    // Puppeteer ë¸Œë¼ìš°ì € ì‹œì‘
    browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-first-run',
        '--no-zygote',
        '--disable-gpu'
      ]
    });
    
    const page = await browser.newPage();
    
    // User-Agent ì„¤ì •
    await page.setUserAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36');
    
    // í˜ì´ì§€ ë¡œë“œ
    logDebug('https://www.soompi.com/ ì ‘ì† ì‹œë„...');
    forceLog('https://www.soompi.com/ ì ‘ì† ì‹œë„...');
    await page.goto('https://www.soompi.com/', { 
      waitUntil: 'networkidle2',
      timeout: 30000 
    });
    
    logDebug('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    forceLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    
    // í˜ì´ì§€ ì œëª© í™•ì¸
    const pageTitle = await page.title();
    forceLog(`í˜ì´ì§€ ì œëª©: ${pageTitle}`);
    
    // ê²°ê³¼ë¥¼ ì €ì¥í•  ë°°ì—´
    const newsItems = [];
    
    // í˜„ì¬ í˜ì´ì§€ì˜ ë‰´ìŠ¤ ë§í¬ì™€ ì´ë¯¸ì§€ ìˆ˜ì§‘
    const currentNewsLinks = await page.evaluate(() => {
      const links = [];
      
      // ê°„ë‹¨í•œ ì…€ë ‰í„°ë“¤ë¡œ ë‰´ìŠ¤ ë§í¬ ì°¾ê¸°
      const selectors = [
        'a[href*="/article/"]',         // /article/ í¬í•¨í•˜ëŠ” ëª¨ë“  ë§í¬
        'a[href*="soompi.com/article"]', // soompi.com/article í¬í•¨í•˜ëŠ” ëª¨ë“  ë§í¬
        'h4.media-heading a',           // ê¸°ì¡´ ì…€ë ‰í„°
        'h3 a',                         // h3 íƒœê·¸ ë‚´ ë§í¬
        'h2 a',                         // h2 íƒœê·¸ ë‚´ ë§í¬
        '.entry-title a',               // WordPress ìŠ¤íƒ€ì¼
        '.post-title a',                // í¬ìŠ¤íŠ¸ ì œëª©
        'article a',                    // article íƒœê·¸ ë‚´ ë§í¬
        '.news-item a',                 // ë‰´ìŠ¤ ì•„ì´í…œ
        '.article-title a'              // ê¸°ì‚¬ ì œëª©
      ];
      
      console.log('=== ì…€ë ‰í„° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
      
      for (const selector of selectors) {
        const elements = document.querySelectorAll(selector);
        console.log(`ì…€ë ‰í„° "${selector}"ì—ì„œ ${elements.length}ê°œ ìš”ì†Œ ë°œê²¬`);
        
        elements.forEach((link, index) => {
          const title = link.textContent.trim();
          const url = link.href;
          
          console.log(`ë§í¬ ${index + 1}: title="${title}", url="${url}"`);
          
          // ìœ íš¨í•œ ë‰´ìŠ¤ ë§í¬ì¸ì§€ í™•ì¸
          if (title && url && 
              url.includes('soompi.com') && 
              url.includes('/article/') &&
              title.length > 5 && 
              !links.some(existing => existing.url === url)) {
            
            // ì´ë¯¸ì§€ ì°¾ê¸° - ë§í¬ ë‚´ë¶€ ë˜ëŠ” ì¸ê·¼ ì´ë¯¸ì§€
            let thumbnailUrl = '';
            
            // 1. ë§í¬ ë‚´ë¶€ img íƒœê·¸
            const imgInLink = link.querySelector('img');
            if (imgInLink && imgInLink.src) {
              thumbnailUrl = imgInLink.src;
            }
            
            // 2. ë§í¬ì˜ ë¶€ëª¨/í˜•ì œ ìš”ì†Œì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
            if (!thumbnailUrl) {
              const parent = link.closest('article, .post, .news-item, div[class*="article"], div[class*="post"]');
              if (parent) {
                const nearbyImg = parent.querySelector('img');
                if (nearbyImg && nearbyImg.src) {
                  thumbnailUrl = nearbyImg.src;
                }
              }
            }
            
            // 3. í˜•ì œ ìš”ì†Œì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
            if (!thumbnailUrl && link.previousElementSibling) {
              const prevImg = link.previousElementSibling.querySelector('img');
              if (prevImg && prevImg.src) {
                thumbnailUrl = prevImg.src;
              }
            }
            
            if (!thumbnailUrl && link.nextElementSibling) {
              const nextImg = link.nextElementSibling.querySelector('img');
              if (nextImg && nextImg.src) {
                thumbnailUrl = nextImg.src;
              }
            }
            
            links.push({ 
              title, 
              url, 
              thumbnailUrl: thumbnailUrl || '',
              index, 
              selector 
            });
            console.log(`ìœ íš¨í•œ ë§í¬ ì¶”ê°€: "${title}"`);
          }
        });
        
        // ì¶©ë¶„í•œ ë§í¬ë¥¼ ì°¾ì•˜ìœ¼ë©´ ì¤‘ë‹¨ (ì œí•œì„ ëŠ˜ë¦¼) - evaluate í•¨ìˆ˜ ë°–ì—ì„œ ì²˜ë¦¬
      }
      
      console.log(`ì´ ${links.length}ê°œì˜ ìœ íš¨í•œ ë§í¬ ë°œê²¬`);
      return links;
    });
    
    forceLog(`currentNewsLinks ê°œìˆ˜: ${currentNewsLinks.length}`);
    logDebug(`currentNewsLinks ê°œìˆ˜: ${currentNewsLinks.length}`);
    logDebug(`í˜„ì¬ í˜ì´ì§€ì—ì„œ ${currentNewsLinks.length}ê°œ ë‰´ìŠ¤ ë§í¬ ë°œê²¬`);
    
    // ë§í¬ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜ë¼ë‚´ê¸° (ì²« í˜ì´ì§€ì—ì„œëŠ” ì ë‹¹íˆ)
    const initialLinkLimit = Math.min(maxItemsLimit * 2, 100);
    const limitedCurrentNewsLinks = currentNewsLinks.slice(0, initialLinkLimit);
    if (currentNewsLinks.length > initialLinkLimit) {
      forceLog(`ì²« í˜ì´ì§€ ë§í¬ë¥¼ ${currentNewsLinks.length}ê°œì—ì„œ ${initialLinkLimit}ê°œë¡œ ì œí•œ`);
    }
    
    // ìƒˆë¡œìš´ ë‰´ìŠ¤ ë§í¬ë§Œ ì¶”ê°€
    for (const link of limitedCurrentNewsLinks) {
      if (newsItems.length >= maxItemsLimit) break;
      
      // ì œëª© í•„í„°ë§ í™•ì¸
      if (shouldSkipNews(link.title)) {
        forceLog(`ë‰´ìŠ¤ ì œì™¸ë¨: "${link.title}"`);
        continue;
      }
      
      // ì¤‘ë³µ í™•ì¸
      if (!newsItems.some(item => item.articleUrl === link.url)) {
        const timeText = 'Recently';
        
        // ì´ë¯¸ì§€ URLì„ í”„ë¡ì‹œ URLë¡œ ë³€í™˜
        let proxyThumbnailUrl = '';
        if (link.thumbnailUrl) {
          proxyThumbnailUrl = `/api/proxy/image?url=${encodeURIComponent(link.thumbnailUrl)}`;
          forceLog(`ğŸ–¼ï¸ í™ˆí˜ì´ì§€ ì´ë¯¸ì§€ í”„ë¡ì‹œ ë³€í™˜: ${link.thumbnailUrl} â†’ ${proxyThumbnailUrl}`);
        }
        
        // ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
        let category = '';
        if (link.url && link.url.includes('/category/')) {
          const categoryMatch = link.url.match(/\/category\/([^\/]+)/);
          if (categoryMatch && categoryMatch[1]) {
            category = categoryMatch[1];
          }
        }
        
        try {
          const newsItem = await createNewsItem(link.title, link.url, proxyThumbnailUrl, category, timeText, newsItems.length);
          newsItems.push(newsItem);
          logDebug(`ë‰´ìŠ¤ ë§í¬ ì¶”ê°€: title="${link.title}", slug="${newsItem.slug}"`);
          forceLog(`ë‰´ìŠ¤ ë§í¬ ì¶”ê°€: "${link.title}"`);
        } catch (error) {
          logDebug(`ë‰´ìŠ¤ ì•„ì´í…œ ìƒì„± ì‹¤íŒ¨: ${link.title}`, error);
          forceLog(`ë‰´ìŠ¤ ì•„ì´í…œ ìƒì„± ì‹¤íŒ¨: ${link.title} - ${error.message}`);
        }
      }
    }
    
    logDebug(`ì´ ${newsItems.length}ê°œì˜ ë‰´ìŠ¤ í•­ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
    forceLog(`ì´ ${newsItems.length}ê°œì˜ ë‰´ìŠ¤ í•­ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
    forceLog(`=== ì¶”ê°€ ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘ ===`);
    forceLog(`í˜„ì¬ newsItems.length: ${newsItems.length}, maxItemsLimit: ${maxItemsLimit}`);
    forceLog(`ì¡°ê±´ ì²´í¬: newsItems.length < maxItemsLimit = ${newsItems.length < maxItemsLimit}`);
    
    // /latest í˜ì´ì§€ì—ì„œ Load More ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ë” ë§ì€ ë‰´ìŠ¤ ìˆ˜ì§‘
    if (newsItems.length < maxItemsLimit) {
      forceLog(`=== /latest í˜ì´ì§€ Load More í¬ë¡¤ë§ ì‹œì‘ ===`);
      
      try {
        await page.goto('https://www.soompi.com/latest', { waitUntil: 'networkidle2', timeout: 30000 });
        forceLog('/latest í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        
        let latestAttempt = 0;
        const maxLatestAttempts = Math.ceil((maxItemsLimit - newsItems.length) / 15); // 15ê°œì”© ë¡œë“œ
        
        forceLog(`/latest Load More ì‹œì‘: í˜„ì¬ ${newsItems.length}ê°œ, ëª©í‘œ ${maxItemsLimit}ê°œ, ìµœëŒ€ ${maxLatestAttempts}ë²ˆ ì‹œë„`);
        
        while (latestAttempt < maxLatestAttempts && newsItems.length < maxItemsLimit) {
          latestAttempt++;
          
                     // í˜„ì¬ í˜ì´ì§€ì˜ ë‰´ìŠ¤ ë§í¬ì™€ ì´ë¯¸ì§€ ìˆ˜ì§‘
           const latestNewsLinks = await page.evaluate(() => {
             const links = [];
             
             // ë‰´ìŠ¤ ë§í¬ì™€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ìˆ˜ì§‘
             document.querySelectorAll('a').forEach(link => {
               if (link.href && 
                   link.href.includes('soompi.com') && 
                   link.href.includes('/article/')) {
                 const title = link.textContent?.trim() || '';
                 
                 if (title.length > 3) {
                   // ì´ë¯¸ì§€ ì°¾ê¸° - ë§í¬ ë‚´ë¶€ ë˜ëŠ” ì¸ê·¼ ì´ë¯¸ì§€
                   let thumbnailUrl = '';
                   
                   // 1. ë§í¬ ë‚´ë¶€ img íƒœê·¸
                   const imgInLink = link.querySelector('img');
                   if (imgInLink && imgInLink.src) {
                     thumbnailUrl = imgInLink.src;
                   }
                   
                   // 2. ë§í¬ì˜ ë¶€ëª¨/í˜•ì œ ìš”ì†Œì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
                   if (!thumbnailUrl) {
                     const parent = link.closest('article, .post, .news-item, div[class*="article"], div[class*="post"]');
                     if (parent) {
                       const nearbyImg = parent.querySelector('img');
                       if (nearbyImg && nearbyImg.src) {
                         thumbnailUrl = nearbyImg.src;
                       }
                     }
                   }
                   
                   // 3. í˜•ì œ ìš”ì†Œì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
                   if (!thumbnailUrl && link.previousElementSibling) {
                     const prevImg = link.previousElementSibling.querySelector('img');
                     if (prevImg && prevImg.src) {
                       thumbnailUrl = prevImg.src;
                     }
                   }
                   
                   if (!thumbnailUrl && link.nextElementSibling) {
                     const nextImg = link.nextElementSibling.querySelector('img');
                     if (nextImg && nextImg.src) {
                       thumbnailUrl = nextImg.src;
                     }
                   }
                   
                   links.push({ 
                     title, 
                     url: link.href, 
                     thumbnailUrl: thumbnailUrl || '' 
                   });
                 }
               }
             });
             
             // ì¤‘ë³µ ì œê±°
             const unique = [];
             links.forEach(article => {
               if (!unique.some(existing => existing.url === article.url)) {
                 unique.push(article);
               }
             });
             
             return unique;
           });
          
          forceLog(`/latest ì‹œë„ ${latestAttempt}: ${latestNewsLinks.length}ê°œ ë‰´ìŠ¤ ë§í¬ ë°œê²¬`);
          
          // ìƒˆë¡œìš´ ë‰´ìŠ¤ë§Œ ì¶”ê°€
          let addedFromLatest = 0;
          for (const link of latestNewsLinks) {
            if (newsItems.length >= maxItemsLimit) break;
            
            // ì œëª© í•„í„°ë§ í™•ì¸
            if (shouldSkipNews(link.title)) {
              forceLog(`/latestì—ì„œ ë‰´ìŠ¤ ì œì™¸ë¨: "${link.title}"`);
              continue;
            }
            
            if (!newsItems.some(item => item.articleUrl === link.url)) {
              try {
                // ì´ë¯¸ì§€ URLì„ í”„ë¡ì‹œ URLë¡œ ë³€í™˜
                let proxyThumbnailUrl = '';
                if (link.thumbnailUrl) {
                  // í”„ë¡ì‹œ URLë¡œ ë³€í™˜
                  proxyThumbnailUrl = `/api/proxy/image?url=${encodeURIComponent(link.thumbnailUrl)}`;
                  forceLog(`ğŸ–¼ï¸ ì´ë¯¸ì§€ í”„ë¡ì‹œ ë³€í™˜: ${link.thumbnailUrl} â†’ ${proxyThumbnailUrl}`);
                }
                
                const newsItem = await createNewsItem(link.title, link.url, proxyThumbnailUrl, '', 'Recently', newsItems.length);
                newsItems.push(newsItem);
                addedFromLatest++;
                forceLog(`/latestì—ì„œ ìƒˆ ë‰´ìŠ¤ ì¶”ê°€ [ì´ ${newsItems.length}ê°œ]: "${link.title}"`);
              } catch (error) {
                forceLog(`ë‰´ìŠ¤ ì•„ì´í…œ ìƒì„± ì‹¤íŒ¨: ${link.title} - ${error.message}`);
              }
            }
          }
          
          forceLog(`/latest ì‹œë„ ${latestAttempt}ì—ì„œ ${addedFromLatest}ê°œ ìƒˆ ë‰´ìŠ¤ ì¶”ê°€ë¨ (ì´ ${newsItems.length}ê°œ)`);
          
          // ëª©í‘œ ë‹¬ì„±í•˜ê±°ë‚˜ ë” ì´ìƒ í´ë¦­í•  ìˆ˜ ì—†ìœ¼ë©´ ì¤‘ë‹¨
          if (newsItems.length >= maxItemsLimit || latestAttempt >= maxLatestAttempts) {
            forceLog(`/latest í¬ë¡¤ë§ ì™„ë£Œ: ${newsItems.length}ê°œ (ëª©í‘œ: ${maxItemsLimit}ê°œ)`);
            break;
          }
          
          // í˜ì´ì§€ ëê¹Œì§€ ìŠ¤í¬ë¡¤
          await page.evaluate(() => {
            window.scrollTo(0, document.body.scrollHeight);
          });
          
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          // Load More ë²„íŠ¼ ì°¾ê¸° ë° í´ë¦­
          const loadMoreResult = await page.evaluate(() => {
            // í…ìŠ¤íŠ¸ë¡œ Load More ë²„íŠ¼ ì°¾ê¸°
            const allButtons = Array.from(document.querySelectorAll('button, a, div[role="button"]'));
            for (const btn of allButtons) {
              const text = btn.textContent?.toLowerCase() || '';
              if (text.includes('load more') || 
                  (text.includes('load') && text.includes('more'))) {
                
                if (btn.offsetParent !== null && btn.style.display !== 'none') {
                  btn.click();
                  return `Load More í´ë¦­ ì„±ê³µ: "${btn.textContent.trim()}"`;
                }
              }
            }
            
            return false;
          });
          
          if (loadMoreResult) {
            forceLog(`ğŸ¯ /latest ${loadMoreResult}`);
            
            // ë¡œë”© ëŒ€ê¸°
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            // ìƒˆë¡œìš´ ì½˜í…ì¸  ë¡œë”© ëŒ€ê¸°
            try {
              await page.waitForFunction((previousCount) => {
                const current = document.querySelectorAll('a[href*="/article/"]').length;
                return current > previousCount;
              }, { timeout: 10000 }, latestNewsLinks.length);
              
              forceLog('âœ… /latest ìƒˆ ì½˜í…ì¸  ë¡œë”© ì™„ë£Œ');
            } catch (e) {
              forceLog('â° /latest ìƒˆ ì½˜í…ì¸  ë¡œë”© ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼');
            }
            
          } else {
            forceLog('âŒ /latest Load More ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ - ì™„ë£Œ');
            break;
          }
        }
        
        forceLog(`/latest Load More í¬ë¡¤ë§ ì™„ë£Œ: ì´ ${newsItems.length}ê°œ ë‰´ìŠ¤ ìˆ˜ì§‘`);
        
      } catch (latestError) {
        forceLog(`/latest í˜ì´ì§€ í¬ë¡¤ë§ ì‹¤íŒ¨: ${latestError.message}`);
      }
    }
    forceLog(`=== ì¶”ê°€ í˜ì´ì§€ í¬ë¡¤ë§ ì‹œì‘ ===`);
    
    // ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ë” ë§ì€ ë‰´ìŠ¤ ìˆ˜ì§‘
    if (newsItems.length < maxItemsLimit) {
      forceLog(`ì¶”ê°€ í˜ì´ì§€ í¬ë¡¤ë§ ì‹œì‘: í˜„ì¬ ${newsItems.length}ê°œ, ëª©í‘œ ${maxItemsLimit}ê°œ`);
      
      const additionalPages = [
        'https://www.soompi.com/k-pop',
        'https://www.soompi.com/k-dramas', 
        'https://www.soompi.com/page/2',
        'https://www.soompi.com/page/3'
      ];
      
             for (const pageUrl of additionalPages) {
         if (newsItems.length >= maxItemsLimit) break;
         
         forceLog(`=== ${pageUrl} í˜ì´ì§€ í¬ë¡¤ë§ ì‹œì‘ ===`);
         
         try {
           await page.goto(pageUrl, { waitUntil: 'networkidle2', timeout: 30000 });
           forceLog(`${pageUrl} í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ`);
           
           // í•´ë‹¹ í˜ì´ì§€ì˜ ë‰´ìŠ¤ ë§í¬ ìˆ˜ì§‘
           const pageNewsLinks = await page.evaluate(() => {
             const links = [];
             document.querySelectorAll('a').forEach(link => {
               if (link.href && 
                   link.href.includes('soompi.com') && 
                   link.href.includes('/article/')) {
                 const title = link.textContent?.trim() || '';
                 const url = link.href;
                 
                 if (title.length > 3) {
                   links.push({ title, url });
                 }
               }
             });
             
             // ì¤‘ë³µ ì œê±°
             const unique = [];
             links.forEach(article => {
               if (!unique.some(existing => existing.url === article.url)) {
                 unique.push(article);
               }
             });
             
             return unique;
           });
           
           forceLog(`${pageUrl}ì—ì„œ ${pageNewsLinks.length}ê°œ ë‰´ìŠ¤ ë§í¬ ë°œê²¬`);
           
           // ìƒˆë¡œìš´ ë‰´ìŠ¤ë§Œ ì¶”ê°€
           let addedFromPage = 0;
           for (const link of pageNewsLinks) {
             if (newsItems.length >= maxItemsLimit) break;
             
             // ì œëª© í•„í„°ë§ í™•ì¸
             if (shouldSkipNews(link.title)) {
               forceLog(`${pageUrl}ì—ì„œ ë‰´ìŠ¤ ì œì™¸ë¨: "${link.title}"`);
               continue;
             }
             
             if (!newsItems.some(item => item.articleUrl === link.url)) {
               try {
                                       const newsItem = await createNewsItem(link.title, link.url, '', '', 'Recently', newsItems.length);
                                newsItems.push(newsItem);
                addedFromPage++;
                forceLog(`${pageUrl}ì—ì„œ ìƒˆ ë‰´ìŠ¤ ì¶”ê°€ [ì´ ${newsItems.length}ê°œ]: "${link.title}"`);
              } catch (error) {
                forceLog(`ë‰´ìŠ¤ ì•„ì´í…œ ìƒì„± ì‹¤íŒ¨: ${link.title} - ${error.message}`);
              }
            }
          }
          
          forceLog(`${pageUrl}ì—ì„œ ${addedFromPage}ê°œ ìƒˆ ë‰´ìŠ¤ ì¶”ê°€ë¨ (ì´ ${newsItems.length}ê°œ)`);
          
        } catch (pageError) {
          forceLog(`${pageUrl} í¬ë¡¤ë§ ì‹¤íŒ¨: ${pageError.message}`);
        }
      }
      
      forceLog(`ì¶”ê°€ í˜ì´ì§€ í¬ë¡¤ë§ ì™„ë£Œ: ìµœì¢… ${newsItems.length}ê°œ ë‰´ìŠ¤ ìˆ˜ì§‘`);
    } else {
      forceLog(`ëª©í‘œ ë‹¬ì„±: ${newsItems.length}ê°œ >= ${maxItemsLimit}ê°œ`);
    }
    
    // ë¸Œë¼ìš°ì € ì¢…ë£Œ
    if (browser) {
      try {
        await browser.close();
        logDebug('Puppeteer ë¸Œë¼ìš°ì € ì¢…ë£Œ');
        forceLog('Puppeteer ë¸Œë¼ìš°ì € ì¢…ë£Œ');
      } catch (closeError) {
        logDebug('ë¸Œë¼ìš°ì € ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜:', closeError);
        forceLog(`ë¸Œë¼ìš°ì € ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: ${closeError.message}`);
      }
    }
    
    return newsItems;
    
  } catch (error) {
    logDebug('Puppeteer í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜:', error);
    forceLog(`Puppeteer í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
    console.error('Puppeteer ì˜¤ë¥˜ ìƒì„¸:', error);
    console.error('Puppeteer ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    
    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¸Œë¼ìš°ì € ì¢…ë£Œ
    if (browser) {
      try {
        await browser.close();
        logDebug('ì—ëŸ¬ ë°œìƒ ì‹œ Puppeteer ë¸Œë¼ìš°ì € ì¢…ë£Œ');
        forceLog('ì—ëŸ¬ ë°œìƒ ì‹œ Puppeteer ë¸Œë¼ìš°ì € ì¢…ë£Œ');
      } catch (closeError) {
        logDebug('ì—ëŸ¬ ì‹œ ë¸Œë¼ìš°ì € ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜:', closeError);
        forceLog(`ì—ëŸ¬ ì‹œ ë¸Œë¼ìš°ì € ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: ${closeError.message}`);
      }
    }
    
    return [];
  }
}

// ê¸°ì¡´ ì •ì  í¬ë¡¤ë§ í•¨ìˆ˜ (ë°±ì—…ìš©)
async function scrapeSoompiNewsStatic(maxItemsLimit = 50) {
  try {
    logDebug('ì •ì  í¬ë¡¤ë§ ì‹œì‘...');
    forceLog('=== ì •ì  í¬ë¡¤ë§ ì‹œì‘ ===');
    
    // ì›¹ì‚¬ì´íŠ¸ HTML ê°€ì ¸ì˜¤ê¸° - ì˜¬ë°”ë¥¸ URL ì‚¬ìš©
    logDebug('https://www.soompi.com/latest ì ‘ì† ì‹œë„...');
    forceLog('https://www.soompi.com/latest ì ‘ì† ì‹œë„...');
    
    try {
      const response = await axios.get('https://www.soompi.com/latest', {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
          'Accept-Language': 'en-US,en;q=0.5',
        },
        timeout: 10000 // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
      });
      
      forceLog('axios ìš”ì²­ ì„±ê³µ');
      
      const html = response.data;
      
      logDebug(`HTML ë°ì´í„° ê°€ì ¸ì˜´, ê¸¸ì´: ${html?.length}`);
      forceLog(`HTML ë°ì´í„° ê°€ì ¸ì˜´, ê¸¸ì´: ${html?.length}`);
      
      if (!html || html.length < 1000) {
        logDebug('HTML ë°ì´í„°ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        forceLog('HTML ë°ì´í„°ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return [];
      }
      
      // cheerioë¡œ HTML íŒŒì‹±
      forceLog('cheerio ë¡œë“œ ì‹œì‘...');
      const $ = cheerio.load(html);
      forceLog('cheerio ë¡œë“œ ì™„ë£Œ');
      
      // HTML êµ¬ì¡° ë””ë²„ê¹…
      logDebug('í˜ì´ì§€ ì œëª©: ' + $('title').text());
      forceLog('í˜ì´ì§€ ì œëª©: ' + $('title').text());
      
      // ê²°ê³¼ë¥¼ ì €ì¥í•  ë°°ì—´
      const newsItems = [];
      
      // ì˜¬ë°”ë¥¸ ì…€ë ‰í„°ë¡œ ë‰´ìŠ¤ ë§í¬ ì°¾ê¸°
      forceLog('ë‰´ìŠ¤ ë§í¬ ê²€ìƒ‰ ì‹œì‘...');
      const newsLinks = $('.col-sm-12.col-md-4 .media-heading a');
      logDebug(`ë‰´ìŠ¤ ë§í¬ ìˆ˜: ${newsLinks.length}`);
      forceLog(`ë‰´ìŠ¤ ë§í¬ ìˆ˜: ${newsLinks.length}`);
      
      // ê°œë³„ ë‰´ìŠ¤ ë§í¬ ì²˜ë¦¬
      if (newsLinks.length > 0) {
        logDebug('=== ê°œë³„ ë‰´ìŠ¤ ë§í¬ ì²˜ë¦¬ ì‹œì‘ ===');
        forceLog('=== ê°œë³„ ë‰´ìŠ¤ ë§í¬ ì²˜ë¦¬ ì‹œì‘ ===');
        
        const linkElements = newsLinks.toArray();
        for (let i = 0; i < linkElements.length; i++) {
          try {
            const link = linkElements[i];
            const $link = $(link);
            
            // ì œëª©ê³¼ URL ì¶”ì¶œ
            const title = $link.text().trim();
            const url = $link.attr('href');
            
            logDebug(`ë§í¬ ${i+1}: title="${title}", url="${url}"`);
            
            // ì œëª© í•„í„°ë§ í™•ì¸
            if (shouldSkipNews(title)) {
              forceLog(`ì •ì  í¬ë¡¤ë§ì—ì„œ ë‰´ìŠ¤ ì œì™¸ë¨: "${title}"`);
              continue;
            }
            
            // ì´ë¯¸ ìˆ˜ì§‘ëœ URLì¸ì§€ í™•ì¸
            if (url && title && !newsItems.some(item => item.articleUrl === url)) {
              // ì‹œê°„ ì •ë³´ ì¶”ì¶œ
              const $parent = $link.closest('.col-sm-12.col-md-4');
              const timeText = $parent.find('.date-time').text().trim() || 'Recently';
              
              // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì¶”ì¶œ
              const thumbnailUrl = $parent.find('.thumbnail-wrapper img').attr('src') || '';
              
              // ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ (URLì—ì„œ)
              let category = '';
              if (url && url.includes('/category/')) {
                const categoryMatch = url.match(/\/category\/([^\/]+)/);
                if (categoryMatch && categoryMatch[1]) {
                  category = categoryMatch[1];
                }
              }
              
              const newsItem = await createNewsItem(title, url, thumbnailUrl, category, timeText, i);
              newsItems.push(newsItem);
              logDebug(`ë‰´ìŠ¤ ë§í¬ ì¶”ê°€ (í•­ëª© ${i+1}): title="${title}", slug="${newsItem.slug}"`);
              forceLog(`ë‰´ìŠ¤ ë§í¬ ì¶”ê°€ (í•­ëª© ${i+1}): title="${title}", slug="${newsItem.slug}"`);
            } else {
              logDebug(`ë§í¬ ${i+1} ìŠ¤í‚µ: ${url && title ? 'ì¤‘ë³µ URL' : 'ì œëª© ë˜ëŠ” URL ì—†ìŒ'}`);
            }
            
            // ìµœëŒ€ ì•„ì´í…œ ìˆ˜ ì œí•œ ë„ë‹¬ ì‹œ ë£¨í”„ ì¤‘ë‹¨
            if (newsItems.length >= maxItemsLimit) {
              logDebug(`ìµœëŒ€ ì•„ì´í…œ ìˆ˜(${maxItemsLimit}) ë„ë‹¬, ë£¨í”„ ì¤‘ë‹¨`);
              forceLog(`ìµœëŒ€ ì•„ì´í…œ ìˆ˜(${maxItemsLimit}) ë„ë‹¬, ë£¨í”„ ì¤‘ë‹¨`);
              break;
            }
          } catch (itemError) {
            logDebug('ë‰´ìŠ¤ ë§í¬ íŒŒì‹± ì¤‘ ì˜¤ë¥˜:', itemError);
            forceLog('ë‰´ìŠ¤ ë§í¬ íŒŒì‹± ì¤‘ ì˜¤ë¥˜: ' + itemError.message);
          }
        }
        logDebug('=== ê°œë³„ ë‰´ìŠ¤ ë§í¬ ì²˜ë¦¬ ì™„ë£Œ ===');
        forceLog('=== ê°œë³„ ë‰´ìŠ¤ ë§í¬ ì²˜ë¦¬ ì™„ë£Œ ===');
      } else {
        logDebug('.col-sm-12.col-md-4 .media-heading a ì…€ë ‰í„°ë¡œ ë‰´ìŠ¤ ë§í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        forceLog('.col-sm-12.col-md-4 .media-heading a ì…€ë ‰í„°ë¡œ ë‰´ìŠ¤ ë§í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        
        // ë°±ì—… ì…€ë ‰í„° ì‹œë„
        const backupLinks = $('h4.media-heading a');
        logDebug(`ë°±ì—… ì…€ë ‰í„°ë¡œ ì°¾ì€ ë‰´ìŠ¤ ë§í¬ ìˆ˜: ${backupLinks.length}`);
        forceLog(`ë°±ì—… ì…€ë ‰í„°ë¡œ ì°¾ì€ ë‰´ìŠ¤ ë§í¬ ìˆ˜: ${backupLinks.length}`);
        
        if (backupLinks.length > 0) {
          const backupElements = backupLinks.toArray();
          for (let i = 0; i < backupElements.length; i++) {
            try {
              const link = backupElements[i];
              const $link = $(link);
              const title = $link.text().trim();
              const url = $link.attr('href');
              
              // ì œëª© í•„í„°ë§ í™•ì¸
              if (shouldSkipNews(title)) {
                forceLog(`ë°±ì—… ì…€ë ‰í„°ì—ì„œ ë‰´ìŠ¤ ì œì™¸ë¨: "${title}"`);
                continue;
              }
              
              if (url && title && !newsItems.some(item => item.articleUrl === url)) {
                const timeText = 'Recently';
                const thumbnailUrl = '';
                let category = '';
                
                if (url && url.includes('/category/')) {
                  const categoryMatch = url.match(/\/category\/([^\/]+)/);
                  if (categoryMatch && categoryMatch[1]) {
                    category = categoryMatch[1];
                  }
                }
                
                const newsItem = await createNewsItem(title, url, thumbnailUrl, category, timeText, i);
                newsItems.push(newsItem);
                forceLog(`ë°±ì—… ì…€ë ‰í„°ë¡œ ë‰´ìŠ¤ ë§í¬ ì¶”ê°€ (í•­ëª© ${i+1}): title="${title}"`);
              }
              
              if (newsItems.length >= maxItemsLimit) {
                break;
              }
            } catch (itemError) {
              forceLog('ë°±ì—… ì…€ë ‰í„° íŒŒì‹± ì¤‘ ì˜¤ë¥˜: ' + itemError.message);
            }
          }
        }
      }
      
      // ê²°ê³¼ ë¡œê¹…
      logDebug(`ì´ ${newsItems.length}ê°œì˜ ë‰´ìŠ¤ í•­ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
      forceLog(`ì´ ${newsItems.length}ê°œì˜ ë‰´ìŠ¤ í•­ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
      
      return newsItems;
      
    } catch (axiosError) {
      forceLog('axios ìš”ì²­ ì‹¤íŒ¨: ' + axiosError.message);
      throw axiosError;
    }
    
  } catch (error) {
    logDebug('ì •ì  ë‰´ìŠ¤ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜:', error);
    forceLog('ì •ì  ë‰´ìŠ¤ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜: ' + error.message);
    forceLog('ì˜¤ë¥˜ ìŠ¤íƒ: ' + error.stack);
    return [];
  }
}

// ê¸°ì‚¬ ìƒì„¸ í˜ì´ì§€ì—ì„œ ë‚´ìš©ê³¼ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
async function fetchArticleDetail(articleUrl) {
  try {
    logDebug(`ê¸°ì‚¬ ìƒì„¸ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°: ${articleUrl}`);
    
    const response = await axios.get(articleUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
      },
      timeout: 10000 // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
    });
    
    const html = response.data;
    
    if (!html || html.length < 1000) {
      logDebug('ìƒì„¸ í˜ì´ì§€ HTML ë°ì´í„°ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.');
      return {
        content: '<p>ìƒì„¸ ê¸°ì‚¬ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›ë³¸ í˜ì´ì§€ë¥¼ ë°©ë¬¸í•´ ì£¼ì„¸ìš”.</p>',
        tags: [],
        author: '',
        coverImage: '',
        title: ''
      };
    }
    
    const $ = cheerio.load(html);
    
    // ì‹¤ì œ ê¸°ì‚¬ ì œëª© ì¶”ì¶œ
    let articleTitle = '';
    
    // ë°©ë²• 1: ê¸°ì‚¬ ì •ë³´ ì˜ì—­ì˜ h1 íƒœê·¸
    const h1Title = $('.article-info h1, .article-wrapper h1, .article-section h1').first();
    if (h1Title.length) {
      articleTitle = h1Title.text().trim();
      logDebug(`h1 íƒœê·¸ì—ì„œ ì¶”ì¶œí•œ ê¸°ì‚¬ ì œëª©: ${articleTitle}`);
    }
    
    // ë°©ë²• 2: í˜ì´ì§€ íƒ€ì´í‹€ì—ì„œ ì¶”ì¶œ
    if (!articleTitle) {
      const pageTitle = $('title').text().trim();
      // "- Soompi" ë¶€ë¶„ ì œê±°
      const titleParts = pageTitle.split(' - ');
      if (titleParts.length > 0) {
        articleTitle = titleParts[0].trim();
        logDebug(`í˜ì´ì§€ titleì—ì„œ ì¶”ì¶œí•œ ê¸°ì‚¬ ì œëª©: ${articleTitle}`);
      }
    }
    
    // ë°©ë²• 3: meta íƒœê·¸ì—ì„œ ì¶”ì¶œ
    if (!articleTitle || articleTitle === 'Trending Now') {
      const metaTitle = $('meta[property="og:title"]').attr('content');
      if (metaTitle) {
        articleTitle = metaTitle.trim();
        logDebug(`meta íƒœê·¸ì—ì„œ ì¶”ì¶œí•œ ê¸°ì‚¬ ì œëª©: ${articleTitle}`);
      }
    }
    
    // "Trending Now"ì™€ ê°™ì€ ì„¹ì…˜ ì œëª©ì´ë©´ ë¬´ì‹œ
    if (articleTitle === 'Trending Now' || articleTitle === 'Latest Articles' || articleTitle === 'Popular Articles') {
      articleTitle = '';
      logDebug('ì„¹ì…˜ ì œëª© ê°ì§€: ì œëª©ì„ ì¬ì„¤ì •í•©ë‹ˆë‹¤');
    }
    
    // íƒœê·¸ ì¶”ì¶œ ê°œì„  (.article-tags í´ë˜ìŠ¤ ë‚´ë¶€ì˜ íƒœê·¸ í•­ëª© ì¶”ì¶œ)
    const tags = [];
    $('.article-tags .tag-item a').each((i, el) => {
      const tag = $(el).text().trim();
      if (tag) tags.push(tag);
    });
    
    // íƒœê·¸ ì»¨í…Œì´ë„ˆì—ì„œë„ íƒœê·¸ ì¶”ì¶œ (ë°±ì—…)
    if (tags.length === 0) {
      $('.tags-container a').each((i, el) => {
        const tag = $(el).text().trim();
        if (tag && !tag.includes('category')) tags.push(tag);
      });
    }
    
    // ì›ë³¸ URLì—ì„œ íƒœê·¸ ê²€ìƒ‰ (ë°±ì—…)
    if (tags.length === 0 && articleUrl.includes('/tag/')) {
      const tagMatch = articleUrl.match(/\/tag\/([^\/]+)/);
      if (tagMatch && tagMatch[1]) {
        tags.push(tagMatch[1].replace(/-/g, ' '));
      }
    }
    
    logDebug(`ì¶”ì¶œëœ íƒœê·¸: ${tags.join(', ')}`);
    
    // ì‘ì„±ì ì¶”ì¶œ
    let author = '';
    const authorEl = $('.info-emphasis.right a, .author-date a[href*="/author/"]').first();
    if (authorEl.length) {
      author = authorEl.text().trim();
    }
    
    // ëŒ€í‘œ ì´ë¯¸ì§€ ì¶”ì¶œ
    let coverImage = '';
    const mainImg = $('.article-section .image-wrapper img, .article-wrapper img').first();
    if (mainImg.length) {
      const originalImageUrl = mainImg.attr('src') || mainImg.attr('data-src') || '';
      coverImage = await convertSoompiImageToProxy(originalImageUrl);
    }
    
    // ê¸°ì‚¬ ë‚´ìš© ì¶”ì¶œì„ ìœ„í•œ ë‹¤ì–‘í•œ ì‹œë„
    logDebug('ê¸°ì‚¬ ë‚´ìš© ì¶”ì¶œ ì‹œë„...');
    
    // ì‹œë„ 1: article-wrapper ë‚´ë¶€ì˜ divì—ì„œ ì¶”ì¶œ
    let contentHtml = '';
    const articleWrapper = $('.article-wrapper');
    
    if (articleWrapper.length) {
      logDebug('article-wrapper ìš”ì†Œ ë°œê²¬: ' + articleWrapper.length);
      
      // ì²« ë²ˆì§¸ div ì°¾ê¸°
      const contentDiv = articleWrapper.find('> div').first();
      if (contentDiv.length) {
        logDebug('article-wrapper > div ìš”ì†Œ ë°œê²¬');
        
        // ë¶ˆí•„ìš”í•œ ìš”ì†Œ ë¯¸ë¦¬ ì œê±°
        const clonedDiv = contentDiv.clone();
        
        // iframe ì¤‘ì—ì„œ YouTubeê°€ ì•„ë‹Œ ê²ƒë§Œ ì œê±° (YouTube iframeì€ ìœ ì§€)
        clonedDiv.find('iframe').each((i, el) => {
          const src = $(el).attr('src') || '';
          // YouTube iframeì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì œê±°
          if (!src.includes('youtube.com/embed/') && !src.includes('youtu.be/')) {
            $(el).remove();
          }
        });
        
        // í•˜ë‹¨ ë°°ë„ˆ ì´ë¯¸ì§€ ì œê±° (SoompiRecommendedWatch ë°°ë„ˆ ë° ìœ ì‚¬í•œ ì´ë¯¸ì§€)
        clonedDiv.find('p > a[target="_blank"][rel="noopener noreferrer"] > img[class*="wp-image-"], hr + p > a > img').each((i, el) => {
          logDebug('í•˜ë‹¨ ë°°ë„ˆ ì´ë¯¸ì§€ ì œê±°');
          $(el).parent().parent().remove();
        });
        
        // í•˜ë‹¨ íšŒìƒ‰ ì¤„(HR íƒœê·¸) ì œê±°
        clonedDiv.find('hr').each((i, el) => {
          logDebug('í•˜ë‹¨ íšŒìƒ‰ ì¤„(HR íƒœê·¸) ì œê±°');
          $(el).remove();
        });
        
        // "ì›ë³¸ ê¸°ì‚¬: Soompi" ê´€ë ¨ ìš”ì†Œ ì œê±°
        clonedDiv.find('p:contains("ì›ë³¸ ê¸°ì‚¬:")').remove();
        
        // hr íƒœê·¸ ë‹¤ìŒì— ì˜¤ëŠ” ë°°ë„ˆ ì œê±° (ì¼ë°˜ì ì¸ ë°°ë„ˆ íŒ¨í„´)
        clonedDiv.find('hr').next('p').each((i, el) => {
          const $el = $(el);
          if ($el.find('img, a[target="_blank"]').length > 0) {
            logDebug('hr íƒœê·¸ ë‹¤ìŒ ë°°ë„ˆ ì œê±°');
            $el.remove();
          }
        });
        
        // "Watch Now" ë²„íŠ¼ ì˜ì—­ ì œê±°
        // ë°©ë²• 1: text-align:center ìŠ¤íƒ€ì¼ì„ ê°€ì§„ p íƒœê·¸ì™€ btn-watch-now í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ë§í¬
        clonedDiv.find('p[style*="text-align: center"]').each((i, el) => {
          const $el = $(el);
          if ($el.find('a.btn-watch-now').length > 0 || $el.text().includes('Watch Now') || $el.text().includes('watch now')) {
            logDebug('Watch Now ë²„íŠ¼ ì˜ì—­ ì œê±°');
            $el.remove();
          }
        });
        
        // ë°©ë²• 2: "Watch ... on Viki" ë˜ëŠ” "Watch ... below" í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ p íƒœê·¸
        clonedDiv.find('p').each((i, el) => {
          const $el = $(el);
          const text = $el.text().toLowerCase();
          if (text.includes('watch') && (text.includes('viki') || text.includes('below'))) {
            logDebug('Watch on Viki í…ìŠ¤íŠ¸ ì˜ì—­ ì œê±°');
            $el.remove();
            
            // ë‹¤ìŒ p íƒœê·¸ê°€ Watch Now ë²„íŠ¼ì„ í¬í•¨í•˜ê³  ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•¨ê»˜ í™•ì¸
            const nextP = $el.next('p');
            if (nextP.length && (nextP.find('a.btn-watch-now').length > 0 || nextP.text().includes('Watch Now'))) {
              nextP.remove();
            }
          }
        });
        
        contentHtml = clonedDiv.html();
        logDebug('ì¶”ì¶œëœ HTML ë‚´ìš© (ì²˜ìŒ 100ì): ' + contentHtml?.substring(0, 100));
      }
    }
    
    // ì‹œë„ 2: article-paragraphì—ì„œ ì¶”ì¶œ
    if (!contentHtml) {
      logDebug('ì‹œë„ 2: article-paragraphì—ì„œ ì¶”ì¶œ');
      const articleParagraph = $('.article-paragraph');
      if (articleParagraph.length) {
        // ë³µì œë³¸ ìƒì„±
        const clonedParagraph = articleParagraph.clone();
        
        // ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
        clonedParagraph.find('.social-share-container, .article-reactions, .article-footer, script, .ad, .disqus_thread, .comment-container').remove();
        
        // iframe ì¤‘ì—ì„œ YouTubeê°€ ì•„ë‹Œ ê²ƒë§Œ ì œê±° (YouTube iframeì€ ìœ ì§€)
        clonedParagraph.find('iframe').each((i, el) => {
          const src = $(el).attr('src') || '';
          // YouTube iframeì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì œê±°
          if (!src.includes('youtube.com/embed/') && !src.includes('youtu.be/')) {
            $(el).remove();
          }
        });
        
        // í•˜ë‹¨ ë°°ë„ˆ ì´ë¯¸ì§€ ì œê±°
        clonedParagraph.find('p > a[target="_blank"][rel="noopener noreferrer"] > img[class*="wp-image-"], hr + p > a > img').each((i, el) => {
          logDebug('í•˜ë‹¨ ë°°ë„ˆ ì´ë¯¸ì§€ ì œê±°');
          $(el).parent().parent().remove();
        });
        
        // í•˜ë‹¨ íšŒìƒ‰ ì¤„(HR íƒœê·¸) ì œê±°
        clonedParagraph.find('hr').each((i, el) => {
          logDebug('í•˜ë‹¨ íšŒìƒ‰ ì¤„(HR íƒœê·¸) ì œê±°');
          $(el).remove();
        });
        
        // "ì›ë³¸ ê¸°ì‚¬: Soompi" ê´€ë ¨ ìš”ì†Œ ì œê±°
        clonedParagraph.find('p:contains("ì›ë³¸ ê¸°ì‚¬:")').remove();
        
        // hr íƒœê·¸ ë‹¤ìŒì— ì˜¤ëŠ” ë°°ë„ˆ ì œê±°
        clonedParagraph.find('hr').next('p').each((i, el) => {
          const $el = $(el);
          if ($el.find('img, a[target="_blank"]').length > 0) {
            logDebug('hr íƒœê·¸ ë‹¤ìŒ ë°°ë„ˆ ì œê±°');
            $el.remove();
          }
        });
        
        // "Watch Now" ë²„íŠ¼ ì˜ì—­ ì œê±°
        // ë°©ë²• 1: text-align:center ìŠ¤íƒ€ì¼ì„ ê°€ì§„ p íƒœê·¸ì™€ btn-watch-now í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ë§í¬
        clonedParagraph.find('p[style*="text-align: center"]').each((i, el) => {
          const $el = $(el);
          if ($el.find('a.btn-watch-now').length > 0 || $el.text().includes('Watch Now') || $el.text().includes('watch now')) {
            logDebug('Watch Now ë²„íŠ¼ ì˜ì—­ ì œê±°');
            $el.remove();
          }
        });
        
        // ë°©ë²• 2: "Watch ... on Viki" ë˜ëŠ” "Watch ... below" í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ p íƒœê·¸
        clonedParagraph.find('p').each((i, el) => {
          const $el = $(el);
          const text = $el.text().toLowerCase();
          if (text.includes('watch') && (text.includes('viki') || text.includes('below'))) {
            logDebug('Watch on Viki í…ìŠ¤íŠ¸ ì˜ì—­ ì œê±°');
            $el.remove();
            
            // ë‹¤ìŒ p íƒœê·¸ê°€ Watch Now ë²„íŠ¼ì„ í¬í•¨í•˜ê³  ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•¨ê»˜ í™•ì¸
            const nextP = $el.next('p');
            if (nextP.length && (nextP.find('a.btn-watch-now').length > 0 || nextP.text().includes('Watch Now'))) {
              nextP.remove();
            }
          }
        });
        
        contentHtml = clonedParagraph.html();
        logDebug('article-paragraphì—ì„œ HTML ì¶”ì¶œë¨');
      }
    }
    
    // ì‹œë„ 3: article-sectionì—ì„œ ì¶”ì¶œ
    if (!contentHtml) {
      logDebug('ì‹œë„ 3: article-sectionì—ì„œ ì¶”ì¶œ');
      const articleSection = $('.article-section');
      if (articleSection.length) {
        // ë³µì œë³¸ ìƒì„±
        const clonedSection = articleSection.clone();
        
        // ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±° (YouTube iframe ì œì™¸)
        clonedSection.find('.social-share-container, .article-reactions, .article-footer, script, .ad, .disqus_thread, .comment-container').remove();
        
        // iframe ì¤‘ì—ì„œ YouTubeê°€ ì•„ë‹Œ ê²ƒë§Œ ì œê±° (YouTube iframeì€ ìœ ì§€)
        clonedSection.find('iframe').each((i, el) => {
          const src = $(el).attr('src') || '';
          // YouTube iframeì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì œê±°
          if (!src.includes('youtube.com/embed/') && !src.includes('youtu.be/')) {
            $(el).remove();
          }
        });
        
        // í•˜ë‹¨ ë°°ë„ˆ ì´ë¯¸ì§€ ì œê±°
        clonedSection.find('p > a[target="_blank"][rel="noopener noreferrer"] > img[class*="wp-image-"], hr + p > a > img').each((i, el) => {
          logDebug('í•˜ë‹¨ ë°°ë„ˆ ì´ë¯¸ì§€ ì œê±°');
          $(el).parent().parent().remove();
        });
        
        // í•˜ë‹¨ íšŒìƒ‰ ì¤„(HR íƒœê·¸) ì œê±°
        clonedSection.find('hr').each((i, el) => {
          logDebug('í•˜ë‹¨ íšŒìƒ‰ ì¤„(HR íƒœê·¸) ì œê±°');
          $(el).remove();
        });
        
        // "ì›ë³¸ ê¸°ì‚¬: Soompi" ê´€ë ¨ ìš”ì†Œ ì œê±°
        clonedSection.find('p:contains("ì›ë³¸ ê¸°ì‚¬:")').remove();
        
        // hr íƒœê·¸ ë‹¤ìŒì— ì˜¤ëŠ” ë°°ë„ˆ ì œê±°
        clonedSection.find('hr').next('p').each((i, el) => {
          const $el = $(el);
          if ($el.find('img, a[target="_blank"]').length > 0) {
            logDebug('hr íƒœê·¸ ë‹¤ìŒ ë°°ë„ˆ ì œê±°');
            $el.remove();
          }
        });
        
        // "Watch Now" ë²„íŠ¼ ì˜ì—­ ì œê±°
        // ë°©ë²• 1: text-align:center ìŠ¤íƒ€ì¼ì„ ê°€ì§„ p íƒœê·¸ì™€ btn-watch-now í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ë§í¬
        clonedSection.find('p[style*="text-align: center"]').each((i, el) => {
          const $el = $(el);
          if ($el.find('a.btn-watch-now').length > 0 || $el.text().includes('Watch Now') || $el.text().includes('watch now')) {
            logDebug('Watch Now ë²„íŠ¼ ì˜ì—­ ì œê±°');
            $el.remove();
          }
        });
        
        // ë°©ë²• 2: "Watch ... on Viki" ë˜ëŠ” "Watch ... below" í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ p íƒœê·¸
        clonedSection.find('p').each((i, el) => {
          const $el = $(el);
          const text = $el.text().toLowerCase();
          if (text.includes('watch') && (text.includes('viki') || text.includes('below'))) {
            logDebug('Watch on Viki í…ìŠ¤íŠ¸ ì˜ì—­ ì œê±°');
            $el.remove();
            
            // ë‹¤ìŒ p íƒœê·¸ê°€ Watch Now ë²„íŠ¼ì„ í¬í•¨í•˜ê³  ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•¨ê»˜ í™•ì¸
            const nextP = $el.next('p');
            if (nextP.length && (nextP.find('a.btn-watch-now').length > 0 || nextP.text().includes('Watch Now'))) {
              nextP.remove();
            }
          }
        });
        
        contentHtml = clonedSection.html();
        logDebug('article-sectionì—ì„œ HTML ì¶”ì¶œë¨');
      }
    }
    
    // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ê°„ë‹¨í•œ ë©”ì‹œì§€ ì œê³µ
    if (!contentHtml) {
      logDebug('HTML ë‚´ìš© ì¶”ì¶œ ì‹¤íŒ¨');
      contentHtml = '<p>ìƒì„¸ ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›ë³¸ í˜ì´ì§€ë¥¼ ë°©ë¬¸í•´ ì£¼ì„¸ìš”.</p>';
    }
    
    // ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
    contentHtml = contentHtml.replace(/src="\/wp-content/g, 'src="https://www.soompi.com/wp-content');
    
    // ì¶”ê°€ì ì¸ ì›ë³¸ ê¸°ì‚¬ ë§í¬ ì œê±° (ì´ë¯¸ ìœ„ì—ì„œ ëŒ€ë¶€ë¶„ ì œê±°ë˜ì§€ë§Œ í™•ì‹¤íˆ í•˜ê¸° ìœ„í•¨)
    contentHtml = contentHtml.replace(/<p>.*?ì›ë³¸ ê¸°ì‚¬.*?<\/p>/g, '');
    
    // ë§í¬ëŠ” ë‚¨ê¸°ê³  ì›ë³¸ ê¸°ì‚¬ í…ìŠ¤íŠ¸ë§Œ ì œê±°
    contentHtml = contentHtml.replace(/ì›ë³¸ ê¸°ì‚¬: Soompi/g, '');
    
    // "Watch Now" ê´€ë ¨ í…ìŠ¤íŠ¸ ë° ë²„íŠ¼ ìµœì¢… ì •ë¦¬ (ì •ê·œì‹ìœ¼ë¡œ)
    contentHtml = contentHtml.replace(/<p[^>]*>.*?Watch.*?(on Viki|below).*?<\/p>/gi, '');
    contentHtml = contentHtml.replace(/<p[^>]*>.*?<a[^>]*class="btn-watch-now"[^>]*>.*?<\/a>.*?<\/p>/gi, '');
    
    // Viki URL ì™„ì „íˆ ì œê±° - ë§í¬ë§Œ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ëŠ” ìœ ì§€
    contentHtml = contentHtml.replace(/<a[^>]*href="https?:\/\/(?:www\.)?viki\.com[^"]*"[^>]*>(.*?)<\/a>/gi, '$1');
    
    // "Watch" í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” ë¬¸ì¥ ì œê±° - ëª…í™•í•œ Viki ê´€ë ¨ ë¬¸ì¥ë§Œ ì œê±°
    contentHtml = contentHtml.replace(/<p[^>]*>.*?[Ww]atch.*?on\s+[Vv]iki.*?<\/p>/gi, '');
    
    // Source í˜•ì‹ ì¡°ì • (ê¸°ì‚¬ ë‚´ìš©ê³¼ Source ì‚¬ì´ì— í•œ ì¤„ ë„ìš°ê¸°, Source ë’¤ì—ëŠ” ë¹ˆì¤„ ì—†ìŒ)
    contentHtml = contentHtml.replace(/(.*?)(<p[^>]*>Source(?:\s*\(\d+\))?:?.*?<\/p>)/is, '$1<p>&nbsp;</p>$2');
    
    // ë§ˆì¹¨í‘œ(.) ë’¤ì— ì¤„ë°”ê¿ˆ(<br>) ì¶”ê°€
    contentHtml = addLineBreakAfterPeriods(contentHtml);
    
    // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ê°„ë‹¨í•œ ë©”ì‹œì§€ ì œê³µ
    if (!contentHtml) {
      logDebug('HTML ë‚´ìš© ì¶”ì¶œ ì‹¤íŒ¨');
      contentHtml = '<p>ìƒì„¸ ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›ë³¸ í˜ì´ì§€ë¥¼ ë°©ë¬¸í•´ ì£¼ì„¸ìš”.</p>';
    }
    
    // ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
    contentHtml = contentHtml.replace(/src="\/wp-content/g, 'src="https://www.soompi.com/wp-content');
    
    // ëª¨ë“  Soompi ì´ë¯¸ì§€ URLì„ í”„ë¡ì‹œ URLë¡œ ë³€í™˜
    const cheerioContent = cheerio.load(contentHtml);
    const imgElements = cheerioContent('img').toArray();
    
    for (const img of imgElements) {
      const originalSrc = cheerioContent(img).attr('src');
      if (originalSrc && originalSrc.startsWith('http')) {
        const proxySrc = await convertSoompiImageToProxy(originalSrc);
        cheerioContent(img).attr('src', proxySrc);
        logDebug(`ì´ë¯¸ì§€ URL ë³€í™˜: ${originalSrc} â†’ ${proxySrc}`);
      }
    }
    
    contentHtml = cheerioContent.html();
    
    // Soompi ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ì¶œ (ìš°ì„ ìˆœìœ„ 1 ì ìš©)
    let detailCategory = '';
    
    // ìš°ì„ ìˆœìœ„ 1-1: ë©”íƒ€ íƒœê·¸ì—ì„œ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ì¶œ (ê°€ì¥ ì •í™•)
    const metaCategory = $('meta[property="article:section"]').attr('content');
    if (metaCategory) {
      detailCategory = metaCategory.trim();
      logDebug(`[ìš°ì„ ìˆœìœ„ 1-1] ë©”íƒ€ íƒœê·¸ì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬: ${detailCategory}`);
    }
    
    
    // ìš°ì„ ìˆœìœ„ 1-2: tags-containerì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ (Soompiì˜ ì‹¤ì œ êµ¬ì¡°)
    if (!detailCategory) {
      const tagLink = $('.tags-container .badges.tags a').first();
      if (tagLink.length) {
        const href = tagLink.attr('href') || '';
        const text = tagLink.text().trim();
        
        if (href.includes('/category/')) {
          const categoryMatch = href.match(/\/category\/([^\/]+)/);
          if (categoryMatch && categoryMatch[1]) {
            detailCategory = categoryMatch[1];
            logDebug(`[ìš°ì„ ìˆœìœ„ 1-2] tags-containerì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬: ${detailCategory} (í…ìŠ¤íŠ¸: ${text})`);
          }
        } else if (text) {
          detailCategory = text.toLowerCase();
          logDebug(`[ìš°ì„ ìˆœìœ„ 1-2] tags-container í…ìŠ¤íŠ¸ì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬: ${detailCategory}`);
        }
      }
    }
    // ìš°ì„ ìˆœìœ„ 1-3: ë¸Œë ˆë“œí¬ëŸ¼ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
    if (!detailCategory) {
      const breadcrumbs = $('.breadcrumbs a, .breadcrumb a, .nav-breadcrumb a');
      breadcrumbs.each((i, el) => {
        const href = $(el).attr('href') || '';
        if (href.includes('/category/')) {
          const categoryMatch = href.match(/\/category\/([^\/]+)/);
          if (categoryMatch && categoryMatch[1]) {
            detailCategory = categoryMatch[1].replace('-', ' ');
            logDebug(`[ìš°ì„ ìˆœìœ„ 1-3] ë¸Œë ˆë“œí¬ëŸ¼ì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬: ${detailCategory}`);
            return false; // ë£¨í”„ ì¢…ë£Œ
          }
        }
      });
    }
    
    // ìš°ì„ ìˆœìœ„ 1-4: URLì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
    if (!detailCategory && articleUrl) {
      if (articleUrl.includes('/category/')) {
        const categoryMatch = articleUrl.match(/\/category\/([^\/]+)/);
        if (categoryMatch && categoryMatch[1]) {
          detailCategory = categoryMatch[1].replace('-', ' ');
          logDebug(`[ìš°ì„ ìˆœìœ„ 1-4] URLì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬: ${detailCategory}`);
        }
      }
    }
    
    // ìš°ì„ ìˆœìœ„ 1-5: íƒœê·¸ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ 
    if (!detailCategory && tags.length > 0) {
      // ì¹´í…Œê³ ë¦¬ ê´€ë ¨ í‚¤ì›Œë“œ (ë” ì •í™•í•œ ë§¤ì¹­ì„ ìœ„í•´ í™•ì¥)
      const categoryKeywords = {
        'K-Drama': 'drama',
        'Drama': 'drama',
        'Korean Drama': 'drama',
        'K-Pop': 'kpop',
        'Music': 'kpop',
        'Korean Music': 'kpop',
        'Movie': 'movie',
        'Film': 'movie',
        'Korean Movie': 'movie',
        'Variety': 'variety',
        'Variety Show': 'variety',
        'Celebrity': 'celeb',
        'Interview': 'celeb',
        'Fashion': 'celeb',
        'Style': 'celeb'
      };
      
      // íƒœê·¸ì—ì„œ ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œ ì°¾ê¸°
      for (const tag of tags) {
        const normalizedTag = tag.trim();
        if (categoryKeywords[normalizedTag]) {
          detailCategory = normalizedTag;
          logDebug(`[ìš°ì„ ìˆœìœ„ 1-5] íƒœê·¸ì—ì„œ ì¶”ë¡ í•œ ì¹´í…Œê³ ë¦¬: ${detailCategory}`);
          break;
        }
      }
    }
    
    // Soompi ì¹´í…Œê³ ë¦¬ë¥¼ ë¡œì»¬ ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘ (ìµœì¢… ê²°ì •)
    let mappedCategory = '';
    if (detailCategory) {
      mappedCategory = mapSoompiCategoryToLocal(detailCategory);
      logDebug(`[Soompi ì¹´í…Œê³ ë¦¬ ë§¤í•‘] '${detailCategory}' â†’ '${mappedCategory}'`);
      forceLog(`[Soompi ì¹´í…Œê³ ë¦¬ ë°œê²¬] "${articleUrl}" â†’ ì›ë³¸: "${detailCategory}", ë§¤í•‘: "${mappedCategory}"`);
    } else {
      logDebug(`[Soompi ì¹´í…Œê³ ë¦¬ ì—†ìŒ] ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
    }
    
    logDebug(`ìƒì„¸ í˜ì´ì§€ íŒŒì‹± ì™„ë£Œ: íƒœê·¸ ${tags.length}ê°œ, ì¹´í…Œê³ ë¦¬: ${detailCategory || 'ì—†ìŒ'}, ì‘ì„±ì: ${author || 'ì—†ìŒ'}`);
    
    return {
      content: contentHtml,
      tags: tags,
      author: author,
      coverImage: coverImage,
      title: articleTitle,
      detailCategory: detailCategory,
      mappedCategory: mappedCategory
    };
  } catch (error) {
    logDebug('ê¸°ì‚¬ ìƒì„¸ í˜ì´ì§€ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜:', error);
    return {
      content: '<p>ìƒì„¸ ê¸°ì‚¬ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì›ë³¸ í˜ì´ì§€ë¥¼ ë°©ë¬¸í•´ ì£¼ì„¸ìš”.</p>',
      tags: [],
      author: '',
      coverImage: '',
      title: ''
    };
  }
}

// Soompi ì¹´í…Œê³ ë¦¬ë¥¼ ë¡œì»¬ ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘í•˜ëŠ” í•¨ìˆ˜
function mapSoompiCategoryToLocal(soompiCategory) {
  if (!soompiCategory) return 'kpop';
  
  // ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ê³  ê³µë°± ë° íŠ¹ìˆ˜ë¬¸ì ì œê±°
  const normalizedCategory = soompiCategory.toLowerCase().trim();
  
  // ì¹´í…Œê³ ë¦¬ ë§µí•‘ í…Œì´ë¸” (í‚¤: Soompi ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œ, ê°’: ë¡œì»¬ ì¹´í…Œê³ ë¦¬)
  const categoryKeywords = {
    // K-POP ê´€ë ¨ í‚¤ì›Œë“œ
    'music': 'kpop',
    'k-pop': 'kpop',
    'kpop': 'kpop',
    'idol': 'kpop',
    'comeback': 'kpop',
    'album': 'kpop',
    'mv': 'kpop',
    'song': 'kpop',
    'concert': 'kpop',
    'performance': 'kpop',
    
    // ë“œë¼ë§ˆ ê´€ë ¨ í‚¤ì›Œë“œ
    'drama': 'drama',
    'kdrama': 'drama',
    'k-drama': 'drama',
    'preview': 'drama',
    'preview-drama': 'drama',
    'drama-preview': 'drama',
    'preview-dramas': 'drama',
    'drama-previews': 'drama',
    'tvn': 'drama',
    'jtbc': 'drama',
    'sbs': 'drama',
    'kbs': 'drama',
    'mbc': 'drama',
    'netflix': 'drama',
    'series': 'drama',
    'tv/film': 'drama',
    'tv': 'drama',
    
    // ì˜í™” ê´€ë ¨ í‚¤ì›Œë“œ
    'movie': 'movie',
    'film': 'movie',
    'cinema': 'movie',
    
    // ì˜ˆëŠ¥ ê´€ë ¨ í‚¤ì›Œë“œ
    'variety': 'variety',
    'show': 'variety',
    'entertainment': 'variety',
    'reality': 'variety',
    
    // ì…€ëŸ½ ê´€ë ¨ í‚¤ì›Œë“œ
    'celeb': 'celeb',
    'celebrity': 'celeb',
    'actor': 'celeb',
    'actress': 'celeb',
    'star': 'celeb',
    'style': 'celeb',
    'fashion': 'celeb',
    'culture': 'celeb',
    'features': 'celeb',
    'interview': 'celeb'
  };
  
  // ê³µì‹ Soompi ì¹´í…Œê³ ë¦¬ ë§µí•‘
  const officialCategoryMap = {
    'drama': 'drama',
    'k-drama': 'drama',
    'drama-preview': 'drama',
    'preview-dramas': 'drama',
    'drama-previews': 'drama',
    'music': 'kpop',
    'k-pop': 'kpop',
    'celeb': 'celeb',
    'celebrity': 'celeb',
    'film': 'movie',
    'tv': 'drama',
    'tv/film': 'drama',
    'style': 'celeb',
    'culture': 'celeb',
    'features': 'celeb',
    'variety': 'variety',
    'variety-show': 'variety',
    'interview': 'celeb'
  };
  
  // 1. ìš°ì„  ê³µì‹ ì¹´í…Œê³ ë¦¬ ë§µì—ì„œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í•­ëª© í™•ì¸
  if (officialCategoryMap[normalizedCategory]) {
    return officialCategoryMap[normalizedCategory];
  }
  
  // 2. í‚¤ì›Œë“œ ê¸°ë°˜ ë§¤ì¹­ ì‹œë„
  for (const [keyword, category] of Object.entries(categoryKeywords)) {
    if (normalizedCategory.includes(keyword)) {
      return category;
    }
  }
  
  // 3. ê¸°ë³¸ê°’ì€ kpop
  return 'kpop';
}

// ê¸°ì‚¬ í•­ëª©ì„ ì¶”ê°€í•˜ëŠ” ê³µí†µ í—¬í¼ í•¨ìˆ˜
async function createNewsItem(title, url, thumbnailUrl, category, timeText, order) {
  // URL ì •ê·œí™”
  const articleUrl = url.startsWith('http') ? url : `https://www.soompi.com${url.startsWith('/') ? '' : '/'}${url}`;
  
  // ì¹´í…Œê³ ë¦¬ ì„¤ì • ìš°ì„ ìˆœìœ„:
  // 1. Soompi ì¹´í…Œê³ ë¦¬ ë§¤í•‘ (ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¶”ì¶œ) - ìµœìš°ì„ 
  // 2. URL ê¸°ë°˜ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
  // 3. ì œëª© ê¸°ë°˜ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ 
  // 4. ê¸°ë³¸ê°’ (kpop)
  
  let enhancedCategory = category;
  
  // ìš°ì„ ìˆœìœ„ 2: URLì—ì„œ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ì¶œ (ìƒì„¸ í˜ì´ì§€ ì •ë³´ê°€ ì—†ì„ ë•Œë§Œ)
  if (!enhancedCategory && articleUrl) {
    // 'category' í‚¤ì›Œë“œ ê²€ìƒ‰
    if (articleUrl.includes('/category/')) {
      const categoryMatch = articleUrl.match(/\/category\/([^\/]+)/);
      if (categoryMatch && categoryMatch[1]) {
        enhancedCategory = categoryMatch[1];
        logDebug(`URLì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ: ${enhancedCategory}`);
      }
    }
    
    // íŠ¹ì • í‚¤ì›Œë“œë¡œ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ 
    if (!enhancedCategory) {
      if (articleUrl.includes('drama') || articleUrl.includes('k-drama')) {
        enhancedCategory = 'drama';
      } else if (articleUrl.includes('music') || articleUrl.includes('k-pop') || articleUrl.includes('kpop')) {
        enhancedCategory = 'kpop';
      } else if (articleUrl.includes('movie') || articleUrl.includes('film')) {
        enhancedCategory = 'movie';
      } else if (articleUrl.includes('variety') || articleUrl.includes('show')) {
        enhancedCategory = 'variety';
      } else if (articleUrl.includes('celeb') || articleUrl.includes('actor') || articleUrl.includes('style')) {
        enhancedCategory = 'celeb';
      }
      
      if (enhancedCategory) {
        logDebug(`URL í‚¤ì›Œë“œì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ : ${enhancedCategory}`);
      }
    }
  }
  
  // ìš°ì„ ìˆœìœ„ 3: ì œëª©ì—ì„œ ì¹´í…Œê³ ë¦¬ íŒíŠ¸ ì°¾ê¸° (URLì—ì„œë„ ì°¾ì§€ ëª»í–ˆì„ ë•Œë§Œ)
  if (!enhancedCategory && title) {
    const lowerTitle = title.toLowerCase();
    
    if (lowerTitle.includes('drama') || lowerTitle.includes('series')) {
      enhancedCategory = 'drama';
    } else if (lowerTitle.includes('comeback') || lowerTitle.includes('mv') || lowerTitle.includes('album') || 
               lowerTitle.includes('music') || lowerTitle.includes('song') || lowerTitle.includes('concert')) {
      enhancedCategory = 'kpop';
    } else if (lowerTitle.includes('movie') || lowerTitle.includes('film')) {
      enhancedCategory = 'movie';
    } else if (lowerTitle.includes('variety') || lowerTitle.includes('show')) {
      enhancedCategory = 'variety';
    }
    
    if (enhancedCategory) {
      logDebug(`ì œëª©ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ : ${enhancedCategory}`);
    }
  }
  
  // ì„ì‹œ ë¡œì»¬ ì¹´í…Œê³ ë¦¬ë¡œ ë³€í™˜ (ìƒì„¸ í˜ì´ì§€ì—ì„œ ìµœì¢… ê²°ì •ë¨)
  const localCategory = mapSoompiCategoryToLocal(enhancedCategory);
  
  // ë””ë²„ê¹…
  if (enhancedCategory !== category) {
    logDebug(`ì¹´í…Œê³ ë¦¬ í–¥ìƒ: '${category || 'none'}' â†’ '${enhancedCategory}' â†’ '${localCategory}'`);
  }
  
  // slug ìƒì„± (ì œëª©ì´ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ì¥ì¹˜)
  let slug = '';
  if (title) {
    slug = title
      .toLowerCase()
      .replace(/[^a-z0-9ã„±-ã…ã…-ã…£ê°€-í£\s]+/g, '')
      .replace(/\s+/g, '-')
      .replace(/^-|-$/g, '');
    
    // slugê°€ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ì€ ê²½ìš° íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    if (!slug || slug.length < 3) {
      const timestamp = Date.now().toString().slice(-6);
      slug = `soompi-news-${timestamp}`;
    }
  } else {
    // ì œëª©ì´ ì—†ëŠ” ê²½ìš° íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ slug ìƒì„±
    const timestamp = Date.now().toString().slice(-6);
    slug = `soompi-news-${timestamp}`;
  }
  
  // slug ìƒì„± ë””ë²„ê¹… ë¡œê·¸
  logDebug(`Slug ìƒì„±: ì œëª©="${title}", ìƒì„±ëœ slug="${slug}"`);
  
  // ë‰´ìŠ¤ ì•„ì´í…œ ìƒì„±
  const newsItem = {
    title,
    slug,
    thumbnailUrl,
    articleUrl,
    timeText: timeText || 'Recently',
    summary: `${title} - From Soompi ${enhancedCategory ? `(${enhancedCategory})` : ''}${timeText ? ` (${timeText})` : ''}`,
    category: localCategory,
    source: 'Soompi',
    sourceUrl: 'https://www.soompi.com',
    coverImage: await convertSoompiImageToProxy(thumbnailUrl) || '/images/default-news.jpg',
    tags: ['K-POP', 'News', 'Soompi'].concat(enhancedCategory ? [enhancedCategory] : []),
    createdAt: new Date(),
    publishedAt: new Date(), // í™ˆí˜ì´ì§€ ì •ë ¬ì„ ìœ„í•´ publishedAt í•„ë“œ ì¶”ê°€
    updatedAt: new Date(),
    featured: order < 5, // ì²˜ìŒ 5ê°œ ì•„ì´í…œì€ featuredë¡œ í‘œì‹œ
    viewCount: 0,
    content: '',  // ë‚´ìš©ì€ ë‚˜ì¤‘ì— fetchArticleDetail í•¨ìˆ˜ì—ì„œ ì±„ì›ë‹ˆë‹¤
    needsDetailFetch: true  // ìƒì„¸ í˜ì´ì§€ì—ì„œ ë‚´ìš©ì„ ê°€ì ¸ì™€ì•¼ í•¨ì„ í‘œì‹œ
  };
  
  // ìµœì¢… ë‰´ìŠ¤ ì•„ì´í…œ ë””ë²„ê¹… ë¡œê·¸
  logDebug(`ë‰´ìŠ¤ ì•„ì´í…œ ìƒì„± ì™„ë£Œ: slug="${newsItem.slug}", title="${newsItem.title}"`);
  
  return newsItem;
}

export default async function handler(req, res) {
  // ê°•ì œ ë¡œê·¸ ì¶”ê°€
  forceLog('=== API ROUTE START ===');
  forceLog(`ìš”ì²­ ë©”ì„œë“œ: ${req.method}`);
  forceLog(`ìš”ì²­ ë°”ë””: ${JSON.stringify(req.body)}`);
  forceLog(`ìš”ì²­ URL: ${req.url}`);
  forceLog(`ìš”ì²­ í—¤ë”: ${JSON.stringify(req.headers)}`);
  
  // API ë¼ìš°íŠ¸ ì§„ì… ë¡œê·¸ ì¶”ê°€
  logDebug('=== API ROUTE START ===');
  logDebug('ìš”ì²­ ë©”ì„œë“œ:', req.method);
  logDebug('ìš”ì²­ ë°”ë””:', req.body);
  logDebug('ìš”ì²­ URL:', req.url);
  
  // POST ìš”ì²­ë§Œ í—ˆìš©
  if (req.method !== 'POST') {
    logDebug('ì˜ëª»ëœ ë©”ì„œë“œ ìš”ì²­:', req.method);
    forceLog(`ì˜ëª»ëœ ë©”ì„œë“œ ìš”ì²­: ${req.method}`);
    return res.status(405).json({ success: false, message: 'Method not allowed' });
  }

  try {
    forceLog('=== í¬ë¡¤ë§ ì‹œì‘ ===');
    
    // ìš”ì²­ì—ì„œ ìµœëŒ€ í¬ë¡¤ë§ ì•„ì´í…œ ìˆ˜ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: 15)
    const maxItems = parseInt(req.body.maxItems) || 15;
    logDebug(`ìµœëŒ€ í¬ë¡¤ë§ ì•„ì´í…œ ìˆ˜: ${maxItems}`);
    forceLog(`ìµœëŒ€ í¬ë¡¤ë§ ì•„ì´í…œ ìˆ˜: ${maxItems}`);
    
    // ë™ì‹œì— ì²˜ë¦¬í•  ìƒì„¸ í˜ì´ì§€ ìš”ì²­ ìˆ˜ (ë³‘ë ¬ ì²˜ë¦¬)
    const concurrentRequests = parseInt(req.body.concurrentRequests) || 3;
    logDebug(`ë™ì‹œ ìƒì„¸ í˜ì´ì§€ ìš”ì²­ ìˆ˜: ${concurrentRequests}`);
    forceLog(`ë™ì‹œ ìƒì„¸ í˜ì´ì§€ ìš”ì²­ ìˆ˜: ${concurrentRequests}`);
    
    // Soompi ë‰´ìŠ¤ í¬ë¡¤ë§
    logDebug('=== SOOMPI í¬ë¡¤ë§ ì‹œì‘ ===');
    forceLog('=== SOOMPI í¬ë¡¤ë§ ì‹œì‘ ===');
    
    // í¬ë¡¤ë§ ë°©ì‹ ì„ íƒ (ê¸°ë³¸ê°’: ë™ì  í¬ë¡¤ë§)
    const useDynamicCrawling = req.body.useDynamicCrawling !== false; // ê¸°ë³¸ê°’ true
    logDebug(`í¬ë¡¤ë§ ë°©ì‹: ${useDynamicCrawling ? 'ë™ì (Puppeteer)' : 'ì •ì (Cheerio)'}`);
    forceLog(`í¬ë¡¤ë§ ë°©ì‹: ${useDynamicCrawling ? 'ë™ì (Puppeteer)' : 'ì •ì (Cheerio)'}`);
    
    let newsItems;
    try {
      forceLog('=== í¬ë¡¤ë§ í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘ ===');
      
      if (useDynamicCrawling) {
        forceLog('=== Puppeteer í¬ë¡¤ë§ ì‹œì‘ ===');
        newsItems = await scrapeSoompiNewsWithPuppeteer(maxItems);
        forceLog('=== Puppeteer í¬ë¡¤ë§ ì™„ë£Œ ===');
      } else {
        forceLog('=== ì •ì  í¬ë¡¤ë§ ì‹œì‘ ===');
        newsItems = await scrapeSoompiNewsStatic(maxItems);
        forceLog('=== ì •ì  í¬ë¡¤ë§ ì™„ë£Œ ===');
      }
      
      forceLog('=== í¬ë¡¤ë§ í•¨ìˆ˜ í˜¸ì¶œ ì™„ë£Œ ===');
      
    } catch (crawlError) {
      forceLog('í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + crawlError.message);
      forceLog('í¬ë¡¤ë§ ì˜¤ë¥˜ ìŠ¤íƒ: ' + crawlError.stack);
      return res.status(500).json({ success: false, message: 'í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + crawlError.message });
    }
    
    logDebug('=== SOOMPI í¬ë¡¤ë§ ì™„ë£Œ ===');
    logDebug('í¬ë¡¤ë§ëœ ë‰´ìŠ¤ ì•„ì´í…œ ìˆ˜:', newsItems.length);
    forceLog(`í¬ë¡¤ë§ëœ ë‰´ìŠ¤ ì•„ì´í…œ ìˆ˜: ${newsItems.length}`);
    logDebug('í¬ë¡¤ë§ëœ ë‰´ìŠ¤ ì•„ì´í…œë“¤:', newsItems.map(item => ({ title: item.title, slug: item.slug, articleUrl: item.articleUrl })));
    
    if (newsItems.length === 0) {
      logDebug('í¬ë¡¤ë§í•  ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      forceLog('í¬ë¡¤ë§í•  ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      return res.status(404).json({ success: false, message: 'í¬ë¡¤ë§í•  ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }
    
    forceLog('=== ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹œì‘ ===');
    
    try {
      // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
      logDebug('MongoDB ì—°ê²° ì‹œë„...');
      forceLog('MongoDB ì—°ê²° ì‹œë„...');
      const { db } = await connectToDatabase();
      forceLog('MongoDB ì—°ê²° ì„±ê³µ');
      const collection = db.collection('news');
      
      // ì¤‘ë³µ URL í™•ì¸
      forceLog('ì¤‘ë³µ URL í™•ì¸ ì‹œì‘...');
      const existingUrls = await collection.find({
        articleUrl: { $in: newsItems.map(item => item.articleUrl) }
      }).project({ articleUrl: 1 }).toArray();
      
      const existingUrlSet = new Set(existingUrls.map(item => item.articleUrl));
      logDebug(`ê¸°ì¡´ URL ${existingUrlSet.size}ê°œ í•„í„°ë§`);
      forceLog(`ê¸°ì¡´ URL ${existingUrlSet.size}ê°œ í•„í„°ë§`);
      
      // ìƒˆ ì•„ì´í…œ í•„í„°ë§ (ì¤‘ë³µ ì œì™¸)
      const newItems = newsItems.filter(item => !existingUrlSet.has(item.articleUrl));
      logDebug(`ìƒˆ ì•„ì´í…œ ìˆ˜: ${newItems.length}`);
      forceLog(`ìƒˆ ì•„ì´í…œ ìˆ˜: ${newItems.length}`);
      
      if (newItems.length === 0) {
        forceLog('ìƒˆë¡œìš´ ë‰´ìŠ¤ê°€ ì—†ìŒ');
        return res.status(200).json({
          success: true,
          message: 'ìƒˆë¡œìš´ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.',
          total: newsItems.length,
          new: 0
        });
      }
      
      // ìƒˆ ì•„ì´í…œì— ëŒ€í•´ ìƒì„¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° (ë³‘ë ¬ ì²˜ë¦¬)
      logDebug(`${newItems.length}ê°œ í•­ëª©ì˜ ìƒì„¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
      forceLog(`${newItems.length}ê°œ í•­ëª©ì˜ ìƒì„¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
      
      // ë³‘ë ¬ ì²˜ë¦¬ ê·¸ë£¹ìœ¼ë¡œ ìƒì„¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
      let processedItems = 0;
      let detailFetchedItems = [];
      
      // ì‘ì€ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë³‘ë ¬ ì²˜ë¦¬
      for (let i = 0; i < newItems.length; i += concurrentRequests) {
        const itemBatch = newItems.slice(i, i + concurrentRequests);
        logDebug(`ë°°ì¹˜ ${Math.floor(i/concurrentRequests) + 1} ì²˜ë¦¬ ì¤‘: ${itemBatch.length}ê°œ í•­ëª©`);
        forceLog(`ë°°ì¹˜ ${Math.floor(i/concurrentRequests) + 1} ì²˜ë¦¬ ì¤‘: ${itemBatch.length}ê°œ í•­ëª©`);
        
        // í˜„ì¬ ë°°ì¹˜ì˜ ìƒì„¸ ë‚´ìš©ì„ ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
        const detailFetchPromises = itemBatch.map(async (item) => {
          try {
            if (item.needsDetailFetch) {
              const detailContent = await fetchArticleDetail(item.articleUrl);
              
              // ìš°ì„ ìˆœìœ„ 1: ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¶”ì¶œí•œ Soompi ì¹´í…Œê³ ë¦¬ ë§¤í•‘ì„ ìµœìš°ì„  ì ìš©
              if (detailContent.mappedCategory) {
                const originalCategory = item.category;
                item.category = detailContent.mappedCategory;
                
                if (originalCategory !== detailContent.mappedCategory) {
                  logDebug(`[ìš°ì„ ìˆœìœ„ 1] Soompi ì¹´í…Œê³ ë¦¬ ë§¤í•‘ ì ìš©: '${originalCategory}' â†’ '${detailContent.mappedCategory}' (ì›ë³¸: ${detailContent.detailCategory})`);
                  forceLog(`[ì¹´í…Œê³ ë¦¬ ìµœì¢… ê²°ì •] "${item.title}" â†’ ${detailContent.mappedCategory} (Soompi: ${detailContent.detailCategory})`);
                } else {
                  logDebug(`[ìš°ì„ ìˆœìœ„ 1] ì¹´í…Œê³ ë¦¬ ì¼ì¹˜ í™•ì¸: '${detailContent.mappedCategory}' (ì›ë³¸: ${detailContent.detailCategory})`);
                }
                
                // íƒœê·¸ì—ë„ Soompi ì›ë³¸ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
                if (detailContent.detailCategory && !item.tags.includes(detailContent.detailCategory)) {
                  item.tags.push(detailContent.detailCategory);
                }
              } else {
                // ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ ë¡œì§ ìœ ì§€
                logDebug(`[ìš°ì„ ìˆœìœ„ 2-3] ìƒì„¸ í˜ì´ì§€ ì¹´í…Œê³ ë¦¬ ì—†ìŒ, ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ìœ ì§€: '${item.category}'`);
              }
              
              return { ...item, ...detailContent, needsDetailFetch: false };
            }
            return item;
          } catch (error) {
            logDebug(`ìƒì„¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${item.articleUrl}`, error);
            return item; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì›ë³¸ í•­ëª© ë°˜í™˜
          }
        });
        
        // í˜„ì¬ ë°°ì¹˜ ì²˜ë¦¬ ê²°ê³¼ ê¸°ë‹¤ë¦¬ê¸°
        const batchResults = await Promise.all(detailFetchPromises);
        detailFetchedItems = [...detailFetchedItems, ...batchResults];
        
        processedItems += itemBatch.length;
        logDebug(`ì§„í–‰ ìƒí™©: ${processedItems}/${newItems.length} í•­ëª© ì²˜ë¦¬ë¨`);
        forceLog(`ì§„í–‰ ìƒí™©: ${processedItems}/${newItems.length} í•­ëª© ì²˜ë¦¬ë¨`);
        
        // ì„œë²„ ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ ì§€ì—°
        if (i + concurrentRequests < newItems.length) {
          await new Promise(resolve => setTimeout(resolve, 1500));
        }
      }
      
      logDebug(`${detailFetchedItems.length}ê°œ í•­ëª©ì˜ ìƒì„¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`);
      forceLog(`${detailFetchedItems.length}ê°œ í•­ëª©ì˜ ìƒì„¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`);
      
      // ì¹´í…Œê³ ë¦¬ ë¶„í¬ ë¡œê¹…
      const categoryCount = {};
      detailFetchedItems.forEach(item => {
        categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
      });
      logDebug('ì¹´í…Œê³ ë¦¬ ë¶„í¬:', categoryCount);
      forceLog(`ì¹´í…Œê³ ë¦¬ ë¶„í¬: ${JSON.stringify(categoryCount)}`);
      
      // ë°ì´í„°ë² ì´ìŠ¤ì— ì‚½ì…
      if (detailFetchedItems.length > 0) {
        forceLog('=== ë°ì´í„°ë² ì´ìŠ¤ ì‚½ì… ì‹œì‘ ===');
        
        // ì €ì¥ ì „ slug ê²€ì¦ ë° ê°•ì œ ì„¤ì •
        detailFetchedItems.forEach((item, index) => {
          logDebug(`=== ì•„ì´í…œ ${index} ê²€ì¦ ì‹œì‘ ===`);
          logDebug(`ì›ë³¸ ì•„ì´í…œ êµ¬ì¡°:`, JSON.stringify(item, null, 2));
          
          if (!item.slug || item.slug === null || item.slug === undefined) {
            logDebug(`ê²½ê³ : ì¸ë±ìŠ¤ ${index}ì˜ ì•„ì´í…œì— slugê°€ ì—†ìŠµë‹ˆë‹¤. ì œëª©: "${item.title}"`);
            // slugê°€ ì—†ëŠ” ê²½ìš° ì„ì‹œ slug ìƒì„±
            const timestamp = Date.now().toString().slice(-6);
            item.slug = `soompi-news-${timestamp}-${index}`;
            logDebug(`ì„ì‹œ slug ìƒì„±: "${item.slug}"`);
          }
          
          // ìµœì¢… ê²€ì¦: slugê°€ ì—¬ì „íˆ nullì´ë©´ ê°•ì œë¡œ ì„¤ì •
          if (!item.slug || item.slug === null || item.slug === undefined) {
            const fallbackSlug = `soompi-fallback-${Date.now()}-${index}`;
            item.slug = fallbackSlug;
            logDebug(`ê°•ì œ fallback slug ì„¤ì •: "${fallbackSlug}"`);
          }
          
          logDebug(`ìµœì¢… ì•„ì´í…œ ${index}: slug="${item.slug}", title="${item.title}"`);
          logDebug(`=== ì•„ì´í…œ ${index} ê²€ì¦ ì™„ë£Œ ===`);
        });
        
        logDebug(`ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹œì‘: ${detailFetchedItems.length}ê°œ í•­ëª©`);
        
        // ì €ì¥ ì „ ìµœì¢… ê²€ì¦
        const itemsWithSlug = detailFetchedItems.filter(item => item.slug && item.slug !== null && item.slug !== undefined);
        logDebug(`slugê°€ ìˆëŠ” ì•„ì´í…œ ìˆ˜: ${itemsWithSlug.length}/${detailFetchedItems.length}`);
        
        if (itemsWithSlug.length !== detailFetchedItems.length) {
          logDebug('ê²½ê³ : ì¼ë¶€ ì•„ì´í…œì— slugê°€ ì—†ìŠµë‹ˆë‹¤!');
          logDebug('slugê°€ ì—†ëŠ” ì•„ì´í…œë“¤:', detailFetchedItems.filter(item => !item.slug || item.slug === null || item.slug === undefined));
          return res.status(500).json({
            success: false,
            message: 'ì¼ë¶€ ë‰´ìŠ¤ í•­ëª©ì— slugê°€ ì—†ì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
            error: 'Slug validation failed'
          });
        }
        
        logDebug('ì €ì¥í•  ì•„ì´í…œë“¤:', itemsWithSlug.map(item => ({ title: item.title, slug: item.slug })));
        
        const result = await collection.insertMany(itemsWithSlug);
        logDebug(`${result.insertedCount}ê°œ í•­ëª©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì¶”ê°€`);
        
        return res.status(200).json({
          success: true,
          message: `${result.insertedCount}ê°œì˜ ìƒˆ ë‰´ìŠ¤ í•­ëª©ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`,
          total: newsItems.length,
          new: result.insertedCount
        });
      } else {
        return res.status(200).json({
          success: true,
          message: 'í¬ë¡¤ë§ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ìƒˆë¡œìš´ ë‰´ìŠ¤ê°€ ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
          total: newsItems.length,
          new: 0
        });
      }
    } catch (dbError) {
      logDebug('ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—… ì¤‘ ì˜¤ë¥˜:', dbError);
      return res.status(500).json({
        success: false,
        message: 'ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + dbError.message,
        error: dbError.toString()
      });
    }
  } catch (error) {
    logDebug('ì „ì²´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
    forceLog('ì „ì²´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + error.message);
    forceLog('ì „ì²´ ì˜¤ë¥˜ ìŠ¤íƒ: ' + error.stack);
    return res.status(500).json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message });
  }
} 